/*
 jQuery Wookmark plugin
  @name jquery.wookmark.js
  @author Christoph Ono (chri@sto.ph or @gbks)
  @author Sebastian Helzle (sebastian@helzle.net or @sebobo)
  @version 1.4.6
  @date 12/07/2013
  @category jQuery plugin
  @copyright (c) 2009-2013 Christoph Ono (www.wookmark.com)
  @license Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
*/
(function(l){"function"===typeof define&&define.amd?define(["jquery"],l):l(jQuery)})(function(l){function t(d){u(function(){var b;for(b=0;b<d.length;b++){var g=d[b];g.obj.css(g.css)}})}var f=function(d,b){return function(){return d.apply(b,arguments)}};var v={align:"center",autoResize:!1,comparator:null,container:l("body"),direction:void 0,ignoreInactiveItems:!0,itemWidth:0,fillEmptySpace:!1,flexibleWidth:0,offset:2,outerOffset:0,onLayoutChanged:void 0,possibleFilters:[],resizeDelay:50,verticalOffset:void 0};
var u=window.requestAnimationFrame||function(d){d()};var w=function(){function d(b,g){this.handler=b;this.columns=this.containerWidth=this.resizeTimer=null;this.activeItemCount=0;this.itemHeightsDirty=!0;this.placeholders=[];l.extend(!0,this,v,g);this.verticalOffset=this.verticalOffset||this.offset;this.update=f(this.update,this);this.onResize=f(this.onResize,this);this.onRefresh=f(this.onRefresh,this);this.getItemWidth=f(this.getItemWidth,this);this.layout=f(this.layout,this);this.layoutFull=f(this.layoutFull,
this);this.layoutColumns=f(this.layoutColumns,this);this.filter=f(this.filter,this);this.clear=f(this.clear,this);this.getActiveItems=f(this.getActiveItems,this);this.refreshPlaceholders=f(this.refreshPlaceholders,this);this.sortElements=f(this.sortElements,this);this.updateFilterClasses=f(this.updateFilterClasses,this);this.updateFilterClasses();this.autoResize&&l(window).bind("resize.wookmark",this.onResize);this.container.bind("refreshWookmark",this.onRefresh)}d.prototype.updateFilterClasses=function(){for(var b=
0,g,e=0,c={},a,h,m,k=this.possibleFilters;b<this.handler.length;b++)if(h=this.handler.eq(b),a=h.data("filterClass"),"object"==typeof a&&0<a.length)for(g=0;g<a.length;g++)m=l.trim(a[g]).toLowerCase(),c[m]||(c[m]=[]),c[m].push(h[0]);for(;e<k.length;e++)b=l.trim(k[e]).toLowerCase(),b in c||(c[b]=[]);this.filterClasses=c};d.prototype.update=function(b){this.itemHeightsDirty=!0;l.extend(!0,this,b)};d.prototype.onResize=function(){clearTimeout(this.resizeTimer);this.itemHeightsDirty=0!==this.flexibleWidth;
this.resizeTimer=setTimeout(this.layout,this.resizeDelay)};d.prototype.onRefresh=function(){this.itemHeightsDirty=!0;this.layout()};d.prototype.filter=function(b,g){var e=[],c=l(),a;b=b||[];g=g||"or";if(b.length){for(a=0;a<b.length;a++){var h=l.trim(b[a]).toLowerCase();h in this.filterClasses&&e.push(this.filterClasses[h])}var m=e.length;if("or"==g||1==m)for(a=0;a<m;a++)c=c.add(e[a]);else if("and"==g){h=e[0];var k;for(a=1;a<m;a++)e[a].length<h.length&&(h=e[a]);h=h||[];for(a=0;a<h.length;a++){var d=
h[a];var f=!0;for(m=0;m<e.length&&f;m++){var n=e[m];if(h!=n){var p=0;for(k=!1;p<n.length&&!k;p++)k=n[p]==d;f&=k}}f&&c.push(h[a])}}this.handler.not(c).addClass("inactive")}else c=this.handler;c.removeClass("inactive");this.columns=null;this.layout()};d.prototype.refreshPlaceholders=function(b,g){for(var e=this.placeholders.length,c,a,h=this.columns.length,d,k,f=this.container.innerHeight();e<h;e++)c=l('<div class="wookmark-placeholder"/>').appendTo(this.container),this.placeholders.push(c);k=this.offset+
2*parseInt(this.placeholders[0].css("borderLeftWidth"),10);for(e=0;e<this.placeholders.length;e++)if(c=this.placeholders[e],a=this.columns[e],e>=h||!a[a.length-1])c.css("display","none");else if(a=a[a.length-1])d=a.data("wookmark-top")+a.data("wookmark-height")+this.verticalOffset,a=f-d-k,c.css({position:"absolute",display:0<a?"block":"none",left:e*b+g,top:d,width:b-k,height:a})};d.prototype.getActiveItems=function(){return this.ignoreInactiveItems?this.handler.not(".inactive"):this.handler};d.prototype.getItemWidth=
function(){var b=this.itemWidth,g=this.container.width()-2*this.outerOffset,e=this.handler.eq(0),c=this.flexibleWidth;void 0===this.itemWidth||0===this.itemWidth&&!this.flexibleWidth?b=e.outerWidth():"string"==typeof this.itemWidth&&0<=this.itemWidth.indexOf("%")&&(b=parseFloat(this.itemWidth)/100*g);c&&("string"==typeof c&&0<=c.indexOf("%")&&(c=parseFloat(c)/100*g),e=g+this.offset,e=Math.max(~~(.5+e/(c+this.offset)),~~(e/(b+this.offset))),b=Math.max(b,Math.min(c,~~((g-(e-1)*this.offset)/e))),this.handler.css("width",
b));return b};d.prototype.layout=function(b){if(this.container.is(":visible")){var g=this.getItemWidth()+this.offset,e=this.container.width()-2*this.outerOffset,c=~~((e+this.offset)/g);var a=0;var h=this.getActiveItems(),d=h.length;if(this.itemHeightsDirty||!this.container.data("itemHeightsInitialized")){for(;a<d;a++){var k=h.eq(a);k.data("wookmark-height",k.outerHeight())}this.itemHeightsDirty=!1;this.container.data("itemHeightsInitialized",!0)}c=Math.max(1,Math.min(c,d));a=this.outerOffset;"center"==
this.align&&(a+=~~(.5+(e-(c*g-this.offset))>>1));this.direction=this.direction||("right"==this.align?"right":"left");b=b||null===this.columns||this.columns.length!=c||this.activeItemCount!=d?this.layoutFull(g,c,a):this.layoutColumns(g,a);this.activeItemCount=d;this.container.css("height",b);this.fillEmptySpace&&this.refreshPlaceholders(g,a);if(void 0!==this.onLayoutChanged&&"function"===typeof this.onLayoutChanged)this.onLayoutChanged()}};d.prototype.sortElements=function(b){return"function"===typeof this.comparator?
b.sort(this.comparator):b};d.prototype.layoutFull=function(b,d,e){var c=0,a,h=l.makeArray(this.getActiveItems()),g=h.length,k,f=[],q=[],n="left"==this.align?!0:!1;this.columns=[];for(h=this.sortElements(h);f.length<d;)f.push(this.outerOffset),this.columns.push([]);for(;c<g;c++){var p=l(h[c]);var r=f[0];for(a=k=0;a<d;a++)f[a]<r&&(r=f[a],k=a);p.data("wookmark-top",r);a=e;if(0<k||!n)a+=k*b;(q[c]={obj:p,css:{position:"absolute",top:r}}).css[this.direction]=a;f[k]+=p.data("wookmark-height")+this.verticalOffset;
this.columns[k].push(p)}t(q);return Math.max.apply(Math,f)};d.prototype.layoutColumns=function(b,d){for(var e=[],c=[],a=0,h,g=0,f,l,q,n;a<this.columns.length;a++){e.push(this.outerOffset);l=this.columns[a];n=a*b+d;f=e[a];for(h=0;h<l.length;h++,g++)q=l[h].data("wookmark-top",f),(c[g]={obj:q,css:{top:f}}).css[this.direction]=n,f+=q.data("wookmark-height")+this.verticalOffset;e[a]=f}t(c);return Math.max.apply(Math,e)};d.prototype.clear=function(){clearTimeout(this.resizeTimer);l(window).unbind("resize.wookmark",
this.onResize);this.container.unbind("refreshWookmark",this.onRefresh);this.handler.wookmarkInstance=null};return d}();l.fn.wookmark=function(d){this.wookmarkInstance?this.wookmarkInstance.update(d||{}):this.wookmarkInstance=new w(this,d||{});this.wookmarkInstance.layout(!0);return this.show()}});
