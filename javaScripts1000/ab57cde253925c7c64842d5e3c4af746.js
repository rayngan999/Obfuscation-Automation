define(['web/modules/mylocations','localization/copy'],function(mylocations,copy){if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,'');};}
var locationSearch=(function(){var cls=window.location.href.split("//"),countrycode=/^[A-z]{2}$/g;cls=cls[1].split("/");if(typeof window.url_countrycode=="undefined"&&(typeof cls[1]!=="undefined"||cls[1]!=="")&&(cls[1].match(countrycode))){window.url_countrycode="/"+cls[1].toLowerCase();}
if(typeof window.url_countrycode=="undefined"){window.url_countrycode="";}
var inputTxt='',nicknameTxt='',newLocation={},locations=[],self={},selectedLoc='',list,oldPos=0,countryCode=window._config.search_country_code_null,config={'pointcastUrl':window.url_countrycode+'/api/locationsearch/pointcastsearch','templateUrl':window.url_countrycode+'/api/locationsearch/searchtemplate/','citypage':(typeof _config.url_weather!="undefined"?'/'+_config.url_weather+'/':window.url_countrycode+'/weather/'),'editpage':window.url_countrycode+'/'+copy.page_url.url_edit_locations+'/'},_getData=function(url,param,callback){return $.get(url,param,callback);},_updateTemplate=function(data,status){var provCountry;if(data&&data!=null&&data.indexOf('{')>=0){var pcode;data=JSON.parse(data);$('.pointcast-suggestion-list').text('');var postalC=data[0].PostalCode||'';if(data.length==1&&postalC!=''){provCountry=(data[0].ProvCode=='')?data[0].CountryName:data[0].ProvCode;var searchTxt=data[0].Name+', '+provCountry+' '+(data[0].PostalCode||'');$('.location-search-input').val($.trim(searchTxt));_updateNewLocationArr(data[0]);selectedLoc=$.trim(searchTxt);}else{var clist=$('<ul/>');$.each(data,function(index,loc){var locProv=(loc.ProvCode)?', '+loc.ProvCode:', '+loc.CountryName;var locName=loc.Name+locProv+' '+(data[0].PostalCode||'');$('<li/>',{href:'/city',text:$.trim(locName)}).addClass('item').attr('data-pcode',loc.Code).appendTo(clist).click(function(){$('.location-search-input').val($(this).text());$('.pointcast-suggestion-list').text('');$('.pointcast-suggestion-list').hide();pcode=$(this).attr('data-pcode');selectedLoc=$.trim($(this).text());newLocation=locations[pcode];locations=[];});_updateLocationsArr(loc);});$('.pointcast-suggestion-list').show();clist.appendTo('.pointcast-suggestion-list');list=$('.pointcast-suggestion-list li');}}else{$('.location-search-error').text($('.search-error').val()).show();$('.pointcast-suggestion-list').text('').hide();}
return data;},_updateLocationsArr=function(loc){locations[loc.Code]={'postCode':loc.PostalCode||'','placeCode':loc.Code||'','city':loc.Name||'','province':loc.ProvCode||'','country':loc.CountryCode||'','countryName':loc.CountryName||'','countyName':loc.CountyName||'','prizmCode':loc.PostalCodePrizmC2||'','gridIndex':loc.PostalCodeLocationCode||'','locationType':loc.LocType||'','friendlyName':'','alertStatus':'0'};},_updateNewLocationArr=function(loc){newLocation.postCode=loc.PostalCode||'';newLocation.placeCode=loc.Code||'';newLocation.city=loc.Name||'';newLocation.province=loc.ProvCode||'';newLocation.country=loc.CountryCode||'';newLocation.countryName=loc.CountryName||'';newLocation.countyName=loc.CountyName||'';newLocation.prizmCode=loc.PostalCodePrizmC2||'';newLocation.gridIndex=loc.PostalCodeLocationCode||'';newLocation.locationType=loc.LocType||'';newLocation.friendlyName='';newLocation.alertStatus='0';},_renderSearchTemplate=function(template){var delem=document.createElement('div');delem.innerHTML=template;var elem=delem.firstChild;$('body').append(elem);if(typeof $('.location-search-input')=='undefined'){$('body').append(template);}
self.bindElements();require(['modals','defaults'],function(modals,defaults){modals.bind(defaults.overlays.locationOverlay);});},arrowKeyEvent=function(e){var kCode=e.which||e.keyCode,c,selected;if((kCode!=40&&kCode!=38&&kCode!=13)||typeof list=='undefined')return;selected=list.filter('.sel');dh=$('.pointcast-suggestion-list').height();list.removeClass('sel');list.removeAttr('tabindex');if(kCode==40){if(selected.length>0&&selected.next().length==0){e.preventDefault();selected.addClass('sel').focus();return false;}
if(!selected.length){c=list.eq(0);oldPos=0;}else if(selected.is(':last-child')){c=selected;oldPos=oldPos;}
else{c=selected.next();if(selected.is(':first-child')){oldPos=0;}}}
else if(kCode==38){if((selected.length>0&&selected.prev().length==0)||!selected.length){e.preventDefault();selected.addClass('sel').focus();return false;}
if(!selected.length||selected.is(':first-child')){c=list.eq(0);}else{c=selected.prev();if(selected.is(':last-child')){oldPos=dh*Math.floor($('.pointcast-suggestion-list ul').height()/dh);}}}else if(kCode==13){if(selected.length>0){e.preventDefault();selected.trigger('click');return false;}}
c.addClass('sel').focus();var o=$(c).offset(),lt=o.top,lh=$(c).height(),dt=$('.pointcast-suggestion-list').offset().top,selpos=lt+lh,divVis=dt+dh;if(kCode==40&&selpos>divVis){oldPos+=(oldPos==0)?dh:oldPos;$('.pointcast-suggestion-list').animate({scrollTop:oldPos});$('.location-search-input').focus();}else if(oldPos>0&&($(c).position().top<0)){oldPos=(oldPos<=0)?oldPos:(oldPos-(dh-lh));$('.pointcast-suggestion-list').animate({scrollTop:oldPos});}};var _tgc=3;self.init=function(){self.bindElements();require(['modals','defaults'],function(modals,defaults){modals.bind(defaults.overlays.locationOverlay);});};self.getLocationUrl=function(locType){var purl;switch(locType){case'schools':if(typeof copy.page_url.school_url!='undefined'){purl=copy.page_url.school_url;}
break;case'cottages':if(typeof copy.page_url.cottage_url!='undefined'){purl=copy.page_url.cottage_url;}
break;case'attractions':if(typeof copy.page_url.attractions_url!='undefined'){purl=copy.page_url.attractions_url;}
break;case'ski':if(pelm_util.isDefined(copy.page_url.ski_url)){purl=copy.page_url.ski_url;}
break;case'airports':if(pelm_util.isDefined(copy.page_url.airport_url)){purl=copy.page_url.airport_url;}
break;default:purl=copy.page_url.weather_url;break;}
return'/'+purl+'/';};self.getLocationType=function(){var lt=(window._config.location_type)?window._config.location_type:'city';return lt;};self.validatePostalCode=function(postalCode){var reg={'us':/^\b\d{5}(-\d{4})?\b$/,'ca':/(^s*([a-z](\s)?\d(\s)?){3}$)s*/i};var valid=true;switch(postalCode.length){case 5:if($.isNumeric(postalCode)&&!reg.us.test(postalCode)){valid=false;$('.location-search-error').text($('.pcode-error').val()).show();}else if(!$.isNumeric(postalCode)){valid=false;}
break;case 6:case 7:if(postalCode.length==6&&postalCode.indexOf(' ')>-1)
{valid=false;}else if(!reg.ca.test(postalCode)){valid=false;$('.location-search-error').text($('.pcode-error').val()).show();}
break;}
return valid;};self.validateInput=function(searchTxt){if(searchTxt.length>=3){if(/\d+/g.test(searchTxt)==false){return true;}
else if(searchTxt.length>=5){return self.validatePostalCode(searchTxt);}}else{$('.pointcast-suggestion-list').text('').hide();}
return false;};self.clearForm=function(){$('.location-search-error').text('').hide();$('.location-search-input').val(inputTxt);$('.pointcast-suggestion-list').text('').hide();locations=[];newLocation={};selectedLoc='';};self.pointcastSearch=function(params,callback){$('.location-search-error').text('').hide();if($.trim(params.searchTxt)==selectedLoc){$('.pointcast-suggestion-list').text('').hide();return false;}else if(selectedLoc.length>0&&$.trim(params.searchTxt).length<selectedLoc.length){locations=[];newLocation={};selectedLoc='';}
if(params.searchTxt&&self.validateInput(params.searchTxt)==true){if((typeof window._user_config!="undefined")&&(typeof window._user_config=="object")&&(typeof window._user_config.lat!="undefined")&&(typeof window._user_config.lng!="undefined")){params.lat=window._user_config.lat.toFixed(4);params.long=window._user_config.lng.toFixed(4);}else if((typeof window._config.lat!="undefined")&&(typeof window._config.lng!="undefined")){params.lat=window._config.lat.toFixed(4);params.long=window._config.lng.toFixed(4);}
_getData(config.pointcastUrl,params,callback);}else{$('.pointcast-suggestion-list').text('').hide();}};self.addLocation=function(placecode){if(typeof placecode!='undefined'){var params={'searchTxt':placecode,'searchType':'pointcast','endPoint':'GetDataByCode'};if(typeof window.postalcode!='undefined'&&window.postalcode!=''){params.endPoint='GetData';}
$.when(_getData(config.pointcastUrl,params)).done(function(data,status){if((data&&data!=null&&data.indexOf('{')>=0)||(typeof window.placecode=='string')){data=JSON.parse(data);if(window._config.location_type=="airports"){data=false;}
if(data&&parseInt(data.length)>0){var locs={'postCode':data[0].PostalCode||'','placeCode':data[0].Code||'','city':data[0].Name||'','province':data[0].ProvCode||'','country':data[0].CountryCode||'','countryName':data[0].CountryName||'','countyName':data[0].CountyName||'','prizmCode':data[0].PostalCodePrizmC2||'','gridIndex':data[0].PostalCodeLocationCode||'','locationType':data[0].LocType||'','friendlyName':'','alertStatus':'0'};}
else if(typeof window._config.prov_code!='undefined'&&typeof window._config.country_code!='undefined'){var locs={'postCode':window.postalcode||'','placeCode':window.placecode||'','city':window._config.city_name||'','province':window._config.prov_code||'','country':window._config.country_code||'','countryName':window._config.country||'','countyName':window._config.county||'','prizmCode':'','gridIndex':window.gridindex||'','locationType':self.getLocationType()||'','friendlyName':'','alertStatus':'0'};}
else{var locs={'postCode':window.postalcode||'','placeCode':window.placecode||'','city':window._config.city_name||'','province':window._user_config.prov||'','country':window._user_config.country||'','countryName':window._user_config.country_name||'','countyName':window._user_config.county_name||'','prizmCode':'','gridIndex':window.gridindex||'','locationType':self.getLocationType()||'','friendlyName':'','alertStatus':'0'};}
mylocations.update(locs);if(typeof $('#overlay-addlocation')!='undefined'){$('#overlay-addlocation').hide();}
return true;}}).fail(function(data,status){if(typeof window._config.prov_code!='undefined'&&typeof window._config.country_code!='undefined'){var locs={'postCode':window.postalcode||'','placeCode':window.placecode||'','city':window._config.city_name||'','province':window._config.prov_code||'','country':window._config.country_code||'','countryName':window._config.country||'','countyName':window._config.county||'','prizmCode':'','gridIndex':window.gridindex||'','locationType':self.getLocationType()||'','friendlyName':'','alertStatus':'0'};}else{var locs={'postCode':window.postalcode||'','placeCode':window.placecode||'','city':window._config.city_name||'','province':window._user_config.prov||'','country':window._user_config.country||'','countryName':window._user_config.country_name||'','countyName':window._user_config.county_name||'','prizmCode':'','gridIndex':window.gridindex||'','locationType':self.getLocationType()||'','friendlyName':'','alertStatus':'0'};}
mylocations.update(locs);if(typeof $('#overlay-addlocation')!='undefined'){$('#overlay-addlocation').hide();}
return true;});}};self.bindElements=function(){var inputTxt=$('.location-search-input').val();var nicknameTxt=$('#location-box .friendly-name-input').val();$('.location-open-window').click(function(event){if(typeof this.id!='undefined'&&this.id=="addLocation"){dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':'clicks','eventLabel':"addLocationBtn"});}else{dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':'clicks','eventLabel':"plusButton"});}
window.pelm.track.click(this);$('#location-box .friendly-name-wrapper').hide();self.clearForm();});$('#location-search-form').submit(function(){self.pointcastSearch({'searchTxt':$('.location-search-input').val(),'searchType':'pointcast'},_updateTemplate);return false;});$('.location-search-input').keyup(function(e){var kCode=e.which||e.keyCode;if(kCode==40||kCode==38||kCode==37||kCode==39){return;}
self.pointcastSearch({'searchTxt':$(this).val(),'searchType':'pointcast'},_updateTemplate);});$('.location-search-input').focus(function(){if($(this).val()==copy.search.txt_pointcast_input){self.clearForm();$(this).val('');}});$(document).on('keydown','#location-search',function(e){arrowKeyEvent(e);return;});$('#location-box .save-button').click(function(event){event.preventDefault();var isEdit=false,pos,purl;if($('#location-box .friendly-name-input').is(':visible')){isEdit=true;pos=$('.edit-pos').val()-1;if(typeof newLocation.placeCode=='undefined'){var myloc=mylocations.getLocations();var editData=myloc[pos];newLocation=myloc[pos];}
if(typeof newLocation.placeCode!='undefined'){newLocation.friendlyName=($('#location-box .friendly-name-input').val()==nicknameTxt)?'':$('#location-box .friendly-name-input').val();}}
if(typeof newLocation.placeCode=='undefined'){$('.location-search-error').text($('.search-error').val()).show();return false;}
if(isEdit){mylocations.update(newLocation,pos);}else{mylocations.update(newLocation);}
var pointcastVars=(newLocation.postCode)?'/'+newLocation.postCode+'/'+newLocation.gridIndex:'';setTimeout(function(){if(isEdit==true){dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':'clicks','eventLabel':"renameLocation"});var tname,pname,sname,provCountry,editT;tname=newLocation.friendlyName;provCountry=(newLocation.province=='')?newLocation.countryName:newLocation.province;pname=" ("+newLocation.city+', '+provCountry+")";tname=tname||newLocation.postCode;tname=tname||(newLocation.city+', '+provCountry);sname=newLocation.city+', '+provCountry+' '+(newLocation.postCode||'');if(!newLocation.friendlyName&&!newLocation.postCode){pname="";}
editT=tname+pname;purl=self.getLocationUrl(newLocation.locationType.toLowerCase());$('#location-box .friendly-name-wrapper').hide();$('#locale_'+(pos+1)).children('h3').html('').append($('<a/>',{href:purl+newLocation.placeCode.toLowerCase()+pointcastVars,text:tname}).append($('<span/>',{text:pname})));$('#locale_'+(pos+1)).attr('name',sname);$('#locale_'+(pos+1)+' .edit').attr('title','Edit '+editT);$('#locale_'+(pos+1)).attr('fname',newLocation.friendlyName);$('#locale_'+(pos+1)).children('h3').removeClass('pointcast_image');if(newLocation.postCode!='undefined'&&newLocation.postCode!=''){$('#locale_'+(pos+1)).children('h3').addClass('pointcast_image');}
$('.edit-pos').val('');newLocation={};selectedLoc='';$('#overlay-mask, .overlay-window').fadeOut();}else{dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':'clicks','eventLabel':"addLocationSaveBtn"});var u=config.citypage;if(typeof newLocation.locationType!='undefined'){u=self.getLocationUrl(newLocation.locationType)}
if(window._config.isEditLocations===true){window.location.reload();}else{window.location.replace(u+newLocation.placeCode.toLowerCase()+pointcastVars);}}
return false;},2000);});};return self;});return locationSearch();});;