define(['session','jquery'],function(session,$){var countrySelection=(function(){var defaultFlag='ca';var defaultLang='';if(typeof(window._config.locale)!=='undefined'&&typeof window._config.locale==='string'){var locale=window._config.locale.split("_");defaultFlag=locale[1].toLowerCase();defaultLang=locale[0].toLowerCase();}
var country='',keyvalue=[],boxClicked=false,canRemember=true,domainlang,domainrm,domainredirecturl,domain,sub,_saved_country=null,domain_name_array=(typeof window._config.domain_redirect_json=='undefined'||typeof window._config.locale!=='string')?null:JSON.parse(window._config.domain_redirect_json),locale=window._config.locale+"",splitUrl=window.location.hostname.split('.'),domain=splitUrl[1]+'.'+splitUrl[2],sub=splitUrl[0]+'.';if((country.toLowerCase()=="ca"||country.toLowerCase()=="gb")&&sub.indexOf("-us")!==-1){sub=sub.replace("-us","");}
if(splitUrl[1]=='dqs'){domain=splitUrl[2]+'.'+splitUrl[3];sub+=splitUrl[1]+'.';}
self.init=function(){session.save_cookie("pelm_user_domain_temp",locale);var scountry=self.checkSavedSelection();if(typeof scountry.country!='undefined'){}
if($('.country-list a[id='+defaultFlag.toUpperCase()+']')&&$('.country-list a[id='+defaultFlag.toUpperCase()+']').attr('data-rem')=='true'){}
window.user_countrycode_url=self.getSavedCountryCode();if(window.user_countrycode_url){window.user_countrycode_url='/'+window.user_countrycode_url;}
$('.user_domain_countrycode').each(function(e){if($(this).attr('href')){$(this).attr('href',self.addSavedCountryCodeUrl($(this).attr('href')));}});var img=$('<img />',{src:window._config.image_url+'icons/flags/all/16/'+defaultFlag.toLowerCase()+'.png',alt:''}).addClass('flag');var imga=$('<img />',{src:window._config.image_url+'icon-arrow-down-blue.png',alt:''});var spnLang=$('<span />').html(defaultLang.toUpperCase());$('.link-flag').append(img);$('.link-flag').append(spnLang);if(typeof window._config.isNitroHeader!=="undefined"&&window._config.isNitroHeader){var icnLang=$('<i />').addClass('icon-gear').html('');$('.link-flag').append(icnLang);}
self.bindElements();self.save_domain_preferences();};self.checkSavedSelection=function(){var saved_country=self.getSavedCountry();if(typeof saved_country.country!='undefined'){defaultFlag=saved_country.country;}
if($('#top_myaccount').length){var url_my_account=$('#top_myaccount').attr('href');url_my_account=url_my_account.replace(/^\//,"");$('#top_myaccount').attr('href','/'+url_my_account);}
var c=defaultFlag;var langOptions=$('.country-list a[id='+c.toUpperCase()+']').attr('data-url');var dlang=defaultLang;self.modifyLanguageSelection(langOptions);if(typeof saved_country.language!='undefined'){dlang=saved_country.language;}
$("#ddl_lang").val(dlang);return saved_country;};self.modifyLanguageSelection=function(data){var ddllist='',obj,len,i;var jdata=data||[];obj=$.parseJSON(jdata)||[];len=obj.length;for(i=0;i<len;i++){keyvalue[obj[i]["code"]]=obj[i]["url"];ddllist+="<option value='"+obj[i]["code"]+"'>"+obj[i]["name"]+"</option>";}
$("#ddl_lang").html(ddllist);var saved_country=self.getSavedCountry();if(typeof saved_country.language!='undefined'){$("#ddl_lang").val(saved_country.language);}};self.getSavedData=function(key){var val=session.fld(key);if(!val||val==null){return false;}
if(val&&val.indexOf('{')>=0||val.indexOf('[')>=0){val=JSON.parse(val);}
return val;};self.getSavedCountry=function(){if(_saved_country!=null){return _saved_country;}
var saved_country=session.fld('pelm_country_selection'),country_code=null;if(saved_country==null||saved_country=="null"||saved_country=="undefined"){saved_country=self.getSavedData('pelm_country_selection_temp');}else{saved_country=self.getSavedData('pelm_country_selection');}
_saved_country=saved_country;return saved_country;};self.getSavedCountryCode=function(){var country_code=null,saved_country=self.getSavedCountry();if(saved_country&&typeof saved_country.country!='undefined'){country_code=saved_country.country;if(country_code=='gb'){country_code='uk';}}
return country_code;};self.addSavedCountryCodeUrl=function(url){var country_code=self.getSavedCountryCode();if(country_code){if(country_code=='ca'){url='/'+(self.stripCountryCodeUrl(url)).replace(/^\//,'');}else{url='/'+country_code+'/'+(self.stripCountryCodeUrl(url)).replace(/^\//,'');}}
return url;};self.stripCountryCodeUrl=function(urlstr){var purl=urlstr||'';var countrycode=/^[A-z]{2}$/g;var split_url=purl.split("/");if((typeof split_url[0]!=="undefined"||split_url[0]!=="")&&(split_url[0].match(countrycode))||(typeof split_url[1]!=="undefined"||split_url[1]!=="")&&(split_url[1]&&split_url[1].match(countrycode))){var rurl=(split_url[0].match(countrycode))?split_url[0]:split_url[1];purl=purl.replace('/'+rurl+'/','/');}
return purl;};self.save_domain_preferences=function(){var saved_domain=session.fld('pelm_user_domain');if(saved_domain&&saved_domain.indexOf('de')!==-1&&window.location.hostname.indexOf('wetterplus.de')==-1){saved_domain=null;}
if(saved_domain==null||saved_domain=="null"||saved_domain=="undefined"){var currentdomain=window.location.hostname;currentdomain=(currentdomain).replace(sub,'');var currentcountry,currentlang;var localearray=locale.split("_");currentcountry=localearray[1].toLowerCase();currentlang=localearray[0].toLowerCase();if(typeof window._config.url_dedupe_enabled=='undefined'||window._config.url_dedupe_enabled==false){var pelm_user_domain=currentlang+'_'+currentcountry;session.save_cookie('pelm_user_domain',pelm_user_domain);var domainrm=true;var expiryvalue=1;cookie_value=currentcountry+'-'+currentlang+'-'+domainrm+'-'+currentdomain;var ifm=$('<iframe />').attr({'src':'//'+sub+currentdomain+'/countryselection/preference/pelm_country_selection/'+cookie_value+'/'+expiryvalue,'width':'0','height':'0'}).addClass('temp-frame').hide();$('body').append(ifm);}else if(domain_name_array){$.each(domain_name_array,function(i,d){var domainrm=true;var expiryvalue=1;cookie_value=currentcountry+'-'+currentlang+'-'+domainrm+'-'+currentdomain;var runiframe=false;if(currentlang=='fr'&&currentdomain.indexOf('meteomedia')>-1){runiframe=true;}
else if(currentlang=='en'&&currentdomain.indexOf('theweathernetwork')>-1){runiframe=true;}
if(runiframe){var ifm=$('<iframe />').attr({'src':'//'+sub+d+'/countryselection/preference/pelm_country_selection/'+cookie_value+'/'+expiryvalue,'width':'0','height':'0'}).addClass('temp-frame').hide();$('body').append(ifm);}});}}}
self.bindElements=function(){$('li .link-flag').click(function(){country='',keyvalue=[],boxClicked=false;var src=$(this).find('.flag').attr('src');country=src.substring(src.lastIndexOf('/')+1,src.lastIndexOf('.'))||defaultFlag;self.checkSavedSelection();var saved_user_country=self.getSavedCountry();if(saved_user_country){dataLayer.push({'event':'eventTracker','eventCategory':window._config.ga_product,'eventAction':"clicks",'eventLabel':'countryselect | '+saved_user_country.country});}});$("a.popuplink").click(function(e){$('.country-list li').removeClass('selected-country');$(this).parent().addClass('selected-country');data_url_json=$(this).attr("data-url");data_url=JSON.parse(data_url_json);lang=data_url[0]['code'];redirecturl=data_url[0]['url'];country=$(this).attr("id");self.modifyLanguageSelection($(this).attr("data-url"));$('.country-list').find('.loading').remove();$(this).parent().append('<img src="'+window._config.image_url+'/loading_web.gif" class="loading" style="vertical-align: top;" />');submitform(e);return false;});var submitform=function(e){e.preventDefault();boxClicked=true;var cookie_value=null,expiry='',cdomain='';if(boxClicked){var rm=false;cdomain='; domain='+escape('.'+redirecturl);var d=new Date();d.setTime(d.getTime()+(20*365*86400000));expiry=d.toGMTString();rm=true;cookie_value=JSON.stringify({'country':country,'language':lang,'rm':rm,'d':redirecturl});domainlang=lang.toLowerCase();domainrm=rm;domainredirecturl=sub+redirecturl;if(domain_name_array){$.each(domain_name_array,function(i,d){expiryvalue=0;if(domainrm==true){expiryvalue=1;}
var domainname=d+"";var cookie_domain=redirecturl;var tc=country.toLowerCase().split('-');tc=tc[0];cookie_value=tc+'-'+domainlang+'-'+domainrm+'-'+cookie_domain;var runiframe=false;if(domainlang=='fr'&&domainname.indexOf('meteomedia')>-1){runiframe=true;}
else if(domainlang=='en'&&domainname.indexOf('theweathernetwork')>-1){runiframe=true;}
if(runiframe){var ifm=$('<iframe />').attr({'src':'//'+sub+domainname+'/countryselection/preference/pelm_country_selection/'+cookie_value+'/'+expiryvalue,'width':'0','height':'0'}).addClass('temp-frame').hide();$('body').append(ifm);}});}
setTimeout(function(){if(domainredirecturl!=''&&domain!=domainredirecturl){domainredirecturl=domainredirecturl.replace('%2F','/');if(domainrm=="true"){domainredirecturl=domainredirecturl+"/?csref=true";}
window.location.replace('http://'+domainredirecturl);return false;}
$('.link-flag .flag').attr('src',window._config.image_url+'icons/flags/all/16/'+country.toLowerCase()+'.png');boxClicked=false;$('#overlay-mask, .overlay-window').fadeOut();$('.temp-frame').remove();},3000);}else{domainredirecturl=sub+redirecturl;window.location.replace('http://'+domainredirecturl);return false;}};};return self;});return countrySelection();});;