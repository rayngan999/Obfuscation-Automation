(function(root,factory){if(typeof define==='function'&&define.amd){define(['underscore','jquery','exports'],function(_,$,exports){root.Backbone=factory(root,exports,_,$);});}else if(typeof exports!=='undefined'){var _=require('underscore');factory(root,exports,_);}else{root.Backbone=factory(root,{},root._,(root.jQuery||root.Zepto||root.ender||root.$));}}(this,function(root,Backbone,_,$){var previousBackbone=root.Backbone;var array=[];var push=array.push;var slice=array.slice;var splice=array.splice;Backbone.VERSION='1.1.2';Backbone.$=$;Backbone.noConflict=function(){root.Backbone=previousBackbone;return this;};Backbone.emulateHTTP=false;Backbone.emulateJSON=false;var Events=Backbone.Events={on:function(name,callback,context){if(!eventsApi(this,'on',name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);events.push({callback:callback,context:context,ctx:context||this});return this;},once:function(name,callback,context){if(!eventsApi(this,'once',name,[callback,context])||!callback)return this;var self=this;var once=_.once(function(){self.off(name,once);callback.apply(this,arguments);});once._callback=callback;return this.on(name,once,context);},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,'off',name,[callback,context]))return this;if(!name&&!callback&&!context){this._events=void 0;return this;}
names=name?[name]:_.keys(this._events);for(i=0,l=names.length;i<l;i++){name=names[i];if(events=this._events[name]){this._events[name]=retain=[];if(callback||context){for(j=0,k=events.length;j<k;j++){ev=events[j];if((callback&&callback!==ev.callback&&callback!==ev.callback._callback)||(context&&context!==ev.context)){retain.push(ev);}}}
if(!retain.length)delete this._events[name];}}
return this;},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,'trigger',name,args))return this;var events=this._events[name];var allEvents=this._events.all;if(events)triggerEvents(events,args);if(allEvents)triggerEvents(allEvents,arguments);return this;},stopListening:function(obj,name,callback){var listeningTo=this._listeningTo;if(!listeningTo)return this;var remove=!name&&!callback;if(!callback&&typeof name==='object')callback=this;if(obj)(listeningTo={})[obj._listenId]=obj;for(var id in listeningTo){obj=listeningTo[id];obj.off(name,callback,this);if(remove||_.isEmpty(obj._events))delete this._listeningTo[id];}
return this;}};var eventSplitter=/\s+/;var eventsApi=function(obj,action,name,rest){if(!name)return true;if(typeof name==='object'){for(var key in name){obj[action].apply(obj,[key,name[key]].concat(rest));}
return false;}
if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){obj[action].apply(obj,[names[i]].concat(rest));}
return false;}
return true;};var triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:while(++i<l)(ev=events[i]).callback.call(ev.ctx);return;case 1:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:while(++i<l)(ev=events[i]).callback.apply(ev.ctx,args);return;}};var listenMethods={listenTo:'on',listenToOnce:'once'};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeningTo=this._listeningTo||(this._listeningTo={});var id=obj._listenId||(obj._listenId=_.uniqueId('l'));listeningTo[id]=obj;if(!callback&&typeof name==='object')callback=this;obj[implementation](name,callback,this);return this;};});Events.bind=Events.on;Events.unbind=Events.off;_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var attrs=attributes||{};options||(options={});this.cid=_.uniqueId('c');this.attributes={};if(options.collection)this.collection=options.collection;if(options.parse)attrs=this.parse(attrs,options)||{};attrs=_.defaults({},attrs,_.result(this,'defaults'));this.set(attrs,options);this.changed={};this.initialize.apply(this,arguments);};_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:'id',initialize:function(){},toJSON:function(options){return _.clone(this.attributes);},sync:function(){return Backbone.sync.apply(this,arguments);},get:function(attr){return this.attributes[attr];},escape:function(attr){return _.escape(this.get(attr));},has:function(attr){return this.get(attr)!=null;},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(key==null)return this;if(typeof key==='object'){attrs=key;options=val;}else{(attrs={})[key]=val;}
options||(options={});if(!this._validate(attrs,options))return false;unset=options.unset;silent=options.silent;changes=[];changing=this._changing;this._changing=true;if(!changing){this._previousAttributes=_.clone(this.attributes);this.changed={};}
current=this.attributes,prev=this._previousAttributes;if(this.idAttribute in attrs)this.id=attrs[this.idAttribute];for(attr in attrs){val=attrs[attr];if(!_.isEqual(current[attr],val))changes.push(attr);if(!_.isEqual(prev[attr],val)){this.changed[attr]=val;}else{delete this.changed[attr];}
unset?delete current[attr]:current[attr]=val;}
if(!silent){if(changes.length)this._pending=options;for(var i=0,l=changes.length;i<l;i++){this.trigger('change:'+changes[i],this,current[changes[i]],options);}}
if(changing)return this;if(!silent){while(this._pending){options=this._pending;this._pending=false;this.trigger('change',this,options);}}
this._pending=false;this._changing=false;return this;},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:true}));},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:true}));},hasChanged:function(attr){if(attr==null)return!_.isEmpty(this.changed);return _.has(this.changed,attr);},changedAttributes:function(diff){if(!diff)return this.hasChanged()?_.clone(this.changed):false;var val,changed=false;var old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff){if(_.isEqual(old[attr],(val=diff[attr])))continue;(changed||(changed={}))[attr]=val;}
return changed;},previous:function(attr){if(attr==null||!this._previousAttributes)return null;return this._previousAttributes[attr];},previousAttributes:function(){return _.clone(this._previousAttributes);},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){if(!model.set(model.parse(resp,options),options))return false;if(success)success(model,resp,options);model.trigger('sync',model,resp,options);};wrapError(this,options);return this.sync('read',this,options);},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(key==null||typeof key==='object'){attrs=key;options=val;}else{(attrs={})[key]=val;}
options=_.extend({validate:true},options);if(attrs&&!options.wait){if(!this.set(attrs,options))return false;}else{if(!this._validate(attrs,options))return false;}
if(attrs&&options.wait){this.attributes=_.extend({},attributes,attrs);}
if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);if(options.wait)serverAttrs=_.extend(attrs||{},serverAttrs);if(_.isObject(serverAttrs)&&!model.set(serverAttrs,options)){return false;}
if(success)success(model,resp,options);model.trigger('sync',model,resp,options);};wrapError(this,options);method=this.isNew()?'create':(options.patch?'patch':'update');if(method==='patch')options.attrs=attrs;xhr=this.sync(method,this,options);if(attrs&&options.wait)this.attributes=attributes;return xhr;},destroy:function(options){options=options?_.clone(options):{};var model=this;var success=options.success;var destroy=function(){model.trigger('destroy',model,model.collection,options);};options.success=function(resp){if(options.wait||model.isNew())destroy();if(success)success(model,resp,options);if(!model.isNew())model.trigger('sync',model,resp,options);};if(this.isNew()){options.success();return false;}
wrapError(this,options);var xhr=this.sync('delete',this,options);if(!options.wait)destroy();return xhr;},url:function(){var base=_.result(this,'urlRoot')||_.result(this.collection,'url')||urlError();if(this.isNew())return base;return base.replace(/([^\/])$/,'$1/')+encodeURIComponent(this.id);},parse:function(resp,options){return resp;},clone:function(){return new this.constructor(this.attributes);},isNew:function(){return!this.has(this.idAttribute);},isValid:function(options){return this._validate({},_.extend(options||{},{validate:true}));},_validate:function(attrs,options){if(!options.validate||!this.validate)return true;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;if(!error)return true;this.trigger('invalid',this,error,_.extend(options,{validationError:error}));return false;}});var modelMethods=['keys','values','pairs','invert','pick','omit'];_.each(modelMethods,function(method){Model.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.attributes);return _[method].apply(_,args);};});var Collection=Backbone.Collection=function(models,options){options||(options={});if(options.model)this.model=options.model;if(options.comparator!==void 0)this.comparator=options.comparator;this._reset();this.initialize.apply(this,arguments);if(models)this.reset(models,_.extend({silent:true},options));};var setOptions={add:true,remove:true,merge:true};var addOptions={add:true,remove:false};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options);});},sync:function(){return Backbone.sync.apply(this,arguments);},add:function(models,options){return this.set(models,_.extend({merge:false},options,addOptions));},remove:function(models,options){var singular=!_.isArray(models);models=singular?[models]:_.clone(models);options||(options={});var i,l,index,model;for(i=0,l=models.length;i<l;i++){model=models[i]=this.get(models[i]);if(!model)continue;delete this._byId[model.id];delete this._byId[model.cid];index=this.indexOf(model);this.models.splice(index,1);this.length--;if(!options.silent){options.index=index;model.trigger('remove',model,this,options);}
this._removeReference(model,options);}
return singular?models[0]:models;},set:function(models,options){options=_.defaults({},options,setOptions);if(options.parse)models=this.parse(models,options);var singular=!_.isArray(models);models=singular?(models?[models]:[]):_.clone(models);var i,l,id,model,attrs,existing,sort;var at=options.at;var targetModel=this.model;var sortable=this.comparator&&(at==null)&&options.sort!==false;var sortAttr=_.isString(this.comparator)?this.comparator:null;var toAdd=[],toRemove=[],modelMap={};var add=options.add,merge=options.merge,remove=options.remove;var order=!sortable&&add&&remove?[]:false;for(i=0,l=models.length;i<l;i++){attrs=models[i]||{};if(attrs instanceof Model){id=model=attrs;}else{id=attrs[targetModel.prototype.idAttribute||'id'];}
if(existing=this.get(id)){if(remove)modelMap[existing.cid]=true;if(merge){attrs=attrs===model?model.attributes:attrs;if(options.parse)attrs=existing.parse(attrs,options);existing.set(attrs,options);if(sortable&&!sort&&existing.hasChanged(sortAttr))sort=true;}
models[i]=existing;}else if(add){model=models[i]=this._prepareModel(attrs,options);if(!model)continue;toAdd.push(model);this._addReference(model,options);}
model=existing||model;if(order&&(model.isNew()||!modelMap[model.id]))order.push(model);modelMap[model.id]=true;}
if(remove){for(i=0,l=this.length;i<l;++i){if(!modelMap[(model=this.models[i]).cid])toRemove.push(model);}
if(toRemove.length)this.remove(toRemove,options);}
if(toAdd.length||(order&&order.length)){if(sortable)sort=true;this.length+=toAdd.length;if(at!=null){for(i=0,l=toAdd.length;i<l;i++){this.models.splice(at+i,0,toAdd[i]);}}else{if(order)this.models.length=0;var orderedModels=order||toAdd;for(i=0,l=orderedModels.length;i<l;i++){this.models.push(orderedModels[i]);}}}
if(sort)this.sort({silent:true});if(!options.silent){for(i=0,l=toAdd.length;i<l;i++){(model=toAdd[i]).trigger('add',model,this,options);}
if(sort||(order&&order.length))this.trigger('sort',this,options);}
return singular?models[0]:models;},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;i<l;i++){this._removeReference(this.models[i],options);}
options.previousModels=this.models;this._reset();models=this.add(models,_.extend({silent:true},options));if(!options.silent)this.trigger('reset',this,options);return models;},push:function(model,options){return this.add(model,_.extend({at:this.length},options));},pop:function(options){var model=this.at(this.length-1);this.remove(model,options);return model;},unshift:function(model,options){return this.add(model,_.extend({at:0},options));},shift:function(options){var model=this.at(0);this.remove(model,options);return model;},slice:function(){return slice.apply(this.models,arguments);},get:function(obj){if(obj==null)return void 0;return this._byId[obj]||this._byId[obj.id]||this._byId[obj.cid];},at:function(index){return this.models[index];},where:function(attrs,first){if(_.isEmpty(attrs))return first?void 0:[];return this[first?'find':'filter'](function(model){for(var key in attrs){if(attrs[key]!==model.get(key))return false;}
return true;});},findWhere:function(attrs){return this.where(attrs,true);},sort:function(options){if(!this.comparator)throw new Error('Cannot sort a set without a comparator');options||(options={});if(_.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this);}else{this.models.sort(_.bind(this.comparator,this));}
if(!options.silent)this.trigger('sort',this,options);return this;},pluck:function(attr){return _.invoke(this.models,'get',attr);},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var success=options.success;var collection=this;options.success=function(resp){var method=options.reset?'reset':'set';collection[method](resp,options);if(success)success(collection,resp,options);collection.trigger('sync',collection,resp,options);};wrapError(this,options);return this.sync('read',this,options);},create:function(model,options){options=options?_.clone(options):{};if(!(model=this._prepareModel(model,options)))return false;if(!options.wait)this.add(model,options);var collection=this;var success=options.success;options.success=function(model,resp){if(options.wait)collection.add(model,options);if(success)success(model,resp,options);};model.save(null,options);return model;},parse:function(resp,options){return resp;},clone:function(){return new this.constructor(this.models);},_reset:function(){this.length=0;this.models=[];this._byId={};},_prepareModel:function(attrs,options){if(attrs instanceof Model)return attrs;options=options?_.clone(options):{};options.collection=this;var model=new this.model(attrs,options);if(!model.validationError)return model;this.trigger('invalid',this,model.validationError,options);return false;},_addReference:function(model,options){this._byId[model.cid]=model;if(model.id!=null)this._byId[model.id]=model;if(!model.collection)model.collection=this;model.on('all',this._onModelEvent,this);},_removeReference:function(model,options){if(this===model.collection)delete model.collection;model.off('all',this._onModelEvent,this);},_onModelEvent:function(event,model,collection,options){if((event==='add'||event==='remove')&&collection!==this)return;if(event==='destroy')this.remove(model,options);if(model&&event==='change:'+model.idAttribute){delete this._byId[model.previous(model.idAttribute)];if(model.id!=null)this._byId[model.id]=model;}
this.trigger.apply(this,arguments);}});var methods=['forEach','each','map','collect','reduce','foldl','inject','reduceRight','foldr','find','detect','filter','select','reject','every','all','some','any','include','contains','invoke','max','min','toArray','size','first','head','take','initial','rest','tail','drop','last','without','difference','indexOf','shuffle','lastIndexOf','isEmpty','chain','sample'];_.each(methods,function(method){Collection.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.models);return _[method].apply(_,args);};});var attributeMethods=['groupBy','countBy','sortBy','indexBy'];_.each(attributeMethods,function(method){Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value);};return _[method](this.models,iterator,context);};});var View=Backbone.View=function(options){this.cid=_.uniqueId('view');options||(options={});_.extend(this,_.pick(options,viewOptions));this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents();};var delegateEventSplitter=/^(\S+)\s*(.*)$/;var viewOptions=['model','collection','el','id','attributes','className','tagName','events'];_.extend(View.prototype,Events,{tagName:'div',$:function(selector){return this.$el.find(selector);},initialize:function(){},render:function(){return this;},remove:function(){this.$el.remove();this.stopListening();return this;},setElement:function(element,delegate){if(this.$el)this.undelegateEvents();this.$el=element instanceof Backbone.$?element:Backbone.$(element);this.el=this.$el[0];if(delegate!==false)this.delegateEvents();return this;},delegateEvents:function(events){if(!(events||(events=_.result(this,'events'))))return this;this.undelegateEvents();for(var key in events){var method=events[key];if(!_.isFunction(method))method=this[events[key]];if(!method)continue;var match=key.match(delegateEventSplitter);var eventName=match[1],selector=match[2];method=_.bind(method,this);eventName+='.delegateEvents'+this.cid;if(selector===''){this.$el.on(eventName,method);}else{this.$el.on(eventName,selector,method);}}
return this;},undelegateEvents:function(){this.$el.off('.delegateEvents'+this.cid);return this;},_ensureElement:function(){if(!this.el){var attrs=_.extend({},_.result(this,'attributes'));if(this.id)attrs.id=_.result(this,'id');if(this.className)attrs['class']=_.result(this,'className');var $el=Backbone.$('<'+_.result(this,'tagName')+'>').attr(attrs);this.setElement($el,false);}else{this.setElement(_.result(this,'el'),false);}}});Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options||(options={}),{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:'json'};if(!options.url){params.url=_.result(model,'url')||urlError();}
if(options.data==null&&model&&(method==='create'||method==='update'||method==='patch')){params.contentType='application/json';params.data=JSON.stringify(options.attrs||model.toJSON(options));}
if(options.emulateJSON){params.contentType='application/x-www-form-urlencoded';params.data=params.data?{model:params.data}:{};}
if(options.emulateHTTP&&(type==='PUT'||type==='DELETE'||type==='PATCH')){params.type='POST';if(options.emulateJSON)params.data._method=type;var beforeSend=options.beforeSend;options.beforeSend=function(xhr){xhr.setRequestHeader('X-HTTP-Method-Override',type);if(beforeSend)return beforeSend.apply(this,arguments);};}
if(params.type!=='GET'&&!options.emulateJSON){params.processData=false;}
if(params.type==='PATCH'&&noXhrPatch){params.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP");};}
var xhr=options.xhr=Backbone.ajax(_.extend(params,options));model.trigger('request',model,xhr,options);return xhr;};var noXhrPatch=typeof window!=='undefined'&&!!window.ActiveXObject&&!(window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent);var methodMap={'create':'POST','update':'PUT','patch':'PATCH','delete':'DELETE','read':'GET'};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments);};var Router=Backbone.Router=function(options){options||(options={});if(options.routes)this.routes=options.routes;this._bindRoutes();this.initialize.apply(this,arguments);};var optionalParam=/\((.*?)\)/g;var namedParam=/(\(\?)?:\w+/g;var splatParam=/\*\w+/g;var escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){if(!_.isRegExp(route))route=this._routeToRegExp(route);if(_.isFunction(name)){callback=name;name='';}
if(!callback)callback=this[name];var router=this;Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);router.execute(callback,args);router.trigger.apply(router,['route:'+name].concat(args));router.trigger('route',name,args);Backbone.history.trigger('route',router,name,args);});return this;},execute:function(callback,args){if(callback)callback.apply(this,args);},navigate:function(fragment,options){Backbone.history.navigate(fragment,options);return this;},_bindRoutes:function(){if(!this.routes)return;this.routes=_.result(this,'routes');var route,routes=_.keys(this.routes);while((route=routes.pop())!=null){this.route(route,this.routes[route]);}},_routeToRegExp:function(route){route=route.replace(escapeRegExp,'\\$&').replace(optionalParam,'(?:$1)?').replace(namedParam,function(match,optional){return optional?match:'([^/?]+)';}).replace(splatParam,'([^?]*?)');return new RegExp('^'+route+'(?:\\?([\\s\\S]*))?$');},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param,i){if(i===params.length-1)return param||null;return param?decodeURIComponent(param):null;});}});var History=Backbone.History=function(){this.handlers=[];_.bindAll(this,'checkUrl');if(typeof window!=='undefined'){this.location=window.location;this.history=window.history;}};var routeStripper=/^[#\/]|\s+$/g;var rootStripper=/^\/+|\/+$/g;var isExplorer=/msie [\w.]+/;var trailingSlash=/\/$/;var pathStripper=/#.*$/;History.started=false;_.extend(History.prototype,Events,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,'$&/')===this.root;},getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:'';},getFragment:function(fragment,forcePushState){if(fragment==null){if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=decodeURI(this.location.pathname+this.location.search);var root=this.root.replace(trailingSlash,'');if(!fragment.indexOf(root))fragment=fragment.slice(root.length);}else{fragment=this.getHash();}}
return fragment.replace(routeStripper,'');},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");History.started=true;this.options=_.extend({root:'/'},this.options,options);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var fragment=this.getFragment();var docMode=document.documentMode;var oldIE=(isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7));this.root=('/'+this.root+'/').replace(rootStripper,'/');if(oldIE&&this._wantsHashChange){var frame=Backbone.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=frame.hide().appendTo('body')[0].contentWindow;this.navigate(fragment);}
if(this._hasPushState){Backbone.$(window).on('popstate',this.checkUrl);}else if(this._wantsHashChange&&('onhashchange'in window)&&!oldIE){Backbone.$(window).on('hashchange',this.checkUrl);}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval);}
this.fragment=fragment;var loc=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){this.fragment=this.getFragment(null,true);this.location.replace(this.root+'#'+this.fragment);return true;}else if(this._hasPushState&&this.atRoot()&&loc.hash){this.fragment=this.getHash().replace(routeStripper,'');this.history.replaceState({},document.title,this.root+this.fragment);}}
if(!this.options.silent)return this.loadUrl();},stop:function(){Backbone.$(window).off('popstate',this.checkUrl).off('hashchange',this.checkUrl);if(this._checkUrlInterval)clearInterval(this._checkUrlInterval);History.started=false;},route:function(route,callback){this.handlers.unshift({route:route,callback:callback});},checkUrl:function(e){var current=this.getFragment();if(current===this.fragment&&this.iframe){current=this.getFragment(this.getHash(this.iframe));}
if(current===this.fragment)return false;if(this.iframe)this.navigate(current);this.loadUrl();},loadUrl:function(fragment){fragment=this.fragment=this.getFragment(fragment);return _.any(this.handlers,function(handler){if(handler.route.test(fragment)){handler.callback(fragment);return true;}});},navigate:function(fragment,options){if(!History.started)return false;if(!options||options===true)options={trigger:!!options};var url=this.root+(fragment=this.getFragment(fragment||''));fragment=fragment.replace(pathStripper,'');if(this.fragment===fragment)return;this.fragment=fragment;if(fragment===''&&url!=='/')url=url.slice(0,-1);if(this._hasPushState){this.history[options.replace?'replaceState':'pushState']({},document.title,url);}else if(this._wantsHashChange){this._updateHash(this.location,fragment,options.replace);if(this.iframe&&(fragment!==this.getFragment(this.getHash(this.iframe)))){if(!options.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,fragment,options.replace);}}else{return this.location.assign(url);}
if(options.trigger)return this.loadUrl(fragment);},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,'');location.replace(href+'#'+fragment);}else{location.hash='#'+fragment;}}});Backbone.history=new History;var extend=function(protoProps,staticProps){var parent=this;var child;if(protoProps&&_.has(protoProps,'constructor')){child=protoProps.constructor;}else{child=function(){return parent.apply(this,arguments);};}
_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child;};Surrogate.prototype=parent.prototype;child.prototype=new Surrogate;if(protoProps)_.extend(child.prototype,protoProps);child.__super__=parent.prototype;return child;};Model.extend=Collection.extend=Router.extend=View.extend=History.extend=extend;var urlError=function(){throw new Error('A "url" property or function must be specified');};var wrapError=function(model,options){var error=options.error;options.error=function(resp){if(error)error(model,resp,options);model.trigger('error',model,resp,options);};};return Backbone;}));(function(root,factory){if(typeof define==='function'&&define.amd){define(['backbone','underscore'],function(Backbone,_){return(root.Marionette=root.Mn=factory(root,Backbone,_));});}else if(typeof exports!=='undefined'){var Backbone=require('backbone');var _=require('underscore');module.exports=factory(root,Backbone,_);}else{root.Marionette=root.Mn=factory(root,root.Backbone,root._);}}(this,function(root,Backbone,_){'use strict';(function(Backbone,_){"use strict";var previousChildViewContainer=Backbone.ChildViewContainer;Backbone.ChildViewContainer=function(Backbone,_){var Container=function(views){this._views={};this._indexByModel={};this._indexByCustom={};this._updateLength();_.each(views,this.add,this);};_.extend(Container.prototype,{add:function(view,customIndex){var viewCid=view.cid;this._views[viewCid]=view;if(view.model){this._indexByModel[view.model.cid]=viewCid;}
if(customIndex){this._indexByCustom[customIndex]=viewCid;}
this._updateLength();return this;},findByModel:function(model){return this.findByModelCid(model.cid);},findByModelCid:function(modelCid){var viewCid=this._indexByModel[modelCid];return this.findByCid(viewCid);},findByCustom:function(index){var viewCid=this._indexByCustom[index];return this.findByCid(viewCid);},findByIndex:function(index){return _.values(this._views)[index];},findByCid:function(cid){return this._views[cid];},remove:function(view){var viewCid=view.cid;if(view.model){delete this._indexByModel[view.model.cid];}
_.any(this._indexByCustom,function(cid,key){if(cid===viewCid){delete this._indexByCustom[key];return true;}},this);delete this._views[viewCid];this._updateLength();return this;},call:function(method){this.apply(method,_.tail(arguments));},apply:function(method,args){_.each(this._views,function(view){if(_.isFunction(view[method])){view[method].apply(view,args||[]);}});},_updateLength:function(){this.length=_.size(this._views);}});var methods=["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck","reduce"];_.each(methods,function(method){Container.prototype[method]=function(){var views=_.values(this._views);var args=[views].concat(_.toArray(arguments));return _[method].apply(_,args);};});return Container;}(Backbone,_);Backbone.ChildViewContainer.VERSION="0.1.6";Backbone.ChildViewContainer.noConflict=function(){Backbone.ChildViewContainer=previousChildViewContainer;return this;};return Backbone.ChildViewContainer;})(Backbone,_);(function(Backbone,_){"use strict";var previousWreqr=Backbone.Wreqr;var Wreqr=Backbone.Wreqr={};Backbone.Wreqr.VERSION="1.3.1";Backbone.Wreqr.noConflict=function(){Backbone.Wreqr=previousWreqr;return this;};Wreqr.Handlers=function(Backbone,_){"use strict";var Handlers=function(options){this.options=options;this._wreqrHandlers={};if(_.isFunction(this.initialize)){this.initialize(options);}};Handlers.extend=Backbone.Model.extend;_.extend(Handlers.prototype,Backbone.Events,{setHandlers:function(handlers){_.each(handlers,function(handler,name){var context=null;if(_.isObject(handler)&&!_.isFunction(handler)){context=handler.context;handler=handler.callback;}
this.setHandler(name,handler,context);},this);},setHandler:function(name,handler,context){var config={callback:handler,context:context};this._wreqrHandlers[name]=config;this.trigger("handler:add",name,handler,context);},hasHandler:function(name){return!!this._wreqrHandlers[name];},getHandler:function(name){var config=this._wreqrHandlers[name];if(!config){return;}
return function(){var args=Array.prototype.slice.apply(arguments);return config.callback.apply(config.context,args);};},removeHandler:function(name){delete this._wreqrHandlers[name];},removeAllHandlers:function(){this._wreqrHandlers={};}});return Handlers;}(Backbone,_);Wreqr.CommandStorage=function(){"use strict";var CommandStorage=function(options){this.options=options;this._commands={};if(_.isFunction(this.initialize)){this.initialize(options);}};_.extend(CommandStorage.prototype,Backbone.Events,{getCommands:function(commandName){var commands=this._commands[commandName];if(!commands){commands={command:commandName,instances:[]};this._commands[commandName]=commands;}
return commands;},addCommand:function(commandName,args){var command=this.getCommands(commandName);command.instances.push(args);},clearCommands:function(commandName){var command=this.getCommands(commandName);command.instances=[];}});return CommandStorage;}();Wreqr.Commands=function(Wreqr){"use strict";return Wreqr.Handlers.extend({storageType:Wreqr.CommandStorage,constructor:function(options){this.options=options||{};this._initializeStorage(this.options);this.on("handler:add",this._executeCommands,this);var args=Array.prototype.slice.call(arguments);Wreqr.Handlers.prototype.constructor.apply(this,args);},execute:function(name,args){name=arguments[0];args=Array.prototype.slice.call(arguments,1);if(this.hasHandler(name)){this.getHandler(name).apply(this,args);}else{this.storage.addCommand(name,args);}},_executeCommands:function(name,handler,context){var command=this.storage.getCommands(name);_.each(command.instances,function(args){handler.apply(context,args);});this.storage.clearCommands(name);},_initializeStorage:function(options){var storage;var StorageType=options.storageType||this.storageType;if(_.isFunction(StorageType)){storage=new StorageType();}else{storage=StorageType;}
this.storage=storage;}});}(Wreqr);Wreqr.RequestResponse=function(Wreqr){"use strict";return Wreqr.Handlers.extend({request:function(){var name=arguments[0];var args=Array.prototype.slice.call(arguments,1);if(this.hasHandler(name)){return this.getHandler(name).apply(this,args);}}});}(Wreqr);Wreqr.EventAggregator=function(Backbone,_){"use strict";var EA=function(){};EA.extend=Backbone.Model.extend;_.extend(EA.prototype,Backbone.Events);return EA;}(Backbone,_);Wreqr.Channel=function(Wreqr){"use strict";var Channel=function(channelName){this.vent=new Backbone.Wreqr.EventAggregator();this.reqres=new Backbone.Wreqr.RequestResponse();this.commands=new Backbone.Wreqr.Commands();this.channelName=channelName;};_.extend(Channel.prototype,{reset:function(){this.vent.off();this.vent.stopListening();this.reqres.removeAllHandlers();this.commands.removeAllHandlers();return this;},connectEvents:function(hash,context){this._connect("vent",hash,context);return this;},connectCommands:function(hash,context){this._connect("commands",hash,context);return this;},connectRequests:function(hash,context){this._connect("reqres",hash,context);return this;},_connect:function(type,hash,context){if(!hash){return;}
context=context||this;var method=type==="vent"?"on":"setHandler";_.each(hash,function(fn,eventName){this[type][method](eventName,_.bind(fn,context));},this);}});return Channel;}(Wreqr);Wreqr.radio=function(Wreqr){"use strict";var Radio=function(){this._channels={};this.vent={};this.commands={};this.reqres={};this._proxyMethods();};_.extend(Radio.prototype,{channel:function(channelName){if(!channelName){throw new Error("Channel must receive a name");}
return this._getChannel(channelName);},_getChannel:function(channelName){var channel=this._channels[channelName];if(!channel){channel=new Wreqr.Channel(channelName);this._channels[channelName]=channel;}
return channel;},_proxyMethods:function(){_.each(["vent","commands","reqres"],function(system){_.each(messageSystems[system],function(method){this[system][method]=proxyMethod(this,system,method);},this);},this);}});var messageSystems={vent:["on","off","trigger","once","stopListening","listenTo","listenToOnce"],commands:["execute","setHandler","setHandlers","removeHandler","removeAllHandlers"],reqres:["request","setHandler","setHandlers","removeHandler","removeAllHandlers"]};var proxyMethod=function(radio,system,method){return function(channelName){var messageSystem=radio._getChannel(channelName)[system];var args=Array.prototype.slice.call(arguments,1);return messageSystem[method].apply(messageSystem,args);};};return new Radio();}(Wreqr);return Backbone.Wreqr;})(Backbone,_);var previousMarionette=root.Marionette;var previousMn=root.Mn;var Marionette=Backbone.Marionette={};Marionette.VERSION='2.4.1';Marionette.noConflict=function(){root.Marionette=previousMarionette;root.Mn=previousMn;return this;};Backbone.Marionette=Marionette;Marionette.Deferred=Backbone.$.Deferred;Marionette.extend=Backbone.Model.extend;Marionette.isNodeAttached=function(el){return Backbone.$.contains(document.documentElement,el);};Marionette.mergeOptions=function(options,keys){if(!options){return;}
_.extend(this,_.pick(options,keys));};Marionette.getOption=function(target,optionName){if(!target||!optionName){return;}
if(target.options&&(target.options[optionName]!==undefined)){return target.options[optionName];}else{return target[optionName];}};Marionette.proxyGetOption=function(optionName){return Marionette.getOption(this,optionName);};Marionette._getValue=function(value,context,params){if(_.isFunction(value)){value=params?value.apply(context,params):value.call(context);}
return value;};Marionette.normalizeMethods=function(hash){return _.reduce(hash,function(normalizedHash,method,name){if(!_.isFunction(method)){method=this[method];}
if(method){normalizedHash[name]=method;}
return normalizedHash;},{},this);};Marionette.normalizeUIString=function(uiString,ui){return uiString.replace(/@ui\.[a-zA-Z_$0-9]*/g,function(r){return ui[r.slice(4)];});};Marionette.normalizeUIKeys=function(hash,ui){return _.reduce(hash,function(memo,val,key){var normalizedKey=Marionette.normalizeUIString(key,ui);memo[normalizedKey]=val;return memo;},{});};Marionette.normalizeUIValues=function(hash,ui,properties){_.each(hash,function(val,key){if(_.isString(val)){hash[key]=Marionette.normalizeUIString(val,ui);}else if(_.isObject(val)&&_.isArray(properties)){_.extend(val,Marionette.normalizeUIValues(_.pick(val,properties),ui));_.each(properties,function(property){var propertyVal=val[property];if(_.isString(propertyVal)){val[property]=Marionette.normalizeUIString(propertyVal,ui);}});}});return hash;};Marionette.actAsCollection=function(object,listProperty){var methods=['forEach','each','map','find','detect','filter','select','reject','every','all','some','any','include','contains','invoke','toArray','first','initial','rest','last','without','isEmpty','pluck'];_.each(methods,function(method){object[method]=function(){var list=_.values(_.result(this,listProperty));var args=[list].concat(_.toArray(arguments));return _[method].apply(_,args);};});};var deprecate=Marionette.deprecate=function(message,test){if(_.isObject(message)){message=(message.prev+' is going to be removed in the future. '+'Please use '+message.next+' instead.'+
(message.url?' See: '+message.url:''));}
if((test===undefined||!test)&&!deprecate._cache[message]){deprecate._warn('Deprecation warning: '+message);deprecate._cache[message]=true;}};deprecate._warn=typeof console!=='undefined'&&(console.warn||console.log)||function(){};deprecate._cache={};Marionette._triggerMethod=(function(){var splitter=/(^|:)(\w)/gi;function getEventName(match,prefix,eventName){return eventName.toUpperCase();}
return function(context,event,args){var noEventArg=arguments.length<3;if(noEventArg){args=event;event=args[0];}
var methodName='on'+event.replace(splitter,getEventName);var method=context[methodName];var result;if(_.isFunction(method)){result=method.apply(context,noEventArg?_.rest(args):args);}
if(_.isFunction(context.trigger)){if(noEventArg+args.length>1){context.trigger.apply(context,noEventArg?args:[event].concat(_.drop(args,0)));}else{context.trigger(event);}}
return result;};})();Marionette.triggerMethod=function(event){return Marionette._triggerMethod(this,arguments);};Marionette.triggerMethodOn=function(context){var fnc=_.isFunction(context.triggerMethod)?context.triggerMethod:Marionette.triggerMethod;return fnc.apply(context,_.rest(arguments));};Marionette.MonitorDOMRefresh=function(view){function handleShow(){view._isShown=true;triggerDOMRefresh();}
function handleRender(){view._isRendered=true;triggerDOMRefresh();}
function triggerDOMRefresh(){if(view._isShown&&view._isRendered&&Marionette.isNodeAttached(view.el)){if(_.isFunction(view.triggerMethod)){view.triggerMethod('dom:refresh');}}}
view.on({show:handleShow,render:handleRender});};(function(Marionette){'use strict';function bindFromStrings(target,entity,evt,methods){var methodNames=methods.split(/\s+/);_.each(methodNames,function(methodName){var method=target[methodName];if(!method){throw new Marionette.Error('Method "'+methodName+'" was configured as an event handler, but does not exist.');}
target.listenTo(entity,evt,method);});}
function bindToFunction(target,entity,evt,method){target.listenTo(entity,evt,method);}
function unbindFromStrings(target,entity,evt,methods){var methodNames=methods.split(/\s+/);_.each(methodNames,function(methodName){var method=target[methodName];target.stopListening(entity,evt,method);});}
function unbindToFunction(target,entity,evt,method){target.stopListening(entity,evt,method);}
function iterateEvents(target,entity,bindings,functionCallback,stringCallback){if(!entity||!bindings){return;}
if(!_.isObject(bindings)){throw new Marionette.Error({message:'Bindings must be an object or function.',url:'marionette.functions.html#marionettebindentityevents'});}
bindings=Marionette._getValue(bindings,target);_.each(bindings,function(methods,evt){if(_.isFunction(methods)){functionCallback(target,entity,evt,methods);}else{stringCallback(target,entity,evt,methods);}});}
Marionette.bindEntityEvents=function(target,entity,bindings){iterateEvents(target,entity,bindings,bindToFunction,bindFromStrings);};Marionette.unbindEntityEvents=function(target,entity,bindings){iterateEvents(target,entity,bindings,unbindToFunction,unbindFromStrings);};Marionette.proxyBindEntityEvents=function(entity,bindings){return Marionette.bindEntityEvents(this,entity,bindings);};Marionette.proxyUnbindEntityEvents=function(entity,bindings){return Marionette.unbindEntityEvents(this,entity,bindings);};})(Marionette);var errorProps=['description','fileName','lineNumber','name','message','number'];Marionette.Error=Marionette.extend.call(Error,{urlRoot:'http://marionettejs.com/docs/v'+Marionette.VERSION+'/',constructor:function(message,options){if(_.isObject(message)){options=message;message=options.message;}else if(!options){options={};}
var error=Error.call(this,message);_.extend(this,_.pick(error,errorProps),_.pick(options,errorProps));this.captureStackTrace();if(options.url){this.url=this.urlRoot+options.url;}},captureStackTrace:function(){if(Error.captureStackTrace){Error.captureStackTrace(this,Marionette.Error);}},toString:function(){return this.name+': '+this.message+(this.url?' See: '+this.url:'');}});Marionette.Error.extend=Marionette.extend;Marionette.Callbacks=function(){this._deferred=Marionette.Deferred();this._callbacks=[];};_.extend(Marionette.Callbacks.prototype,{add:function(callback,contextOverride){var promise=_.result(this._deferred,'promise');this._callbacks.push({cb:callback,ctx:contextOverride});promise.then(function(args){if(contextOverride){args.context=contextOverride;}
callback.call(args.context,args.options);});},run:function(options,context){this._deferred.resolve({options:options,context:context});},reset:function(){var callbacks=this._callbacks;this._deferred=Marionette.Deferred();this._callbacks=[];_.each(callbacks,function(cb){this.add(cb.cb,cb.ctx);},this);}});Marionette.Controller=function(options){this.options=options||{};if(_.isFunction(this.initialize)){this.initialize(this.options);}};Marionette.Controller.extend=Marionette.extend;_.extend(Marionette.Controller.prototype,Backbone.Events,{destroy:function(){Marionette._triggerMethod(this,'before:destroy',arguments);Marionette._triggerMethod(this,'destroy',arguments);this.stopListening();this.off();return this;},triggerMethod:Marionette.triggerMethod,mergeOptions:Marionette.mergeOptions,getOption:Marionette.proxyGetOption});Marionette.Object=function(options){this.options=_.extend({},_.result(this,'options'),options);this.initialize.apply(this,arguments);};Marionette.Object.extend=Marionette.extend;_.extend(Marionette.Object.prototype,Backbone.Events,{initialize:function(){},destroy:function(){this.triggerMethod('before:destroy');this.triggerMethod('destroy');this.stopListening();return this;},triggerMethod:Marionette.triggerMethod,mergeOptions:Marionette.mergeOptions,getOption:Marionette.proxyGetOption,bindEntityEvents:Marionette.proxyBindEntityEvents,unbindEntityEvents:Marionette.proxyUnbindEntityEvents});Marionette.Region=Marionette.Object.extend({constructor:function(options){this.options=options||{};this.el=this.getOption('el');this.el=this.el instanceof Backbone.$?this.el[0]:this.el;if(!this.el){throw new Marionette.Error({name:'NoElError',message:'An "el" must be specified for a region.'});}
this.$el=this.getEl(this.el);Marionette.Object.call(this,options);},show:function(view,options){if(!this._ensureElement()){return;}
this._ensureViewIsIntact(view);var showOptions=options||{};var isDifferentView=view!==this.currentView;var preventDestroy=!!showOptions.preventDestroy;var forceShow=!!showOptions.forceShow;var isChangingView=!!this.currentView;var _shouldDestroyView=isDifferentView&&!preventDestroy;var _shouldShowView=isDifferentView||forceShow;if(isChangingView){this.triggerMethod('before:swapOut',this.currentView,this,options);}
if(this.currentView){delete this.currentView._parent;}
if(_shouldDestroyView){this.empty();}else if(isChangingView&&_shouldShowView){this.currentView.off('destroy',this.empty,this);}
if(_shouldShowView){view.once('destroy',this.empty,this);view.render();view._parent=this;if(isChangingView){this.triggerMethod('before:swap',view,this,options);}
this.triggerMethod('before:show',view,this,options);Marionette.triggerMethodOn(view,'before:show',view,this,options);if(isChangingView){this.triggerMethod('swapOut',this.currentView,this,options);}
var attachedRegion=Marionette.isNodeAttached(this.el);var displayedViews=[];var triggerBeforeAttach=showOptions.triggerBeforeAttach||this.triggerBeforeAttach;var triggerAttach=showOptions.triggerAttach||this.triggerAttach;if(attachedRegion&&triggerBeforeAttach){displayedViews=this._displayedViews(view);this._triggerAttach(displayedViews,'before:');}
this.attachHtml(view);this.currentView=view;if(attachedRegion&&triggerAttach){displayedViews=this._displayedViews(view);this._triggerAttach(displayedViews);}
if(isChangingView){this.triggerMethod('swap',view,this,options);}
this.triggerMethod('show',view,this,options);Marionette.triggerMethodOn(view,'show',view,this,options);return this;}
return this;},triggerBeforeAttach:true,triggerAttach:true,_triggerAttach:function(views,prefix){var eventName=(prefix||'')+'attach';_.each(views,function(view){Marionette.triggerMethodOn(view,eventName,view,this);},this);},_displayedViews:function(view){return _.union([view],_.result(view,'_getNestedViews')||[]);},_ensureElement:function(){if(!_.isObject(this.el)){this.$el=this.getEl(this.el);this.el=this.$el[0];}
if(!this.$el||this.$el.length===0){if(this.getOption('allowMissingEl')){return false;}else{throw new Marionette.Error('An "el" '+this.$el.selector+' must exist in DOM');}}
return true;},_ensureViewIsIntact:function(view){if(!view){throw new Marionette.Error({name:'ViewNotValid',message:'The view passed is undefined and therefore invalid. You must pass a view instance to show.'});}
if(view.isDestroyed){throw new Marionette.Error({name:'ViewDestroyedError',message:'View (cid: "'+view.cid+'") has already been destroyed and cannot be used.'});}},getEl:function(el){return Backbone.$(el,Marionette._getValue(this.options.parentEl,this));},attachHtml:function(view){this.$el.contents().detach();this.el.appendChild(view.el);},empty:function(options){var view=this.currentView;var preventDestroy=Marionette._getValue(options,'preventDestroy',this);if(!view){return;}
view.off('destroy',this.empty,this);this.triggerMethod('before:empty',view);if(!preventDestroy){this._destroyView();}
this.triggerMethod('empty',view);delete this.currentView;if(preventDestroy){this.$el.contents().detach();}
return this;},_destroyView:function(){var view=this.currentView;if(view.destroy&&!view.isDestroyed){view.destroy();}else if(view.remove){view.remove();view.isDestroyed=true;}},attachView:function(view){this.currentView=view;return this;},hasView:function(){return!!this.currentView;},reset:function(){this.empty();this.el=(this.$el&&this.$el.selector)||this.options.el;delete this.$el;return this;}},{buildRegion:function(regionConfig,DefaultRegionClass){if(_.isString(regionConfig)){return this._buildRegionFromSelector(regionConfig,DefaultRegionClass);}
if(regionConfig.selector||regionConfig.el||regionConfig.regionClass){return this._buildRegionFromObject(regionConfig,DefaultRegionClass);}
if(_.isFunction(regionConfig)){return this._buildRegionFromRegionClass(regionConfig);}
throw new Marionette.Error({message:'Improper region configuration type.',url:'marionette.region.html#region-configuration-types'});},_buildRegionFromSelector:function(selector,DefaultRegionClass){return new DefaultRegionClass({el:selector});},_buildRegionFromObject:function(regionConfig,DefaultRegionClass){var RegionClass=regionConfig.regionClass||DefaultRegionClass;var options=_.omit(regionConfig,'selector','regionClass');if(regionConfig.selector&&!options.el){options.el=regionConfig.selector;}
return new RegionClass(options);},_buildRegionFromRegionClass:function(RegionClass){return new RegionClass();}});Marionette.RegionManager=Marionette.Controller.extend({constructor:function(options){this._regions={};this.length=0;Marionette.Controller.call(this,options);this.addRegions(this.getOption('regions'));},addRegions:function(regionDefinitions,defaults){regionDefinitions=Marionette._getValue(regionDefinitions,this,arguments);return _.reduce(regionDefinitions,function(regions,definition,name){if(_.isString(definition)){definition={selector:definition};}
if(definition.selector){definition=_.defaults({},definition,defaults);}
regions[name]=this.addRegion(name,definition);return regions;},{},this);},addRegion:function(name,definition){var region;if(definition instanceof Marionette.Region){region=definition;}else{region=Marionette.Region.buildRegion(definition,Marionette.Region);}
this.triggerMethod('before:add:region',name,region);region._parent=this;this._store(name,region);this.triggerMethod('add:region',name,region);return region;},get:function(name){return this._regions[name];},getRegions:function(){return _.clone(this._regions);},removeRegion:function(name){var region=this._regions[name];this._remove(name,region);return region;},removeRegions:function(){var regions=this.getRegions();_.each(this._regions,function(region,name){this._remove(name,region);},this);return regions;},emptyRegions:function(){var regions=this.getRegions();_.invoke(regions,'empty');return regions;},destroy:function(){this.removeRegions();return Marionette.Controller.prototype.destroy.apply(this,arguments);},_store:function(name,region){if(!this._regions[name]){this.length++;}
this._regions[name]=region;},_remove:function(name,region){this.triggerMethod('before:remove:region',name,region);region.empty();region.stopListening();delete region._parent;delete this._regions[name];this.length--;this.triggerMethod('remove:region',name,region);}});Marionette.actAsCollection(Marionette.RegionManager.prototype,'_regions');Marionette.TemplateCache=function(templateId){this.templateId=templateId;};_.extend(Marionette.TemplateCache,{templateCaches:{},get:function(templateId,options){var cachedTemplate=this.templateCaches[templateId];if(!cachedTemplate){cachedTemplate=new Marionette.TemplateCache(templateId);this.templateCaches[templateId]=cachedTemplate;}
return cachedTemplate.load(options);},clear:function(){var i;var args=_.toArray(arguments);var length=args.length;if(length>0){for(i=0;i<length;i++){delete this.templateCaches[args[i]];}}else{this.templateCaches={};}}});_.extend(Marionette.TemplateCache.prototype,{load:function(options){if(this.compiledTemplate){return this.compiledTemplate;}
var template=this.loadTemplate(this.templateId,options);this.compiledTemplate=this.compileTemplate(template,options);return this.compiledTemplate;},loadTemplate:function(templateId,options){var template=Backbone.$(templateId).html();if(!template||template.length===0){throw new Marionette.Error({name:'NoTemplateError',message:'Could not find template: "'+templateId+'"'});}
return template;},compileTemplate:function(rawTemplate,options){return _.template(rawTemplate,options);}});Marionette.Renderer={render:function(template,data){if(!template){throw new Marionette.Error({name:'TemplateNotFoundError',message:'Cannot render the template since its false, null or undefined.'});}
var templateFunc=_.isFunction(template)?template:Marionette.TemplateCache.get(template);return templateFunc(data);}};Marionette.View=Backbone.View.extend({isDestroyed:false,constructor:function(options){_.bindAll(this,'render');options=Marionette._getValue(options,this);this.options=_.extend({},_.result(this,'options'),options);this._behaviors=Marionette.Behaviors(this);Backbone.View.call(this,this.options);Marionette.MonitorDOMRefresh(this);},getTemplate:function(){return this.getOption('template');},serializeModel:function(model){return model.toJSON.apply(model,_.rest(arguments));},mixinTemplateHelpers:function(target){target=target||{};var templateHelpers=this.getOption('templateHelpers');templateHelpers=Marionette._getValue(templateHelpers,this);return _.extend(target,templateHelpers);},normalizeUIKeys:function(hash){var uiBindings=_.result(this,'_uiBindings');return Marionette.normalizeUIKeys(hash,uiBindings||_.result(this,'ui'));},normalizeUIValues:function(hash,properties){var ui=_.result(this,'ui');var uiBindings=_.result(this,'_uiBindings');return Marionette.normalizeUIValues(hash,uiBindings||ui,properties);},configureTriggers:function(){if(!this.triggers){return;}
var triggers=this.normalizeUIKeys(_.result(this,'triggers'));return _.reduce(triggers,function(events,value,key){events[key]=this._buildViewTrigger(value);return events;},{},this);},delegateEvents:function(events){this._delegateDOMEvents(events);this.bindEntityEvents(this.model,this.getOption('modelEvents'));this.bindEntityEvents(this.collection,this.getOption('collectionEvents'));_.each(this._behaviors,function(behavior){behavior.bindEntityEvents(this.model,behavior.getOption('modelEvents'));behavior.bindEntityEvents(this.collection,behavior.getOption('collectionEvents'));},this);return this;},_delegateDOMEvents:function(eventsArg){var events=Marionette._getValue(eventsArg||this.events,this);events=this.normalizeUIKeys(events);if(_.isUndefined(eventsArg)){this.events=events;}
var combinedEvents={};var behaviorEvents=_.result(this,'behaviorEvents')||{};var triggers=this.configureTriggers();var behaviorTriggers=_.result(this,'behaviorTriggers')||{};_.extend(combinedEvents,behaviorEvents,events,triggers,behaviorTriggers);Backbone.View.prototype.delegateEvents.call(this,combinedEvents);},undelegateEvents:function(){Backbone.View.prototype.undelegateEvents.apply(this,arguments);this.unbindEntityEvents(this.model,this.getOption('modelEvents'));this.unbindEntityEvents(this.collection,this.getOption('collectionEvents'));_.each(this._behaviors,function(behavior){behavior.unbindEntityEvents(this.model,behavior.getOption('modelEvents'));behavior.unbindEntityEvents(this.collection,behavior.getOption('collectionEvents'));},this);return this;},_ensureViewIsIntact:function(){if(this.isDestroyed){throw new Marionette.Error({name:'ViewDestroyedError',message:'View (cid: "'+this.cid+'") has already been destroyed and cannot be used.'});}},destroy:function(){if(this.isDestroyed){return this;}
var args=_.toArray(arguments);this.triggerMethod.apply(this,['before:destroy'].concat(args));this.isDestroyed=true;this.triggerMethod.apply(this,['destroy'].concat(args));this.unbindUIElements();this.isRendered=false;this.remove();_.invoke(this._behaviors,'destroy',args);return this;},bindUIElements:function(){this._bindUIElements();_.invoke(this._behaviors,this._bindUIElements);},_bindUIElements:function(){if(!this.ui){return;}
if(!this._uiBindings){this._uiBindings=this.ui;}
var bindings=_.result(this,'_uiBindings');this.ui={};_.each(bindings,function(selector,key){this.ui[key]=this.$(selector);},this);},unbindUIElements:function(){this._unbindUIElements();_.invoke(this._behaviors,this._unbindUIElements);},_unbindUIElements:function(){if(!this.ui||!this._uiBindings){return;}
_.each(this.ui,function($el,name){delete this.ui[name];},this);this.ui=this._uiBindings;delete this._uiBindings;},_buildViewTrigger:function(triggerDef){var hasOptions=_.isObject(triggerDef);var options=_.defaults({},(hasOptions?triggerDef:{}),{preventDefault:true,stopPropagation:true});var eventName=hasOptions?options.event:triggerDef;return function(e){if(e){if(e.preventDefault&&options.preventDefault){e.preventDefault();}
if(e.stopPropagation&&options.stopPropagation){e.stopPropagation();}}
var args={view:this,model:this.model,collection:this.collection};this.triggerMethod(eventName,args);};},setElement:function(){var ret=Backbone.View.prototype.setElement.apply(this,arguments);_.invoke(this._behaviors,'proxyViewProperties',this);return ret;},triggerMethod:function(){var ret=Marionette._triggerMethod(this,arguments);this._triggerEventOnBehaviors(arguments);this._triggerEventOnParentLayout(arguments[0],_.rest(arguments));return ret;},_triggerEventOnBehaviors:function(args){var triggerMethod=Marionette._triggerMethod;var behaviors=this._behaviors;for(var i=0,length=behaviors&&behaviors.length;i<length;i++){triggerMethod(behaviors[i],args);}},_triggerEventOnParentLayout:function(eventName,args){var layoutView=this._parentLayoutView();if(!layoutView){return;}
var eventPrefix=Marionette.getOption(layoutView,'childViewEventPrefix');var prefixedEventName=eventPrefix+':'+eventName;Marionette._triggerMethod(layoutView,[prefixedEventName,this].concat(args));var childEvents=Marionette.getOption(layoutView,'childEvents');var normalizedChildEvents=layoutView.normalizeMethods(childEvents);if(!!normalizedChildEvents&&_.isFunction(normalizedChildEvents[eventName])){normalizedChildEvents[eventName].apply(layoutView,[this].concat(args));}},_getImmediateChildren:function(){return[];},_getNestedViews:function(){var children=this._getImmediateChildren();if(!children.length){return children;}
return _.reduce(children,function(memo,view){if(!view._getNestedViews){return memo;}
return memo.concat(view._getNestedViews());},children);},_getAncestors:function(){var ancestors=[];var parent=this._parent;while(parent){ancestors.push(parent);parent=parent._parent;}
return ancestors;},_parentLayoutView:function(){var ancestors=this._getAncestors();return _.find(ancestors,function(parent){return parent instanceof Marionette.LayoutView;});},normalizeMethods:Marionette.normalizeMethods,mergeOptions:Marionette.mergeOptions,getOption:Marionette.proxyGetOption,bindEntityEvents:Marionette.proxyBindEntityEvents,unbindEntityEvents:Marionette.proxyUnbindEntityEvents});Marionette.ItemView=Marionette.View.extend({constructor:function(){Marionette.View.apply(this,arguments);},serializeData:function(){if(!this.model&&!this.collection){return{};}
var args=[this.model||this.collection];if(arguments.length){args.push.apply(args,arguments);}
if(this.model){return this.serializeModel.apply(this,args);}else{return{items:this.serializeCollection.apply(this,args)};}},serializeCollection:function(collection){return collection.toJSON.apply(collection,_.rest(arguments));},render:function(){this._ensureViewIsIntact();this.triggerMethod('before:render',this);this._renderTemplate();this.isRendered=true;this.bindUIElements();this.triggerMethod('render',this);return this;},_renderTemplate:function(){var template=this.getTemplate();if(template===false){return;}
if(!template){throw new Marionette.Error({name:'UndefinedTemplateError',message:'Cannot render the template since it is null or undefined.'});}
var data=this.mixinTemplateHelpers(this.serializeData());var html=Marionette.Renderer.render(template,data,this);this.attachElContent(html);return this;},attachElContent:function(html){this.$el.html(html);return this;}});Marionette.CollectionView=Marionette.View.extend({childViewEventPrefix:'childview',sort:true,constructor:function(options){this.once('render',this._initialEvents);this._initChildViewStorage();Marionette.View.apply(this,arguments);this.on('show',this._onShowCalled);this.initRenderBuffer();},initRenderBuffer:function(){this._bufferedChildren=[];},startBuffering:function(){this.initRenderBuffer();this.isBuffering=true;},endBuffering:function(){this.isBuffering=false;this._triggerBeforeShowBufferedChildren();this.attachBuffer(this);this._triggerShowBufferedChildren();this.initRenderBuffer();},_triggerBeforeShowBufferedChildren:function(){if(this._isShown){_.each(this._bufferedChildren,_.partial(this._triggerMethodOnChild,'before:show'));}},_triggerShowBufferedChildren:function(){if(this._isShown){_.each(this._bufferedChildren,_.partial(this._triggerMethodOnChild,'show'));this._bufferedChildren=[];}},_triggerMethodOnChild:function(event,childView){Marionette.triggerMethodOn(childView,event);},_initialEvents:function(){if(this.collection){this.listenTo(this.collection,'add',this._onCollectionAdd);this.listenTo(this.collection,'remove',this._onCollectionRemove);this.listenTo(this.collection,'reset',this.render);if(this.getOption('sort')){this.listenTo(this.collection,'sort',this._sortViews);}}},_onCollectionAdd:function(child,collection,opts){var index;if(opts.at!==undefined){index=opts.at;}else{index=_.indexOf(this._filteredSortedModels(),child);}
if(this._shouldAddChild(child,index)){this.destroyEmptyView();var ChildView=this.getChildView(child);this.addChild(child,ChildView,index);}},_onCollectionRemove:function(model){var view=this.children.findByModel(model);this.removeChildView(view);this.checkEmpty();},_onShowCalled:function(){this.children.each(_.partial(this._triggerMethodOnChild,'show'));},render:function(){this._ensureViewIsIntact();this.triggerMethod('before:render',this);this._renderChildren();this.isRendered=true;this.triggerMethod('render',this);return this;},reorder:function(){var children=this.children;var models=this._filteredSortedModels();var modelsChanged=_.find(models,function(model){return!children.findByModel(model);});if(modelsChanged){this.render();}else{var els=_.map(models,function(model){return children.findByModel(model).el;});this.triggerMethod('before:reorder');this._appendReorderedChildren(els);this.triggerMethod('reorder');}},resortView:function(){if(Marionette.getOption(this,'reorderOnSort')){this.reorder();}else{this.render();}},_sortViews:function(){var models=this._filteredSortedModels();var orderChanged=_.find(models,function(item,index){var view=this.children.findByModel(item);return!view||view._index!==index;},this);if(orderChanged){this.resortView();}},_emptyViewIndex:-1,_appendReorderedChildren:function(children){this.$el.append(children);},_renderChildren:function(){this.destroyEmptyView();this.destroyChildren();if(this.isEmpty(this.collection)){this.showEmptyView();}else{this.triggerMethod('before:render:collection',this);this.startBuffering();this.showCollection();this.endBuffering();this.triggerMethod('render:collection',this);if(this.children.isEmpty()){this.showEmptyView();}}},showCollection:function(){var ChildView;var models=this._filteredSortedModels();_.each(models,function(child,index){ChildView=this.getChildView(child);this.addChild(child,ChildView,index);},this);},_filteredSortedModels:function(){var models;var viewComparator=this.getViewComparator();if(viewComparator){if(_.isString(viewComparator)||viewComparator.length===1){models=this.collection.sortBy(viewComparator,this);}else{models=_.clone(this.collection.models).sort(_.bind(viewComparator,this));}}else{models=this.collection.models;}
if(this.getOption('filter')){models=_.filter(models,function(model,index){return this._shouldAddChild(model,index);},this);}
return models;},showEmptyView:function(){var EmptyView=this.getEmptyView();if(EmptyView&&!this._showingEmptyView){this.triggerMethod('before:render:empty');this._showingEmptyView=true;var model=new Backbone.Model();this.addEmptyView(model,EmptyView);this.triggerMethod('render:empty');}},destroyEmptyView:function(){if(this._showingEmptyView){this.triggerMethod('before:remove:empty');this.destroyChildren();delete this._showingEmptyView;this.triggerMethod('remove:empty');}},getEmptyView:function(){return this.getOption('emptyView');},addEmptyView:function(child,EmptyView){var emptyViewOptions=this.getOption('emptyViewOptions')||this.getOption('childViewOptions');if(_.isFunction(emptyViewOptions)){emptyViewOptions=emptyViewOptions.call(this,child,this._emptyViewIndex);}
var view=this.buildChildView(child,EmptyView,emptyViewOptions);view._parent=this;this.proxyChildEvents(view);if(this._isShown){Marionette.triggerMethodOn(view,'before:show');}
this.children.add(view);this.renderChildView(view,this._emptyViewIndex);if(this._isShown){Marionette.triggerMethodOn(view,'show');}},getChildView:function(child){var childView=this.getOption('childView');if(!childView){throw new Marionette.Error({name:'NoChildViewError',message:'A "childView" must be specified'});}
return childView;},addChild:function(child,ChildView,index){var childViewOptions=this.getOption('childViewOptions');childViewOptions=Marionette._getValue(childViewOptions,this,[child,index]);var view=this.buildChildView(child,ChildView,childViewOptions);this._updateIndices(view,true,index);this._addChildView(view,index);view._parent=this;return view;},_updateIndices:function(view,increment,index){if(!this.getOption('sort')){return;}
if(increment){view._index=index;}
this.children.each(function(laterView){if(laterView._index>=view._index){laterView._index+=increment?1:-1;}});},_addChildView:function(view,index){this.proxyChildEvents(view);this.triggerMethod('before:add:child',view);if(this._isShown&&!this.isBuffering){Marionette.triggerMethodOn(view,'before:show');}
this.children.add(view);this.renderChildView(view,index);if(this._isShown&&!this.isBuffering){Marionette.triggerMethodOn(view,'show');}
this.triggerMethod('add:child',view);},renderChildView:function(view,index){view.render();this.attachHtml(this,view,index);return view;},buildChildView:function(child,ChildViewClass,childViewOptions){var options=_.extend({model:child},childViewOptions);return new ChildViewClass(options);},removeChildView:function(view){if(view){this.triggerMethod('before:remove:child',view);if(view.destroy){view.destroy();}else if(view.remove){view.remove();}
delete view._parent;this.stopListening(view);this.children.remove(view);this.triggerMethod('remove:child',view);this._updateIndices(view,false);}
return view;},isEmpty:function(){return!this.collection||this.collection.length===0;},checkEmpty:function(){if(this.isEmpty(this.collection)){this.showEmptyView();}},attachBuffer:function(collectionView){collectionView.$el.append(this._createBuffer(collectionView));},_createBuffer:function(collectionView){var elBuffer=document.createDocumentFragment();_.each(collectionView._bufferedChildren,function(b){elBuffer.appendChild(b.el);});return elBuffer;},attachHtml:function(collectionView,childView,index){if(collectionView.isBuffering){collectionView._bufferedChildren.splice(index,0,childView);}else{if(!collectionView._insertBefore(childView,index)){collectionView._insertAfter(childView);}}},_insertBefore:function(childView,index){var currentView;var findPosition=this.getOption('sort')&&(index<this.children.length-1);if(findPosition){currentView=this.children.find(function(view){return view._index===index+1;});}
if(currentView){currentView.$el.before(childView.el);return true;}
return false;},_insertAfter:function(childView){this.$el.append(childView.el);},_initChildViewStorage:function(){this.children=new Backbone.ChildViewContainer();},destroy:function(){if(this.isDestroyed){return this;}
this.triggerMethod('before:destroy:collection');this.destroyChildren();this.triggerMethod('destroy:collection');return Marionette.View.prototype.destroy.apply(this,arguments);},destroyChildren:function(){var childViews=this.children.map(_.identity);this.children.each(this.removeChildView,this);this.checkEmpty();return childViews;},_shouldAddChild:function(child,index){var filter=this.getOption('filter');return!_.isFunction(filter)||filter.call(this,child,index,this.collection);},proxyChildEvents:function(view){var prefix=this.getOption('childViewEventPrefix');this.listenTo(view,'all',function(){var args=_.toArray(arguments);var rootEvent=args[0];var childEvents=this.normalizeMethods(_.result(this,'childEvents'));args[0]=prefix+':'+rootEvent;args.splice(1,0,view);if(typeof childEvents!=='undefined'&&_.isFunction(childEvents[rootEvent])){childEvents[rootEvent].apply(this,args.slice(1));}
this.triggerMethod.apply(this,args);});},_getImmediateChildren:function(){return _.values(this.children._views);},getViewComparator:function(){return this.getOption('viewComparator');}});Marionette.CompositeView=Marionette.CollectionView.extend({constructor:function(){Marionette.CollectionView.apply(this,arguments);},_initialEvents:function(){if(this.collection){this.listenTo(this.collection,'add',this._onCollectionAdd);this.listenTo(this.collection,'remove',this._onCollectionRemove);this.listenTo(this.collection,'reset',this._renderChildren);if(this.getOption('sort')){this.listenTo(this.collection,'sort',this._sortViews);}}},getChildView:function(child){var childView=this.getOption('childView')||this.constructor;return childView;},serializeData:function(){var data={};if(this.model){data=_.partial(this.serializeModel,this.model).apply(this,arguments);}
return data;},render:function(){this._ensureViewIsIntact();this._isRendering=true;this.resetChildViewContainer();this.triggerMethod('before:render',this);this._renderTemplate();this._renderChildren();this._isRendering=false;this.isRendered=true;this.triggerMethod('render',this);return this;},_renderChildren:function(){if(this.isRendered||this._isRendering){Marionette.CollectionView.prototype._renderChildren.call(this);}},_renderTemplate:function(){var data={};data=this.serializeData();data=this.mixinTemplateHelpers(data);this.triggerMethod('before:render:template');var template=this.getTemplate();var html=Marionette.Renderer.render(template,data,this);this.attachElContent(html);this.bindUIElements();this.triggerMethod('render:template');},attachElContent:function(html){this.$el.html(html);return this;},attachBuffer:function(compositeView){var $container=this.getChildViewContainer(compositeView);$container.append(this._createBuffer(compositeView));},_insertAfter:function(childView){var $container=this.getChildViewContainer(this,childView);$container.append(childView.el);},_appendReorderedChildren:function(children){var $container=this.getChildViewContainer(this);$container.append(children);},getChildViewContainer:function(containerView,childView){if('$childViewContainer'in containerView){return containerView.$childViewContainer;}
var container;var childViewContainer=Marionette.getOption(containerView,'childViewContainer');if(childViewContainer){var selector=Marionette._getValue(childViewContainer,containerView);if(selector.charAt(0)==='@'&&containerView.ui){container=containerView.ui[selector.substr(4)];}else{container=containerView.$(selector);}
if(container.length<=0){throw new Marionette.Error({name:'ChildViewContainerMissingError',message:'The specified "childViewContainer" was not found: '+containerView.childViewContainer});}}else{container=containerView.$el;}
containerView.$childViewContainer=container;return container;},resetChildViewContainer:function(){if(this.$childViewContainer){delete this.$childViewContainer;}}});Marionette.LayoutView=Marionette.ItemView.extend({regionClass:Marionette.Region,options:{destroyImmediate:false},childViewEventPrefix:'childview',constructor:function(options){options=options||{};this._firstRender=true;this._initializeRegions(options);Marionette.ItemView.call(this,options);},render:function(){this._ensureViewIsIntact();if(this._firstRender){this._firstRender=false;}else{this._reInitializeRegions();}
return Marionette.ItemView.prototype.render.apply(this,arguments);},destroy:function(){if(this.isDestroyed){return this;}
if(this.getOption('destroyImmediate')===true){this.$el.remove();}
this.regionManager.destroy();return Marionette.ItemView.prototype.destroy.apply(this,arguments);},showChildView:function(regionName,view){return this.getRegion(regionName).show(view);},getChildView:function(regionName){return this.getRegion(regionName).currentView;},addRegion:function(name,definition){var regions={};regions[name]=definition;return this._buildRegions(regions)[name];},addRegions:function(regions){this.regions=_.extend({},this.regions,regions);return this._buildRegions(regions);},removeRegion:function(name){delete this.regions[name];return this.regionManager.removeRegion(name);},getRegion:function(region){return this.regionManager.get(region);},getRegions:function(){return this.regionManager.getRegions();},_buildRegions:function(regions){var defaults={regionClass:this.getOption('regionClass'),parentEl:_.partial(_.result,this,'el')};return this.regionManager.addRegions(regions,defaults);},_initializeRegions:function(options){var regions;this._initRegionManager();regions=Marionette._getValue(this.regions,this,[options])||{};var regionOptions=this.getOption.call(options,'regions');regionOptions=Marionette._getValue(regionOptions,this,[options]);_.extend(regions,regionOptions);regions=this.normalizeUIValues(regions,['selector','el']);this.addRegions(regions);},_reInitializeRegions:function(){this.regionManager.invoke('reset');},getRegionManager:function(){return new Marionette.RegionManager();},_initRegionManager:function(){this.regionManager=this.getRegionManager();this.regionManager._parent=this;this.listenTo(this.regionManager,'before:add:region',function(name){this.triggerMethod('before:add:region',name);});this.listenTo(this.regionManager,'add:region',function(name,region){this[name]=region;this.triggerMethod('add:region',name,region);});this.listenTo(this.regionManager,'before:remove:region',function(name){this.triggerMethod('before:remove:region',name);});this.listenTo(this.regionManager,'remove:region',function(name,region){delete this[name];this.triggerMethod('remove:region',name,region);});},_getImmediateChildren:function(){return _.chain(this.regionManager.getRegions()).pluck('currentView').compact().value();}});Marionette.Behavior=Marionette.Object.extend({constructor:function(options,view){this.view=view;this.defaults=_.result(this,'defaults')||{};this.options=_.extend({},this.defaults,options);this.ui=_.extend({},_.result(view,'ui'),_.result(this,'ui'));Marionette.Object.apply(this,arguments);},$:function(){return this.view.$.apply(this.view,arguments);},destroy:function(){this.stopListening();return this;},proxyViewProperties:function(view){this.$el=view.$el;this.el=view.el;}});Marionette.Behaviors=(function(Marionette,_){var delegateEventSplitter=/^(\S+)\s*(.*)$/;function Behaviors(view,behaviors){if(!_.isObject(view.behaviors)){return{};}
behaviors=Behaviors.parseBehaviors(view,behaviors||_.result(view,'behaviors'));Behaviors.wrap(view,behaviors,_.keys(methods));return behaviors;}
var methods={behaviorTriggers:function(behaviorTriggers,behaviors){var triggerBuilder=new BehaviorTriggersBuilder(this,behaviors);return triggerBuilder.buildBehaviorTriggers();},behaviorEvents:function(behaviorEvents,behaviors){var _behaviorsEvents={};_.each(behaviors,function(b,i){var _events={};var behaviorEvents=_.clone(_.result(b,'events'))||{};behaviorEvents=Marionette.normalizeUIKeys(behaviorEvents,getBehaviorsUI(b));var j=0;_.each(behaviorEvents,function(behaviour,key){var match=key.match(delegateEventSplitter);var eventName=match[1]+'.'+[this.cid,i,j++,' '].join('');var selector=match[2];var eventKey=eventName+selector;var handler=_.isFunction(behaviour)?behaviour:b[behaviour];_events[eventKey]=_.bind(handler,b);},this);_behaviorsEvents=_.extend(_behaviorsEvents,_events);},this);return _behaviorsEvents;}};_.extend(Behaviors,{behaviorsLookup:function(){throw new Marionette.Error({message:'You must define where your behaviors are stored.',url:'marionette.behaviors.html#behaviorslookup'});},getBehaviorClass:function(options,key){if(options.behaviorClass){return options.behaviorClass;}
return Marionette._getValue(Behaviors.behaviorsLookup,this,[options,key])[key];},parseBehaviors:function(view,behaviors){return _.chain(behaviors).map(function(options,key){var BehaviorClass=Behaviors.getBehaviorClass(options,key);var behavior=new BehaviorClass(options,view);var nestedBehaviors=Behaviors.parseBehaviors(view,_.result(behavior,'behaviors'));return[behavior].concat(nestedBehaviors);}).flatten().value();},wrap:function(view,behaviors,methodNames){_.each(methodNames,function(methodName){view[methodName]=_.partial(methods[methodName],view[methodName],behaviors);});}});function BehaviorTriggersBuilder(view,behaviors){this._view=view;this._behaviors=behaviors;this._triggers={};}
_.extend(BehaviorTriggersBuilder.prototype,{buildBehaviorTriggers:function(){_.each(this._behaviors,this._buildTriggerHandlersForBehavior,this);return this._triggers;},_buildTriggerHandlersForBehavior:function(behavior,i){var triggersHash=_.clone(_.result(behavior,'triggers'))||{};triggersHash=Marionette.normalizeUIKeys(triggersHash,getBehaviorsUI(behavior));_.each(triggersHash,_.bind(this._setHandlerForBehavior,this,behavior,i));},_setHandlerForBehavior:function(behavior,i,eventName,trigger){var triggerKey=trigger.replace(/^\S+/,function(triggerName){return triggerName+'.'+'behaviortriggers'+i;});this._triggers[triggerKey]=this._view._buildViewTrigger(eventName);}});function getBehaviorsUI(behavior){return behavior._uiBindings||behavior.ui;}
return Behaviors;})(Marionette,_);Marionette.AppRouter=Backbone.Router.extend({constructor:function(options){this.options=options||{};Backbone.Router.apply(this,arguments);var appRoutes=this.getOption('appRoutes');var controller=this._getController();this.processAppRoutes(controller,appRoutes);this.on('route',this._processOnRoute,this);},appRoute:function(route,methodName){var controller=this._getController();this._addAppRoute(controller,route,methodName);},_processOnRoute:function(routeName,routeArgs){if(_.isFunction(this.onRoute)){var routePath=_.invert(this.getOption('appRoutes'))[routeName];this.onRoute(routeName,routePath,routeArgs);}},processAppRoutes:function(controller,appRoutes){if(!appRoutes){return;}
var routeNames=_.keys(appRoutes).reverse();_.each(routeNames,function(route){this._addAppRoute(controller,route,appRoutes[route]);},this);},_getController:function(){return this.getOption('controller');},_addAppRoute:function(controller,route,methodName){var method=controller[methodName];if(!method){throw new Marionette.Error('Method "'+methodName+'" was not found on the controller');}
this.route(route,methodName,_.bind(method,controller));},mergeOptions:Marionette.mergeOptions,getOption:Marionette.proxyGetOption,triggerMethod:Marionette.triggerMethod,bindEntityEvents:Marionette.proxyBindEntityEvents,unbindEntityEvents:Marionette.proxyUnbindEntityEvents});Marionette.Application=Marionette.Object.extend({constructor:function(options){this._initializeRegions(options);this._initCallbacks=new Marionette.Callbacks();this.submodules={};_.extend(this,options);this._initChannel();Marionette.Object.call(this,options);},execute:function(){this.commands.execute.apply(this.commands,arguments);},request:function(){return this.reqres.request.apply(this.reqres,arguments);},addInitializer:function(initializer){this._initCallbacks.add(initializer);},start:function(options){this.triggerMethod('before:start',options);this._initCallbacks.run(options,this);this.triggerMethod('start',options);},addRegions:function(regions){return this._regionManager.addRegions(regions);},emptyRegions:function(){return this._regionManager.emptyRegions();},removeRegion:function(region){return this._regionManager.removeRegion(region);},getRegion:function(region){return this._regionManager.get(region);},getRegions:function(){return this._regionManager.getRegions();},module:function(moduleNames,moduleDefinition){var ModuleClass=Marionette.Module.getClass(moduleDefinition);var args=_.toArray(arguments);args.unshift(this);return ModuleClass.create.apply(ModuleClass,args);},getRegionManager:function(){return new Marionette.RegionManager();},_initializeRegions:function(options){var regions=_.isFunction(this.regions)?this.regions(options):this.regions||{};this._initRegionManager();var optionRegions=Marionette.getOption(options,'regions');if(_.isFunction(optionRegions)){optionRegions=optionRegions.call(this,options);}
_.extend(regions,optionRegions);this.addRegions(regions);return this;},_initRegionManager:function(){this._regionManager=this.getRegionManager();this._regionManager._parent=this;this.listenTo(this._regionManager,'before:add:region',function(){Marionette._triggerMethod(this,'before:add:region',arguments);});this.listenTo(this._regionManager,'add:region',function(name,region){this[name]=region;Marionette._triggerMethod(this,'add:region',arguments);});this.listenTo(this._regionManager,'before:remove:region',function(){Marionette._triggerMethod(this,'before:remove:region',arguments);});this.listenTo(this._regionManager,'remove:region',function(name){delete this[name];Marionette._triggerMethod(this,'remove:region',arguments);});},_initChannel:function(){this.channelName=_.result(this,'channelName')||'global';this.channel=_.result(this,'channel')||Backbone.Wreqr.radio.channel(this.channelName);this.vent=_.result(this,'vent')||this.channel.vent;this.commands=_.result(this,'commands')||this.channel.commands;this.reqres=_.result(this,'reqres')||this.channel.reqres;}});Marionette.Module=function(moduleName,app,options){this.moduleName=moduleName;this.options=_.extend({},this.options,options);this.initialize=options.initialize||this.initialize;this.submodules={};this._setupInitializersAndFinalizers();this.app=app;if(_.isFunction(this.initialize)){this.initialize(moduleName,app,this.options);}};Marionette.Module.extend=Marionette.extend;_.extend(Marionette.Module.prototype,Backbone.Events,{startWithParent:true,initialize:function(){},addInitializer:function(callback){this._initializerCallbacks.add(callback);},addFinalizer:function(callback){this._finalizerCallbacks.add(callback);},start:function(options){if(this._isInitialized){return;}
_.each(this.submodules,function(mod){if(mod.startWithParent){mod.start(options);}});this.triggerMethod('before:start',options);this._initializerCallbacks.run(options,this);this._isInitialized=true;this.triggerMethod('start',options);},stop:function(){if(!this._isInitialized){return;}
this._isInitialized=false;this.triggerMethod('before:stop');_.invoke(this.submodules,'stop');this._finalizerCallbacks.run(undefined,this);this._initializerCallbacks.reset();this._finalizerCallbacks.reset();this.triggerMethod('stop');},addDefinition:function(moduleDefinition,customArgs){this._runModuleDefinition(moduleDefinition,customArgs);},_runModuleDefinition:function(definition,customArgs){if(!definition){return;}
var args=_.flatten([this,this.app,Backbone,Marionette,Backbone.$,_,customArgs]);definition.apply(this,args);},_setupInitializersAndFinalizers:function(){this._initializerCallbacks=new Marionette.Callbacks();this._finalizerCallbacks=new Marionette.Callbacks();},triggerMethod:Marionette.triggerMethod});_.extend(Marionette.Module,{create:function(app,moduleNames,moduleDefinition){var module=app;var customArgs=_.drop(arguments,3);moduleNames=moduleNames.split('.');var length=moduleNames.length;var moduleDefinitions=[];moduleDefinitions[length-1]=moduleDefinition;_.each(moduleNames,function(moduleName,i){var parentModule=module;module=this._getModule(parentModule,moduleName,app,moduleDefinition);this._addModuleDefinition(parentModule,module,moduleDefinitions[i],customArgs);},this);return module;},_getModule:function(parentModule,moduleName,app,def,args){var options=_.extend({},def);var ModuleClass=this.getClass(def);var module=parentModule[moduleName];if(!module){module=new ModuleClass(moduleName,app,options);parentModule[moduleName]=module;parentModule.submodules[moduleName]=module;}
return module;},getClass:function(moduleDefinition){var ModuleClass=Marionette.Module;if(!moduleDefinition){return ModuleClass;}
if(moduleDefinition.prototype instanceof ModuleClass){return moduleDefinition;}
return moduleDefinition.moduleClass||ModuleClass;},_addModuleDefinition:function(parentModule,module,def,args){var fn=this._getDefine(def);var startWithParent=this._getStartWithParent(def,module);if(fn){module.addDefinition(fn,args);}
this._addStartWithParent(parentModule,module,startWithParent);},_getStartWithParent:function(def,module){var swp;if(_.isFunction(def)&&(def.prototype instanceof Marionette.Module)){swp=module.constructor.prototype.startWithParent;return _.isUndefined(swp)?true:swp;}
if(_.isObject(def)){swp=def.startWithParent;return _.isUndefined(swp)?true:swp;}
return true;},_getDefine:function(def){if(_.isFunction(def)&&!(def.prototype instanceof Marionette.Module)){return def;}
if(_.isObject(def)){return def.define;}
return null;},_addStartWithParent:function(parentModule,module,startWithParent){module.startWithParent=module.startWithParent&&startWithParent;if(!module.startWithParent||!!module.startWithParentIsConfigured){return;}
module.startWithParentIsConfigured=true;parentModule.addInitializer(function(options){if(module.startWithParent){module.start(options);}});}});return Marionette;}));Backbone.Facebook={};Backbone.Webshop={analytics:{resource:{},mixin:{}},appBanner:{},applePay:{},banners:{},basket:{mixin:{}},bop:{analytics:{converter:{},mixin:{}},mixin:{}},bundleDeals:{},catalogue:{},cluster:{},comboDeals:{},cow:{gift:{}},delivery:{newdesign:{}},discountclub:{},favourites:{},filters:{},fop:{analytics:{converter:{},mixin:{}},mixin:{}},header:{},homepage:{},infiniteScroll:{multilevel:{}},iaf:{},login:{},mixins:{},modal:{},navigation:{},notifications:{},oos:{},order:{},payment:{},pers:{},popup:{},product:{analytics:{mixin:{}}},productView:{},promotions:{},promobox:{},quickreg:{},recipes:{},recipeFinder:{},registration:{},reviews:{},ribbons:{},router:{mixin:{}},scroll:{},settings:{},shoppingLists:{},slotBooking:{},social:{mixin:{}},sortby:{},subNavigation:{},tabbedContent:{},trolley:{analytics:{converter:{},mixin:{}},mixin:{}},ulp:{},unavailableItems:{},userPreference:{},wineFinder:{},youritems:{}};