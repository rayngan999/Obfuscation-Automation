define(['jquery','module.base','lib/maps/google','lib/maps/layer','lib/maps/control','util/eventhandler','session','localization/copy','web/modules/gps_location','mapwebglchecker'],function($,Module,Mapping,MapLayer,MapControl,_event,_session,copy,gps,mapwebglchecker){if(!window.templates.citysearch){MapControl.prototype.loadTemplate('citysearch','web/maps');}
if(!window.templates.map_messaging){MapControl.prototype.loadTemplate('map_messaging','web/maps');}
if(!window.templates.map_confirmation){MapControl.prototype.loadTemplate('map_confirmation','web/maps');}
if(copy){copy=copy.maps;}else{copy={};require([_config.platform+'/modules/adapters/localization-copy-'+_config.lang],function(_copy){copy=_copy.maps;});}
var Map=function(){var controls=[],map=null,_options={title:true,refresh_ads:true},ttls={},ttks=[],lastAjaxPtQuery=null,addControl=function(type,options){var cntrl=type,nm='';if(cntrl){controls.push(cntrl);if(cntrl.id){nm=cntrl.id.toLowerCase();}}
return cntrl;},removeControl=function(id){var fnd=hasControl(id),cntrl=null;if(fnd!==false){cntrl=controls.splice(fnd,1)[0];cntrl.reset();}},hasControl=function(id){var i=controls.length-1,r=false;for(;i>=0;i--){if(controls[i].id==id.id){r=i;}}
return r;},_auto_play=function(){var c=controls.length-1;if(window.maps_autoplay){window.maps_autoplay=false;if(controls.length){for(;c>=0;c--){if(typeof controls[c].play=='function'){controls[c].play();break;}}}}},_auto_stop=function(){var c=controls.length-1;if(window.maps_autostop){window.maps_autostop=false;if(controls.length){for(;c>=0;c--){if(typeof controls[c].stop=='function'){controls[c].stop();break;}}}}},_set_message=function(res){var txt='',idx=0,lnk='#',mxl=60,mtype='',elm=$('#map_breaking_news a'),elmhead=$('#map_breaking_news span'),classname=' hidden',hasbnws=false,hastkovr=false,heading='';if(res){res=$.parseJSON(res);if(res){$.each(res,function(key,value){if(value.Type=='breaking'){idx=key;hastkovr=true;return false;}else if(hastkovr==false&&value.Type=='breaking'){idx=key;hasbnws=true;}});if(!hastkovr&&!hasbnws)
idx=Math.floor(Math.random()*res.length)
txt=res[idx].message;lnk=res[idx].CTA;mtype=res[idx].Type;heading=typeof(res[idx].heading)!='undefined'?res[idx].heading:'';if(txt.length>mxl){txt=txt.substring(0,mxl-3)+"&hellip;";}
if(mtype.indexOf('breaking')>-1){if(heading&&heading!=''){var hclassname=elmhead.attr('class');if(typeof res[idx].style!='undefined'&&typeof res[idx].style.backgroundcolor!='undefined'){hclassname+=' b-'+res[idx].style.backgroundcolor;}
elmhead.html(heading).attr('class',hclassname);}
classname='Breaking';if(typeof res[idx].style!='undefined'){if(typeof res[idx].style.fontweight!='undefined'){var fontweight=res[idx].style.fontweight;for(var f=0;f<fontweight.length;f++){classname+=' bt-'+fontweight[f];}}
if(typeof res[idx].style.textcolor!='undefined'){var textcolor=res[idx].style.textcolor;classname+=' bt-'+textcolor;}}
$("#editors_choice_news").hide();$("#map_breaking_news span.breaking").show();$('#map_breaking_news').show();elm.html(txt).attr('href',lnk).attr('class','map_headline'+classname).attr('onclick','window.pelm.track.headline_click(this);').attr('data-headline',txt).attr('data-headline_page','home page').attr('data-headline_cat',mtype).attr('data-headline_heading',heading);window._q.add(track_headline);}
else{$('#map_breaking_news').hide();$("#editors_choice_news").show();}
function track_headline(){if(typeof window.pelm!='undefined'){if(typeof(window.pelm.track)!='undefined'){var obj=$("#map_breaking_news a");window.pelm.track.headline_view(obj);window._q.remove(track_headline);}}}}}
return res;},_set_title=function(res){var hcp=$(".user-current-location").text().length>0;if(!hcp&&!window._config.map_homepage&&window._config.locale!='en_us'){var zm=null,txt='',pt,pos;if(res){res=$.parseJSON(res);try{zm=map.getZoom();}catch(e){}
if(zm!==null&&zm<=6&&res){if(zm<=3){txt=res.pop();}else if(zm==4){txt=res.pop();if(txt=="North America"){txt=res.pop();}}else{if(res.length>=3){res.pop();}
txt=res.pop();if(res.length>=2&&zm==6){txt=res.pop();if(res.length>=2&&zm==6){txt=res.pop();}}}}else if(res){txt=res.shift();}
txt=txt.replace(/\.$/,'');if(txt&&_options.title){$('#masthead h1').text(txt);pt=document.title;pos=pt.lastIndexOf('-');if(window._config.locale=='en_ca'){document.title=txt+' '+pt.substring(pos);}}}
return res;}},_adjust_title=function(){var c=controls.length-1,pt=null;if(typeof window._config.maps.edit_title!=='undefined'&&window._config.maps.edit_title==true){window.maps_dataready=false;if(controls.length){for(;c>=0;c--){if(typeof controls[c].getCenterMarker=='function'){pt=controls[c].getCenterMarker();if(typeof(pt)=='string'){if(typeof ttls[pt]=='undefined'){ttls[pt]=1;ttks.push(pt);lastAjaxPtQuery=pt;__.a('/api/maps/title/'+pt,function(res){var d=_set_title(res);if(d){ttls[pt]=d;}},function(){});if(_options.banner){__.a('/api/bannertext/'+pt,function(res){_set_message(res);},function(){});}}else{if(lastAjaxPtQuery==pt){_set_title(ttls[pt]);}else{__.a('/api/maps/title/'+pt,function(res){var d=_set_title(res);if(d){ttls[pt]=d;}},function(){});if(_options.banner){__.a('/api/bannertext/'+pt,function(res){_set_message(res);},function(){});}}
lastAjaxPtQuery=pt;}
while(ttks.length>30){delete(ttls[ttks.shift()]);}}
break;}}}
setTimeout(_adjust_title,1500);}},_coverage=(function(){var self=this,_cz=-1,_nz=null,_region='',_regions={},_check_zoom=function(){if(_nz==null){_nz=map.getZoom();}
var r=false;if(_nz!=_cz){_cz=_nz;r=true;}
return r;},_reg_check=function(reg){var r='',p;if(reg){if(typeof _regions[reg]!='undefined'){r=reg;}else{if(reg.match(/^\w{2}_\w{2}$/i)){reg=reg.split('_')[1];for(p in _regions){if(p==reg){r=p;}else if(typeof _regions[p].cntry!='undefined'){var o='';for(o in _regions[p].cntry){if(o==reg){if(typeof _config.maps.regions[p].cntry[o].length=='number'&&_config.maps.regions[p].cntry[o].length==4){r=o;}else if(typeof _config.maps.regions[p].cntry[o].x1!='undefined'){r=o;}else{r=p;}}
if(r){break;}}}
if(r){break;}}}}}
return r;},_set_region=function(reg){reg=_reg_check(reg);if(reg&&typeof _regions[reg]!='undefined'){var r=_regions[reg];if(typeof r.x1=='undefined'){_region={x1:r[0],y1:r[1],x2:r[2],y2:r[3]};}else{_region={x1:r.x1,y1:r.y1,x2:r.x2,y2:r.y2};}
map.setBounds(_region);}
return _region;};self.check=function(){var c={},r=true;if(!_check_zoom()){c=map.getCenter()
if(!map.inBounds(c.lat,c.lng)){r=false;}}
return r;}
self.regions=function(reg){var r=_region;if(reg){if(typeof reg=='string'){r=_set_region(reg)}else{r=_regions=reg;}}
return r;}
return self;})();if(typeof window._config.maps.regions!='undefined'){_coverage.regions(window._config.maps.regions);}else{_coverage.regions({'na':[-167.0,70.0,-54.0,24.0],'eu':[-9.23,60.85,2.69,49.84]});}
_options.title=_config.maps.update_title;_options.refresh_ads=_config.maps.refresh_ads;_options.banner=_config.maps.banner;if(!(this instanceof Map)){return new Map();}
this.init=function(elm,opts){if(typeof Mapping.prototype.activeLib==='undefined'){throw"Mapping Library not set";return;}
map=Mapping([Mapping.prototype.activeLib],function(){});if(map){window.__m=map;this.map=map;var m_opt={width:728,height:400,apikey:'',lat:50.90987147201214,lng:-91.80003630603217,zoom:5};if(opts){for(prop in m_opt){if(typeof opts[prop]!=='undefined'){m_opt[prop]=opts[prop];}}}
var params=[];var query_string=document.URL.split('?')[1];if(typeof query_string!=='undefined'){query_string=query_string.split('&');for(var i=0;i<query_string.length;i++){param=query_string[i].split('=');if(param&&typeof param[0]!=='undefined'&&param[0]&&typeof param[1]!=='undefined'&&param[1]){params[param[0]]=param[1].replace("#","");}}
if(pelm_util.notEmpty(params['lat'])&&pelm_util.notEmpty(params['lng'])){m_opt['lat']=params['lat'];m_opt['lng']=params['lng'];}
if(pelm_util.notEmpty(params['zm'])){m_opt['zoom']=parseInt(params['zm']);}}
window._q.add(_auto_play,0);window._q.add(_auto_stop,1);if(elm){var el_img=document.getElementById('map_canvas');el_img.innerHTML='';this.map.setElement(elm).setOptions(m_opt).create();var dbl_zoom=(function(map){return function(){map.zoom(map.getZoom()+1);};}(this.map));var logCoverage=function(){_coverage.check();}
this.map.addMoveListener(logCoverage);if(typeof window._config.maps.edit_title!=='undefined'&&window._config.maps.edit_title==true){$('#weather-map .header-wrap').hide();var $ed_choice=jQuery('#editors_choice_news'),$curloc=jQuery('#current-location'),$main=jQuery('#main-content'),$breaking_news='<div id="map_breaking_news" class="breaking-news" style="display: none;"><span class=\'breaking\'>'+copy.news_break+'</span><a href=\'#\' class=\'map_headline hidden\'>Example Area</a><div>';if($ed_choice&&$ed_choice.length&&$ed_choice.length>0){$ed_choice.after($breaking_news);}else if($curloc&&$curloc.length&&$curloc.length>0){$curloc.after($breaking_news);}else if($main&&$main.length&&$main.length>0){$main.prepend($breaking_news)}
_adjust_title();}
$('#'+elm).on('click','img[src*=virtualearth]',function(){if(window.map_dbl_clk==true){dbl_zoom();window.map_dbl_clk=false;}else{window.map_dbl_clk=true;}
setTimeout(function(){window.map_dbl_clk=false;},250);});}
_coverage.regions(window._config.locale);}else{}
return map;};this.removeAll=function(){var cntrl=null;if(controls.length){while(cntrl=controls.pop()){try{var soft=undefined;cntrl.reset(soft);this.map.clearAll();}catch(ex){}
cntrl.active=false;}}};this.remove=function(item){return removeControl(item);};this.add=function(item,options){var res=false,_cntl;if(typeof item!=='undefined'&&typeof item.name==='function'){switch(item.name()){case'MapControl':res=addControl(item,options);if(typeof options==='undefined'||options==null){var options={};}
if(typeof item.type=='string'&&item.type=='radar'){if(typeof this.map!=='undefined'&&typeof this.map.map!=='undefined'){options.map=this.map;}}
options.icon=Module.getGlobal('image_url')+"icons/wxicons_medium/{icon}.png";options.icon_lrg=Module.getGlobal('image_url')+"icons/wxicons_medium/{icon}.png";res.active=true;res.init(options);break;}}else if(typeof item==='string'){_cntl=MapControl.factory(ucfirst(item),this.map);res=this.add(_cntl,options);}
return res;};};Module.MapMessage=function(){var self=this;self.tpl_main='map_messaging';self.visible=0;self.init=function(elm){self.element(elm);};self.check=function(){self.visible-=1;if(self.visible==0){$(self.element()).hide();}};self.update=function(ttl,msg,time){var d={title:'',message:''};if(typeof time!=='number'||isNaN(time)){time=3000;}else{time=Math.abs(parseInt(time));}
if(ttl&&msg){if(ttl!='skip'){d.title=ttl;}
d.message=msg.replace('&apos;','`');self.render(d);$(self.element()).show();self.visible+=1;setTimeout(self.check,time);}};};Module.MapConfirmation=function(){var self=this,_close=function(){};self.tpl_main='map_confirmation';self.visible=0;self.init=function(elm){self.element(elm);_close=function(){self.check();};};self.check=function(){self.visible-=1;if(self.visible==0){$(self.element()).hide().off('click','span');}};self.update=function(ttl,msg,suc,flr){var d={title:'',message:''},sucs=_close,cncl=_close;if(typeof flr=='function'){cncl=function(){flr();_close();};}
if(typeof suc=='function'){sucs=function(){suc();_close();};}
if(ttl&&msg){d.title=ttl;d.message=msg.replace('&apos;','`');self.render(d);$(self.element()).show().on('click','span',function(){if($(this).hasClass('confirm_save')){sucs();}else{cncl();}
return false;})
self.visible+=1;}};};Module.MapSearch=function(){var self=this,m=null,srcbox=null,_dr=0,_addClicks=function(elms){var i=elms.length-1,p,pos,t='',z=10;if(elms.length){for(;i>=0;i--){p=elms[i].getAttribute('data-pos');t=elms[i].getAttribute('data-type');txt=elms[i].innerHTML;if(p){pos=p.split(',');if(t=='province'){z=5;}
if(t=='country'){z=5;}
_event.add(elms[i],'click',(function(lat,lng,txt){return function(){m.go(lat,lng,z);if(srcbox){srcbox.value=txt;}
self.elm.className=self.elm.className+' off';};})(parseFloat(pos[0]),parseFloat(pos[1]),txt));}}}};self.changeDirection=function(dr){var dirs={down:0,d:0,dwn:0};_dr=1;if(typeof dirs[dr]!=='undefined'){_dr=dirs[dr];}}
self.tpl_main='citysearch';self.init=function(elm){var f=_config.locale.split('_')[1]=='ca'?document.getElementById('mapform'):null;if(elm){self.element(elm);return;}
if(!f){f=document.getElementById('searchform_home_map');if(f){f=f.parentNode;}}
if(f){srcbox=document.getElementById('search-city');var dvs=f.getElementsByTagName('ul');var i=dvs.length-1;for(;i>=0;i--){if(dvs[i].className=='map_suggestion_list off'){f=dvs[i];break;}}
if(f.tagName==='UL'){self.element(f);}}else{f=document.getElementById('searchform_home_map');if(f){f=f.parentNode;}
if(f){self.element(f);}}};self.setMap=function(map){if(typeof map!=='undefined'){m=map;}};self.fetch=function(v){if(v.length>2){if($('.map_suggestion_list_div').hasClass('hidden')){$('.map_suggestion_list_div').removeClass('hidden');}
var s_lat,s_lng;if((typeof window._user_config!="undefined")&&(typeof window._user_config=="object")&&(typeof window._user_config.lat!="undefined")&&(typeof window._user_config.lng!="undefined")){s_lat=parseFloat(window._user_config.lat).toFixed(4);s_lng=parseFloat(window._user_config.lng).toFixed(4);}else if((typeof window._config.lat!="undefined")&&(typeof window._config.lng!="undefined")){s_lat=parseFloat(window._config.lat).toFixed(4);s_lng=parseFloat(window._config.lng).toFixed(4);}
var mapSearchUrl='/api/locationsearch/index?searchType=city&search='+v+'&lat='+s_lat+'&long='+s_lng;$.get(mapSearchUrl,function(r){var i=0,a='',t=0,r=$.parseJSON(r);if($('html').hasClass('fullscreen-map')&&$("#search_map").length){$(".map_suggestion_list_div").css('left','0px');}else{$(".map_suggestion_list_div").removeAttr('style');}
if(r){for(i=r.length-1;i>-1;i--){if(typeof r[i]['type']!=='undefined'){a=r[i]['type'].substring(0,4)+'_type';r[i][a]=a;if(a=='coun_type'||a=='prov_type'){t=r[i].lat;r[i].lat=r[i].long;r[i].long=t;t=0;}}}
if(_dr){var _top=0;self.elm.parentNode.removeAttribute('style');if(r.length<11){_top=parseInt($(self.elm).parent().css('top').replace('px',''));_top+=30*(11-r.length);_top+='px';self.elm.parentNode.style.top=_top;}}
self.render({data:r});_addClicks(self.elm.getElementsByTagName('span'));self.elm.className=self.elm.className.replace('off','').replace(' ','');}});}else{jQuery(self.elm).addClass("off").empty();}};};Module.Map=function(){var self=this,m=Map(),_m=null,lyr_alrt=null,ntl={lat:null,lng:null,zm:null},init_h=0,initp={x:0,y:0},initc={lat:0,lng:0},_notrack=false,_options={refresh_ads:true},elms={dpad:null,zoomin:null,zoomout:null,zoominfullmap:null,zoomoutfullmap:null,twod:null,threed:null,road:null,aerial:null,labels:null,dirN:null,dirE:null,dirS:null,dirW:null,roadfullmap:null,aerialfullmap:null,dirNfullmap:null,dirEfullmap:null,dirSfullmap:null,dirWfullmap:null,myview:null,national:null,locate:null,refresh:null,save:null,open_search:null,open_settings:null,search_box:null,fscreen:null},_debug=false,debug=function(out,method){if(!_debug){return;}
method=typeof console[method]==='function'?method:'log';console[method](out);},_track=function(actn,val,sub,page){var prod='',sprod='',s,prod_ovr='',_fs=$('html').hasClass('fullscreen-map')?': full screen':'';if(typeof window.s!='undefined'){s=window.s;}
if(typeof window.s=='undefined'&&typeof s_pelm!='undefined'){s=s_pelm;}
sprod=false;switch(s.prop1){case'Forecasts':prod=': city page';sprod=true;break;case'14 Days':prod=': 14 day trend page';sprod=true;break;case'Hourly':prod=': hourly page';sprod=true;break;case'36 Hours':prod=': 36 hours page';sprod=true;break;case'lightning alert':prod=': lightning';sprod=true;break;case'cottage report':prod=': cottage report';sprod=true;break;case'School Day Forecast':prod=': school day';sprod=true;break;case'Flight Tracker':prod=': flight tracker';sprod=true;break;case'Ski':prod=': ski';sprod=true;break;case'golf report':prod=': golf';sprod=true;break;}
sprod=sprod?' forecasts: ':'';try{if(page){pelm.track.page('Maps','maps'+(sub?': '+sub:'')+_fs,window._config.site_prefix+prod+': maps: '+actn+(val?': '+val:'')+_fs);if(dataLayer){var gtm_actn=actn;gtm_actn=gtm_actn.replace('select layer: ','');dataLayer.push({'event':'VirtualPageview','vpvProduct':'maps','pageName':'vpv: maps'+(_fs?_fs:'')+(gtm_actn?': '+gtm_actn:''),'vpvName':'maps'+(_fs?_fs:'')+(gtm_actn?': '+gtm_actn:'')});}}else{prod=prod.replace(': ','');if(prod){prod+=': ';}
pelm.track.link(sprod+'maps: '+actn+(val?': '+val:''),prod+'maps: '+actn+(val?': '+val:''),null);debug(window._config.site_prefix+prod+sprod+': maps: '+actn+(val?': '+val:''),'info');debug(prod.replace(': ','')+': maps: '+actn);}}catch(ex){debug("Error: tracking failed");}},_class=function(e){var elm=e.target||e.srcElement,ec=elm.className.replace(/active/g,'').replace(/^\s+|\s+$/g,''),sibs=getSiblings(elm),el=null;while(el=sibs.pop()){var rg=new RegExp(ec);if(rg.test(el.className)){el.className=el.className.replace(/active/g,'').replace(/^\s+|\s+$/g,'');}}
elm.className=elm.className+' active';},_locate=function(no_track){if(typeof no_track=='undefined'){_track('home: '+'locate','','locate',true);}
var z=9;var sess=_session.fld('pelm_gps'),ip_detect=_session.fld('pelm_ip');var handleGPS=function(position){if(position){_m.go(position.lat,position.lng,z)}else{}};gps.locate_lookup(handleGPS);_refreshAd();return false;},_refreshAd=function(){if(typeof currentad!=='undefined'){if(document.body.getAttribute('id')!='adtakeover'){}}},_refresh=function(){var mu=_session.fld('pelm_map');_track('home: '+'refresh','','refresh',true);if(mu){mu=eval('('+mu+')');_m.go(mu.lat,mu.lng,mu.zm);}else{msngr_cfm.update(copy.homeview_notsaved,copy.homeview_msg,_save,_cancel);}
_refreshAd();return false;},_save=function(){var z=_m.getZoom(),s=_m.getCenter();s.zm=z;s.al=0;if(lyr_alrt){s.al=lyr_alrt==-1?0:1;}
_session.save_cookie('pelm_map',JSON.stringify(s));msngr.update('\n',copy.homeview_saved)
_track('change map content','save');return false;},_cancel=function(){msngr.update('\n',copy.homeview_notsaved)},_sub_navs=[],_close_subnavs=function(_id){var el,els;if(_sub_navs.length<1){els=$('ul.map-subnav:not(#'+_id+')');if(els.length){_sub_navs=els;}}
if(_sub_navs.length){_sub_navs.addClass('hidden');}
_sub_navs=[];},_open_menu=function(_id){_close_subnavs(_id);var elm=document.getElementById(_id),ex='map-subnav';if(elm){if($('.map_suggestion_list_div').hasClass('hidden')){$('.map_suggestion_list_div').removeClass('hidden');}else{$('.map_suggestion_list_div').addClass('hidden');}}},_open_search=function(){_open_menu('map_open_search');},_open_settings=function(){_open_menu('map_open_settings');},_remove_active_class=function(){$(".map-views .active").removeClass('active');},_srchcity=null,srchcity=null,srchcitylwr=null,_search_box=function(){if(_srchcity){if(_srchcity.val()!=_srchcity.prev('label').text()){_srchcity.trigger('keyup');}}
return false;},_slctr=null,_legend_controls=null,_legend_controls_sub=null,_showhideControls=function(name){if(name){_legend_controls.className='map_legend_'+name;_legend_controls_sub.className='map_legend_'+name;$(_legend_controls).addClass('map_legend_'+name);$(_legend_controls_sub).addClass('map_legend_'+name);}},msngr_cfm=null,msngr=null,_search_set=function(vr,gbl,slct,rev){if(window.templates.citysearch){if(vr){gbl=Module.factory('MapSearch');gbl.init(slct||null);gbl.setMap(_m);if(rev){gbl.changeDirection();}
vr.on('keyup',function(){var $input=$(this);var clearSearchThrottle=function(){clearTimeout(window.mapSearchThrottle);delete window.window.mapSearchThrottle;}
var doThrottledSearch=function(){var v=$input.val()
dataLayer.push({'event':'eventTracker','eventCategory':window._config.ga_product,'eventAction':"clicks",'eventLabel':"maps | "+v});gbl.fetch(v);}
clearSearchThrottle();window.mapSearchThrottle=setTimeout(doThrottledSearch,200);});}}else{MapControl.prototype.loadTemplate('citysearch','web/maps');setTimeout(function(){_search_set(vr,gbl,slct,rev);},500);}
return gbl;},_message_set=function(type,elm,vr){if(type=='message'){if(typeof window.templates.map_messaging!='undefined'&&typeof window.templates.map_messaging.length!='undefined'&&!window.templates.map_messaging.length){}
if(window.templates.map_messaging){msngr=Module.factory('MapMessage');if(msngr){msngr.init(elm);msngr.update(copy.loading,copy.wait);MapControl.prototype.notification=msngr.update;}}else{MapControl.prototype.loadTemplate('map_messaging','web/maps');setTimeout(function(){_message_set(type,elm,vr);},500);}}else if(type=='confirm'){if(window.templates.map_confirmation){msngr_cfm=Module.factory('MapConfirmation');if(msngr_cfm){msngr_cfm.init(elm);msngr_cfm.update(copy.loading,copy.wait,_save);}}else{MapControl.prototype.loadTemplate('map_confirmation','web/maps');setTimeout(function(){_message_set(type,elm,vr);},500);}}},setup=function(elm){var noop=function(){return false;},f=noop,slctr=$("#map-selector"),slctrfullmap=$('#map-selector-fdivlmap input[name="maptype"]'),srchcity=$("#search-city"),srchcitylwr=$("#search_footer_map"),srch=null,srchlwr=null,alrts=$("#map-alerts"),titleElmFeatured=$('#map-view .header h2'),titleElm=$('#map-report-content .header h2'),msgbox=$("#map_messaging"),msgcnfrm=$("#map_confirmation"),ntnl=$('#map-national'),origmaplayer=$("#orig_map_layer");origmaplayerwebgl=$("#orig_map_layerwebgl");_legend_controls=$('#map_legend_controls')[0];_legend_controls_sub=$('#map_sublegend_box')[0];if(titleElmFeatured&&typeof(window._config.setmaptitle)!=="undefined"&&window._config.setmaptitle){titleElm=titleElmFeatured;}
$('.controls li,.controls input,.map li,.map input',elm).each(function(){var hr=$(this).attr('data-action');if(hr){hr=hr.split('#').pop();$(this).removeAttr('data-action');if(elms[hr]===null){elms[hr]=$(this);}}});var _ntlmap=_session.fld('map_ntl');for(prop in elms){if(elms[prop]){switch(prop){case'dirN':case'dirE':case'dirS':case'dirW':f=(function(map,prop){var d=prop.charAt(3);return function(){map.moveScreen(d);window.mapmoved=true;_track('change map content','pan');return false;};})(m.map,prop);break;case'zoomin':f=(function(map){return function(){map.zoom(map.zoom()+1);_track('change map content','zoom in');return false;};})(m.map);break;case'zoomout':f=(function(map){return function(){map.zoom(map.zoom()-1);_track('change map content','zoom out');return false;};})(m.map);break;case'national':f=function(e){_track('home: '+'national','','national',true);if(ntl.lng!==null&&ntl.lat!==null&&ntl.zm!==null){_m.go(ntl.lat,ntl.lng,ntl.zm);}
_refreshAd();return false;};break;case'myview':f=function(e){_class(e);var z=9;var sess=_session.fld('pelm_gps'),ip_detect=_session.fld('pelm_ip');if(sess){sess=eval('('+sess+')');if(typeof sess.long!=='undefined'){_m.go(sess.lat,sess.long,z);}}else if(ip_detect){ip_detect=eval('('+ip_detect+')');if(typeof ip_detect.lng!=='undefined'){_m.go(ip_detect.lat,ip_detect.lng,z);}}};if(_ntlmap!=1){$(elms[prop]).removeClass('active');}
break;case'twod':case'threed':case'road':case'aerial':f=(function(map,prop){return function(e){_class(e);window.map.setOptions({maptype:prop});if(!window.mapmoved){window.mapmoved=true;}
_track('change map content',(prop=='twod'?'2d':(prop=='threed'?'3d':prop)));return false;};})(m.map,prop);break;case'labels':f=(function(map){return function(){var o=map.toggleLabels();return false;};})(m.map);break;case'locate':f=_locate;break;case'refresh':f=_refresh;break;case'save':f=_save;break;break;case'open_search':f=function(){_open_search();var rst=$(this).hasClass('active');_remove_active_class();if(!rst){$(this).toggleClass('active');}};break;case'open_settings':f=function(){_open_settings();var rst=$(this).hasClass('active');_remove_active_class();if(!rst){$(this).toggleClass('active');}};break;case'search_box':f=_search_box;break;case'fscreen':window._config.maps.fson=false;if($("#map-view").length){window._config.maps.fson=true;}
f=function(){if(window._config.maps.fson){var ct=$("#map-view");if(ct.length){var tlel=ct.find('.map-view .tools .showhide');if(tlel.hasClass('expand')){tlel.click();setTimeout(function(){window._config.maps.fson=false;},3000);}else if(tlel.css('background-position')=='0px -46px'){window._config.maps.fson=false;setTimeout(function(){$('.icon-full-screen').click();},500);}else{window._config.maps.fson=false;}}}
window._config.maps.fson=true;fscreen();setTimeout(function(){window._config.maps.fson=false;},2000);}
break;}
if(typeof f=='function'){elms[prop].click(f);}
f=noop;}}
if($('#searchform_home_map').length){$('#searchform_home_map').submit(function(){_search_box();return false;}).focus(function(){return false;}).click(function(){return false;});srchcity=$('#search_map');var handleMapSearchDocumentClick=function($event){if($event.currentTarget!==srchcity){srchcity.val("").trigger("keyup").blur();clearDocumentClickListener();}};var clearDocumentClickListener=function(){$(document).off("click",handleMapSearchDocumentClick);};srchcity.focus(function(){clearDocumentClickListener()
$(document).on("click",handleMapSearchDocumentClick);return false;}).click(function(){return false;});}
if(origmaplayer.length){if(self.checkallowedpages()===true&&!$('html').hasClass('fullscreen-map')){if(_session.fld('make_orig_default')==1){origmaplayer.prop('checked',true);origmaplayerwebgl.prop('checked',true);$(".msg_map_default_saved").show();}
origmaplayer.on("click",function(){if(origmaplayer.is(":checked")){if(_session.fld('make_orig_default')!=1){_session.save_cookie("make_orig_default",1);}
$(".msg_map_default_saved").show();origmaplayerwebgl.prop('checked',true);}else{_session.delete_cookie('make_orig_default','/');$(".msg_map_default_saved").hide();origmaplayerwebgl.prop('checked',false);}});}else{$('#feedback_wrapper').hide();}}
if(origmaplayerwebgl.length){if(window._config.locale.split('_')[1]=='gb'){$('#feedback_wrapper').hide();}else{if(self.checkallowedpages()===true&&!$('html').hasClass('fullscreen-map')){if(_session.fld('make_orig_default')==1){origmaplayerwebgl.prop('checked',true);origmaplayer.prop('checked',true);$(".msg_map_default_saved").show();}
origmaplayerwebgl.on("click",function(){if(origmaplayerwebgl.is(":checked")){if(_session.fld('make_orig_default')!=1){_session.save_cookie("make_orig_default",1);}
$(".msg_map_default_saved").show();origmaplayer.prop('checked',true);}else{_session.delete_cookie('make_orig_default','/');$(".msg_map_default_saved").hide();origmaplayer.prop('checked',false);}});}else{$('#feedback_wrapper').hide();}}}
if(slctr.length){_slctr=slctr;if(slctr[0]){var _opts=Function("return "+elm.getAttribute('data-param')+"")();if(_opts&&_opts.type){for(var i=0;i<slctr[0].options.length;i++){if(slctr[0].options[i].value==_opts.type){slctr[0].selectedIndex=i;$('#uniform-map-selector span:first-child').html(slctr[0].options[i].label);break;}}}}
setTimeout(function(){$('#map-selector').css('width','100%');},2000);slctr.change(function(){$('.map_companion_layer').unbind('click');var param_elm=$(':selected',slctr),param={},ttl='',cl='',val=slctr.val(),lbl=$(this).find("option:selected").text();if(val){$('#feedback_wrapper').hide();$('#beta_wrapper').hide();if(val=='satradwebgl'){var webglcheckflag=(_session.fld('webglsupported')&&_session.fld('webglsupported')==1)||mapwebglchecker.init();if(!webglcheckflag){msngr=Module.factory('MapMessage');if(msngr){msngr.init($("#map_messaging"));msngr.update('skip',copy.webgl_not_supported,5000);}}else{if(!$('html').hasClass('fullscreen-map')){$('#feedback_wrapper').show();if(!self.checkallowedpages()){$('#feedback_wrapper .default_map_layer').hide();}}}}
if(val.match(/^\//)&&location.href.indexOf('farmzone=1')==-1){if(val.match(/#/)){window.location.href=val.replace('#','');return;}
if(val=='/map/radar'||val=='/map/satellite'||val=='/carte/radar'||val=='/carte/satellites-radars'){window.location.href=(typeof window._config.domain_countrycode!=='undefined'?"/"+window._config.domain_countrycode:'/ca')+val;return;}
if(_config.maps.url){window.location.href='/'+_config.maps.url+val;return;}}
if(param_elm.length>0){param_elm=param_elm[0];if(titleElm&&param_elm.innerHTML){ttl=param_elm.innerHTML;if(ttl!=="Highway Forecast"){if(cityName!==undefined&&cityName){if(ttl.indexOf("(")!=-1){var ttlArray=[];ttlArray=ttl.split("(");ttl=ttlArray[0];}
if(ttl==="Flood Warnings"||ttl==="Weather Warnings"){ttl+=" "+window._config.mapTxt;}else{ttl+=" "+window._config.mapTxt+' '+window._config.forTxt+" "+cityName;}}}
if(ttl.length>15){cl='small';}
titleElm.html(ttl.replace('(',"<sub style='bottom:0;font-size: 10px;'>(").replace(')',")</sub>"));titleElm.removeClass('small').addClass(cl);}
param=param_elm.getAttribute('data-param');if(typeof msngr!=='undefined'&&msngr){msngr.update(copy.loading,titleElm.text());}
param=$.parseJSON(param);if(typeof val!='undefined'&&val!=null&&val!=""){var
satrad_subtype='',contElem=$('#map-report-content'),omni=val,os=val;if(param&&typeof param.omni!=='undefined'){omni=param.omni;os=omni;if(typeof param.omnis!=='undefined'){os=param.omnis;}}
if(window._config.locale.split('_')[1]=='ca'&&s_pelm.prop1=='Maps'){$('#masthead #h1_title').html(param.maptitle);$("h1").textfill(42);}
if(window._config.locale.split('_')[1]!='ca'){$("#map_legend_controls").hide();$("#map_sublegend_box").hide();$("#map_common_box").hide();$("#alerts_legend_controls").hide();$("#alerts_uk_regions").hide();$("#alerts_de_regions").hide();$("#flood_warnings_summary").hide();if(val=='ushighwayforecast'){contElem.removeClass('ushwy-map').addClass('ushwy-map');$("#map_legend_controls").show();$("#map_sublegend_box").show();$("#map_common_box").show();}else if(val=='alerts'){$("#alerts_legend_controls").show();$("#alerts_uk_regions").show();$("#alerts_de_regions").show();}else if(val=='floodwarnings'){$("#flood_warnings_summary").show();}else if(val=='satrad'){$("#map_legend_controls").show();$("#map_sublegend_box").show();}else if(val=='satradwebgl'){$("#map_legend_controls").show();$("#map_sublegend_box").show();}else{contElem.removeClass('ushwy-map');}}
if(param&&typeof param.type!=='undefined'){satrad_subtype='/'+param.type;}}}
if(slctr.data('no_track')&&slctr.data('no_track')===true){_notrack=true;}else{dataLayer.push({'event':'eventTracker','eventCategory':window._config.ga_product,'eventAction':"clicks",'eventLabel':"maps"+(lbl?" | "+lbl:"")});}
self.loadLayer(val,param);if(val=='satrad'||val=='satradwebgl'){val=param_elm.id.replace('fsdp_','');}
if($('#fssd_'+val).length){$(slctrfullmap).removeAttr('disabled');$('#fssd_'+val).attr('checked','checked').attr('disabled','disabled');}}});}
if(slctrfullmap.length){$(slctrfullmap).on("click",function(){$(slctrfullmap).removeAttr('disabled');var id=this.id,vl;if(id){vl=id.replace('fssd_','');if(vl){if(this.value=='satrad'){$('#fsdp_'+vl).attr('selected','selected');}else{slctr.val(vl);}
$(slctr).trigger('change');_track('full screen flyout','select layer');this.disabled='disabled';}}});}
if(alrts){alrts.attr('checked',false);alrts.change(function(){var stat='-';if(typeof alrts.attr('checked')==='string'){stat='on';lyr_alrt=self.loadLayer(alrts.val(),{'map_callback':function(id){lyr_alrt=id;},infobox:false},true);}else{stat='off';self.removeLayer(lyr_alrt);lyr_alrt=-1;}
return false;});}
if(ntnl){ntnl.attr('checked',false);ntnl.change(function(){if(typeof ntnl.attr('checked')==='string'){if(ntl.lng!==null&&ntl.lat!==null&&ntl.zm!==null){_m.go(ntl.lat,ntl.lng,ntl.zm);}}});}
if(srchcity){_search_set(srchcity,srch,null);_srchcity=srchcity;}
if(srchcitylwr){srchlwr=_search_set(srchcitylwr,srchlwr,$('#searchform_footer_map + .map_suggestion_list_div ul')[0],true);$('#searchform_footer_map input[type=image]').click(function(){return false;})}
if(msgbox){_message_set('message',msgbox,msngr);}
if(msgcnfrm){_message_set('confirm',msgcnfrm,msngr_cfm);}},cityName=null;_options.refresh_ads=_config.maps.refresh_ads;self.urlbase='maps/';self.tpl=window.templates;self.listen=function(pc,cb){pelm.package.listen(this.urlbase+this.urltype+'/'+(pc||''),cb);};self.loadLayer=function(name,options,keep,fullmap){var id=null;if(typeof keep=='undefined'||!keep){m.removeAll();}
if(!options){options={};}
if(m&&typeof name=='string'){require([window._config.platform+'/modules/map/'+name],function(module){var omni=name,os='';if(module){m.map.deactivateTrafficLayer();MapControl=module;if(!keep){_showhideControls(name);}
if(name==='satrad'){if(options&&typeof options.type!=='undefined'&&options.type=='past'){name='radar';}}
if(options&&typeof options.omni!=='undefined'&&options.omni!==''){omni=options.omni;os=omni;if(typeof options.omnis!=='undefined'&&options.omnis!==''){os=options.omnis;}}
if(!_notrack){_track('select layer: '+omni,'',os,true);}
_notrack=false;$("#map-selector").data('no_track',false);id=m.add(name,options);self.setRelevantLayers(name,options);if(typeof options.map_callback=='function'){options.map_callback(id);}
if((typeof window._config.nomapadrefresh!=="undefined")&&(window._config.nomapadrefresh)){}else{if(_options.refresh_ads){processDFP.refreshad('maps/'+name);}}
window.mapmoved=true;if($('html').hasClass('fullscreen-map')){setTimeout(function(){$(window).trigger('debouncedresize');},750);}}});}
return id;};self.removeLayer=function(id){if(id){m.remove(id);}};self.isLayerActive=function(id){};self.urltype='';self.tpl_main='';self.setRelevantLayers=function(name,params){var rlvnt=[],rL=0,idx=0,lyr='',_opts={},rlayers={},_fn=false,type='';if(name=='radar'){name='satrad';}
if(params&&typeof params.type!='undefined'&&params.type){name+='-'+params.type;}
if(name=='satrad'){name+='-forecast';}
if(_slctr){if(typeof _slctr[0].options!='undefined'){var slct=_slctr[0].options,sL=slct.length,i=0;for(var ltyp='',val='';i<sL;i++,ltyp=''){if(!slct[i].value){continue;}
_opts=Function("return "+slct[i].getAttribute('data-param')+"")();ltyp=_opts.type?'-'+_opts.type:'';val=slct[i].value+ltyp;if(!rlayers[val]){rlayers[val]=[]}
rlayers[val].push(i);if(!_fn&&val==name){if(_opts.rel){_slctr[0].selectedIndex=i;rlvnt=_opts.rel.split(',');if(rlvnt[0].match(/^#/)){rlvnt=rlvnt[0];rL=-1;break;}else{rL=rlvnt.length;}}
_fn=i;}}}}
if(rL){var btnTxt='';if(rL>=1){idx=Math.floor(Math.random()*rL);lyr=rlvnt[idx];if(typeof lyr!='undefined'&&typeof rlayers!='undefined'&&typeof slct[rlayers[lyr][0]]!='undefined'){btnTxt=slct[rlayers[lyr][0]].innerHTML;}}else if(rL==-1){lyr=rlvnt.split('|')[0];btnTxt=rlvnt.split('|')[1];}
$('.map_companion_layer').click(function(){if(lyr.match(/^#/)){window.location.href=lyr.replace('#','');return;}
$('.map_companion_layer').unbind('click').hide();if(_slctr[0].options[rlayers[lyr]]){_slctr[0].options[rlayers[lyr]].selected='selected';try{_slctr.trigger('change');}catch(ex){_slctr.trigger('change');}}}).css({cursor:'pointer'}).html(btnTxt).show();}}
self.checkallowedpages=function(){if($(location).attr('pathname').indexOf("/maps/")>=0||window._config.locale.split('_')[1]=='gb'){return false;}
if(!(typeof window._config!='undefined'&&typeof window._config.webgl_default!='undefined'&&window._config.webgl_default==true)){return false;}
return true;}
self.init=function(o){debug('Maps is Initializing!!!!');var webglcheckflag=(_session.fld('webglsupported')&&_session.fld('webglsupported')==1)||mapwebglchecker.init();var use_ip=true,cw_ielt9=window._config.maps.cw_ielt9||6;if(typeof self.template_manager!=='undefined'){MapControl.prototype.loadTemplate=self.template_manager.load;}else if(typeof window._Module.prototype.template_manager!=='undefined'){MapControl.prototype.loadTemplate=window._Module.prototype.template_manager.load;}
if(typeof MapControl!=='undefined'){MapControl.prototype.track=_track;MapControl.prototype.sess=_session;}
if(typeof o=='undefined'||typeof o.elm=='undefined'){elm=document.getElementById('weather-map');if(!elm){elm=document.getElementById('map-report-content');}
if(!elm){elm=document.getElementById('map-view');}}else{elm=o.elm;}
self.element(elm);var opts=elm.getAttribute('data-param');if(opts){o=eval('('+opts+')');}
var options={fs:false},pagedefined=false;;var opts_avail={lat:0,lng:0,zoom:0,apikey:'',width:0,height:0,fs:false};var sess=_session.fld('pelm_gps'),ip_detect=_session.fld('pelm_ip');if(window._config){for(prop in opts_avail){if(typeof window._config[prop]!='undefined'&&typeof options[prop]=='undefined'){options[prop]=window._config[prop];}}
if(window._config.maps){for(prop in opts_avail){if(typeof window._config.maps[prop]!='undefined'){options[prop]=window._config.maps[prop];if(prop=='lat'||prop=='lng'){pagedefined=true;}
if(prop=='zoom'){if(typeof window._config.maps[prop].slice=='function'){options[prop]=window._config.maps[prop].pop();}}}}}
if(typeof window._config.maps.geoip!=='undefined'){use_ip=window._config.maps.geoip;}}
if(typeof window._config.placecode=='undefined'&&!pagedefined&&typeof window._config.maps.nop=='undefined'){if(sess){sess=eval('('+sess+')');sess.zoom=9;if(typeof sess.long!=='undefined'){sess.lng=sess.long;}
for(prop in sess){if(typeof sess[prop]!='undefined'){options[prop]=sess[prop];}}}else if(ip_detect&&use_ip){var currentUrl=window.location.pathname;var isHomeMap=currentUrl.indexOf(_config.maps.url);var localeCountry=window._config.locale;localeCountry=localeCountry.split('_')[1].toUpperCase();if(window._user_config.country!==localeCountry&&isHomeMap===-1){options.lat=window._config.maps.ntl_lat;options.lng=window._config.maps.ntl_lng;options.zoom=window._config.maps.ntl_zm;}else{ip_detect=eval('('+ip_detect+')');ip_detect.zoom=9;if(typeof ip_detect.long!=='undefined'){ip_detect.lng=ip_detect.long;}
for(prop in ip_detect){if(typeof ip_detect[prop]!='undefined'){options[prop]=ip_detect[prop];}}}}
var _mu=_session.fld('pelm_map');if(_mu&&window.location.pathname=='/'){_mu=eval('('+_mu+')');if(_mu){options.lat=_mu.lat;options.lng=_mu.lng;options.zoom=_mu.zm;}}}
var _tmp_o=[];if(_session.fld('map_back_alert')&&typeof window._config.fullmap_maptype!=='undefined'){_tmp_o=_session.fld('map_back_alert').split(':');options.zoom=(typeof _tmp_o[3]!=='undefined')?parseInt(_tmp_o[3]):options.zoom;}else if(_session.fld('map_back')){_tmp_o=_session.fld('map_back').split(':');}
_session.save_cookie_shrt('map_back_alert',"",-1);if(_tmp_o.length>=2){options.lat=_tmp_o[0];options.lng=_tmp_o[1];o.type=_tmp_o[2]?_tmp_o[2]:o.type;}
if(window.mapmoved=='geo'){window.mapmoved=false;}
if(o.type=='regional'&&(document.getElementsByTagName('html')[0].className.match('lt-ie9')||navigator.userAgent.match(/iPod|iPhone|iPad/))){if(options['zoom']>cw_ielt9){options['zoom']=cw_ielt9;}}
var _ntlmap=_session.fld('map_ntl');if(window._config.maps.ntl_lat&&window._config.maps.ntl_lng&&window._config.maps.ntl_zm){ntl.lat=window._config.maps.ntl_lat;ntl.lng=window._config.maps.ntl_lng;ntl.zm=window._config.maps.ntl_zm;}
var fshght=null;if(document.body.className.match('fullscreen-map')){var mcns_o=null;mcns_o=$('#main-content').offset();if(mcns_o.top){fshght=$(window).height()-mcns_o.top-55;}}
var mcns_o=null;if(options.width==='auto'||fshght){var style='';if(!window.getComputedStyle){style=elm.currentStyle;}else{style=window.getComputedStyle(elm,null);}
if(style){var nw=style.width.replace('px',''),nh=style.height.replace('px','');if(nw){options.width=nw;}
if(fshght){options.height=fshght;$('#map_canvas').css({height:fshght});}else{var max_height=(document.documentElement.clientHeight||window.innerHeight||document.body.clientHeight)/2;if(nh&&nh>=max_height){options.height=nh;}else{options.height=max_height;}}
var myNav=navigator.userAgent.toLowerCase();var myBrowserType=(myNav.indexOf('msie')!=-1)?parseInt(myNav.split('msie')[1]):false;if(myBrowserType==8){document.getElementById('map_canvas').setAttribute("style","height:"+options.height+"px");}}}
if(window._config.fullmap_maptype=='alerts'){options.zoom=3;}
var oheight=0;_m=m.init('map_canvas',options);if(fshght!='undefined'){require(['lib/jquery.debouncedresize'],function(debouncedresize){$(window).on("debouncedresize orientationchange",function(){if($("#map_clk_opn:visible").length!=0){return;}
var cntr=initc,html=$('html');if(!html.hasClass('fullscreen-map')){if(init_h){$('#map_canvas').height(init_h);}
$('.map-content').removeAttr('style');if(initp.x||initp.y){scroll(initp.x,initp.y);}
if(initc.lat*initc.lng){setTimeout(function(){__m.go(cntr.lat,cntr.lng);},250);initc={lat:0,lng:0}}
return;}
var small=false;scroll(0,0);mcns_o=$('#main-content').offset();if(mcns_o!=undefined){fshght=$(window).height()-mcns_o.top-55;fswdth=$(window).width();html.removeClass('fssublgd');if(fswdth<=1024){small=true;}
options.width=fswdth;options.height=fshght;var lgh=$("#map_legend_controls").height()-10;var slgh=$("#map_sublegend_box").height()-5;var lgw=1427;if(!$("#map_sublegend_box").height()){lgw-=$("#map_sublegend_box").width();}
if(!small&&fswdth<lgw){small=true;}
var fsflyout=$("#map_full_control");var offsetval=(fsflyout.offset())?fsflyout.offset().top:0;var flyhgt=fsflyout.height()+offsetval;if(slgh<=0){html.addClass('fssublgd');}
lgh=(lgh>slgh?lgh:slgh);if($("#map-view").length){lgh-=4;}
var legend_trim=50;if(location.href.indexOf('farmzone=1')!=-1){legend_trim=-10;}
$(".map-content,#map_canvas").css('height',fshght-20+8-lgh+legend_trim);html.removeClass('fsnofly');if((fshght-20+8-lgh)<flyhgt){html.addClass('fsnofly');}
if(typeof google!=='undefined'&&typeof google.maps!=='undefined'&&__m&&__m.map){setTimeout(function(){google.maps.event.trigger(__m.map,'resize');scroll(0,0);if(initc.lat*initc.lng){setTimeout(function(){__m.go(cntr.lat,cntr.lng);},100);initc={lat:0,lng:0}}},250);}}});});}
var params={};var allow_sess=true;if(sess){allow_sess=typeof sess.zoom=='undefined'?true:false;}
if(allow_sess&&ip_detect&&typeof ip_detect.zoom=='undefined'&&!pagedefined){params.pagedefined=!pagedefined;}
params.lat=options.lat;params.lng=options.lng;var _cur_name='satrad';if(webglcheckflag&&self.checkallowedpages()===true&&!(_session.fld('make_orig_default')&&_session.fld('make_orig_default')==1)){_cur_name='satradwebgl';}
var $slctr=$("#map-selector");if(!(typeof o=='undefined'||typeof o.type=='undefined')){switch(o.type){case'satrad':if(window.location.href.indexOf("us-highway-forecast")>-1||window.location.href.indexOf("previsions-routieres-americaines")>-1){o.type='ushighwayforecast';o.fullmap_showhide=false;params={fullmap_showhide:false};}
break;case'rader':case'radar':o.type='satrad';params={type:'past'};break;case'cloudcover':o.type='satrad';params={type:'cloud'};break;case'forecast':o.type='satrad';params={type:'forecast'};break;case'satrad':if(webglcheckflag&&self.checkallowedpages()===true&&!(_session.fld('make_orig_default')&&_session.fld('make_orig_default')==1)){o.type='satradwebgl';}
break;case'satradwebgl':if(!webglcheckflag){msngr=Module.factory('MapMessage');if(msngr){msngr.init($("#map_messaging"));msngr.update('skip',copy.webgl_not_supported,5000);}}
break;}
var _cur_name=o.type;if(typeof window._config.fullmap_submaptype!=='undefined'){params={type:window._config.fullmap_submaptype};}else if(typeof _tmp_o[3]!=='undefined'&&_tmp_o[3]!==''){params={type:_tmp_o[3]};}
require([window._config.platform+'/modules/map/'+o.type],function(module){MapControl=module;MapControl.prototype.track=_track;MapControl.prototype.sess=_session;m.add(o.type,params);if($slctr&&_cur_name=='satradwebgl'&&self.checkallowedpages()===true){$slctr.val(_cur_name);$("#uniform-map-selector span:first-child").html($slctr.children("option:selected").text());}
self.setRelevantLayers(o.type,params);});}else{require([window._config.platform+'/modules/map/'+_cur_name],function(module){MapControl=module;MapControl.prototype.track=_track;MapControl.prototype.sess=_session;m.add(_cur_name,params);if($slctr&&_cur_name=='satradwebgl'&&self.checkallowedpages()===true){$slctr.val(_cur_name);$("#uniform-map-selector span:first-child").html($slctr.children("option:selected").text());}
self.setRelevantLayers(_cur_name);});}
if(webglcheckflag&&self.checkallowedpages()===true&&_cur_name=='satradwebgl'){$('#feedback_wrapper').show();$('#beta_wrapper').show();}
if(typeof params.type!=='undefined'){$.each($("#map-selector option"),function(){var map_layer=$(this).attr('data-param'),map_layer_options={};if(typeof map_layer!=='undefined'){map_layer_options=$.parseJSON(map_layer);if(typeof map_layer_options.type!=='undefined'){if(map_layer_options.type==params.type){$('#map-report-content .header h2').html($(this).text());return false;}}}});}
var fullmap_init_url=window._config.fullmap_back_url;if(typeof _tmp_o[4]!=='undefined'&&_tmp_o[4]!==''){fullmap_init_url=_tmp_o[4];}
if(typeof o.fullmap_showhide!=='undefined'&&o.fullmap_showhide==1){$("li.fullmap-interactive").show();}else{$("li.fullmap-interactive").hide();}
if(m){setup(elm);if(_legend_controls){_showhideControls(_cur_name);}
if(window.location.pathname=='/'&&navigator.userAgent.match(/(iPod|iPhone|iPad);.*CPU.*OS 7_0/i)){var ckie=_session.fld('pelm_mios');if(!ckie){_session.save_cookie('pelm_mios',1);msngr.update('\n',copy.ios7_msg,7000);}}
if(navigator.userAgent.match(/(iPod|iPhone|iPad)/i)){$(".map-content").addClass('nofs');}}
var query_string=document.URL.split('?')[1];if(typeof query_string!=='undefined'&&query_string.indexOf('show_fs=1')!==-1){elms['fscreen'].click();}
if(typeof query_string!=='undefined'&&query_string.indexOf('farmzone=1')!==-1){setTimeout(function(){fscreen();},1000);var controls=document.getElementById("map_legend_controls")
controls.style.left="0";controls.style.top="77px";controls.style.position="relative";var appBanners=document.getElementsByClassName('map-views'),i;for(i=0;i<appBanners.length;i+=1){appBanners[i].style.display='none';}
document.getElementById('fssd_highwayforecast').parentNode.style.display='none';document.getElementById('fssd_trafficflow').parentNode.style.display='none';document.getElementById('fssd_alerts').parentNode.style.display='none';document.getElementById('fssd_lightning').parentNode.style.display='none';$('.noMobile').hide();var mapad=document.getElementById('mapad');mapad.parentNode.removeChild(mapad);}};var checkMapFSPos=function(rmv){var mp=$(".map"),cnt=$(".map-content .controls"),d=mp.offset().top,t=38;if(d<0){t-=d;cnt.attr('style','top: 0 !important;position:fixed;');}
if(typeof rmv!=='undefined'){mp.removeAttr('style');cnt.removeAttr('style');}}
window.mapexpandfix=function(){setTimeout(function(){if(typeof window._config.lat!=='undefined'&&typeof window._config.lng!=='undefined'&&__m){__m.go(window._config.lat,window._config.lng);google.maps.event.trigger(__m.map,'resize');}},1000);}
window.fscreen=self.toggleFullScreen=function(){var isfs=$('html').hasClass('fullscreen-map'),elm=null,txt='',ic=$("i.icon-full-screen"),icp=ic.parent('a'),omniact='',myNav=navigator.userAgent.toLowerCase(),isie=(myNav.indexOf('msie')!=-1)||(myNav.indexOf('trident')!=-1);initc=__m.getBounds();initc.lng=(initc.x1+initc.x2)/2;initc.lat=(initc.y1+initc.y2)/2;if(!init_h&&!isfs){init_h=$('#map_canvas').height();initp={x:window.scrollX,y:window.scrollY};}
elm=$('html').toggleClass('fullscreen-map');window.maps_autoplay=false;window.maps_autostop=true;if(!isfs){initp={x:window.scrollX,y:window.scrollY};var val=$("#map-selector option:selected")
if(val&&val.length&&val.length>0){val=val[0].id.replace('fsdp_','');if($('#fssd_'+val).length){$('#fssd_'+val).attr('checked','checked');}
var e=document.getElementById("map-selector");var strUser=e.options[e.selectedIndex].dataset.param;if(typeof JSON==='object'&&typeof JSON.parse==='function'){strUser=JSON.parse(strUser);}else{strUser=eval('('+strUser+')');;}
if(dataLayer){dataLayer.push({'event':'VirtualPageview','vpvProduct':'map','pageName':'vpv: map: full screen'+(strUser.omni?': '+strUser.omni:''),'vpvName':'map: full screen'+(strUser.omni?': '+strUser.omni:'')});}}
txt=icp.attr('data-close');ic.addClass('icon-exit-full-screen');omniact='open';$("#map-selector").change();$('#feedback_wrapper').hide();if(isie){$("#map-selector option.nfsm").wrap("<span>");}
_q.add(checkMapFSPos,1);}else{_q.remove(checkMapFSPos);ic.removeClass('icon-exit-full-screen')
txt=icp.attr('data-open');omniact='close';if(isie){$("#map-selector option.nfsm").unwrap();}
if(s_pelm&&window._config.stopOmniture==false){s_pelm.t();}
_notrack=true;$("#map-selector").change();checkMapFSPos(1);}
icp.attr('alt',txt).attr('title',txt);_track('full screen',omniact);setTimeout(function(){$(window).trigger('debouncedresize');},750);};};function ucfirst(string){return string.charAt(0).toUpperCase()+string.slice(1);}
function getChildren(n,skipMe){var r=[];var elem=null;for(;n;n=n.nextSibling)
if(n.nodeType==1&&n!=skipMe)
r.push(n);return r;};function getSiblings(n){return getChildren(n.parentNode.firstChild,n);}
function ucFirstAllWords(str){var pieces=str.split(" ");for(var i=0;i<pieces.length;i++){var j=pieces[i].charAt(0).toUpperCase();pieces[i]=j+pieces[i].substr(1);}
return pieces.join(" ");}
function getProdSprod(originalProd){switch(originalProd){case'Maps':this.prod='maps';this.sprod='maps';break;case'Home':this.prod='home';this.sprod='home';break;case'Forecasts':this.prod='city page';this.sprod='forecasts';break;case'14 Days':this.prod='14 day trend page';this.sprod='forecasts';break;case'Hourly':this.prod='hourly page';this.sprod='forecasts';break;case'36 Hours':this.prod='36 hours page';this.sprod='forecasts';break;case'lightning alert':this.prod='lightning';this.sprod='lightning';break;case'cottage report':this.prod='cottage report';this.sprod='cottage report';break;case'School Day Forecast':this.prod='school day';this.sprod='school day';break;}}
function checkControlsCollision($mapSelector,$layerControls){if(!$mapSelector.length||!$layerControls.length){return false;}
var x1=$mapSelector.offset().left;var y1=$mapSelector.offset().top;var h1=$mapSelector.outerHeight(true);var w1=$mapSelector.outerWidth(true);var b1=y1+h1;var r1=x1+w1;var x2=$layerControls.offset().left;var y2=$layerControls.offset().top;var h2=$layerControls.outerHeight(true);var w2=$layerControls.outerWidth(true);var b2=y2+h2;var r2=x2+w2;if(b1<y2||y1>b2||r1<x2||x1>r2)return false;return true;}
function mapSelectorStatus(){$(document).ready(function(){var result=checkControlsCollision($('#map-selector-fdivlmap'),$('#layer-controls-tap'));if(result===true){$(".map-selector").animate({right:"-285px"});$("#side-layer-controls-tap").on('click',function(){if($("#map_travelflowattribtion").is(':visible')){$(".layer-controls").animate({bottom:"-55px"});}else if($("#map_highwayforecast").is(':visible')){$(".layer-controls").animate({bottom:"-105px"});}else{$(".layer-controls").animate({bottom:"-135px"});}});$("#layer-controls-tap").on('click',function(){$(".map-selector").animate({right:"-285px"});});}else{$(".map-selector").animate({right:"0px"});}});}
if(typeof jQuery!='undefined'){$(document).ready(function($){$('li.fullmap-interactive a').removeAttr("href");$("#side-layer-controls-tap").click(function(e){e.preventDefault();dataLayer.push({'event':"eventTracker",'eventCategory':'maps','eventAction':'clicks','eventLabel':"showHide"});var div=$(".map-selector");if(div.css("right")==="-285px"){div.animate({right:"0px"});}else{div.animate({right:"-285px"});}
$(this).find('a').toggle();});});}else{setTimeout(function(){if(typeof jQuery!='undefined'){$('li.fullmap-interactive a').removeAttr("href");$("#side-layer-controls-tap").click(function(e){e.preventDefault();dataLayer.push({'event':"eventTracker",'eventCategory':'maps','eventAction':'clicks','eventLabel':"showHide"});var div=$(".map-selector");if(div.css("right")==="-285px"){div.animate({right:"0px"});}else{div.animate({right:"-285px"});}
$(this).find('a').toggle();});}},2000);}
return Module.factory('Map');});;