define(['web/modules/mylocations','web/modules/notifications','util/weather_convertion','localization/copy','jquery'],function(mylocations,notifications,convert,copy,$){if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,'');};}
var favorite_locations=function(){mylocations.reLoadLocations();var cls=window.location.href.split("//"),countrycode=/^[A-z]{2}$/g;cls=cls[1].split("/");if(typeof window.url_countrycode=="undefined"&&(typeof cls[1]!=="undefined"||cls[1]!=="")&&(cls[1].match(countrycode))){window.url_countrycode="/"+cls[1].toLowerCase();}
if(typeof window.url_countrycode=="undefined"){window.url_countrycode="";}
var showRecent=false,siteredirect=false,weather_refreshed=false,_config={'template':window._config.tpl_url+'web/savedlocations/locationcontent','citypage':(pelm_util.isDefined(window._config.url_weather)?'/'+window._config.url_weather+'/':'/weather/'),'defaultUnit':'c','weatherUrl':window.url_countrycode+'/api/savedlocation/index/','imageName':'no-saved-locations-'+window._config.lang,'alertUrl':'/api/savedlocation/alerts/','editLocationUrl':copy.page_url.url_myaccount_edit_locations,'alertsCache':3*60*1000},_getData=function(url,params,callback){$.get(url,params,callback,"json");},_refresh_weather=function(){mylocations.setSavedLocationsUpdateTimer(true);mylocations.setWeatherLastUpdateToCurrentTimeStamp();weather_refreshed=true;return true;},_renderSavedLocations=function(){if(location.search.indexOf(copy.page_url.url_myaccount_edit_locations)>=0||location.search.indexOf(copy.page_url.url_my_alerts)>=0){if(mylocations.isUserLoggedin()){if(typeof window.reloaded_locations=='undefined'){setTimeout(function(){_renderSavedLocations();},500);return;}}}
var d=[],sdata={},rend,el,elem,temp_unit,tpl,pcast='',t,qty=0;var mylocs=mylocations.getLocations()||[];var elem,celem,selem;temp_unit=mylocations.getStoredData('pelm_unit')||_config.defaultUnit;temp_unit=temp_unit.toLowerCase();if(pelm_util.notEmpty(mylocs)){var temp_valid=true;if(weather_refreshed==false){$.each(mylocs,function(index,val){if(pelm_util.isDefined(val.temperature)&&val.temperature!=''){return true;}
temp_valid=false;return false;});if(temp_valid==false){_refresh_weather();return;}}
elem=$('<div/>').addClass('saved-locations');selem=$('<div/>',{id:'saved-locations-slider'}).addClass('carousel visuallyhidden');$.each(mylocs,function(index,val){pcast='visuallyhidden';t=9;if(pelm_util.isDefined(val.temperature)){var fname=trimName=val.friendlyName||val.city;var temp=(temp_unit==val.temperature_unit.toLowerCase())?val.temperature:convert.temperature(val.temperature,temp_unit);if(pelm_util.notEmpty(val.postCode)){pcast='pointcast-icon';t=6;}
fname=(fname.length>t)?$.trim(fname).substring(0,t).trim(this)+"...":fname;fname=(self.textWidth(fname)>95&&fname.indexOf(' ')>0)?$.trim(trimName).substring(0,(t-1)).trim(this)+"...":fname;var linkUrl=(val.postCode)?val.placeCode.toLowerCase()+'/'+val.postCode+'/'+val.gridIndex:val.placeCode.toLowerCase();var celem=_createTemplate({'nickname':fname,'weather_icon':val.weather_icon||'-','temperature':temp||'-','temperature_unit':temp_unit.toUpperCase(),'link_url':linkUrl,'loc_type':val.locationType,'image_url':window._config.image_url,'pointcast_display':pcast});selem.append(celem);qty++;}});elem.append(selem);}else{elem=$('<div/>').addClass('saved-locations-none').append($('<img/>',{src:window._config.image_url+_config.imageName+'.png',alt:copy.location.nolocationlbl}));$('.location-open-window').addClass('expand');}
$(".locations > div[class ^=saved-locations]").remove();$('.locations').prepend($(elem));self.checkAlerts();showRecent=false;},_createTemplate=function(v){var elem=($('<div/>').addClass('locations-container').append($('<div/>').addClass('locations-content').append($('<span/>').append('<img src="'+window._config.image_url+'icon-spacer.png" data-img="'+window._config.image_url+'PointCast-pin.png'+'" class="'+v.pointcast_display+'" />'+v.nickname)).append($('<div/>').addClass('clearfix').append($('<img/>',{src:window._config.image_url+'icons/wxicons_small/'+v.weather_icon+'.png',alt:v.wxcondition})).append($('<span/>',{text:v.temperature}).addClass('location-temp num').append($('<span/>').addClass('location-temp degree').append('<sup>o</sup>'+v.temperature_unit)))).append($('<div/>').addClass('active').append($('<a/>',{href:_config.editLocationUrl}).addClass('edit-location').append($('<span/>').text(copy.location.edit_lbl))))).append($('<input/>',{"class":"link_url",type:"hidden",value:v.link_url}).attr('data-loctype',v.loc_type)));return elem;},_onClickTempUnitUpdateFromStorage=function(myloc){var temp_unit=mylocations.getStoredData('pelm_unit')||_config.defaultUnit;temp_unit=temp_unit.toLowerCase();var elems=$('.location-container');var mylocs=mylocations.getLocations()||[];$.each(elems,function(index,val){var placecode=$(this).attr("data-placecode"),el=$(this);$.each(mylocs,function(i,val){if(val.placeCode.toLowerCase()==placecode.toLowerCase()){var temp=(temp_unit==val.temperature_unit.toLowerCase())?val.temperature:convert.temperature(val.temperature,temp_unit);el.find('.num').text(temp);el.find('.degree').html('&deg;'+temp_unit.toUpperCase());}});});},getLocationUrl=function(locType){var purl='',replace_purl='',replace_locale='';var data=window._config.domain_redirect_products;if(data&&data.indexOf('{')>=0&&data.indexOf('<')<0){data=JSON.parse(data);}
switch(locType){case'schools':if(pelm_util.isDefined(copy.page_url.school_url)){purl=copy.page_url.school_url;}
break;case'cottages':if(pelm_util.isDefined(copy.page_url.cottage_url)){purl=copy.page_url.cottage_url;}
break;case'camping':if(pelm_util.isDefined(copy.page_url.camping_url)){purl=copy.page_url.camping_url;}
break;case'beaches':if(pelm_util.isDefined(copy.page_url.beaches_url)){purl=copy.page_url.beaches_url;}
break;case'attractions':if(pelm_util.isDefined(copy.page_url.attractions_url)){purl=copy.page_url.attractions_url;}
break;case'golf':if(pelm_util.isDefined(copy.page_url.golf_url)){purl=copy.page_url.golf_url;}
break;case'ski':if(pelm_util.isDefined(copy.page_url.ski_url)){purl=copy.page_url.ski_url;}
break;case'airports':if(pelm_util.isDefined(copy.page_url.airport_url)){purl=copy.page_url.airport_url;}
break;case'sailing':if(pelm_util.isDefined(copy.page_url.sailing_cruising_url)){purl=copy.page_url.sailing_cruising_url;}
break;default:purl=copy.page_url.weather_url;break;}
return'/'+purl+'/';};self.checkAlerts=function(){if($('body.blurred').length){return;}
var mylocs=mylocations.getLocations()||[];var params={},alertLocs=[];if($.isArray(mylocs)&&mylocs.length>0){$.each(mylocs,function(index,val){params[index]=val.placeCode.toLowerCase();});_getData(_config.alertUrl,{'placecodes':params},function(data){if(data){var data=(typeof data=='string')?JSON.parse(data):data;var astatus,n=1,txt='',bar=$('.locations-container');$.each(data,function(placecode,alerts){$.each(mylocs,function(i,v){astatus=0,txt='';if(placecode&&typeof v.placeCode!='undefined'&&v.placeCode.toLowerCase()==placecode.toLowerCase()){if(alerts.length>0){astatus=1;$.each(alerts,function(index,alert){if(typeof alert.warnings!="undefined"){var labels=notifications.get_warning_labels(alert,v.placeCode);if(labels.length>0){$.each(labels,function(i,lbl){txt+=(txt.length>0)?' | '+lbl:lbl;});}}else{txt+=(txt.length>0)?' | '+alert.alert_type:alert.alert_type;}});if(txt==''){return true;}
var id='#alert-id'+n;if(pelm_util.notDefined($(".locations-content a[href = "+id+"]").attr('class'))){var el=$('<a/>',{href:'#alert-id'+n}).addClass('location-alert');var m=$('.link_url[value ^='+placecode.toLowerCase()+']').parent().find('.locations-content');m.addClass('active-alert');$(m).find('div:last').before(el);};if(typeof $(id)!='undefined'){$(id).remove();}
n++;}
alertLocs.push({'placeCode':v.placeCode,'status':astatus});}});});if(alertLocs.length>0){mylocations.updateAlertsStatus(alertLocs);}
require(['takeover','defaults'],function(takeover,defaults){takeover.bindAlertsSavedLocation(defaults.elements.alertSavedLocation);});require(['web/modules/savedlocations/locationlist_nitro'],function(locationlist){locationlist.init();});}});mylocations.setAlertsLastUpdateToCurrentTimeStamp();setTimeout(function(){self.checkAlerts();},_config.alertsCache);}};self.refreshBar=function(showLastEntry){if(mylocations.getCount()==0){if($('#edit-savedlocations').length>0){$("#edit-savedlocations").remove();}
var cur_url=window.location.href;var placecode=(typeof window._config['placecode']!=='undefined')?window._config['placecode']:null;if(placecode){if(cur_url.indexOf('/'+window._config['url_weather']+'/')!=-1||cur_url.indexOf('/'+window._config['url_cottage']+'/')!=-1||cur_url.indexOf('/'+window._config['url_schoolday']+'/')!=-1){var newLocation={alertStatus:'0',city:window._config['city_name']||'',country:window._config['country_code']||'',countryName:window._config['country']||'',countyName:window._config['county']||'',friendlyName:'',gridIndex:window.gridindex,guid:'',guidUpdate:'',locationType:window._config['location_type'],placeCode:placecode.toUpperCase(),postCode:window.postalcode||'',prizmCode:'',province:window._config['prov_code']||''};var uup_enabled=false;if(typeof window._config.uup_on_first_location!='undefined'&&window._config.uup_on_first_location==true){uup_enabled=true;}
mylocations.update(newLocation,null,uup_enabled);showLastEntry=true;}}}
showRecent=showLastEntry||false;require(['web/modules/savedlocations/locationlist_nitro'],function(locationlist){locationlist.init();setTimeout(function(){_renderSavedLocations();},500);});};self.textWidth=function(txt){var el=$('<span />',{text:txt});$('body').append(el);var width=el.width();el.remove();return width;};self.run=function(){mylocations.deleteCrossLocationCookie();mylocations.setSavedLocationsUpdateTimer();$('.tempunit').click(function(){var mylocs=mylocations.getLocations()||[];setTimeout(function(){_onClickTempUnitUpdateFromStorage(mylocs);},500);});var checkIfSavedLocationsAreLoaded=function(){if($('#savedlocations-container').length>0){self.refreshBar();return;}
setTimeout(checkIfSavedLocationsAreLoaded,500);};checkIfSavedLocationsAreLoaded();};return self;};return favorite_locations();});;