/**
 * AME Event Tracking System
 * Manages tracking of page impressions, SERP clicks and more
 * Integrated as standalone external package
 * Based on PAMELa Loader System
 *
 * @version 1.4.0
 * @author Alessandro Maurizio <alessandro.maurizio@mondadori.it>
 * @preserve
 */
class AmeEtsClient{constructor(){this.version="1.4.0",this.startTime=(new Date).getTime(),this.endpoint="https://endpoint.ets.amedigital.it/topics/ame-ets-stream",this.frameUrl=new URL("https://dafne.sirio.stbm.it/ame-ets/client/uid.html"),this.frameTimeout=2e3;let t=document.querySelector(".ame-ets-config");if(t){try{t=JSON.parse(t.text)}catch(t){return void this.log("Opzioni AME-ETS malformate!","FATAL")}t&&t.website&&t.context?(this.opt=Object.assign({},t),this.detectPlatform(),this.injectTrackingConfiguration(),this.log("Avvio AME ETS v"+this.version+" - Sito: "+this.opt.website+" - Platform: "+this.platform+" | "+this.mobileType,"INFO","Main",!0),this.init()):this.log("Website e Context non settati nelle opzioni. Assicurarsi di inizializzare lo script correttamente!","FATAL")}else this.log("Opzioni AME-ETS non presenti in pagina. Inserire i dati correttamente!","FATAL")}init(){this.setupEtsId().then(()=>{this.bindEverything()}).catch(()=>{this.log("Errore durante il retrieval dell'ETS ID, proseguo...","WARNING"),this.bindEverything()})}bindEverything(){this.track({type:"pageview"});const t=this.opt.context;"serp"===t&&this.bindSerpClicks(),"serp"!==t&&"home"!==t&&"leaf"!==t||(this.bindStripClicks(),this.bindStripViewability()),"leaf"===t&&(this.bindSuggestedClicks(),this.bindSuggestedViewability(),this.bindVoteClicks())}bindSerpClicks(){this.existsInPage(this.opt.serpTarget)&&document.addEventListener("click",t=>{this.trackClick(t,this.opt.serpTarget,"serp-click",this.opt.serpSpecial)},!0)}bindStripClicks(){this.existsInPage(this.opt.stripTarget)&&document.addEventListener("click",t=>{this.trackClick(t,this.opt.stripTarget,"strip-click")},!0)}bindSuggestedClicks(){document.addEventListener("click",t=>{this.trackClick(t,this.opt.suggestedTarget,"suggested-click")},!0)}bindVoteClicks(){this.existsInPage(this.opt.voteTarget)&&document.addEventListener("click",t=>{this.trackAction(t,this.opt.voteTarget,"vote")},!0)}bindStripViewability(){if(!this.existsInPage(this.opt.stripContainer))return;this.prepareIntersectionObserver();const t=document.querySelectorAll(this.opt.stripContainer),e=Array.from(t);t.forEach(t=>{let i=e.indexOf(t);this.observedElements.set(t,()=>{this.log("VisibilitÃ  strip registrata: "+t.dataset.swipername+" in posizione "+i+" - Tracciamenti rimanenti: "+(this.observedElements.size-1),"DEBUG"),t.dataset.etsStripPos=i.toString();let e={type:"strip-view",strip:t.dataset.swipername,pos:i};this.track(e)}),this.viewObserver.observe(t)})}bindSuggestedViewability(){if(!this.existsInPage(this.opt.suggestedContainer))return;this.prepareIntersectionObserver();const t=document.querySelector(this.opt.suggestedContainer);this.observedElements.set(t,()=>{this.log("VisibilitÃ  suggeriti registrata - Tracciamenti rimanenti: "+(this.observedElements.size-1),"DEBUG"),this.track({type:"strip-view",strip:"suggeriti",pos:0});const t=document.querySelectorAll(this.opt.suggestedTarget);for(let e=1;e<t.length;e++)this.bindAdditionalSuggestedView(t[e-1],e)}),this.viewObserver.observe(t)}bindAdditionalSuggestedView(t,e){this.observedElements.set(t,()=>{this.log("Suggerito "+e+" visibile - Tracciamenti rimanenti: "+(this.observedElements.size-1),"DEBUG"),this.track({type:"strip-view",strip:"suggeriti",pos:e})}),this.viewObserver.observe(t)}prepareIntersectionObserver(){this.viewObserver||(this.observedElements=new Map,this.viewObserver=!!window.IntersectionObserver&&new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting||void 0===t.isIntersecting){const e=t.target;this.viewObserver.unobserve(e),this.observedElements.get(e)(),this.observedElements.delete(e)}})},{rootMargin:"-100px"}))}trackClick(t,e,i,s=""){let r,o,n,a,l=-1,c=t.target;for(;c&&c.parentNode;){if("A"===c.nodeName&&(r=c),c.matches(e)){o=c;break}c=c.parentNode}if(!o||!r)return;let d=Array.from(o.parentElement.children).filter(t=>t.classList.contains(e.substr(1))).findIndex(t=>t===o);if(o.classList.contains(s.substr(1)))i+="-special";else if(1===o.parentElement.children.length)return;if("strip-click"===i){let e=t.target,s=this.opt.stripContainer.split(",");for(;e&&e.parentNode&&!n;){for(let t of s)if(e.classList.contains(t.trim().substr(1))){n=e;break}e=e.parentNode}if(!n||!n.dataset)return void this.log("Impossibile tracciare "+i+" su questo elemento, strip container non trovato!","WARNING");a=n.dataset.swipername,l=parseInt(n.dataset.etsStripPos||-1)}"suggested-click"===i&&(i="strip-click",a="suggeriti");let p={type:i,link:r.href,pos:d,strip:a,strip_pos:l};p=this.addKeyValueData(o.dataset,p),this.log("Click tracciato, posizione "+d+" per strip: "+(a||i)+" (strip "+l+")","DEBUG"),this.track(p)}trackAction(t,e,i){let s=null,r=-1,o=t.target;for(;o&&o.parentNode;){if(o.matches(e)){s=o;break}o=o.parentNode}s&&("vote"===i&&(console.log(s),console.log(s.dataset.index),s.dataset.index&&(r=parseInt(s.dataset.index)+1)),this.log("Evento tracciato, tipo "+i+", valore: "+r,"DEBUG"),this.track({type:i,value:r}))}existsInPage(t){const e=!(!t||!document.querySelector(t));return this.log("Elemento "+t+" in pagina: "+e,"DEBUG"),e}addKeyValueData(t,e){if(!t)return e;let i={strip_algo:t.etsAlgo,strip_type:t.etsTipo};for(let t in i)i[t]&&(e[t]=i[t]);return e}injectTrackingConfiguration(){let t=window.screen.width+"x"+window.screen.height;this.ameAnalyticsData={dl:window.location.href,dm:window.location.host,ds:"web",ul:navigator.language.toLowerCase(),sr:t,wb:this.opt.website,cl:this.platform,mt:this.mobileType,cx:this.opt.context,ve:this.version,ua:navigator.userAgent};let e=new URL(this.ameAnalyticsData.dl);if(e.searchParams.delete("fbclid"),this.ameAnalyticsData.dl=e.toString(),window.location.href.includes("#amp")&&(this.ameAnalyticsData.ds="AMP"),this.opt.userVariable){let t=this.opt.userVariable.split(".").reduce((t,e)=>t&&t[e]||null,window);t&&(this.ameAnalyticsData.lu=t)}}setupEtsId(){let t=this;return new Promise(function(e,i){let s=!1;if(window.localStorage&&(s=window.localStorage.getItem("localEtsId")),s&&!s.startsWith("err"))return t.log("ETS ID trovato in cache locale, salta injection...","DEBUG"),t.setEtsId(s),e();t.log("Cache ID locale inesistente, inietto frame...","DEBUG"),t.injectTrackingFrame().then(t=>e(t)).catch(t=>i(t))})}injectTrackingFrame(){let t=this;return new Promise(function(e,i){let s=window.setTimeout(()=>(t.setEtsId("err_timeout"),i()),t.frameTimeout);window.addEventListener("message",i=>{if(i.origin===t.frameUrl.origin&&i.data&&"EtsIdMessage"===i.data.type)return t.setEtsId(i.data.id),t.log("Tracking frame cross-domain caricato con successo e ID ricevuto"),clearTimeout(s),e()},!1);let r=document.createElement("iframe");r.setAttribute("style","width:0;height:0;border:0;border:none;visibility:hidden;"),r.src=t.frameUrl.href,document.body.appendChild(r)})}setEtsId(t){this.etsId=t,this.log("ID tracking attuale: "+this.etsId,"DEBUG"),window.localStorage&&window.localStorage.setItem("localEtsId",t)}detectPlatform(){let t=navigator.userAgent||navigator.vendor||window.opera;if(/iPhone/.test(t)&&!window.MSStream)return this.platform="mobile",void(this.mobileType="ios");let e="desktop",i="other",s={"windows phone":{device:"mobile",type:"other"},ipad:{device:"tablet",type:"ios"},"ip(hone|od)":{device:"mobile",type:"ios"},"android.*(mobile|mini)":{device:"mobile",type:"android"},"android 3i":{device:"tablet",type:"android"},"Opera Mobi":{device:"mobile",type:"other"},android:{device:"tablet",type:"android"},"PlayBook; U; RIM Tablet":{device:"tablet",type:"other"},"hp-tablet.*TouchPad":{device:"tablet",type:"other"},"Kindle/3":{device:"tablet",type:"android"},"Silk/":{device:"tablet",type:"android"},"NokiaBrowser/":{device:"mobile",type:"other"}};for(let[r,o]of Object.entries(s))if(new RegExp(r,"i").test(t)){e=o.device,i=o.type;break}this.platform=e,this.mobileType=i}log(t,e="INFO",i="Main",s=!1){let r="WARNING";if(window.location.href.includes("AmeEtsDebug")&&(r="DEBUG"),r!==e&&"DEBUG"!==r&&"WARNING"!==e&&"ERROR"!==e&&"FATAL"!==e&&!s)return;let o=console.info,n="#13c454";switch(e){case"DEBUG":o=console.debug,n="#41979b";break;case"WARNING":o=console.warn,n="#EED202";break;case"ERROR":case"FATAL":o=console.error,n="#ef4c37"}let a=Date.now()-this.startTime,l="--";window.performance&&(l=0|performance.now()),o("%c[AME-ETS] %c["+i+"] %c["+e+"] %c"+t+" %c("+a+"ms) (fromStart: "+l+"ms)","color: #b78114","color: #2f74e2","color: "+n,"color: #24ada4","color: #5d697c")}track(t){if(!t||!t.type)return;let e=localStorage.getItem("kxkuid");!e&&window.Krux&&window.Krux.kxkuid&&(e=window.Krux.kxkuid),e||(e="UNK");let i=Object.assign({},this.ameAnalyticsData,{uid:this.etsId,ec:t.type,kx:e,ts:Date.now()});t.type.startsWith("serp-click")&&(i.serp={query:this.opt.serpQuery,link:t.link,pos:t.pos}),t.type.startsWith("strip")&&(i.strip={name:t.strip,pos:t.pos},t.strip_algo&&(i.strip.algo=t.strip_algo),t.strip_type&&(i.strip.tipo=t.strip_type),"strip-click"===t.type&&(i.strip.link=t.link,i.strip.strip_pos=t.strip_pos||0),"serp"===this.opt.context&&(i.strip.query=this.opt.serpQuery)),"vote"===t.type&&(i.action={val:t.value}),i={records:[{value:i}]};try{navigator.sendBeacon(this.endpoint,JSON.stringify(i))}catch(t){this.log("Errore di invio evento: "+t.message,"WARNING")}this.log("Evento "+t.type+" registrato e tracciato","INFO")}}window.AmeEtsClientInstance=new AmeEtsClient;