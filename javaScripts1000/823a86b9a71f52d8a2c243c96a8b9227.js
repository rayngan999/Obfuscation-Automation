define(["modules/id.core","modules/id.csshelper","modules/id.tracking","modules/id.base64","modules/id.nonAmdLoader"],function(e,t,n,o,i){"use strict";e.utils.log("loading id.form.js");var s;return s=function(){this.conf={FORMAT_VALIDATION_TEXT:"Bitte Ã¼berprÃ¼fen Sie die Formatierung!",SUBMIT_BUTTON_SELECTOR:".id-js-form-submit",SUBMIT_BUTTON_TEXT:"Formular wird abgeschickt...",EMAIL_VALIDATION_TEXT:"Bitte verwenden sie eine korrekte E-Mail-Adresse!",SERVER_ERROR_TEXT:"Ihre Formulardaten konnten aufgrund technischer Probleme nicht Ã¼bermittelt werden. Bitte versuchen Sie es spÃ¤ter noch ein mal. Beim Klick auf OK wird die Seite neu geladen.",VALIDATION_DATAATTR_NAME:"data-id-validator",COMPOSITE_ELEMENT_SELECTOR:".id-js-composite",COMPOSITE_ELEMENT_CLASS:"id-js-composite",UPLOAD_FIELD_SELECTOR:".id-js-uploader",UPLOAD_FIELD_ID_DATAATTR_NAME:"data-id-uploader-fieldid",UPLOAD_FIELD_ID_DATAATTR_MULTI:"data-id-uploader-multi",ALLOWED_EXT_DATAATTR_NAME:"data-id-allowed-extensions",FORMCONFIG_DATAATTR_NAME:"data-id-formconfigid",EMAIL_REGEX:"\\S+@\\S+\\.\\w+",GRECAPTCHA_FIELD_SELECTOR:".idjs-grecaptcha",FORM_ELEMENT_SELECTOR:".id-Form-el",INVALID_ELEMENT_SELECTOR:".id-Form-error",ERROR_MESSAGE_SUMMARY_CLASS:"id-Form-el-container id-Form-status-summary id-Form-error",ERROR_MESSAGE_SUMMARY_TEXT:"Bitte korrigieren Sie die fehlerhaften oder fehlenden Eingaben.",SUCCESS_MESSAGE_SUMMARY_CLASS:"id-Form-el-container id-Form-status-summary id-Form-succ",SUCCESS_VOTING_CLASS:"id-Form-el-container id-Form-voting-result",SUCCESS_MESSAGE_SUMMARY_TEXT:"Vielen Dank, das Formular wurde erfolgreich Ã¼bermittelt.",ELEMENT_CONTAINER_SELECTOR:".id-Form-el-container",SUMMARY_SELECTOR:".id-Form-status-summary",STATUS_MESSAGE_HOLDER_PREFIX:"idjs-err",STATUS_MESSAGE_HOLDER_SELECTOR_PREFIX:".idjs-err",ERROR_CLASS:"id-Form-error",TOKEN_CLASS:".id-js-dcup-token",DATE_INPUT_SELECTOR:".idjs-Form--dateInput",SUBMIT_DEFAULT_TEXT_DATAATTR_NAME:"data-id-default-value",inheritStyleCss:"",FORM_LINK_VALIDATION_DELAY:310,FORM_REDIRECT_PARAM_NAME:"dcpr",VOTING_VOTEBUTTON_SELECTOR:".id-js-Voting-voteCTA",VOTING_VOTEBUTTON_CLASSNAME:"id-js-Voting-voteCTA",VOTING_IMAGEZOOM_SELECTOR:".id-js-VotingList-image-zoom",VOTING_IMAGEZOOM_CLASSNAME:"id-js-VotingList-image-zoom",VOTING_SUBMITBUTTONS_NOTLOGGEDIN_TEXT:"Zum Abstimmen bitte einloggen",VOTING_SUBMITBUTTONS_SUMITTING_TEXT:"Ihre Stimme wird Ã¼bermittelt...",VOTING_IMAGE_SELECTOR:".id-js-VotingList-image",VOTING_IMAGE_ZOOMED_CLASSNAME:"id-VotingList-image--zoomed",VOTING_OVERLAYACTION_ZOOMICON_CLASSNAME:"id-OverlayAction-icon",VOTING_OVERLAYACTION_ZOOMICON_COLLAPSED_CLASSNAME:"id-OverlayAction-icon--collapse",VOTING_RADIO_SELECTOR:".id-js-VotingList-radio",VOTING_ELEMENT_SELECTOR:".id-js-Voting-element",MAINNAV_USERSETTINGS_TRIGGER:".idjs-MainNavV2-userSettingsTrigger",MAINNAV_USERSETTINGS_HASH:"#idjs-user-settings",enableAjaxSubmit:!0,grecaptchaSitekey:!1,grecaptchaElementId:null};var s=this;this.matchRequired=function(e){return 0!==e.value.length&&"checkbox"!==e.type?!0:"checkbox"===e.type&&e.checked},this.matchFormat=function(e,t){return void 0!==e.value&&(0===e.value.length||e.value.match(t))},this.matchLength=function(e,t){return void 0!==e.value&&(null===t.min||e.value.length>=t.min)&&(null===t.max||e.value.length<=t.max)},this.displayFormStatusMessage=function(t,n,o){var i,s=e.dom.$(this.conf.STATUS_MESSAGE_HOLDER_SELECTOR_PREFIX+t,n),r=e.dom.closest(this.conf.ELEMENT_CONTAINER_SELECTOR,s),a="";for(e.dom.$(s.parent()).hasClass(this.conf.COMPOSITE_ELEMENT_CLASS)&&(r=e.dom.closest(this.conf.COMPOSITE_ELEMENT_SELECTOR,s)),i=0;o.length>i;i+=1)o[i].reason&&0!==o[i].reason.length&&(a+=o[i].reason,i!==o.length-1&&(a+="<br/>"));0===o.length&&null!==r&&(s.html(""),r.removeClass(this.conf.ERROR_CLASS)),o.length>0&&null!==r&&(s.html(a),r.addClass(this.conf.ERROR_CLASS))},this.validateFormField=function(t){var n,o=e.dom.$(t),i=e.dom.closest("form",o),s=JSON.parse(o.attr(this.conf.VALIDATION_DATAATTR_NAME)),r=[];for(n=0;s.length>n;n+=1)void 0===s[n].REQUIRED||this.matchRequired(t)||r.push({reason:s[n].REQUIRED.message}),void 0===s[n].LENGTH||this.matchLength(t,s[n].LENGTH)||r.push({reason:s[n].LENGTH.message}),void 0===s[n].FORMAT||this.matchFormat(t,s[n].FORMAT.format)||(s[n].FORMAT.message?r.push({reason:s[n].FORMAT.message}):r.push({reason:this.conf.FORMAT_VALIDATION_TEXT})),void 0===s[n].EMAIL||this.matchFormat(t,this.conf.EMAIL_REGEX)||(s[n].EMAIL.message?r.push({reason:s[n].EMAIL.message}):r.push({reason:this.conf.EMAIL_VALIDATION_TEXT}));i&&this.displayFormStatusMessage(t.name,i,r)},this.validateComposite=function(t){var n,o,i,s=e.dom.closest("form",t),r=JSON.parse(t.attr(this.conf.VALIDATION_DATAATTR_NAME)),a=[],d=e.dom.$("input",t),l=e.dom.$("[id^='"+this.conf.STATUS_MESSAGE_HOLDER_PREFIX+"']",t).last();for(o=0;r.length>o;o+=1){for(n=!1,i=0;d.length>i;i+=1)void 0!==r[o].REQUIRED&&this.matchRequired(d[i])&&(n=!0);n||a.push({reason:r[o].REQUIRED.message})}s&&this.displayFormStatusMessage(l.attr("id").replace(this.conf.STATUS_MESSAGE_HOLDER_PREFIX,""),s,a)},this.handleFormSubmissionResponse=function(t,i,r){var a,d,l,c,u,m,f,h=t.dcupResponse,g=s.getParamValue(s.conf.FORM_REDIRECT_PARAM_NAME),E=e.dom.$(this.conf.SUBMIT_BUTTON_SELECTOR,i);if(h.status&&"INVALID"===h.status){0!==E.length&&E.val(E.attr(this.conf.SUBMIT_DEFAULT_TEXT_DATAATTR_NAME)).removeAttr("disabled"),s.conf.trackingEnabled&&e.event.publish(e.event.constants.TRACKING,{type:n.conf.INTERACTION,category:"Formular",action:"Submit",description:s.conf.formTitle+"/Error",formId:r});for(a in h.results)h.results.hasOwnProperty(a)&&this.displayFormStatusMessage(a,i,h.results[a]);e.dom.$(this.conf.SUMMARY_SELECTOR,i).remove(),e.dom.$(e.dom.util.create("<div>"+this.conf.ERROR_MESSAGE_SUMMARY_TEXT+"</div>")).addClass(this.conf.ERROR_MESSAGE_SUMMARY_CLASS).insertBefore(e.dom.$(this.conf.ELEMENT_CONTAINER_SELECTOR,i).first()),m=e.dom.$(this.conf.INVALID_ELEMENT_SELECTOR,i).get(1),e.event.publish(e.event.constants.JUMP_TO_WITH_OFFSET_JUMP,m),e.dom.$(this.conf.FORM_ELEMENT_SELECTOR,m).focus()}else if(h.status&&"OK"===h.status){if(s.conf.trackingEnabled&&e.event.publish(e.event.constants.TRACKING,{type:n.conf.INTERACTION,category:"Formular",action:"Submit",description:s.conf.formTitle+"/Success",formId:r}),l=t.votingResults||h.msg||this.conf.SUCCESS_MESSAGE_SUMMARY_TEXT,c=t.votingResults?s.conf.SUCCESS_VOTING_CLASS:s.conf.SUCCESS_MESSAGE_SUMMARY_CLASS,f=e.dom.$("["+this.conf.FORMCONFIG_DATAATTR_NAME+'="'+h.formId+'"]'),f.length>0)for(i=e.dom.$(f[0]),d=1;f.length>d;d+=1)f[d].remove();u=e.dom.$(e.dom.util.create('<div class="'+c+'">'+l+"</div>")),i.replaceWith(u),e.event.publish(e.event.constants.JUMP_TO_WITH_OFFSET_JUMP,u),g&&(window.location=o.decode(g))}else h.status&&"REDIRECT"===h.status?(s.conf.trackingEnabled&&e.event.publish(e.event.constants.TRACKING,{type:n.conf.INTERACTION,category:"Formular",action:"Submit",description:s.conf.formTitle+"/Success",formId:r}),window.location=g?o.decode(g):h.msg):window.confirm(this.conf.SERVER_ERROR_TEXT)&&window.location.reload()},this.initCssClasses=function(){var e;""!==this.conf.inheritStyleCss&&(e=new t,this.conf.ERROR_MESSAGE_SUMMARY_CLASS=e.getContainerElementCssClass(this.conf.ERROR_MESSAGE_SUMMARY_CLASS,this.conf.inheritStyleCss),this.conf.SUCCESS_MESSAGE_SUMMARY_CLASS=e.getContainerElementCssClass(this.conf.SUCCESS_MESSAGE_SUMMARY_CLASS,this.conf.inheritStyleCss),this.conf.SUCCESS_VOTING_CLASS=e.getContainerElementCssClass(this.conf.SUCCESS_VOTING_CLASS,this.conf.inheritStyleCss))},this.getParamValue=function(e){var t=window.location.search.match(RegExp("(?:[?&]"+e+"=)([^&]+)"));return t?t[1]:null},this.initImageVoting=function(t){var n=e.dom.$(this.conf.SUBMIT_BUTTON_SELECTOR,t),o=e.dom.$(this.conf.VOTING_VOTEBUTTON_SELECTOR,t),i=e.dom.$(this.conf.VOTING_IMAGEZOOM_SELECTOR,t),r="true"===e.configuration.userInfo.loggedIn,a=!1;r||o.text(this.conf.VOTING_SUBMITBUTTONS_NOTLOGGEDIN_TEXT),o.removeAttr("disabled"),e.dom.$(i.parent()).removeClass("id-HiddenVisually"),e.dom.bind(t,"click",function(t){var o,i,d=e.dom.$(t.target);d.hasClass(s.conf.VOTING_IMAGEZOOM_CLASSNAME)&&(t.preventDefault(),o=e.dom.closest(s.conf.VOTING_IMAGE_SELECTOR,d),i=e.dom.$("img",o),o.toggleClass(s.conf.VOTING_IMAGE_ZOOMED_CLASSNAME),window.setTimeout(function(){i.attr("sizes",i.dim().width+"px")},500),d.toggleClass(s.conf.VOTING_OVERLAYACTION_ZOOMICON_CLASSNAME).toggleClass(s.conf.VOTING_OVERLAYACTION_ZOOMICON_COLLAPSED_CLASSNAME)),d.hasClass(s.conf.VOTING_VOTEBUTTON_CLASSNAME)&&(r?(e.dom.$(s.conf.VOTING_RADIO_SELECTOR,e.dom.closest(s.conf.VOTING_ELEMENT_SELECTOR,d)).attr("checked","checked"),d.text(s.conf.VOTING_SUBMITBUTTONS_SUMITTING_TEXT).attr("disabled","disabled"),n[0].click()):(a===!1&&(e.dom.$(s.conf.MAINNAV_USERSETTINGS_TRIGGER)[0].click(),a=!0),location.href=s.conf.MAINNAV_USERSETTINGS_HASH))})},this.convertDateToGermanDateFormat=function(e){var t,n,o,i,s=e;return t=new Date(e),isNaN(t.getDate())===!1&&(n=("0"+t.getDate()).slice(-2),o=("0"+(t.getMonth()+1)).slice(-2),i=t.getFullYear(),s=n+"."+o+"."+i),s},this.doesNotSupportInputTypeDate=function(e){return e[0]&&"text"===e[0].type},this.captchaSuccessHandler=function(t){if(e.utils.log("grecaptcha was successful"),this.conf.grecaptchaElementId){var n=e.dom.closest("form",e.dom.$(t));this.displayFormStatusMessage(this.conf.grecaptchaElementId,n,[])}},this.initCaptcha=function(t){var n=e.dom.$(this.conf.GRECAPTCHA_FIELD_SELECTOR,t);n.length>0&&this.conf.grecaptchaSitekey&&(window.idGrecaptchaOnLoadCallback=function(){e.utils.log("grecaptcha api is ready"),window.grecaptcha.render(n[0],{sitekey:s.conf.grecaptchaSitekey,callback:function(){s.captchaSuccessHandler(n[0])}})},i.load("https://www.google.com/recaptcha/api.js?onload=idGrecaptchaOnLoadCallback&render=explicit&hl=de",function(){e.utils.log("recaptcha api loaded")},"extNoAmd.grecaptcha","Grecaptcha"))},this.init=function(t){var o,i=e.dom.$(t),s=this,r=e.dom.$(s.conf.DATE_INPUT_SELECTOR,i),a=i.attr(s.conf.FORMCONFIG_DATAATTR_NAME);this.initCssClasses(),this.conf.isImageVoting&&this.initImageVoting(i),s.doesNotSupportInputTypeDate(r)&&r.each(function(){this.value=s.convertDateToGermanDateFormat(this.value)}),e.dom.$(this.conf.TOKEN_CLASS,i).val(e.utils.guid()),s.conf.trackingEnabled&&e.event.publish(e.event.constants.TRACKING,{type:n.conf.INTERACTION,category:"Formular",action:"Anzeige",description:s.conf.formTitle,formId:a}),e.dom.bind(t,"change focusout",function(t){var n,o=t.target,i=e.dom.$(o);o&&(n=e.dom.closest(s.conf.COMPOSITE_ELEMENT_SELECTOR,i),i.attr(s.conf.VALIDATION_DATAATTR_NAME)&&window.setTimeout(function(){s.validateFormField(o)},s.conf.FORM_LINK_VALIDATION_DELAY),n&&window.setTimeout(function(){s.validateComposite(n)},s.conf.FORM_LINK_VALIDATION_DELAY))}),e.dom.bind(t,"submit",function(n){s.conf.enableAjaxSubmit&&(n.preventDefault(),e.dom.$(s.conf.SUBMIT_BUTTON_SELECTOR,i).val(s.conf.SUBMIT_BUTTON_TEXT).attr("disabled","disabled"),e.ajax({url:e.configuration.page.ajaxUrl+"?eventtype=dcupFormAjaxHandler",method:"post",data:e.ajax.serialize(t),type:"json",success:function(n){window.setTimeout(function(){s.handleFormSubmissionResponse(n,i,a),e.event.publish(e.event.constants.FORM_SUCCESS,e.ajax.serialize(t))},s.conf.FORM_LINK_VALIDATION_DELAY)},error:function(e){window.setTimeout(function(){s.handleFormSubmissionResponse(e,i,a)},s.conf.FORM_LINK_VALIDATION_DELAY)}}))}),o=e.dom.$(this.conf.UPLOAD_FIELD_SELECTOR,i),o.length>0&&require(["vendor/fileuploader"],function(){o.each(function(n){var o,r,a=0,d=e.dom.$(n),l=e.dom.closest("form",d),c=d.attr(s.conf.UPLOAD_FIELD_ID_DATAATTR_NAME),u=d.attr(s.conf.UPLOAD_FIELD_ID_DATAATTR_MULTI),m=JSON.parse(d.attr(s.conf.VALIDATION_DATAATTR_NAME)),f=""!==d.attr(s.conf.ALLOWED_EXT_DATAATTR_NAME)?d.attr(s.conf.ALLOWED_EXT_DATAATTR_NAME).split(","):[];for("false"===u&&(u=!1),r=0;m.length>r;r+=1)if(m[r].FILESIZE&&m[r].FILESIZE.maxInBytes){a=parseInt(m[r].FILESIZE.maxInBytes,10);break}o=new qq.FileUploader({action:e.configuration.page.ajaxUrl,element:n,params:{eventtype:"dcupUploadAjaxHandler",formConfigId:i.attr(s.conf.FORMCONFIG_DATAATTR_NAME),elementId:c},multiple:u,sizeLimit:a,allowedExtensions:f,debug:!1,onComplete:function(n,o,i){var r="fileToken_"+c;i.success&&(this.multiple||e.dom.$("[name="+r+"]",l).remove(),e.dom.$(e.dom.util.create("<input/>")).attr({type:"hidden",name:r,value:i.fileId}).prependTo(t)),s.displayFormStatusMessage(c,l,[])},showMessage:function(e){s.displayFormStatusMessage(c,l,[{reason:e}])}}),e.utils.log("initialized uploader: "+o)})}),this.initCaptcha(i)}}});