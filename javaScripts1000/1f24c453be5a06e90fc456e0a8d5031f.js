(function(window,Backbone,$){'use strict';var Facebook=Backbone.Marionette.Object.extend({loginToken:'',facebookEnabled:false,attemptedLogin:false,currentAccessToken:null,currentStatus:null,initialize:function(options){var self=this;window.fbAsyncInit=function(){FB.init({appId:getConfigProperty('FACEBOOK_APP_ID'),cookie:true,xfbml:false,version:'v2.12'});if($('.fb-like').get(0)||$('.fb-like-box').get(0)){FB.XFBML.parse();}
FB.getLoginStatus(function(response){self.currentStatus=response.status;if(response.status==='connected'){self.currentAccessToken=response.authResponse.accessToken;updateExtendedAccessToken(response);}
FB.Event.subscribe('auth.authResponseChange',authChange.bind(self));},true);};webshop.gtm.registerEventSource(this);loadFacebookScript();},authenticate:function(){if(this.getOption('facebookEnabled')){if(this.currentStatus==='connected'||this.currentStatus==='not_authorized'){reauthenticate.call(this);}else{FB.login(function(){}.bind(this),{scope:webshop.config.fbPermissions});}}else{this.trigger("facebookFallback");}},elevateLogin:function(){FB.login(function(response){if(response.authResponse!=null){identifyUser.call(this,response);}}.bind(this),{scope:webshop.config.fbPermissions,auth_type:'reauthenticate'})},isUserConnected:function(){return this.currentStatus==='connected';},logout:function(options){options=_.extend({callback:function(){}},options);isFacebookUserLoggedIn.call(this,function(isLoggedIn){if(isLoggedIn){FB.logout(function(){options.callback();});}else{options.callback();}});}});var instance=null;Backbone.Facebook.getInstance=function(){if(!instance){instance=new Facebook({loginToken:jQ('#loginToken').val(),facebookEnabled:window.Facebook.facebookEnabled});}
return instance;};function isFacebookUserLoggedIn(callback){FB.getLoginStatus(function(response){if(response.status==='connected'){jQ.ajax({url:webshop.social.FacebookRedirects.buildSecureUrl('/isFacebookUserLoggedIn.go'),data:{'ajax':true,'fbuid':response.authResponse.userID},dataType:'jsonp',success:function(data){if(data.isSameUser===true){callback(true);}else{callback(false);}}});}else{callback(false);}});}
function updateExtendedAccessToken(response){jQ.ajax({url:webshop.social.FacebookRedirects.buildSecureUrl('/updateFacebookAccessToken.go'),data:{'ajax':true,'accessToken':response.authResponse.accessToken,'fbuid':response.authResponse.userID},dataType:'jsonp'});}
function loadFacebookScript(){$.ajax({type:"GET",url:"//connect.facebook.net/en_GB/sdk.js",dataType:"script"});}
function reauthenticate(){FB.login(function(response){if(response.authResponse!==null&&response.authResponse.accessToken!==this.currentAccessToken){if(webshop.config.loggedIn){connectUser.call(this,response);}else{identifyUser.call(this,response);}}}.bind(this),{scope:webshop.config.fbPermissions,auth_type:'reauthenticate'});}
function authChange(response){if(response.status!=this.currentStatus||(response.status==='connected'&&this.attemptedLogin)){this.currentStatus=response.status;if(response.status==='connected'){this.currentAccessToken=response.authResponse.accessToken;this.attemptedLogin=true;if(webshop.config.loggedIn){connectUser.call(this,response);}else{identifyUser.call(this,response);}}else if(response.status==='not_authorized'&&webshop.config.loggedIn){this.currentAccessToken=null;window.location='/webshop/logout.do';}else if(webshop.config.loggedIn){this.currentAccessToken=null;window.location='/webshop/logout.do';}}}
function identifyUser(response){jQ.ajax({url:webshop.social.FacebookRedirects.buildSecureUrl('/isFacebookUserRegistered.go'),data:{'ajax':true,'fbuid':response.authResponse.userID,'accessToken':response.authResponse.accessToken},dataType:'jsonp',success:function(data){var loginUrl=webshop.social.FacebookRedirects.buildSecureUrl('/login.go');if(!!window.payPalUserId){loginUrl=webshop.social.FacebookRedirects.buildSecureUrl('/paypalLinkAccountAcceptForm.do?fromFacebook');}
if(data.error){var redirectUrl=webshop.social.FacebookRedirects.buildSecureUrl('/error.do');webshop.ajax.Util.postRedirect(redirectUrl,{'errorMessage':data.message});}
else if(data.valid){this.trigger("identifyUser:dataValid",loginUrl,response,this.getOption('loginToken'));this.trigger('gtm:uaEvent',{category:'Login',action:'fb-loginsuccess-registered'});}else{if(!data.emailExists){this.trigger("identifyUser:dataInvalid:emailAbsent",response.authResponse.userID,response.authResponse.accessToken,response.authResponse.signedRequest);}else{this.trigger("identifyUser:dataInvalid:emailPresent",data.emailExists,data.email,response.authResponse.userID,response.authResponse.accessToken,response.authResponse.signedRequest);}
this.trigger('gtm:uaEvent',{category:'Login',action:'fb-loginsuccess-nowregister'});}}.bind(this),error:function(jqXHR,textStatus,errorThrown){window.location=url;}});}
function connectUser(response){jQ.ajax({url:webshop.social.FacebookRedirects.buildSecureUrl('/linkFacebookAccountOverlay.go'),data:{'ajax':true,'fbuid':response.authResponse.userID,'signedRequest':response.authResponse.signedRequest,'accessToken':response.authResponse.accessToken,'token':Backbone.$('#loginToken').val()},success:function(data){if(data.valid){this.trigger("connectUser:connected");}else{this.trigger("connectUser:alreadyLinked");}}.bind(this),dataType:'jsonp'});}})(window,Backbone,jQuery);(function(webshop,$){'use strict';webshop.social=webshop.social||{};webshop.social.FacebookRedirects={loadLinkAccountOverlay:function(emailExists,email,fbuid,accessToken,signedRequest){postRedirect(webshop.social.FacebookRedirects.buildSecureUrl('/linkAccountDisplay.go'),{emailExists:emailExists,emailAddress:email,fbuid:fbuid,accessToken:accessToken,signedRequest:signedRequest});},goToRegisterForm:function(fbuid,accessToken,signedRequest){postRedirect(webshop.social.FacebookRedirects.buildSecureUrl('/facebookRegistration.do'),{'fbuid':fbuid,'accessToken':accessToken,'signedRequest':signedRequest});},facebookFallback:function(){postRedirect(webshop.social.FacebookRedirects.buildSecureUrl('/login.go?facebookFallBack=true&from=facebookFallBack'),{'_csrf':jQ("meta[name='_csrf']").attr("content")});},redirectToTargetPage:function(loginUrl,response,loginToken){postRedirect(loginUrl,{'fbuid':response.authResponse.userID,'accessToken':response.authResponse.accessToken,'signedRequest':response.authResponse.signedRequest,'token':loginToken,'loginToken':loginToken,'_csrf':jQ("meta[name='_csrf']").attr("content")});},buildSecureUrl:function(page){var url='https://'+document.domain;if(location.port=='8443'||location.port=='8444'){url+=':'+location.port;}
url+=application.url;url+=page;return url;}};function postRedirect(url,params){var form=$('<form id="facebookForm"></form>');form.attr('method','POST');form.attr('action',url);var successRedirectUrl=$('.js-facebook-login-success-redirect').val();if(successRedirectUrl){params['success_redirect']=successRedirectUrl;}
for(var i in params){var input=$('<input />');input.attr('type','hidden');input.attr('name',i);input.attr('value',params[i]);input.appendTo(form);}
if($('#js-popup-content').length){$('#js-popup-content').append(form);}else{$('body').append(form);};form.submit();}})(webshop,jQuery);