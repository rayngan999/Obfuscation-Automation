define(["modules/id.core","modules/id.watchScroll"],function(e,t){"use strict";e.utils.log("loading id.stickyElement.js");var n,i={watchScrollGlobalConf:t.globalConf,defaultTriggeredEvent:"STICKY_ELEMENT_TOGGLE_CLASS",defaultToggleClassName:"id-ScrollWatcher--reached",maxTopToggleClassName:"id-ScrollWatcher--reachedMaxTop",stickyElementPlaceholderClassName:"id-StickyElement-placeholder",triggeredEventNameCalculateSticky:"STICKY_ELEMENT_CALCULATE_STICKY",stickyClassName:"id-StickyElement--isSticky",stickyShowClassName:"id-StickyElement--show",stickyHideClassName:"id-StickyElement--hide",inactiveClassName:"id-StickyElement--inactive"};return n=function(){this.conf={needsPlaceholder:!0,scrollTriggerOffset:0,scrollTriggerOffsetBottom:0,scrollTriggers:[{triggerType:t.globalConf.triggerNameReachViewPortTop,watchDifferentElementSelector:!1,triggeredEvent:{name:i.defaultTriggeredEvent,conf:{hasPlaceHolder:!0,toggleClassName:i.defaultToggleClassName}}}],stickyOnScrollUp:!1,exactToggleMode:!1},this.addPlaceHolder=function(t){var n=e.dom.util.create('<div class="'+i.stickyElementPlaceholderClassName+'"></div>'),o=e.dom.$(n),s=e.dom.$(t);return o.css({height:e.dom.totalHeight(s)}),o.insertBefore(t),s.appendTo(n),n},this.updatePlaceHolders=function(){var t,n,o,s,a=e.dom.$("."+i.stickyElementPlaceholderClassName),r=a.length;for(s=0;r>s;s+=1)t=e.dom.$(a[s]),n=e.dom.$(t[s].firstChild),n.hasClass(i.stickyClassName)?(n.removeClass(i.stickyClassName),o=i.stickyClassName):n.hasClass(i.defaultToggleClassName)&&(n.removeClass(i.defaultToggleClassName),o=i.defaultToggleClassName),t.css({height:e.dom.totalHeight(n)}),o&&n.addClass(o)},this.addScrollWatcher=function(n,i){var o,s,a,r,d,l=i.scrollTriggers,c=l.length;for(this.conf.stickyOnScrollUp&&(this.initScrollTriggersForStickyOnScrollUp(n),l=i.scrollTriggers,c=l.length),o=0;c>o;o+=1)l[o].watchDifferentElementSelector?(r=n,s=e.dom.$(l[o].watchDifferentElementSelector)[0]):(r=!1,s=n),a=new t.module,d=this.conf.stickyOnScrollUp?l[o].triggeredEvent.conf:{elemToToggleClass:n,hasPlaceHolder:l[o].triggeredEvent.conf.hasPlaceHolder,toggleClassName:l[o].triggeredEvent.conf.toggleClassName},this.conf.exactToggleMode&&(d.exactToggleMode=!0),a.conf=e.utils.extend(a.conf,{triggerType:l[o].triggerType,triggerOffset:this.conf.scrollTriggerOffset,triggerOffsetBottom:this.conf.scrollTriggerOffsetBottom,triggeredEvent:{name:l[o].triggeredEvent.name,conf:d},additionalElement:r}),a.init(s)},this.initElement=function(e,t){var n=e;t.needsPlaceholder===!0&&(n=this.addPlaceHolder(e)),this.addScrollWatcher(n,t)},this.init=function(e){this.initElement(e,this.conf)};var n=this,o=300,s=650,a=500,r=!1,d=0,l=e.utils.currentWindowHeight(),c=o>l-o?o:l-o>s?s:l-o;this.lastState={isSticky:!1,isVisible:!1,hasOpenTab:!1,reachedTop:!1,leftTop:!1,scrolledUp:!1,scrolledDown:!1},this.initScrollTriggersForStickyOnScrollUp=function(n){this.conf.scrollTriggers=[],this.watchScrollElement=n,this.stickyElement=n,this.conf.needsPlaceholder&&(this.stickyElement=e.dom.$(e.dom.children(n)[0])),this.addScrollTrigger(t.globalConf.triggerNameReachViewPortTop,this.conf.scrollTriggerOffset,this.conf.scrollTriggerOffsetBottom,i.triggeredEventNameCalculateSticky,{triggeredEventReceiver:this},this.eventHandlerCalculateSticky),this.addScrollTrigger(t.globalConf.triggerNameLeaveViewPortTop,this.conf.scrollTriggerOffset,this.conf.scrollTriggerOffsetBottom,i.triggeredEventNameCalculateSticky,{triggeredEventReceiver:this},this.eventHandlerCalculateSticky),this.addScrollTrigger(t.globalConf.triggerNameScrollUp,this.conf.scrollTriggerOffset,this.conf.scrollTriggerOffsetBottom,i.triggeredEventNameCalculateSticky,{triggeredEventReceiver:this},this.eventHandlerCalculateSticky),this.addScrollTrigger(t.globalConf.triggerNameScrollDown,this.conf.scrollTriggerOffset,this.conf.scrollTriggerOffsetBottom,i.triggeredEventNameCalculateSticky,{triggeredEventReceiver:this},this.eventHandlerCalculateSticky)},this.addScrollTrigger=function(t,n,i,o,s,a){s.triggerType=t,this.conf.scrollTriggers.push({triggerType:t,triggerOffset:n,triggerOffsetBottom:i,watchDifferentElementSelector:!1,triggeredEvent:{name:o,conf:s}}),e.event.subscribe(e.event.constants[o],a,this,!1)},this.eventHandlerCalculateSticky=function(o,s){var l=e.utils.extend({},n.lastState);s.triggeredEventReceiver===n&&(s.triggerType===t.globalConf.triggerNameLeaveViewPortTop&&(l.leftTop=s.eventReached,l.isSticky=l.leftTop,n.lastState.isSticky&&n.lastState.scrolledUp&&(l.isSticky=!0)),s.triggerType===t.globalConf.triggerNameReachViewPortTop&&(l.reachedTop=s.eventReached,n.lastState.isSticky&&!l.reachedTop&&(l.isSticky=!1),n.lastState.hasOpenTab&&l.reachedTop&&(l.isSticky=!0)),s.triggerType===t.globalConf.triggerNameScrollUp&&(d=d+s.viewPortToplastState-s.viewPortTop,r!==!0&&(r=!0,setTimeout(function(){d=0,r=!1},a)),d>c&&(l.isVisible=!0)),s.triggerType===t.globalConf.triggerNameScrollDown&&(l.isVisible=!1,d=0),n.lastState.hasOpenTab&&(l.isVisible=!0),l.isSticky||(l.isVisible=!1),l.isSticky&&!n.lastState.isSticky?n.stickyElement.addClass(i.stickyClassName):!l.isSticky&&n.lastState.isSticky&&n.stickyElement.removeClass(i.stickyClassName),l.isVisible!==n.lastState.isVisible&&(l.isVisible?(n.stickyElement.addClass(i.stickyShowClassName),n.stickyElement.removeClass(i.stickyHideClassName)):(n.stickyElement.addClass(i.stickyHideClassName),n.stickyElement.removeClass(i.stickyShowClassName))),l.reachedTop||l.leftTop||(n.stickyElement.removeClass(i.stickyHideClassName),n.stickyElement.removeClass(i.stickyShowClassName)),n.lastState=l)}},e.event.subscribe(e.event.constants.STICKY_ELEMENT_TOGGLE_CLASS,function(t,n){var o;o=n.hasPlaceHolder?e.dom.$(e.dom.children(e.dom.$(n.elemToToggleClass))[0]):e.dom.$(n.elemToToggleClass),n.exactToggleMode?o.hasClass(i.inactiveClassName)||(n.eventReached?o.addClass(n.toggleClassName):o.removeClass(n.toggleClassName)):o.toggleClass(n.toggleClassName),e.event.publish(e.event.constants.STICKY_ELEMENT_TOGGLED_CLASS,t,n)},this,!1),e.event.subscribe(e.event.constants.WINDOW_WIDTH_CHANGED,(new n).updatePlaceHolders),{module:n,globalConf:i}});