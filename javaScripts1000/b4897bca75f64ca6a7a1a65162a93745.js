webshop.jsConfig=webshop.jsConfig||{};(function(ocBackbone,webshop){'use strict';webshop.jsConfig.popupViewClass=function(targeted){return targeted?ocBackbone.popup.TargetedPopupView:ocBackbone.popup.PopupView;};webshop.jsConfig.fopsNumberOutsideTheWindow=60;webshop.jsConfig.fopsRenderCushion=2;webshop.jsConfig.fopsFeatchCushion=4;webshop.jsConfig.fopsDestroyCushion=6;})(ocBackbone,webshop);(function(Backbone,$){'use strict';Backbone.Webshop.notifications.NotificationView=Backbone.Marionette.ItemView.extend({events:{'click .js-icon-close':'closeNotification','touchstart .js-icon-close':'closeNotification'},className:'notification-animation',delayAnimation:601,wrapper:getWrapper(),initialize:function(options){this.template=Handlebars.templates['notifications/notifications']({content:options.content,type:options.type||'info'});this.model=new Backbone.Model({displayTimeMillis:options.displayTimeMillis||3000});this.render();this.wrapper.append(this.$el);var actualNotificationsCount=this.wrapper.children().length*this.delayAnimation;this.animateNotification(actualNotificationsCount);var that=this;jQ(document).ready(function(){window.ocBackbone.pubsub.on('notification:force:close',that.closeNotification.bind(that),that);});},closeNotification:function(){var _this=this;this.$el.animate({opacity:0,height:0},300,function(){_this.$el.remove();});},animateNotification:function(actualNotificationsCount){var _this=this;this.$el.delay(actualNotificationsCount).animate({right:'0'},550,function(){setTimeout(_this.closeNotification.bind(_this),_this.model.get('displayTimeMillis'));});}});function getWrapper(){var wrapper=$('#notifications');if(wrapper.length==0){wrapper=$('<div id="notifications" class="notification-wrapper"></div>');if($('#content > .rwd-site').length){$('#content > .rwd-site').append(wrapper);}else{$('#content').append(wrapper);}}
return wrapper;}})(Backbone,jQ);(function(Backbone,_){'use strict';Backbone.Webshop.notifications.debouncedNotification=_.debounce(function(text,isError){new Backbone.Webshop.notifications.NotificationView({content:text,type:isError?'error':'success'});},1000,{'leading':true,'trailing':false});})(Backbone,_);webshop.dialogs=webshop.dialogs||{};webshop.dialogs.AddToList=(function(){var getAddToShoppingListPopupInstance=_.once(function(){return new Backbone.Webshop.shoppingLists.AddToShoppingListPopup();});function createSimpleBopObject(skuData){return{sku:skuData.sku,product:{imageSrc:skuData.src,name:skuData.alt}};}
function getSkusFromItems(skuList){return skuList.map(function(item){return item.sku;});}
return{showPopup:function(skuList,config){var shoppingListEventTracker=Backbone.Webshop.ShoppingListEventTracker.getInstance();var addToShoppingListModel,addToShoppingListView;if(config.trolley){addToShoppingListModel=new Backbone.Webshop.shoppingLists.AddFromTrolleyModel({totalItems:skuList.length,skus:getSkusFromItems(skuList)});addToShoppingListView=Backbone.Webshop.shoppingLists.AddFromTrolleyView;}else if(config.source==="Front of pack"){addToShoppingListModel=new Backbone.Webshop.shoppingLists.AddFromFopModel(createSimpleBopObject(skuList[0]));addToShoppingListView=Backbone.Webshop.shoppingLists.AddFromFopView;shoppingListEventTracker.triggerShoppingListPopupOpened();}else{addToShoppingListModel=new Backbone.Webshop.shoppingLists.AddFromBopModel(createSimpleBopObject(skuList[0]));addToShoppingListView=Backbone.Webshop.shoppingLists.AddFromBopView;}
getAddToShoppingListPopupInstance().show(addToShoppingListModel,addToShoppingListView);}}})();(function(Backbone,_){'use strict';Backbone.Webshop.shoppingLists.AddFromBopModel=ocBackbone.popup.PopupModel.extend({url:'/webshop/webservices/shoppingLists/withoutItems/',defaults:{sku:null,lists:[],display:false},getLists:function(){return this.fetch({data:{checkSku:this.get('sku')}});},parse:function(response){return{lists:Backbone.Webshop.shoppingLists.responseRedirectionHandler(response)};},addItemToList:function(listId){var that=this;var sku=this.get('sku');if(this._listContainsSku(listId)){return new Backbone.$.Deferred().reject('List already contains sku '+sku).promise();}
return Backbone.Webshop.ShoppingListsCollection.getInstance().updateShoppingListItem(listId,sku,{quantity:1,silent:true}).then(Backbone.Webshop.shoppingLists.responseRedirectionHandler).then(function(){var lists=_.cloneDeep(that.get('lists'));var updatedList=lists.find(function(list){return+list.listId===+listId;});if(!updatedList){return new Backbone.$.Deferred().reject('List does not exist').promise();}
updatedList.containsSku=true;that.set('lists',lists);}).done(function(){Backbone.Webshop.notifications.debouncedNotification(getMessage('shoppingLists.success.itemAdded'));}).fail(function(error){console.error(error);Backbone.Webshop.notifications.debouncedNotification(getMessage('shoppingLists.error.general'),true);});},addItemToNewList:function(listName){var that=this;var sku=this.get('sku');Backbone.Webshop.ShoppingListsCollection.getInstance().addNewList(listName,[{sku:sku}]).then(Backbone.Webshop.shoppingLists.responseRedirectionHandler).then(function(response){var lists=_.cloneDeep(that.get('lists'));lists.push({"containsSku":true,"listId":response.id,"listName":listName});that.set('lists',lists);}).done(function(){Backbone.Webshop.notifications.debouncedNotification(getMessage('shoppingLists.success.itemAdded'));}).fail(function(error){console.error(error);});},_listContainsSku:function(listId){var listData=this.get('lists').find(function(list){return+list.listId===+listId;});return listData.containsSku;}});})(Backbone,_);(function(Backbone,webshop){'use strict';Backbone.Webshop.shoppingLists.AddFromBopView=Backbone.Marionette.ItemView.extend({template:Handlebars.templates['shoppinglists/addToListView'],ui:{'showNewListFormBtn':'.js-new-list-btn','listBtn':'.js-sl-list','createNewListForm':'.js-new-list-form','newListNameInput':'.js-new-list-name'},events:{"click @ui.showNewListFormBtn":"showNewListForm","click @ui.listBtn":"addItemToList","submit @ui.createNewListForm":"addItemToNewList"},modelEvents:{"change":"render"},initialize:function(){this.eventTracker=Backbone.Webshop.ShoppingListEventTracker.getInstance();},showNewListForm:function(){this.ui.createNewListForm.toggleClass('hidden');this.ui.showNewListFormBtn.toggleClass('hidden');this.ui.newListNameInput.focus();},addItemToList:function(e){this.model.addItemToList(Backbone.$(e.currentTarget).data('slId'));this.onItemAddedToList();},addItemToNewList:function(e){e.preventDefault();var listName=this.ui.newListNameInput.val().trim();this.model.addItemToNewList(listName);this.onListCreated();this.onItemAddedToNewList();},onListCreated:function(){this.eventTracker.triggerNewListCreated();},onItemAddedToList:function(){this.eventTracker.triggerBopItemAddedToList(this.model.get('sku'));},onItemAddedToNewList:function(){this.eventTracker.triggerBopItemAddedToNewList(this.model.get('sku'));}});})(Backbone,webshop);(function(Backbone,_){'use strict';Backbone.Webshop.shoppingLists.AddFromFopModel=Backbone.Webshop.shoppingLists.AddFromBopModel.extend({});})(Backbone,_);(function(Backbone,webshop){'use strict';Backbone.Webshop.shoppingLists.AddFromFopView=Backbone.Webshop.shoppingLists.AddFromBopView.extend({onItemAddedToList:function(){this.eventTracker.triggerFopItemAddedToList(this.model.get('sku'));},onItemAddedToNewList:function(){this.eventTracker.triggerFopItemAddedToNewList(this.model.get('sku'));}});})(Backbone,webshop);(function(Backbone,_){'use strict';var defaultEventContext={source:'Trolley'};Backbone.Webshop.shoppingLists.AddFromTrolleyModel=ocBackbone.popup.PopupModel.extend({url:'/webshop/webservices/shoppingLists/withoutItems/',defaults:{fromTrolley:true,totalItems:0,skus:[],lists:[],display:false},getLists:function(){return this.fetch();},parse:function(response){return{lists:Backbone.Webshop.shoppingLists.responseRedirectionHandler(response)};},addTrolleyToList:function(listId){if(this._alreadyAddedToList(listId)){return new Backbone.$.Deferred().reject('Trolley already added to this list.').promise();}
var that=this;var skus=this.get('skus');return Backbone.Webshop.ShoppingListsCollection.getInstance().mergeBasketIntoList(listId,{silentAddNotification:true}).then(Backbone.Webshop.shoppingLists.responseRedirectionHandler).then(function(){var lists=_.cloneDeep(that.get('lists'));var updatedList=lists.find(function(list){return+list.listId===+listId;});if(!updatedList){return new Backbone.$.Deferred().reject('List does not exist').promise();}
updatedList.containsSku=true;that.set('lists',lists);}).done(function(){Backbone.Webshop.notifications.debouncedNotification(getMessage('shoppingLists.success.trolleyAdded'));}).fail(function(error){console.error(error);Backbone.Webshop.notifications.debouncedNotification(getMessage('shoppingLists.error.general'),true);});},addTrolleyToNewList:function(listName){var that=this;var skus=this.get('skus');Backbone.Webshop.ShoppingListsCollection.getInstance().createListFromBasket(listName).then(Backbone.Webshop.shoppingLists.responseRedirectionHandler).then(function(response){var lists=_.cloneDeep(that.get('lists'));lists.push({"containsSku":true,"listId":response.id,"listName":listName});that.set('lists',lists);}).done(function(){Backbone.Webshop.notifications.debouncedNotification(getMessage('shoppingLists.success.trolleyAdded'));}).fail(function(error){console.error(error);});},_alreadyAddedToList:function(listId){var listData=this.get('lists').find(function(list){return parseInt(list.listId)===parseInt(listId);});return listData.containsSku;}});})(Backbone,_);(function(Backbone){'use strict';Backbone.Webshop.shoppingLists.AddFromTrolleyView=Backbone.Marionette.ItemView.extend({template:Handlebars.templates['shoppinglists/addToListView'],ui:{'showNewListFormBtn':'.js-new-list-btn','listBtn':'.js-sl-list','createNewListForm':'.js-new-list-form','newListNameInput':'.js-new-list-name'},events:{"click @ui.showNewListFormBtn":"showNewListForm","click @ui.listBtn":"addTrolleyToList","submit @ui.createNewListForm":"addTrolleyToNewList"},modelEvents:{"change":"render"},initialize:function(){this.eventTracker=Backbone.Webshop.ShoppingListEventTracker.getInstance();},showNewListForm:function(){this.ui.createNewListForm.toggleClass('hidden');this.ui.showNewListFormBtn.toggleClass('hidden');this.ui.newListNameInput.focus();},addTrolleyToList:function(e){this.model.addTrolleyToList(Backbone.$(e.currentTarget).data('slId'));var skus=this.model.get('skus');sendSkusAddedToListEvent(this.model.get('skus'));},addTrolleyToNewList:function(e){e.preventDefault();var listName=this.ui.newListNameInput.val().trim();this.model.addTrolleyToNewList(listName);sendSkusAddedToNewListEvent(this.model.get('skus'));}});function sendSkusAddedToListEvent(skus){var eventTracker=Backbone.Webshop.ShoppingListEventTracker.getInstance();_.each(skus,function(sku){eventTracker.triggerTrolleyItemAddedToList(sku);});}
function sendSkusAddedToNewListEvent(skus){var eventTracker=Backbone.Webshop.ShoppingListEventTracker.getInstance();_.each(skus,function(sku){eventTracker.triggerTrolleyItemAddedToNewList(sku);});}})(Backbone);(function(Backbone,_){'use strict';var PopupViewClass=webshop.jsConfig.popupViewClass();Backbone.Webshop.shoppingLists.AddToShoppingListPopup=PopupViewClass.extend({blockOverScroll:false,initialize:function(){this.model=new ocBackbone.popup.PopupModel({display:false,classNames:['sl-popup'],modalTitle:getMessage('shoppingLists.addToList.header')});PopupViewClass.prototype.initialize.apply(this,arguments);this.eventTracker=Backbone.Webshop.ShoppingListEventTracker.getInstance();},show:function(addToShoppingListModel,addToShoppingListView){addToShoppingListModel.getLists().done(function(){this.model.show();this.addToListView=new addToShoppingListView({el:'#js-popup-content',model:addToShoppingListModel});this.addToListView.render();}.bind(this)).fail(function(error){console.error(error);Backbone.Webshop.notifications.debouncedNotification(getMessage('shoppingLists.error.general'),true);});},closePopup:function(callback){PopupViewClass.prototype.closePopup.call(this,function(){if(_.isFunction(callback)){callback();}
this.addToListView.remove();this.eventTracker.triggerShoppingListPopupClosed();}.bind(this));}});})(Backbone,_);(function(Backbone,_){'use strict';Backbone.Webshop.shoppingLists.responseRedirectionHandler=function responseRedirectionHandler(response){if(Backbone.Webshop.mixins.ResponseHandler.isRedirectionWarning(response)){var redirectUrl=response.redirectionWarning||response.attributes.redirectionWarning;window.location.href=(redirectUrl.match(/^https?:\/\//i))?redirectUrl:'/webshop'+redirectUrl;return null;}
return response;}})(Backbone,_);(function(Backbone){'use strict';var TIMEOUT_LENGTH=5500;Backbone.Webshop.mixins.ResponseHandler={isRedirectionWarning:function(response){return response&&(response.redirectionWarning||response.attributes&&response.attributes.redirectionWarning);},buildCollection:function(response){if(response.length>1){this.setCollection(response);}else{this.view.model.set('orderId',response[0].orderId);this.saveOrder(response);}},redirectionHandler:function(response){var text=getMessage('oneclick.responsive.redirectionWarning');new Backbone.Webshop.notifications.NotificationView({content:text,type:'error'});setTimeout(function(){var redirectUrl=response.redirectionWarning||response.attributes.redirectionWarning;return window.location.href=(redirectUrl.match(/^https?:\/\//i))?redirectUrl:'/webshop'+redirectUrl;},TIMEOUT_LENGTH);},errorHandler:function(response){switch(response.status){case 401:case 403:var text=getMessage('oneclick.responsive.errorGeneric');new Backbone.Webshop.notifications.NotificationView({content:text,type:'error'});setTimeout(function(){return window.location="/webshop/login.go";},TIMEOUT_LENGTH);break;default:return window.location="/webshop/error.do";}},successHandler:function(name,dateStart,dateEnd){var text=_.template('${name} ${message} ${dayOfWeek} ${dayDate} ${slotTimeStart} - ${slotTimeEnd}')({name:name,message:getMessage('oneclick.responsive.notificationAddedToOrder'),dayOfWeek:moment(dateStart).format('ddd'),dayDate:moment(dateStart).format('DD/MM/YY'),slotTimeStart:moment(dateStart).format('h:mm A'),slotTimeEnd:moment(dateEnd).format('h:mm A')});new Backbone.Webshop.notifications.NotificationView({content:text,type:'success'});}}})(Backbone);