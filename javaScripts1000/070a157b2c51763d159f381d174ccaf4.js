define(['module.base','carousels_light','jquery'],function(Module,carousels_light,$){Module.GetPlaylist=function(){var self=this,vc_id='';self.tpl_main='playlist_module';var locationTargeted='',begin_playing_datetime='',end_playing_datetime='',dailytime_starts_and_ends=[],client_date='',client_time='',carousel_prefix='video-carousel_';self.init=function(elm,wait){var check_datetime=function(playlist_data){if(typeof playlist_data.dailytime_starts_and_ends!=='undefined'&&playlist_data.dailytime_starts_and_ends){dailytime_starts_and_ends=JSON.parse(playlist_data.dailytime_starts_and_ends);client_time=new Date();var ct=("0"+client_time.getHours()).slice(-2)+":"+("0"+client_time.getMinutes()).slice(-2)+":"+("0"+client_time.getSeconds()).slice(-2);if(dailytime_starts_and_ends[0].split("-")[0]<ct){if(dailytime_starts_and_ends[0].split("-")[1]>ct){if(typeof playlist_data.begin_playing_datetime!=='undefined'){begin_playing_datetime=playlist_data.begin_playing_datetime;if(typeof playlist_data.end_playing_datetime!=='undefined'){end_playing_datetime=playlist_data.end_playing_datetime;client_date=new Date().toISOString().slice(0,10);var d1=begin_playing_datetime.split('T')[0].split("-");var d2=end_playing_datetime.split('T')[0].split("-");var cd=client_date.split("-");var from=new Date(d1[0],parseInt(d1[1])-1,parseInt(d1[2])-1);var to=new Date(d2[0],parseInt(d2[1])-1,parseInt(d2[2])+1);var check=new Date(cd[0],parseInt(cd[1])-1,cd[2]);if(check>from&&check<to){if(typeof dailytime_starts_and_ends[1]!=='undefined'){var numFromOrigin=Math.floor((check-from)/86400000)-1;if(numFromOrigin%dailytime_starts_and_ends[1]===0){return true;}}}}}}}}
return false;}
var opts=elm.getAttribute('data-param');if(opts){var o=eval('('+opts+')');var componenttitle=o.ct,moduleregion=o.mr,moduleheading=o.mh,moduletemplate=o.mt,playlists=o.pl,urldataprovcode=o.pv,noofvideostoshowfirst=o.nv,placecode=o.pc;if(moduletemplate){self.tpl_main='playlist_'+moduletemplate;}else{moduletemplate='module';}
var playliststoshow='',playliststartat='',noofvideotoshow='',sponsored_flags='',playlist_cat_mapping=[];$.each(playlists,function(k,v){playlist_cat_mapping[v.PlaylistID]=v.AdCategories;if(typeof v.Location!=='undefined'&&v.Location&&typeof window._config.targeted_location_details!=='undefined'){if($.inArray(v.Location,window._config.targeted_location_details)!==-1){if(typeof v.dailytime_starts_and_ends!=='undefined'&&v.dailytime_starts_and_ends){if(check_datetime(v)===true){playliststoshow+=v.PlaylistID+",";playliststartat+=typeof v.playlist_starts_at!='undefined'?v.playlist_starts_at+",":'0,';noofvideotoshow+=typeof v.no_of_videos_perplaylist!='undefined'?v.no_of_videos_perplaylist+",":'20,';sponsored_flags+=typeof v.higher_priority!='undefined'?v.higher_priority+",":'0,';}}else{playliststoshow+=v.PlaylistID+",";playliststartat+=typeof v.playlist_starts_at!='undefined'?v.playlist_starts_at+",":'0,';noofvideotoshow+=typeof v.no_of_videos_perplaylist!='undefined'?v.no_of_videos_perplaylist+",":'20,';sponsored_flags+=typeof v.higher_priority!='undefined'?v.higher_priority+",":'0,';}}}else{if(v.dailytime_starts_and_ends!==undefined){if(check_datetime(v)===true){playliststoshow+=v.PlaylistID+",";playliststartat+=typeof v.playlist_starts_at!='undefined'?v.playlist_starts_at+",":'0,';noofvideotoshow+=typeof v.no_of_videos_perplaylist!='undefined'?v.no_of_videos_perplaylist+",":'20,';sponsored_flags+=typeof v.higher_priority!='undefined'?v.higher_priority+",":'0,';}}
else{playliststoshow+=v.PlaylistID+",";playliststartat+=typeof v.playlist_starts_at!='undefined'?v.playlist_starts_at+",":'0,';noofvideotoshow+=typeof v.no_of_videos_perplaylist!='undefined'?v.no_of_videos_perplaylist+",":'20,';sponsored_flags+=typeof v.higher_priority!='undefined'?v.higher_priority+",":'0,';}}});playliststoshow=playliststoshow.replace(/,(?=[^,]*$)/,'');playliststartat=playliststartat.replace(/,(?=[^,]*$)/,'');noofvideotoshow=noofvideotoshow.replace(/,(?=[^,]*$)/,'');sponsored_flags=sponsored_flags.replace(/,(?=[^,]*$)/,'');adkvvideocat='';if(typeof(moduletemplate)!=='undefined'&&moduletemplate=='gallery'){noofvideostoshowfirst=20;}
$.ajax({timeout:10000,url:window.url_countrycode+'/api/videodata/getplaylistbyid?playlistID='+playliststoshow+'&noofvideosPerPlaylist='+noofvideotoshow+'&playlistStartsAt='+playliststartat+'&sponsored='+sponsored_flags+(typeof noofvideostoshowfirst!='undefined'&&noofvideostoshowfirst?'&total='+noofvideostoshowfirst:'')+(typeof placecode!='undefined'&&placecode?'&placecode='+placecode:''),success:function(data){_success(data);}});var _success=function(data){if(data){data=$.parseJSON(data);datatorender=_preProcessModuleData(data,moduletemplate,adkvvideocat);var displaySlideQtyValue=self.getNumberOfVideoToDisplayInSlider(moduletemplate);if(typeof(moduletemplate)!=='undefined'&&moduletemplate=='gallery'){carousel_prefix='video-list_';}
vc_id=carousel_prefix+componenttitle;$('#'+vc_id).html(datatorender);$('#'+vc_id).removeClass('visuallyhidden');self.datarendered=true;if(typeof data.name!=='undefined'&&data.name){$('#h4_'+componenttitle).text(data.name);}
if(data.videos.length>0){$('#videos_'+componenttitle).removeClass('doublepad');$('#videos_'+componenttitle).addClass('nopad');var lightslider_options={paginationContainer:vc_id+'_pagination',totalSlideQty:(typeof(moduletemplate)!=='undefined'&&moduletemplate=='rightrail'?3:data.videos.length),displaySlideQty:displaySlideQtyValue}
var initLightSlider=function(){if($('#'+vc_id).children().length>0){carousels_light.bind(vc_id,lightslider_options);}else{setTimeout(function(){initLightSlider();},1000);}};initLightSlider();}}else{return false;}
if(typeof _config.videotoautoload!=="undefined"){window.firstvideoplayed=true;}}
var _preProcessModuleData=function(data,moduletemplate,adkvvideocat){var count=0,divtext='',videoctr=0;var videoarray={videos:[],domain_countrypath:typeof window._config.domain_countrycode!='undefined'&&window._config.domain_countrycode!=''&&window._config.domain_countrycode!='ca'?'/'+window._config.domain_countrycode:'/ca',ga_product:window._config.ga_product,image_url:window._config.image_url};$.each(data.videos,function(k,v){var playlist_cat=(typeof playlist_cat_mapping[v.playlist_id]!=='undefined'?playlist_cat_mapping[v.playlist_id]:'');var videodata='["cid":"'+v.thumbnail_url+'","divid":"'+data.playlist_id+"_"+k+'","pi":"'+data.playlist_id+'","pv":"'+data.provcode+'","ac":"'+data.adcategory+'","akv":"'+playlist_cat+'","title":"'+v.title+'","vid":"'+v.video_id+'"]';videoarray.videos.push({"videodata":videodata,"slideindex":k,"title":v.title,"videoStillURL":"src="+v.thumbnail_url,"playlist_id":v.playlist_id,"urlname":v.seo_name,"video_id":v.video_id,"playlist_sequence_no":v.sequence_no,"videocat":playlist_cat,"gap_category":(typeof data.name!=="undefined")?data.name:'geo_targetted'});});if(typeof window.templates['playlistdata_'+moduletemplate]!=='undefined'){var tempHTML=Mustache.render(window.templates['playlistdata_'+moduletemplate],videoarray);divtext+=tempHTML;}
return divtext;}}}
self.getNumberOfVideoToDisplayInSlider=function(moduletemplate){var displaySlideQtyNum=3;if(typeof(moduletemplate)!=='undefined'){switch(moduletemplate){case'gallery':displaySlideQtyNum=4;break;case'rightrail':displaySlideQtyNum=1;break;}}
return displaySlideQtyNum;}};return Module.factory('GetPlaylist');});;