(function(){try{const globalOptions=getParameterValues(window,"viewability_options");const options={url:globalOptions["url"]||"https://storage.googleapis.com/dianomi-viewability/1x1.png",threshold:globalOptions["threshold"]||0.5,tagParams:globalOptions["tagParams"]||["adgroup_ids","device_type","publisher_id","smartad_id","impression_id","geo_country","referer"],viewabilityTime:globalOptions["viewabilityTime"]||1000,multipleViews:globalOptions["multipleViews"],selectors:[{name:"dianomi_video",type:"video",selector:"class"},{name:"dianomi_ad_",type:"adgroup",selector:"id"}],maxHeight:650,attributes:{adGroupVariantSelector:"data-adgroup-variant-id",impressionUrlsTrigger:"data-dianomi-trigger-trackers",impressionUrls:"data-dianomi-impression-trackers",viewability:"data-dianomi-viewability",clickTrackers:"data-dianomi-click-trackers"}};let campaignParams=getCampaignParams();let visibleAds=[];function getDianomiElement(){const dianomiElements=[];const addElement=(element,type)=>{const aTags=element.getElementsByTagName("a");const adId=getAdId(aTags,element);const impressionUrls=getImpressionUrls(aTags);const impressionUrlsTrigger=getAttributeValue(aTags,options.attributes.impressionUrlsTrigger);const viewabilityTrigger=getAttributeValue(aTags,options.attributes.viewability);setClickTrackers(aTags);const elementExists=visibleAds.filter((elem)=>elem.adId===adId);if(elementExists.length<1){const elementDetails={element,type,adId,adViewed:false,entry:null,inView:false,impressionUrls,impressionUrlsTrigger,impressionUrlsAreSet:false,viewabilityTrigger};dianomiElements.push(elementDetails);}};for(let i=0;i<options.selectors.length;i++){const selector=options.selectors[i];let elements=[];switch(selector.selector){case "class":elements=document.getElementsByClassName(selector.name);for(let j=0;j<elements.length;j++){addElement(elements[j],selector.type);}
break;case "id":elements=document.querySelectorAll(`[id^="${selector.name}"`);for(let j=0;j<elements.length;j++){addElement(elements[j],selector.type);}
break;}}
return dianomiElements;}
function createObservers(fn,threshold){setTimeout(()=>{visibleAds=getDianomiElement();let observerOptions={threshold};let observer=new IntersectionObserver(fn,observerOptions);visibleAds.forEach((ad)=>{observer.observe(ad.element);ad.viewabilityTrigger>0&&sendCampaignStats(true,ad);});},500);}
function handleIntersect(entries){entries.forEach((entry)=>{const aTags=entry.target.getElementsByTagName("a");const adId=getAdId(aTags,entry.target);let ad;for(let i=0;i<visibleAds.length;i++){if(visibleAds[i].adId&&visibleAds[i].adId===adId&&visibleAds[i].element===entry.target){ad=visibleAds[i];break;}}
!ad.entry&&ad.impressionUrlsTrigger===0&&setImpressionUrls(ad);if(entry.isIntersecting&&entry.intersectionRatio>=options.threshold&&!ad.entry){ad.entry=entry;ad.inView=true;checkVisibleAds(ad);}else if(ad.entry){ad.inView=false;const timeDiff=Math.floor(entry.time-ad.entry.time);if(timeDiff>=options.viewabilityTime){ad.viewabilityTrigger>0&&sendCampaignStats(false,ad);ad.impressionUrlsTrigger>0&&setImpressionUrls(ad);}}});}
function setImpressionUrls(ad){if(ad.impressionUrls.length>0&&!ad.impressionUrlsAreSet){ad.impressionUrls.forEach((url)=>sendXMLHttpRequest(url));ad.impressionUrlsAreSet=true;}}
function getAdId(aTags,entry){let adgroupVariantId;for(let i=0;i<aTags.length;i++){const adgroupAttr=aTags[i].getAttribute(options.attributes.adGroupVariantSelector);if(adgroupAttr){adgroupVariantId=adgroupAttr;break;}}
return adgroupVariantId?adgroupVariantId:entry.getAttribute("data-dianomi-video-id");}
function getImpressionUrls(aTags){let urls=[];for(let i=0;i<aTags.length;i++){const urlsString=aTags[i].getAttribute(options.attributes.impressionUrls);if(urlsString){urlsString.split(",").forEach((url)=>urls.push(decodeURIComponent(url)));}}
return urls;}
function getAttributeValue(elems,attributeKey){for(let i=0;i<elems.length;i++){const attr=elems[i].getAttribute(attributeKey);if(attr){return parseInt(attr);}}
return 0;}
function setClickTrackers(aTags){for(let i=0;i<aTags.length;i++){const trackersAttr=aTags[i].getAttribute(options.attributes.clickTrackers);if(trackersAttr){const trackers=trackersAttr.split(",").map((tracker)=>decodeURIComponent(tracker));aTags[i].addEventListener("click",(e)=>{trackers.forEach((url)=>sendXMLHttpRequest(url));});}}}
function checkVisibleAds(ad){setTimeout(()=>{if(ad.inView){ad.viewabilityTrigger>0&&sendCampaignStats(false,ad);ad.impressionUrlsTrigger>0&&setImpressionUrls(ad);}},options.viewabilityTime);}
function sendCampaignStats(pageLoad,ad){if(pageLoad||options.multipleViews||!ad.adViewed){let url=options.url+createQuery(pageLoad,ad);sendXMLHttpRequest(url);if(!pageLoad){ad.adViewed=true;}}}
function sendXMLHttpRequest(url){if(!url.includes("dianomi.com")){const script=document.createElement("img");script.src=url;document.body.appendChild(script);}else{const xhttp=new XMLHttpRequest();xhttp.open("GET",url);xhttp.send();}}
function createQuery(pageLoad,ad){let query=`?initial_load=${pageLoad}`;if(ad.type==="adgroup"){query+=`&ad_group_variant_id=${ad.adId}`;}else if(ad.type==="video"){query+=`&video_id=${ad.adId}`;}
Object.keys(campaignParams).forEach((key)=>{query+=`&${key}=${campaignParams[key]}`;});return query;}
function getParameterValues(object,keyname){let newObject={};Object.keys(object).forEach((key)=>{if(key.substring(0,keyname.length)===keyname){newObject=object[key];}});return newObject;}
function selectedParams(object,params){let newObject={};Object.keys(object).forEach((tag)=>{if(params.includes(tag)){newObject[tag]=object[tag];}});return newObject;}
function getCampaignParams(){let dianomiTag=selectedParams(getParameterValues(window,"dianomi_tag_params_"),options.tagParams)||{};if(!dianomiTag.smartad_id){try{dianomiTag["smartad_id"]=document.getElementsByTagName("div")[0].attributes["data-smartad-id"].textContent;}catch(error){throw new Error("No campaign details available");}}
return dianomiTag;}
createObservers(handleIntersect,options.threshold);}catch(error){console.error(error);}})();