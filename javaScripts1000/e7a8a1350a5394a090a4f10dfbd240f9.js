class lrPoll{constructor(e=".polli-container",t="//umfrage.maerkischepresse.net/"){this.api=t,this.cookieName="polli",this.polls=document.querySelectorAll(e),this.initContainers()}initContainers(){Array.from(this.polls).forEach(e=>{if(!1 in window)return void this.loadPollData(e);let t=this,a=new IntersectionObserver(function(l){l[0].isIntersecting&&(t.loadPollData(e),a.disconnect())},{rootMargin:"500px 0px 500px 0px"});a.observe(e)})}loadPollData(e){let t=this.getPollID(e);t?this.fetchPollData(t).then(a=>{if("1"==a.status){let t=a.data;this.displayPollElement(t,e)}else console.warn(`Poll-ID: ${t} ${a.message}`),e.style.display="none"}):console.warn(`Poll: No data-poll-id found on ${e}`)}getPollID(e){let t=e.getAttribute("data-poll-id");return(t=(t=t.split(","))[Math.floor(Math.random()*t.length)]).trim()}fetchPollData(e){return fetch(this.api+e).then(e=>e.json()).then(e=>e).catch(t=>{console.error(`Poll: TED ${e} canÂ´t be fetched`),console.error(`Poll: API Error: ${t}`)})}calculatePollStats(e){let t=0,a="",l="";return e.forEach(e=>{t+=parseInt(e.Value)}),e.forEach((i,o)=>{t>0&&(a=(parseInt(i.Value)/parseInt(t)*100).toFixed(2)),l=a.replace(".",","),e[o].votePercent=a,e[o].votePercentGerman=l,e[o].votePlain=i.Value+"/"+t}),e}displayPollElement(e,t){let a=document.createElement("div");if(a.classList.add("polli-headline"),a.innerHTML=e.Question,t.appendChild(a),e.Teaser){let a=document.createElement("div");a.classList.add("polli-teaser"),a.innerHTML=e.Teaser,t.appendChild(a)}if(1==this.getCookie(this.cookieName+e.ID))return void this.showStats(e,t);let l=Date.now(),i=localStorage.getItem(this.cookieName+e.ID);if(i){if(new Date(l-i).getMinutes()<e.CookieExpire)return void this.showStats(e,t);localStorage.removeItem(this.cookieName+e.ID)}Date.now()>Date.parse(e.EndDate)?this.showStats(e,t):e.Answers.forEach((a,l)=>{let i=document.createElement("div");i.setAttribute("data-answer-id",a.ID),i.className="polli-item prevote";let o=document.createElement("p"),n=`${a.Name}`;o.innerHTML=n,i.appendChild(o),t.appendChild(i);const s=this;i.addEventListener("click",function(){s.sendVoteToApi(this).then(a=>{if(this.parentElement.querySelectorAll(".polli-item").forEach(e=>{e.remove()}),1==a.status)e.Answers[l].Value=parseInt(e.Answers[l].Value)+1,s.setVoteCookie(e.ID,e.CookieExpire),s.showStats(e,t);else{let e=document.createElement("div");e.className="polli-item error",e.innerHTML=a.message,t.appendChild(e)}})})})}showStats(e,t){if("secret"==e.Type){let e=document.createElement("div");return e.className="polli-item info",e.innerHTML="Vielen Dank fÃ¼r Ihre Stimme - die Umfrage ist geheim!",void t.appendChild(e)}if("delayed"==e.Type){let a=Date.parse(e.EndDate);if(a>Date.now()){let e=new Date(a);e=e.toLocaleDateString();let l=document.createElement("div");return l.className="polli-item info",l.innerHTML=`Vielen Dank fÃ¼r Ihre Stimme - Das Ergebnis wird am ${e} verÃ¶ffentlicht!`,void t.appendChild(l)}}e.Answers=this.calculatePollStats(e.Answers),e.Answers.forEach(e=>{let a=document.createElement("div");a.setAttribute("data-answer-id",e.ID),a.className="polli-item",1==e.Highlight&&(a.className="polli-item marked");let l=document.createElement("p"),i=`${e.Name} <small>${e.votePercentGerman}%</small> <span>(${e.votePlain})</span>`;l.innerHTML=i;let o=document.createElement("div");o.className="polli-bar",o.setAttribute("data-value",e.votePercent);let n=document.createElement("div");o.appendChild(n),setTimeout(t=>{n.style.width=e.votePercent+"%"},100),a.appendChild(l),a.appendChild(o),t.appendChild(a)});let a=document.createElement("div");a.className="polli-ad",a.innerHTML='<img src="https://umfrage.maerkischepresse.net/styles/img/Logo_MOZplus.svg"><p>Bleiben Sie informiert, wie es mit dem Thema weitergeht!</p><p>Hier kostenlosen Probemonat sichern und jederzeit alle PLUS-Inhalte auf <b>MOZ.de</b> lesen!</p><p><a href="https://www.moz.de/plus?utm_campaign=MozPlusallg&utm_source=mozde&utm_medium=Umfragetool&utm_term=DTM" target="_blank">Jetzt Testen</a></p>',t.appendChild(a)}setVoteCookie(e,t){this.setCookie(this.cookieName+e,1,t);let a=Date.now();localStorage.setItem(this.cookieName+e,a)}getCookie(e){for(var t=e+"=",a=document.cookie.split(";"),l=0;l<a.length;l++){for(var i=a[l];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""}setCookie(e,t,a){var l=new Date;l.setTime(l.getTime()+60*a*1e3);var i="expires="+l.toUTCString();document.cookie=e+"="+t+";"+i+";path=/"}async sendVoteToApi(e){const t=e.getAttribute("data-answer-id");let a=await fetch(this.api+"vote/"+t);return await a.json()}}