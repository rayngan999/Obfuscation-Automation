define(['session','web/modules/mylocations'],function(session,mylocations){var _recent_locations=(function(){var _recent_location_limit=8,replace_locale='';self.set_recent_location=function(location_name,province,country,location_code,product_type,prov_code,post_code,grid_index){var storage_name='pelm_rec_loc',stored_locations='';location_name=escape(location_name);product_type=stripCountryCodeUrl(product_type);if(province)province=escape(province);if(country)country=escape(country);if(product_type)product_type=escape(product_type);if(prov_code)prov_code=escape(prov_code);if(post_code)post_code=escape(post_code);if(pelm_util.notEmpty(session.fld(storage_name))){stored_locations=session.fld(storage_name);stored_locations=stored_locations.replace(/''/g,"\"\"");stored_locations=stored_locations.replace(/'|\\'/g,"\\'");stored_locations=stored_locations.replace(/\\',/g,"\",");stored_locations=stored_locations.replace(/,\\'/g,",\"");stored_locations=stored_locations.replace(/\[\\'/g,"\[\"");stored_locations=stored_locations.replace(/\\'\]/g,"\"\]");stored_locations=eval(stored_locations);}else{stored_locations=new Array(_recent_location_limit);for(var n=0;n<_recent_location_limit;n++){stored_locations[n]=new Array(11);}}
var match=0,matchPosition=-1;if(pelm_util.notEmpty(stored_locations)){for(var y=stored_locations.length-1;y>=0;y--){if(location_code==stored_locations[y][3]&&post_code==stored_locations[y][7]&&grid_index==stored_locations[y][8]){match=1;matchPosition=y;}
if(pelm_util.isDefined(stored_locations[y][1])){stored_locations[y][1]=escape(stored_locations[y][1]);}}
if(match==0){var quick_url=(pelm_util.notEmpty(window._config['url_bypass_construction'])?stripCountryCodeUrl(window._config['url_bypass_construction']):'');if(stored_locations.length<_recent_location_limit){stored_locations.shift();}else{stored_locations.sort(sortfav_array);stored_locations.pop();}
stored_locations.push(new Array(location_name,province,country,location_code,1,product_type,prov_code,post_code,grid_index,quick_url,new Date().getTime()));}else{if(matchPosition!=-1){stored_locations[matchPosition][4]++;if(pelm_util.isEmpty(stored_locations[matchPosition][9])&&pelm_util.notEmpty(window._config['url_bypass_construction'])){stored_locations[matchPosition][9]=stripCountryCodeUrl(window._config['url_bypass_construction']);}
if(pelm_util.isEmpty(stored_locations[matchPosition][10])){stored_locations[matchPosition][10]=new Date().getTime();}}}
session.save_localstorage(storage_name,JSON.stringify(stored_locations));}};self.get_recent_location=function(storage_name){var html='';if(pelm_util.notEmpty(session.fld(storage_name))){var recent_location_array=eval(session.fld(storage_name));if(pelm_util.notEmpty(recent_location_array)){recent_location_array.sort(sortfav_array);for(var i=0;i<recent_location_array.length;i++){var temp_location=recent_location_array[i];if(pelm_util.notEmpty(temp_location[0])&&pelm_util.notEmpty(temp_location[3])){var city_name=unescape(temp_location[0]);var prov_code='',display_name='';if(stripCountryCodeUrl(temp_location[5])==stripCountryCodeUrl(window._config['url_weather'])){prov_code=unescape(temp_location[6]);display_name=city_name;}else{city_name=city_name.split(",");display_name=city_name[0];prov_code=(pelm_util.isDefined(city_name[1])?unescape(city_name[1]):'');}
display_name=decodeURIComponent(display_name);if(pelm_util.notEmpty(prov_code)){prov_code=', '+prov_code;}else if(pelm_util.notEmpty(temp_location[2])){prov_code=', '+unescape(temp_location[2]);}
if(display_name.length>=28){display_name=display_name.substr(0,25);display_name=display_name+"...";}
display_name=display_name+prov_code;var temp_location_url='';temp_location_url=buildUrlFromData(temp_location);html=html+'<li class="result" id="'+temp_location[3]+'"><a data-event-action="clicks" data-event-label="recentLocationsDropDown" data-replace_locale="'+replace_locale+'" data-omni_link_name="'+window._config.site_prefix+': search: recent location dropdown: '
+temp_location[3]+'" data-omni_action="search: recent location dropdown" href="'+temp_location_url+'">'
+display_name+'</a></li>';}}}}
return html;};var buildUrlFromData=function(my_arrayr){var link_url='',countrycode_append=(typeof window.url_countrycode!='undefined')?window.url_countrycode:'';my_arrayr[5]=stripCountryCodeUrl(my_arrayr[5]);if(my_arrayr[5].indexOf('/')>=0){var splt=my_arrayr[5].split('/'),sz=splt.length;my_arrayr[5]=splt[sz-1];}
switch(my_arrayr[5]){case'weather':case'meteo':var find=' ';var re=new RegExp(find,'g');link_url='/'+my_arrayr[5]+'/'+my_arrayr[3];break;case'golf-report':case'ski-and-snow':case'airport-forecast':case'school-day':case'camping':link_url='/forecasts/'+my_arrayr[5]+'/'+my_arrayr[3];break;case'parks':link_url='/outdoors/'+my_arrayr[5]+'/'+my_arrayr[3];break;case'golf':case'ski-neige':case'aeroports':case'scolaires':link_url='/previsions/'+my_arrayr[5]+'/'+my_arrayr[3];break;case'parcs':link_url='/plein-air/'+my_arrayr[5]+'/'+my_arrayr[3];break;default:link_url='/'+my_arrayr[5]+'/'+my_arrayr[3];}
return link_url;};stripVowelAccent=function(str){if(typeof str!="undefined"&&str!=null&&str!=""){var rExps=[/[\xC0-\xC2]/g,/[\xE0-\xE2]/g,/[\xC8-\xCA]/g,/[\xE8-\xEB]/g,/[\xCC-\xCE]/g,/[\xEC-\xEE]/g,/[\xD2-\xD4]/g,/[\xF2-\xF4]/g,/[\xD9-\xDB]/g,/[\xF9-\xFB]/g];var repChar=['A','a','E','e','I','i','O','o','U','u'];for(var i=0;i<rExps.length;i++)
str=str.replace(rExps[i],repChar[i]);}
return str;};trim=function(s){return s.replace(/^\s+|\s+$/,'');};function sortfav_array(a,b){if(a[4]<b[4])
return 1;else if(a[4]>b[4])
return-1;else if(a[10]&&b[10]&&a[10]<b[10])
return 1;else if(a[10]&&b[10]&&a[10]>b[10])
return-1;else
return 0;};var stripCountryCodeUrl=function(urlstr){var purl=urlstr||'';var countrycode=/^[A-z]{2}$/g;var split_url=purl.split("/");if((typeof split_url[0]!=="undefined"||split_url[0]!=="")&&(split_url[0].match(countrycode))||(typeof split_url[1]!=="undefined"||split_url[1]!=="")&&(split_url[1]&&split_url[1].match(countrycode))){var rurl=(split_url[0].match(countrycode))?split_url[0]:split_url[1];purl=purl.replace(rurl+'/','').replace(rurl,'');}
return purl;},getProductCountrycode=function(locType){var pcountry='';var data=window._config.domain_redirect_products;if(data&&data.indexOf('{')>=0&&data.indexOf('<')<0){data=JSON.parse(data);}
if(locType.indexOf('/')>=0){var splt=locType.split('/'),sz=splt.length;locType=splt[sz-1];}
switch(stripCountryCodeUrl(locType)){case'school-day':case'scolaires':pcountry=(data.schools.countrycode)?'/'+data.schools.countrycode:'';replace_locale=(data.schools.locale)?data.schools.locale:'';break;case'cottages':case'cottage':pcountry=(data.cottages.countrycode)?'/'+data.cottages.countrycode:'';replace_locale=(data.cottages.locale)?data.cottages.locale:'';break;case'attractions':pcountry=(data.attractions.countrycode)?'/'+data.attractions.countrycode:'';replace_locale=(data.attractions.locale)?data.attractions.locale:'';break;case'golf-report':pcountry=(data.golf.countrycode)?'/'+data.golf.countrycode:'';replace_locale=(data.golf.locale)?data.golf.locale:'';break;case'ski-and-snow':pcountry=(data.ski.countrycode)?'/'+data.ski.countrycode:'';replace_locale=(data.ski.locale)?data.ski.locale:'';break;case'airport-forecast':pcountry=(data.airports.countrycode)?'/'+data.airports.countrycode:'';replace_locale=(data.airports.locale)?data.airports.locale:'';break;case'parks':pcountry=(data.parks.countrycode)?'/'+data.parks.countrycode:'';replace_locale=(data.parks.locale)?data.parks.locale:'';break;default:pcountry=(typeof window.url_countrycode!='undefined')?window.url_countrycode:'';replace_locale='';break;}
return pcountry;};return self;});return _recent_locations();});;