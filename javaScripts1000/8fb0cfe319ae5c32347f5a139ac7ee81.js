/***************************************
 * @preserve
 * Copyright (c) 2019 Verint Systems, Inc. All rights reserved.
 * ForeSee Web SDK: Trigger
 * Version: 19.11.0
 * Built: September 13, 2019, 12:55:27 PDT
 ***************************************/
_fsDefine(["fs",_fsNormalizeUrl("$fs.utils.js"),_fsNormalizeUrl("$fs.compress.js"),"exports"],function(e,t,i,r){var s={loadedEmitter:new t.FSEvent,initializedEmitter:new t.FSEvent,inviteShownEmitter:new t.FSEvent,inviteAcceptedEmitter:new t.FSEvent,inviteAbandonedEmitter:new t.FSEvent,inviteDeclinedEmitter:new t.FSEvent,trackerShownEmitter:new t.FSEvent,customInvitationRequested:new t.FSEvent,CPPS:null,_triggerResetLock:null,state:{didInvite:!1},inviteSetup:null},n="fs_inviteShown",o="fs_inviteAccepted",a="fs_inviteDeclined",c="fs_inviteAbandoned",f="fs_linksCancel",l=window,u=function(){function i(e,t){this.stg=e,this.cfg=t}var r=i.prototype;return r.calcReplayPoolStatus=function(i){var r,s=this.cfg.config,n=s.replay_pools,o=l.location.toString();if(!n||0===n.length||!0===this.pooloverride)return i(!0);var a=this.stg.get("pl");if(!e.isDefined(a))for(r=0;r<n.length;r++)t.testAgainstSearch(n[r].path,o)&&(a=100*Math.random()<n[r].sp?1:0,this.stg.set("pl",a,144e5));var c=s.replay_repools;if(0===a&&c&&c.length>0)for(r=0;r<c.length;r++)t.testAgainstSearch(c[r].path,o)&&(a=100*Math.random()<c[r].sp?1:0,this.stg.set("pl",a,144e5));return i(!!a)},r.optoutCheck=function(e,t){var i=this;this.stg.ready.subscribe(function(){!0===i.stg.get("optout")?t():e()},!0,!0)},r.browserCheck=function(e,t){return!(!e.isMobile&&t.config.browser_cutoff[e.browser.name]&&e.browser.actualVersion<t.config.browser_cutoff[e.browser.name])},r.featureCheck=function(e,i){return!(i.config.persistence==t.storageTypes.DS&&!e.supportsLocalStorage)},r.platformCheck=function(e,t){return!(t.config.platform_cutoff[e.os.name]&&e.os.version<t.config.platform_cutoff[e.os.name])},r.checkDeviceBlacklist=function(t,i){for(var r=0;r<i.config.device_blacklist.length;r++)if(e.toLowerCase(t.agent).indexOf(e.toLowerCase(i.config.device_blacklist[r]))>-1)return!1;return!0},r._match=function(e,t,i){var r=e.include,s=e[i||"globalExclude"];if(e.criteria){if(!e.criteria.supportsSmartPhones&&!t.isTablet&&t.isMobile)return!1;if(!e.criteria.supportsTablets&&t.isTablet)return!1;if(!e.criteria.supportsDesktop&&!t.isMobile)return!1}if(s&&this.runAllTests(s,t,!1,!0))return!1;return!r||this.runAllTests(r,t,!1,!0)},r.runAllTests=function(i,r,s,n){var o,a=new t.Cookie({}),c={urls:l.location.href.toString(),referrers:document.referrer.toString(),userAgents:l.navigator.userAgent};function f(e,i){Array.isArray(i)||(i=[i]);for(var r=0,s=i.length;r<s;r++)if("string"==typeof i[r]&&(i[r]=i[r].replace(/-_DS_-/gi,"$$")),t.testAgainstSearch(i[r],e))return!0;return!1}for(var u in i){var g=i[u];if(g.length>0){if(o=!1,c[u])o=f(c[u],g);else if("browsers"==u)for(var d=r.browser.name,h=r.browser.actualVersion,p=0;p<g.length;p++)e.toLowerCase(d).indexOf(e.toLowerCase(g[p].name))>-1&&(g[p].comparison?"lt"==g[p].comparison&&h<g[p].version?o=!0:"eq"==g[p].comparison&&h==g[p].version?o=!0:"gt"==g[p].comparison&&h>g[p].version&&(o=!0):o=!0);else if("cookies"==u)for(var v=0;v<g.length;v++){var m=g[v],b=a.get(m.name);e.isDefined(m.value)&&b==m.value?o=!0:!e.isDefined(m.value)&&b&&(o=!0)}else if("variables"==u)for(var y=0;y<g.length;y++){var w=g[y],S=t.retrieveNestedVariable(l,w.name);S||(S="boolean"!=typeof S&&"");var _=e.isDefined(w.value);_&&S===w.value?o=!0:_&&t.testAgainstSearch(w.value,S)?o=!0:!_&&S&&(o=!0)}if(!o&&s)return!0;if(o&&n)return!0}}return!1},i}(),g=function(){function i(t,i,r,s){this.cfg=t,this.globalConfig=t.globalConfig||e.globalConfig,this.cpps=i,this.def=r,this.locale=i.get("locale")||"en",this.qual=s}var r=i.prototype;return r.decideModernSurvey=function(){var e=this.cfg.config.abSurveyType,t=e&&e.shouldTest&&this.globalConfig.modernSurveyUrl&&d(e,this.def);return this.cfg.config.onlyModernSurvey?{modernChosen:!0,modernPercentage:100}:t?{modernChosen:t.modernPercentage>=Math.floor(100*Math.random()),modernPercentage:t.modernPercentage}:{modernChosen:!1,modernPercentage:0}},r.getMeasureId=function(){return[this.def.name,this.def.site,this.def.section,this.locale,this.qual?this.qual.qualifiesValue:null].filter(function(e){return e}).join("-")},r.getUrl=function(){var e=this.decideModernSurvey();if(e.modernChosen)return this._buildUrl(this.globalConfig.modernSurveyUrl,this._getParams({}));var i=t.now()+"_"+Math.round(1e13*Math.random()),r=this._getParams({a:i,b:t.hash(i),c:864e5,mp:e.modernPercentage});return this._buildUrl(this.globalConfig.surveyUrl,r)},r._getParams=function(t){return e.ext({sid:this.getMeasureId(),cid:this.globalConfig.customerId,pattern:this.cpps.get(this.def.pattern)||this.def.pattern},t||{},!1)},r._buildUrl=function(t,i){var r=t+"?";for(var s in i)r+=e.enc(s)+"="+e.enc(i[s])+"&";return r+=this.cpps.toQueryString(["browser","os"])},r.getShortSurveyUrl=function(e){var t=e.pageView,i=e.paginationType,r=e.midOverride;try{if(1===t&&sessionStorage.removeItem("FSR_SSURL"),t>1){var s=sessionStorage.getItem("FSR_SSURL");if(s)return s}}catch(a){}var n=this.globalConfig.modernSurveyUrl,o=this._getParams({template:"contextual",pv:t,paginationType:i});return r&&(delete o.cid,delete o.sid,o.mid=r),o.paginationType||delete o.paginationType,this._buildUrl(n,o)},r.getShortSurveyOrigin=function(){return e.globalConfig.modernSurveyUrl.replace(/\/sv$/,"")},i}(),d=function(e,t){var i,r,s,n=t.name||"";for(n+="-"+(t.section||""),n+="-"+(t.site||""),i=0;i<e.defs.length;i++)if(r=(s=e.defs[i]).name||"",r+="-"+(s.section||""),(r+="-"+(s.site||""))===n)return s;return null};function h(t,i,r,s,n,o){var a={width:700,height:350,left:50,top:50,resizable:"no",scrollbar:"1",scrollbars:"1",toolbar:"no",menubar:"no",location:"0",directories:"no",status:"no"},c=o?function(e,t){var i=void 0!==window.screenLeft?window.screenLeft:screen.left,r=void 0!==window.screenTop?window.screenTop:screen.top,s=window.innerWidth;window.innerWidth||(s=document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width);var n=window.innerHeight;window.innerHeight||(n=document.documentElement.clientHeight?document.documentElement.clientHeight:screen.Height);return{left:s/2-e/2+i,top:n/2-t/2+r}}(r.width||a.width,r.height||a.height):{},f=e.ext(a,r,c),u="";for(var g in f)u+=g+"="+f[g]+",";var d=this._win=l.open(t,i,u);if(d&&n)if(d.blur(),d.opener.window.focus(),l.focus(),"Firefox"==s.browser.name){var h=l.open("about:blank");h.focus(),h.close()}else s.isIE&&setTimeout(function(){d.blur(),d.opener.window.focus(),l.focus()},1e3);return d}var p=function(){function i(i,r,n,o,a,c,f){var u=this;s.tracker&&(s.tracker.dispose(),s.tracker=null),s.tracker=this,e.ext(this,{template:i,def:r,cfg:n,disp:c,_fcBindings:[]},!1),this.cpps=a,this.br=f,this.stg=o;var g=0;window.performance&&window.performance.timing&&(g=window.performance.timing.domComplete-window.performance.timing.navigationStart),this.hbi=3*Math.max(n.config.trackerHeartbeatTimeout,s.pageLoadTime,g),i&&s.trackerShownEmitter.fire(r,o,n,a),e.globalConfig.storage!==t.storageTypes.MC&&this.stg._readyState.subscribe(function(){if(o._serverFails>0){var e=t.getGeneralStorage(f);e.set("i","f"),s.state.inviteSituation="BRAINFAILED",e.set("fw",t.now()+432e5)}},!0,!1),this.stg.ready.subscribe(function(){u.stg.set("tracker_hb",t.now(),u.hbi,!1);var e=function(e){u.stg.set("page_hb",t.now(),u.hbi,!!e)},i=u.stg.onCommit.subscribe(function(){null===o.get("tracker_hb")?t.now()-u.lastTimeSeenTracker>u.cfg.config.trackerHeartbeatTimeout&&(i.unsubscribe(),delete u.lastTimeSeenTracker,u.dispose()):u.lastTimeSeenTracker=t.now()},!1,!1);u._heartbeat=setInterval(e,Math.round(.5*u.cfg.config.trackerHeartbeatTimeout)),e(!0)},!0,!0),t.Bind(l,"unload",function(){u.hbi=u.cfg.config.trackerHeartbeatLongTimeout,u.stg.set("page_hb",t.now(),u.hbi,!0)});var d=e.enc;this._url=e.makeURI(["$fs.tracker.html?uid=",d(o.uid||""),"&sitekey=",d(e.globalConfig.siteKey),"&domain=",d(t.getRootDomain()),"&gw=",d(e.makeURI("trigger/__gwtest__")),"&brain_url=",d(e.globalConfig.brainUrl),"&fsrlocale=",d(a.get("locale")||"en"),"&_svu_=",d(e.globalConfig.surveyUrl),"&_cv_=",d(e.globalConfig.codeVer),"&_issh_=",d(e.isSelfHosted),"&_vt_=",d(e.tagVersion),"&_au_=",d(e.globalConfig.analyticsUrl),"&_pa_=",d(e.assetLocation),e.codeLocation?"&_cl_="+d(e.codeLocation):""].join("")),this.cpps.onSet.subscribe(function(e,t){var i={};i[e]=t,u.stg.set("ckcpps",i,2e5,!1)}),this.stg.set("ckcpps",this.cpps.all(),2e5,!1),this._sendDefinition()}var r=i.prototype;return r._sendDefinition=function(){var i={method:"init",cfg:e.ext({active_surveydef:null},this.cfg,{globalConfig:e.globalConfig}),hb_i:this.hbi,cpps:this.cpps.all()};this.disp&&(i.display=this.disp),this.template&&(i.template=this.template),this.stg.set("page_hb",t.now(),this.cfg.config.trackerHeartbeatTimeout,!1),this.stg.set("trackerinfo",i,6e4,!1),this.stg.set("ckcpps",this.cpps.all(),2e5,!1)},r.show=function(e){this.wref=h(this._url,"fsTracker",{width:700,height:450},e,!0,this.cfg.config.centerTrackerPopup)},r.applyExisting=function(e,t){this.wref=t,t.location=this._url},r.dispose=function(){for(var e=0;e<this._fcBindings.length;e++)this._fcBindings[e].unsubscribe();t.getGeneralStorage(this.br)===this.stg&&this.stg.dispose(),this.stg=null,clearInterval(this._heartbeat)},i}(),v={SERVICE_TYPES:{mobileOnExitInitialize:{path:"/e",url:"/initialize"},mobileOnExitHeartbeat:{path:"/e",url:"/recordHeartbeat"}},ping:function(i,r,s,n){var o=new t.ImageTransport,a="https://"+e.globalConfig.mobileOnExitUrl+i.path+(i.url||"");o.send({url:a,success:s||function(){},failure:n||function(){},data:r})}},m=function(){function i(t,i,r,s,n,o){this.itype=t,this.cfg=i,this.def=r,this.cpps=s,this.rid=n,this._measureName=this.def.name+"-"+(e.isDefined(this.def.site)?this.def.site+"-":"")+(e.isDefined(this.def.section)?this.def.section+"-":"")+(o||this.def.language.locale)}var r=i.prototype;return r.init=function(i,r){r=r||function(){};var s=new g(this.cfg,this.cpps,this.def,null).decideModernSurvey(),n=t.now()+"_"+Math.round(1e13*Math.random()),o={a:n,notify:i,b:t.hash(n),c:864e5,cid:e.globalConfig.customerId,sid:this._measureName,rid:this.rid,uid:t.now(),support:"SMSEMAIL"==this.itype?"b":"EMAIL"==this.itype?"e":"s",cpps:"version="+encodeURIComponent(e.globalConfig.codeVer)+"&"+this.cpps.toQueryString()};s.modernChosen&&(o=e.ext({fs_renderer:"modern"},o)),v.ping(v.SERVICE_TYPES.mobileOnExitInitialize,o,r,r)},r.beginHeartbeat=function(){var i=this;this._timer&&(clearTimeout(this._timer),this._timer=null);var r=function(){v.ping(v.SERVICE_TYPES.mobileOnExitHeartbeat,{cid:e.globalConfig.customerId,sid:i._measureName,rid:i.rid,uid:t.now()},function(){},function(){})};this._timer=setInterval(r,this.cfg.config.onExitMobileHeartbeatInterval),r()},i}(),b=function(e,t,i,r,n,o,a,c){return s.inviteSetup?c.call(s.inviteSetup):s.inviteSetup=new y(e,t,i,r,n,o,a,c),s.inviteSetup},y=function(){function i(r,n,o,a,c,f,u,d){var h=this;this.trig=r,this.browser=n,this.stg=o,this.cpps=a,this.displayoverride=c,this.jrny=f,this.resourcesready=new t.FSEvent,this.triggerMethod=u;var p=e.getProductConfig("trigger");if(this.config=p,e.isDefined(this.trig.surveydef.inviteExclude)&&e.isDefined(this.trig.crit)&&this.trig.crit.runAllTests(this.trig.surveydef.inviteExclude,this.browser,!1,!0))return!1;l.fsReady(function(){var t;if(r.invite&&r.invite.dispose(),n.isMobile&&r.cfg.config.pagesInviteAvailable)if(null===(t=o.get("pia")))o.set("pia",r.cfg.config.pagesInviteAvailable-1);else if(t>0)o.set("pia",--t);else if(0===t)return;var f=i.getFittingDisplay(r.surveydef,c,a.get("locale"),n);o.set("dn",f.displayname),h.abTestShortSurvey(f),"SHORTSURVEY"!==f.inviteType?l._fsRequire([e.makeURI("$fs.invite.js")],function(e){h.invite=r.invite=new e(p,r.surveydef,n,f,a,s),d&&d.call(h)}):l._fsRequire([e.makeURI("$fs.shortsurvey.js")],function(e){var t=new g(p,a,r.surveydef);h.invite=r.invite=new e(p,r.surveydef,f,a,o,t),d&&d.call(h)})})}var r=i.prototype;return r.initialize=function(){var i=e.getProductConfig("trigger"),r=this.trig,n=this.stg,f=this.cpps,l=this.invite,u=this.jrny;this.didInitialize||(this.didInitialize=!0,u.addEventsDefault("properties",{fs_defName:[r.surveydef.name],fs_section:[r.surveydef.section],fs_displayName:[l.display.displayname],fs_displayTemplate:[l.display.template],fs_pvInvited:[r.pageViewCount],fs_language:[l.locale],fs_samplePercentage:[r.surveydef.criteria.sp.reg],fs_loyaltyFactor:[r.surveydef.criteria.lf],fs_environment:[e.isProduction?"production":"staging"],fs_deployType:[e.isSelfHosted?"on-prem":"cloud"],fs_inviteType:["intercept"],fs_triggerMethod:[this.triggerMethod]}),f.set("TriggerMethod",this.triggerMethod),f.set("dn",l.display.displayname),f.set("dt",l.display.template),l.loadResources(this.resourcesready),l.declined.subscribe(function(t){var o=e.isDefined(i.active_surveydef)&&e.isDefined(i.active_surveydef.repeatDays)?i.active_surveydef.repeatDays:i.config.repeatDays;n.set("i","d"),n.setMaxKeyExpiration(24*o.decline*60*60*1e3),u.addEventObj({name:a,properties:{action:[t]}}),s.inviteDeclinedEmitter.fire(r.surveydef,n,i,f),r.surveydef.cxRecord&&s.rec&&"y"!=n.get("fbr")&&(s.rec.cancelRecord(),r.recordController=s.rec=null),s.state.inviteSituation="DECLINED"}),l.abandoned.subscribe(function(){u.addEventString(c),n.set("i","a"),s.state.inviteSituation="ABANDONED",s.inviteAbandonedEmitter.fire(r.surveydef,n,i,f),n.set("rw",t.now()+i.config.reinviteDelayAfterInviteAbandon)}),l.accepted.subscribe(function(a,c){var g=e.isDefined(i.active_surveydef)&&e.isDefined(i.active_surveydef.repeatDays)?i.active_surveydef.repeatDays:i.config.repeatDays;switch(n.setMaxKeyExpiration(24*g.accept*60*60*1e3),s.inviteAcceptedEmitter.fire(r.surveydef,n,i,f),r.surveydef.cxRecord&&s.rec&&s.rec.recorder&&s.rec.beginTransmitting(),u.initPopupId(),u.addEventString(o),n.set("i","x"),s.state.inviteSituation="ACCEPTED",n.set("ixw",t.now()),a){case"TRACKER":r.popTracker(l);break;case"INSESSION":r.popSurvey();break;case"SMS":case"EMAIL":case"SMSEMAIL":w(r,c,a),r.stg.set("mhbi",{ui:c,it:a});break;case"SHORTSURVEY":break;default:throw new Error("Unknown inviteType: "+a)}}))},r.present=function(){var i=this,r=e.getProductConfig("trigger"),o=this.invite,a=this.stg,c=this.jrny,f=this.trig,l=this.cpps;s.state.didInvite||(s.state.didInvite=!0,this.resourcesready.subscribe(function(){var u=r.config.inviteDelay;null!=o.display.inviteDelay&&(u=o.display.inviteDelay);var g=Math.max(0,u-(t.now()-e.startTS));"SHORTSURVEY"===o.display.inviteType&&(g="p"===a.i?0:g),setTimeout(function(){i.invite.present(i.browser),"p"!==a.get("i")&&c.addEvent(n),a.set("i","p"),s.state.inviteSituation="PRESENTED",s.inviteShownEmitter.fire(f.surveydef,a,r,l)},g)},!0,!0))},r.abTestShortSurvey=function(e){if("SHORTSURVEY"===e.inviteType&&e.shortSurvey&&e.shortSurvey.abTestPercent&&e.shortSurvey.abTestPercent<100&&e.shortSurvey.abTestPercent>0){var t=new g(this.config,this.cpps,this.trig.surveydef).getMeasureId()+"-"+e.displayname+"-AB",i=this.stg.get(t);if(null==i)i=100*Math.random()<=e.shortSurvey.abTestPercent?1:0,this.stg.set(t,i);i||(e.inviteType="TRACKER")}},i}(),w=function(t,i,r){var s=new m(r,e.getProductConfig("trigger"),t.surveydef,t.cpps,t.stg.get("rid"),t.locale);t.stg.get("mhbi")?s.beginHeartbeat():s.init(i,function(){s.beginHeartbeat()})};y.getFittingDisplay=function(t,i,r,n){r=r||s.CPPS.get("locale")||"en";var o,a,c,f,l={},u={};if(o=(n=n||s.browser).isMobile&&t.display.mobile?t.display.mobile:t.display.desktop)for(f=0;f<o.length;f++)u=l.dialog||{},l=e.ext({},l),l=e.ext(l,o[f]),o[f].dialog&&l.dialog&&(l.dialog=e.ext(e.ext({},u),o[f].dialog)),o[f]=l;if(i){for(f=0;f<o.length;f++)if(o[f].displayname==i){c=o[f];break}}else c=o[Math.round(999999999999*Math.random())%o.length];return c.dialog.locales&&c.dialog.locales[r]&&(a=c.dialog.locales[r],c.dialog=e.ext(c.dialog,a),a.localeImages&&(c=e.ext(c,a.localeImages))),e.ext({inviteLogo:"",trackerLogo:"",siteLogoAlt:""},c)};var S=function(){function i(e){this.cfg=e}var r=i.prototype;return r._bindToLink=function(i,r){for(var s=document.querySelectorAll(i.selector),n=function(e,i,r){return function(s){i.preventDefault&&t.preventDefault(s),r.call(e,i)}},o=0;o<s.length;o++){var a=s[o],c=!0,f=void 0;if(i.attribute&&(c=!1,(f=a.getAttribute(i.attribute))&&(c=!0,i.patterns&&i.patterns.length>0))){c=!1;for(var l=0;l<i.patterns.length;l++)if(e.toLowerCase(f).indexOf(e.toLowerCase(i.patterns[l]))>-1){c=!0;break}}c&&t.Bind(a,"trigger:click",n(this,i,r))}},r.performBindings=function(e){if(e&&this.cfg){var t,i=this.cfg;if(i.cancel&&i.cancel.length>0){var r=function(){e.cancelTracker(),e.jrny.addEventString(f)};for(t=0;t<i.cancel.length;t++)this._bindToLink(i.cancel[t],r)}if(i.survey&&i.survey.length>0){var s=function(){e.popSurvey()};for(t=0;t<i.survey.length;t++)this._bindToLink(i.survey[t],s)}if(!e.browser.isMobile&&i.tracker&&i.tracker.length>0){var n=function(){e.popTracker()};for(t=0;t<i.tracker.length;t++)this._bindToLink(i.tracker[t],n)}}},i}(),_=function(){function i(i,r,s,n,o,a){var c,f;this.stg=i,this.cfg=r,this.browser=s,this.crit=n,this.cpps=o,this.jrny=a;var l=e.globalConfig.adobeRsid;if(!i.get("pv")){for(f in c={browser:s.browser.name+" "+s.browser.version,os:s.os.name,referrer:document.referrer.toString(),site:t.getRootDomain(),sitekey:e.globalConfig.siteKey||""})e.hasProp(c,f)&&o.set(f,c[f]);t.INT.GA.has()&&t.INT.GA.uid(function(e){e&&o.set("GA_UID",e)});var u=function(e){o.set(e.name,e.value)};t.INT.OM.uid(l,u),t.INT.OM.mcid(l,u),t.INT.OM.beacon(function(e){o.set("OMTR_BEACON",e)})}this.heartbeatExpired=new t.FSEvent}var r=i.prototype;return r.doesPassCriteria=function(){var e=this.crit,t=this.cfg,i=s.state,r="DIDNOTPASSCRITERIA";if(e.platformCheck(this.browser,t))if(e.browserCheck(this.browser,t))if(e.checkDeviceBlacklist(this.browser,t)){if(e.featureCheck(this.browser,t))return!0;i.inviteStatus=r,i.reason="BROWSER"}else i.inviteStatus=r,i.reason="DEVICE";else i.inviteStatus=r,i.reason="BROWSER";else i.inviteStatus=r,i.reason="PLATFORM";return!1},r.popTracker=function(e){var i=this,r=this;if(this.stg.set("i","x"),s.state.inviteSituation="ACCEPTED",this.didPopTrackerAlready="y"==this.stg.get("tp"),s.state.didInvite=!0,!this.didPopTrackerAlready){this.stg.set("tp","y");if(e)r.tracker=new p(e.template,r.surveydef,i.cfg,t.getBrainStorage(r.browser,r.stg.uid),r.cpps,e.display,r.browser),r.tracker.show(r.browser);else{var n=h("about:blank","fsTracker",{width:700,height:400},this.browser,!0,this.cfg.config.centerTrackerPopup);b(this,r.browser,r.stg,r.cpps,!1,r.jrny,"Traditional",function(){r.tracker=new p(this.invite.template,r.surveydef,this.cfg,t.getBrainStorage(r.browser,r.stg.uid),r.cpps,this.invite.display,r.browser),r.tracker.applyExisting(r.browser,n),r.surveydef.cxRecord&&s.rec&&s.rec.recorder&&s.rec.beginTransmitting()})}}},r.canDisplayInvitation=function(){if(!this.crit._match(this.cfg.config,this.browser,"inviteExclude"))return!1;var e=y.getFittingDisplay(this.cfg.active_surveydef);if("SHORTSURVEY"===e.inviteType&&e.shortSurvey&&e.shortSurvey.idleViewsBeforeStop>0){var t=new g(this.cfg,this.cpps,this.surveydef).getMeasureId(),i=this.stg.get(t+"pv");if(!this.stg.get(t+"li")&&e.shortSurvey.idleViewsBeforeStop<i)return!1}return!0},r.popSurvey=function(e){(this.stg.set("i","x"),s.state.inviteSituation="ACCEPTED",this.didPopTrackerAlready="y"==this.stg.get("tp"),s.state.didInvite=!0,this.didPopTrackerAlready)?this.stg&&this.stg.get("page_hb")&&t.getBrainStorage(this.browser,this.stg.uid).set("trackercmd",{method:"survey"},6e4,!0):(this.stg.set("tp","y"),h(new g(this.cfg,this.cpps,this.surveydef,null,e).getUrl(),"acsSurvey",{width:700,height:400},this.browser,!1,this.cfg.config.centerTrackerPopup))},r.init=function(){for(var i,r,s,n,o=this.cfg.surveydefs,a=function(t,i){if(!e.isDefined(t))return null;var r=null;"number"==typeof t&&t>=0&&t<i.length?r=i[t].uid:"string"!=typeof t||(r=t);return r}(this.stg.get("def"),o),c=0;c<o.length;c++){if(!(s=o[c]).uid||"string"!=typeof s.uid)throw new Error('All survey definitions need a "uid" string property.');e.isDefined(a)&&s.uid==a&&(r=c,i=s),n&&(s=e.ext(n,s),!o[c].site&&n.site&&delete s.site,!o[c].section&&n.section&&delete s.section,o[c]=s),n=e.ext({},s)}if(i&&"default"!=i.selectMode&&"pin"!=i.selectMode){if(i)return this.cfg.active_surveydef=i,this.surveydef=i,this.locale=this._initLocale(),this.cpps.set("locale",this.locale),i.section&&this.cpps.set("section",i.section),i}else for(var f,l=i&&"pin"==i.selectMode?r+1:o.length,u=0;u<l;u++)if(f=o[u],r==u&&"pin"==i.selectMode||this.crit._match(f,this.browser))return"x"===this.stg.get("i")&&this.stg.set("def",f.uid,this.cfg.config.surveyDefResetTimeout||864e5),this.cfg.active_surveydef=f,this.surveydef=f,this.locale=this._initLocale(),this.cpps.set("locale",this.locale),f.section&&this.cpps.set("section",f.section),f;return i&&this.isTrackerAlive()?(this.tracker=new p(null,i,this.cfg,t.getBrainStorage(this.browser,this.stg.uid),this.cpps,null,this.browser),i):null},r._initLocale=function(){var i,r=this.surveydef,s=r.language;if(e.isDefined(s.src)&&e.isDefined(s.locales)){switch(s.src){case"variable":e.isDefined(s.name)&&(i=t.retrieveNestedVariable(window,s.name));break;case"cookie":if(e.isDefined(s.name))i=new t.Cookie({}).get(s.name);break;case"url":var n=s.locales;if(e.isDefined(n))for(var o=0,a=n.length;o<a;o++)if(e.isDefined(n[o].locale)&&e.isDefined(n[o].match)&&location.href.match(n[o].match))return this.locale=n[o].locale,n[o].criteria&&e.ext(this.surveydef.criteria,n[o].criteria),this.locale!==r.language.locale&&(r.language.locale=this.locale),n[o].locale;break;default:throw new Error("Unknown locale src: "+s.src)}if(i)for(var c=0;c<s.locales.length;c++)if(s.locales[c].match==i)return s.locale=s.locales[c].locale,s.locales[c].criteria&&e.ext(this.surveydef.criteria,s.locales[c].criteria),s.locale}return s.locale||"en"},r.isTrackerAlive=function(){return e.isDefined(this.stg.get("tracker_hb"))},r.cancelTracker=function(){t.getBrainStorage(this.browser,this.stg.uid).set("trackercmd",{method:"close"},6e4,!0),this.stg.set("i","a"),s.state.inviteSituation="ABANDONED",e.isDefined(this.tracker)&&clearInterval(this.tracker._heartbeat)},r.logState=function(){this.pageViewCount=(this.stg.get("pv")||0)+1,this.stg.set("pv",this.pageViewCount,this.cfg.config.pageViewsResetTimeout||864e5)},r.logDefState=function(){if(this.surveydef){var e=new g(this.cfg,this.cpps,this.surveydef).getMeasureId();this.defPageViewCount=(this.stg.get(e+"pv")||0)+1,this.stg.set(e+"pv",this.defPageViewCount,this.cfg.config.pageViewsResetTimeout||864e5)}},r.evalLoyaltySampling=function(t){var i=this.surveydef,r=i[t]||i.criteria,s=this.stg.get("pl"),n=e.isDefined(s)&&1!=s?r.sp.outreplaypool||0:r.sp.reg||0,o=100*Math.random();return this.defPageViewCount>=r.lf&&o<=n},r.dispose=function(){this.disposed||(this.stg.save(!0),this.disposed=!0,this.invite&&this.invite.dispose(),delete s.inviteSetup,this.mouseoff&&this.mouseoff.dispose(),s.rec&&(s.RecordController.disposeInstance(),s.RecordController=null,s.rec=null),t.Unbind("trigger:*"))},i}();var k,I,E=function(e,t,i,r,s,n){return new _(e,t,i,r,s,n)},C=new t.FSEvent;e.API.expose("CPPS",{set:function(e,t){C.subscribe(function(){s.CPPS.set(e,t)},!0,!0)},get:function(e,t){t=t||console.log,C.subscribe(function(){t(s.CPPS.get(e))},!0,!0)},all:function(e){e=e||console.table||console.log,C.subscribe(function(){e(s.CPPS.all())},!0,!0)}}),e.API.expose("clearState",function(){C.subscribe(function(){s.tracker&&s.tracker._heartbeat&&clearInterval(s.tracker._heartbeat),s.stg.reset(),e.supportsDomStorage&&sessionStorage.removeItem("acsFeedbackSubmitted"),s.rec&&s.rec.recorder&&s.rec.recorder.clearState()},!0,!0)}),e.API.expose("dispose",function(){C.subscribe(function(){s.trig&&s.trig.dispose()},!0,!0)}),e.API.expose("getState",function(e){e=e||console.log,C.subscribe(function(){e(s.state)},!0,!0)}),e.API.expose("getConfig",function(){return e.ext({},e.getProductConfig("trigger"),{global:e.globalConfig})}),e.API.expose("getConfigFormatted",function(){var t=e.getProductConfig("trigger");if(console&&console.info&&(console.info("************************** Trigger Configuration **************************"),console.info("Config: ",t.config),t.surveydefs&&t.surveydefs.length)){console.info("************************** Surveydefs Configuration **************************");for(var i=0;i<t.surveydefs.length;i++)console.info("************************** Surveydef "+(i+1)+" **************************"),console.info("Config: ",t.surveydefs[i])}}),e.API.expose("optOut",function(){var e=l.location.toString();l.location=e.indexOf("#")>-1?e+"&fscommand=fsoptout":e+"#fscommand=fsoptout",l.location.reload()}),e.API.expose("test",function(){var e=l.location.toString();l.location=e.indexOf("#")>-1?e+"&fscommand=fstest":e+"#fscommand=fstest",l.location.reload()});var T=function(){C.subscribe(function(){k&&(clearTimeout(k),k=null),k=setTimeout(function(){if(k=null,!s._triggerResetLock){s._triggerResetLock=!0;var t=s.trig;t&&(t.dispose(),s.trig=null),e.resetStartTS(),e.nextTick(I)}},250)},!0,!0)};e.API.expose("run",T),e.API.expose("pageReset",T),e.API.expose("showInvite",function(t){C.subscribe(function(){if(!document.getElementById("fsrInvite")&&!document.getElementById("acsMainInvite")){var i=s.trig||E(s.stg,e.getProductConfig("trigger"),s.browser,s.crit,s.CPPS);i.init()&&i.doesPassCriteria()&&i.surveydef&&(s.state.didInvite=!1,b(i,s.browser,s.stg,s.CPPS,t,s.jrny,"Traditional",function(){this.initialize(),this.present()}))}},!0,!0)}),e.API.expose("onLoaded",s.loadedEmitter),e.API.expose("onInitialized",s.initializedEmitter),e.API.expose("onInviteShown",s.inviteShownEmitter),e.API.expose("onInviteAccepted",s.inviteAcceptedEmitter),e.API.expose("onInviteAbandoned",s.inviteAbandonedEmitter),e.API.expose("onInviteDeclined",s.inviteDeclinedEmitter),e.API.expose("onTrackerShown",s.trackerShownEmitter),e.API.expose("customInvitationRequested",s.customInvitationRequested),e.API.expose("Journey",{addEvent:function(e){C.subscribe(function(){s.jrny.addEvent(e)},!0,!0)},addEventObj:function(e){C.subscribe(function(){s.jrny.addEventObj(e)},!0,!0)},addEventString:function(e){C.subscribe(function(){s.jrny.addEventString(e)},!0,!0)}}),e.API.expose("Storage",{get:function(e,t){t=t||console.log,C.subscribe(function(){t(s.stg.get(e))},!0,!0)},all:function(e){e=e||console.table||console.log,C.subscribe(function(){var t=s.stg.all(),i={};for(var r in t)1!==t[r].d&&(i[r]=t[r]);e(i)},!0,!0)}});var D=new t.Cookie({path:"/",secure:!1,encode:!0});e.API.expose("Cookie",{get:function(e,t){t=t||console.log||function(){},C.subscribe(function(){try{return t("_4c_"===e?JSON.parse(i.decompress(decodeURIComponent(D.get(e)))):D.get(e))}catch(r){console.error("trigger: couldn't read cookie",e)}},!0,!0)}});var R=function(t,i,r,n,o){e.ext(s,{CPPS:r,crit:i,stg:t,jrny:n,browser:o},!1),C.fire()};var P=function(i,r,n,o,a,c){r&&o&&e.globalConfig.products.record&&l._fsRequire([e.makeURI("$fs.record.js")],function(r){n.set("rc","true");var o={id:e.globalConfig.customerId||t.getRootDomain()||"record_customerId"};s.RecordController=r,s.rec=r.getInstance(i,l,n,o,a),c&&(c.recordController=s.rec)})},A={hash:l.location.hash,href:l.location.href,pathname:l.location.pathname},x=window!=l.top;function L(){var i=e.getProductConfig("trigger");if(s._triggerResetLock=!0,A.href.indexOf("fs.tracker.html")>-1)s._triggerResetLock=!1;else{var r=new t.Browser;r.ready.subscribe(function(){var n=t.getGeneralStorage(r),o=new u(n,i),a=new t.CPPS(n,i.config.cppsResetTimeout);a.set("url",l.location.toString().replace(/(\?|&)(cpp\[[^&#]+\]+)=([^&#]*)/g,"")),n.ready.subscribe(function(){n.upgradeOldStorage(function(){s.pageLoadTime=t.now()-e.startTS,t.initBehavioralData(e.globalConfig.customerId||t.getRootDomain()||"trigger_customerId",n,r,a);var c=s._journey=new t.Journey({customerId:e.globalConfig.customerId||t.getRootDomain()||"trigger_customerId",appId:t.APPID.TRIGGER,stg:n,browser:r,useSessionId:!0,usePopupId:!1});c.addEventsDefault("properties",{fs_site:[t.getRootDomain()],fs_repeatDaysAccept:[i.config.repeatDays.accept],fs_repeatDaysDecline:[i.config.repeatDays.decline],fs_reinviteDelayAfterInviteAbandon:[i.config.reinviteDelayAfterInviteAbandon]}),R(n,o,a,c,r);var f=n.get("i");setTimeout(function(){a.set("code",e.globalConfig.codeVer),a.set("tz",-(new Date).getTimezoneOffset()),a.set("product_type","web sdk");var u,g=t.getScreenResolution();if(a.set("device_width",g.w),a.set("device_height",g.h),a.set("dpr",window.devicePixelRatio||1),r.isMobile)a.set("window_width",g.w),a.set("window_height",g.h);else{var d=t.getSize(window);a.set("window_width",d.w),a.set("window_height",d.h)}if(i.config.cpps){var h,v,m=i.config.cpps;for(var _ in m){var k=m[_];if(e.isObject(k))switch(k.source){case"param":var I=e.getParam(k.val)||k.init||null;if(e.isDefined(k.mode)&&"append"==k.mode){var C=k.delimiter||",",T=a.get(_),D=T?T.split(C):[],R=void 0;I=I||"",D[D.length-1]!==I&&(D.push(I),R=D.join(C),a.set(_,R))}else e.isDefined(I)&&null!==I?a.set(_,I):a.get(_)||a.set(_,"");break;case"variable":if(e.isDefined(k.name)){h=k.exists;var A=t.retrieveNestedVariable(l,k.name);e.isDefined(h)?a.get(_)!==h.success&&a.set(_,A?h.success:h.init):A?a.set(_,A):a.get(_)||a.set(_,k.init||"")}break;case"cookie":var L=new t.Cookie({path:"/",secure:!1,encode:!0}).get(k.val),M=e.isDefined(L);h=k.exists,e.isDefined(h)?a.get(_)!==h.success&&a.set(_,M?h.success:h.init):e.isDefined(L)&&null!==L?a.set(_,L):a.get(_)||a.set(_,k.init||"");break;case"url":for(var O=0,U=k.patterns.length;O<U;O++){var N=k.patterns[O].regex||k.patterns[O].match;v=k.patterns[O].value,e.isString(location.href)&&t.testAgainstSearch(N,location.href)?a.set(_,v):a.get(_)||a.set(_,k.init||"")}break;default:throw new Error("Unknown CPP source: "+k.source)}else a.set(_,k)}}if(n.get("ovr")&&(u=JSON.parse(n.get("ovr"))),u){for(var V=0;V<i.surveydefs.length;V++){var B=i.surveydefs[V].name;u.sp[B]&&(i.surveydefs[V].criteria.sp=u.sp[B]),u.lf[B]&&(i.surveydefs[V].criteria.lf=u.lf[B])}!0===u.pooloverride&&(o.pooloverride=!0)}(s.state.codeVer=e.globalConfig.codeVer,s.state.siteKey=e.globalConfig.siteKey,s.state.didInvite="xda".indexOf(f)>-1,s.state.inviteSituation={x:"ACCEPTED",d:"DECLINED",a:"ABANDONED",p:"PRESENTED",f:"BRAINFAILED"}[f],"a"==f)&&(parseInt(n.get("rw"),10)<t.now()&&(n.erase("i"),n.erase("rw"),f=s.state.didInvite=null));"f"==f&&(parseInt(n.get("fw"),10)<t.now()&&(n.erase("f"),n.erase("fw"),f=s.state.didInvite=null));if("runRecordOnly"===i.config.workInIframes&&x){for(var j=!1,F=0;F<i.surveydefs.length;F++){if(i.surveydefs[F].cxRecord){j=!0;break}}return P(r,j,n,!0,a),void(s._triggerResetLock=!1)}if("d"!=f&&"a"!=f&&"f"!=f)o.calcReplayPoolStatus(function(u){u&&(s.state.isinpool=u),o.optoutCheck(function(){if(o._match(i.config,r,"globalExclude")&&"y"!=n.get("gx"))if(null===n.selectCookieDomain(e.globalConfig.cookieDomain,window.location.toString()))s._triggerResetLock=!1;else{var g=s.trig=E(n,i,r,o,a,c);if(g.logState(),a.set("pv",g.pageViewCount,i.config.pageViewsResetTimeout||864e5),g.init())if(s.initializedEmitter.fire(),g.isTrackerAlive()||g.doesPassCriteria())if(g.surveydef){if(g.logDefState(),P(r,g.surveydef.cxRecord,n,u,a),"x"!=f)r.isMobile||r.isTablet||!g.surveydef.mouseoff||"off"===g.surveydef.mouseoff.mode||1!=n.get("pv")||n.set("sst",t.now()),g.canDisplayInvitation()?g.evalLoyaltySampling("criteria")?(n.set("def",g.surveydef.uid,g.cfg.config.surveyDefResetTimeout||864e5),b(g,r,n,a,!1,c,"Traditional",function(){this.initialize(),this.present()})):n.get("sst")&&g.evalLoyaltySampling("mouseoff")?(n.set("def",g.surveydef.uid,g.cfg.config.surveyDefResetTimeout||864e5),l._fsRequire([e.makeURI("$fs.mouseoff.js")],function(e){s._triggerResetLock=!1;var t=g.mouseoff=new e(g,g.surveydef,r,n,c);t.initialize(),t.startListening(function(){this.inviteSetup=b(g,r,n,a,!1,c,"MouseOff",function(){this.initialize()})},function(){this.inviteSetup.present()})})):s._triggerResetLock=!1:s._triggerResetLock=!1;else{var d=g.stg.get("mhbi");if(d)w(g,d.ui,d.it);else if(g.isTrackerAlive()){var h=y.getFittingDisplay(g.surveydef);g.tracker=new p(h.template,g.surveydef,i,t.getBrainStorage(r,n.uid),a,h,r)}s._triggerResetLock=!1}g.surveydef.links&&new S(g.surveydef.links).performBindings(g)}else s._triggerResetLock=!1;else s._triggerResetLock=!1;else s._triggerResetLock=!1}else n.set("gx","y"),s._triggerResetLock=!1},function(){s._triggerResetLock=!1})});else{if("a"==f){var H="true"==n.get("rc")||!0===n.get("rc");P(r,H,n,H,a)}s._triggerResetLock=!1}},Math.max(0,i.config.triggerDelay-(t.now()-e.startTS)))})},!0,!0)},!0,!0)}}return r.startup=function(){var i,r=e.getProductConfig("trigger");if(!(r&&r.config&&r.surveydefs&&r.config.browser_cutoff))throw new Error("Looks like the trigger config is missing or broken. Please push a trigger config to fix this error.");if(r.surveydefs.length&&"string"==typeof r.surveydefs[0])throw new Error("Looks like an old trigger config from pre-19.9.0. Please re-push the trigger settings with 19.9.0+ to fix this error.");t.registerProduct("foresee",r),s.loadedEmitter.fire(),("dontRunOtherIframes"!==r.config.workInIframes&&r.config.workInIframes||!x)&&(l.__fsrtracker||l.location.toString().indexOf("survey.foreseeresults.com")>-1||(e.fsCmd("fstest")?l._fsRequire([e.makeURI("$fs.svadmin.js")],function(){}):e.fsCmd("fsoptout")?l._fsRequire([e.makeURI("$fs.optout.js")],function(){}):(e.domReady(L),I=L,r.config.ignoreNavigationEvents||t.pageNavEvent.subscribe(function(){var e=l,s=e.location,n=e[r.config.publicApiName||"FSR"],o=function(e){var t=e.split("#");return t.length>2?t[0]+t[1]:e.replace(/#/gi,"")},a=o(A.hash),c=o(s.hash);t.now()-t.startTime<(r.config.pageLoadUrlChangeBlackout||0)||(n&&a!=c||A.pathname!=s.pathname)&&l.fsReady(function(){clearTimeout(i),i=setTimeout(function(){A={hash:l.location.hash,href:l.location.href,pathname:l.location.pathname},n.pageReset()},1e3)})},!1,!1))))},r});
