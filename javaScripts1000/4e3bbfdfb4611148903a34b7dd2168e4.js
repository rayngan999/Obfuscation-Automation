define(['module.base','jquery','localization/copy'],function(Module,$,copy){Module.get_dfp_lowerBox=function(){var self=this;var refresh_trigger=0;var elm_att_lowerbox='';var scrolling_lowerbox=false;self.tpl_main='dfpLowerbox';window.adLowerBoxRendered={};window.adLowerBoxRefreshed={};window.adLowerBoxHandle={};window.boxad_slot_names={};window.addisplay={};window.copy=copy;self.init=function(elm){var opts=elm.getAttribute('data-param');if(opts){var slot_name='';var data='';var o=eval('('+opts+')');slot_name=o.slot_name;window.addisplay[slot_name]=setInterval(function(){checkGoogleService($(elm),slot_name);},window._config.dfpcheckdatainterval);function checkGoogleService(elm,slot_name){if(typeof window.adserviceenabled!=='undefined'&&window.adserviceenabled){data='<script type="text/javascript">window.adLowerBoxRendered[\''+slot_name+'\'] = googletag.cmd.push(function() { googletag.display("'+slot_name+'");});</script>';if(window._config.mobile_citypage){$('.div-gpt-ad-lowerbox').css("padding","25px 0 0 0");$('<div class="lbl_ad">'+copy.util.lbl_advertisement+'</div>').insertAfter(elm);}
$(elm).html(data);if(typeof window.adLowerBoxRendered[slot_name]=='undefined'){window.adLowerBoxRendered[slot_name]=googletag.cmd.push(function(){googletag.display(slot_name);});}
if(typeof window.adLowerBoxRendered[slot_name]!=='undefined'){clearInterval(window.addisplay[slot_name]);}
if(typeof window.adLowerBoxRefreshed[slot_name]=='undefined'&&window.enableSRA){var int_lowerbox=(typeof window._config.dfpcheckdatainterval!=="undefined")?window._config.dfpcheckdatainterval:100;window.adLowerBoxHandle[slot_name]=setInterval(function(){processDFP.refreshSRA([window.adslots[slot_name]]);window.adLowerBoxRefreshed[slot_name]=true;clearInterval(window.adLowerBoxHandle[slot_name]);},int_lowerbox);}}}
var elm_att_lowerbox=Function('return ('+opts+')')();if(elm_att_lowerbox&&elm_att_lowerbox.refresh_trigger){refresh_trigger=elm_att_lowerbox.refresh_trigger;slot_name=elm_att_lowerbox.slot_name;}
if(refresh_trigger>0){clearInterval(window.boxad_slot_names[slot_name]);window.boxad_slot_names[slot_name]=setInterval(function(){self.refresh(slot_name);},refresh_trigger*1000);}}
$(window).scroll(function(){clearTimeout($.data(this,'scrollTimerBox'));$.data(this,'scrollTimerBox',setTimeout(function(){scrolling_lowerbox=false;},250));scrolling_lowerbox=true;});window.isScrolledIntoViewLBox=function(elem){var $elem=$(elem);var $window=$(window);var docViewTop=$window.scrollTop();var docViewBottom=docViewTop+$window.height();var elemTop=$elem.offset().top;var elemBottom=elemTop+$elem.height();return((elemTop<=docViewBottom)&&(elemBottom>=docViewTop)&&(elemBottom<=docViewBottom)&&(elemTop>=docViewTop));};}
self.refresh=function(slot_name){if(!document.body.className.match('blurred')&&isScrolledIntoViewLBox(document.getElementById(slot_name))&&!scrolling_lowerbox){setTimeout(function(){window.adslots[slot_name].setTargeting("tar","true");if(window.prebidEnabled){pbjs_request_queue.refreshBySlotName(slot_name);}else{googletag.pubads().refresh([window.adslots[slot_name]]);}},2000);}};}
return Module.factory('get_dfp_lowerBox');});;