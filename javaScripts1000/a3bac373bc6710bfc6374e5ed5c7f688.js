!function(){"use strict";var e,t,r;!function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG",e[e.RECORD=4]="RECORD"}(e||(e={})),function(e){e.EventEmpty="Empty Event",e.EventUnexpected="Unexpected Event",e.MonitorCallError="Monitor Call Error",e.MonitorCreateError="Monitor Creation Error",e.MonitorDuplicateProp="Monitor Duplicate Property",e.MonitorEmitError="Monitor Emit Error",e.MonitorRemoveError="Monitor Removal Error",e.OperatorError="Operator Error",e.ObserverMultipleLoad="Duplicate Observer",e.ObserverReadError="Read Error",e.ObserverRulesNone="No Rules Defined",e.RuleInvalid="Invalid Rule",e.RuleRegistrationError="Rule Registration Error",e.ObserverInitializationError="Observer Initialization Error"}(t||(t={})),function(e){e.DataLayerMissing="Data layer not found",e.DuplicateValue="Value $0 already used",e.ShimFail="Shim not allowed because object is $0",e.SelectorInvalidIndex="Selector index $0 is not a number in $1",e.SelectorIncorrectTokenCount="Selector has incorrect number ($0) of tokens in $1",e.SelectorMalformed="Selector $0 is malformed",e.SelectorMissingToken="Selector is missing $0 in $1",e.SelectorNoProps="Selector is missing properties",e.SelectorSyntaxUnsupported="Selector syntax $0 is unsupported",e.TargetSubjectObject="Target subject must be an object",e.TargetPropertyMissing="Target property is missing",e.TargetPathMissing="Target path is missing",e.UnknownValue="Unknown value $0",e.UnsupportedType="Unsupported type $0"}(r||(r={}));var o=function(){function t(){}return t.prototype.log=function(t){var r=t.context,o=t.level,n=t.message+(r?" "+JSON.stringify(r):"");switch(o){case e.RECORD:return;case e.ERROR:return console.error(n);case e.WARN:return console.warn(n);case e.INFO:return console.info(n);case e.DEBUG:default:return console.debug(n)}},t}(),n=function(){function t(){this.timeoutId=null}return t.prototype.log=function(r){var o=this,n=window[window._fs_namespace];if(n){var i=r.context,s=r.level,a=r.message,u=i?{level_int:s,message:a,context:i}:{level_int:s,message:a};this.isDuplicate(r)?("number"==typeof this.timeoutId&&window.clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout((function(){o.timeoutId=null,r.level===e.RECORD||n.event("Data Layer Observer",u,"dlo-log")}),t.debounceTime)):r.level===e.RECORD||n.event("Data Layer Observer",u,"dlo-log"),this.prevEvent=r}},t.prototype.isDuplicate=function(e){var t=e.context,r=e.message;if(!this.prevEvent||!t||!this.prevEvent.context)return!1;var o=t.source,n=t.reason,i=this.prevEvent,s=i.message,a=i.context,u=a.source,c=a.reason;return r===s&&o===u&&n===c},t.debounceTime=250,t}(),i=function(){function t(e){switch(void 0===e&&(e="console"),this.level=1,e){case"fullstory":this.appender=new n;break;case"console":default:this.appender=new o}}return t.format=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];for(var o=e,n=0;n<t.length;n+=1)o=o.replace("$"+n,t[n]);return o.trim()},t.getInstance=function(e){return t.instance||(t.instance=new t(e)),t.instance},t.prototype.log=function(t,r,o){(t<=this.level||t===e.RECORD)&&this.appender.log({level:t,message:r,context:o})},t.prototype.error=function(t,r){this.log(e.ERROR,t,r)},t.prototype.warn=function(t,r){this.log(e.WARN,t,r)},t.prototype.info=function(t,r){this.log(e.INFO,t,r)},t.prototype.debug=function(t,r){this.log(e.DEBUG,t,r)},t.prototype.record=function(t,r){this.log(e.RECORD,t,r)},t}(),s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var a=function(){return(a=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},u=function(){function e(e){if(this.options=e,!e.name)throw new Error("Operator options "+JSON.stringify(e)+" has no name")}return e.prototype.checkRequired=function(e){void 0===this.options[e]&&this.throwError(e,"is required")},e.prototype.checkType=function(e,t){-1===t.toString().toLowerCase().indexOf(typeof this.options[e])&&this.throwError(e,"is a "+typeof this.options[e]+" but should be "+t)},e.prototype.checkDependencies=function(e,t){var r=this;t.forEach((function(t){void 0===r.options[t]&&r.throwError(e,"requires option "+t)}))},e.prototype.throwError=function(e,t){throw new Error("Operator '"+this.options.name+"' option '"+e+"' "+t)},e.isReservedProperty=function(e){return"name"===e||"index"===e||"maxDepth"===e},e.prototype.validate=function(t){var r=this,o=this.options.name;Object.getOwnPropertyNames(t).forEach((function(e){var o=t[e],n=o.required,i=o.type,s=o.dependencies,a=void 0===s?[]:s;n&&r.checkRequired(e),r.options[e]&&(r.checkType(e,i),r.checkDependencies(e,a))})),Object.getOwnPropertyNames(this.options).filter((function(t){return!e.isReservedProperty(t)})).forEach((function(e){if(!t[e])throw Error("Operator '"+o+"' has unknown option "+e)}))},e}();function c(e,t,r){var o=e.slice();return o.splice(t,1,r),o}var p=function(){function e(e){this.options=e;var t=e.index,r=void 0===t?0:t;this.index=r}return e.convert=function(t,r){switch(t){case"bool":return"true"===r||"TRUE"===r||"True"===r;case"date":return new Date(r);case"int":case"real":return r?e.enumerate(r):0;case"string":switch(typeof r){case"boolean":return Boolean(r).toString();case"number":return r.toString();case"undefined":return"";default:return null===r?"":r}default:return r}},e.enumerate=function(e){var t=parseFloat(e);return isNaN(e)||Number.isNaN(t)?NaN:t},e.enumerableProperties=function(e){return Object.getOwnPropertyNames(e).filter((function(t){return"string"==typeof e[t]||Array.isArray(e[t])&&"string"==typeof e[t][0]}))},e.prototype.handleData=function(t){var r=this.index>=0?this.index:t.length+this.index,o=this.options.properties,n=this.options,i=n.enumerate,s=n.force,u=n.preserveArray,p=n.type;"string"==typeof o&&(o=o.split(",").map((function(e){return e.trim()})));var h=a({},t[r]);i&&e.enumerableProperties(t[r]).forEach((function(o){if("string"==typeof t[r][o])""!==t[r][o]&&(h[o]=e.convert("real",t[r][o]),e.verifyConversion("real",o,h,t[r]));else{h[o]=[];for(var n=0;n<t[r][o].length;n+=1)h[o].push(e.convert("real",t[r][o][n]));e.verifyConversion("real",o,h,t[r])}}));o&&p&&("*"===o[0]?Object.getOwnPropertyNames(t[r]):o).forEach((function(o){var n=t[r][o];if(null!=n||s)if(Array.isArray(n)){h[o]=[];for(var i=0;i<n.length;i+=1){var a=n[i];h[o].push(e.convert(p,a))}e.verifyConversion(p,o,h,t[r])}else h[o]=e.convert(p,n),e.verifyConversion(p,o,h,t[r])}));return u||Object.getOwnPropertyNames(h).forEach((function(e){if(Array.isArray(h[e])&&1===h[e].length){var t=h[e][0];h[e]=t}})),c(t,r,h)},e.prototype.validate=function(){var t=new u(this.options);t.validate(e.specification);var r=this.options,o=r.enumerate,n=r.force,i=r.properties,s=r.type;if(void 0===o&&void 0===i)throw t.throwError("properties","must be specified if 'enumerate' is undefined and vice versa");if(void 0!==o&&"boolean"!=typeof o)throw t.throwError("enumerate","should be a boolean");if(void 0!==n&&"boolean"!=typeof n)throw t.throwError("force","should be a boolean");if(void 0!==n&&n&&"date"===s)throw t.throwError("force","can not forcibly convert dates");if(void 0!==i&&!s)throw t.throwError("type","must be declared when using 'properties'");if(s&&"bool"!==s&&"int"!==s&&"real"!==s&&"string"!==s&&"date"!==s)throw t.throwError("type","unknown type '"+s+"' used")},e.verifyConversion=function(e,r,o,n){var s=o[r],a=n[r],u=!0;"int"!==e&&"real"!==e||(u=Array.isArray(s)?s.every((function(e){return!Number.isNaN(e)})):!Number.isNaN(s)),"date"===e&&(u=Array.isArray(s)?s.every((function(e){return!Number.isNaN(e.getTime())})):!Number.isNaN(s.getTime())),u||(o[r]=a,i.getInstance().debug(t.OperatorError,{operator:"convert",property:r.toString(),reason:"Failed to convert to "+e+" for value "+a}))},e.specification={enumerate:{required:!1,type:["boolean"]},force:{required:!1,type:["boolean"]},index:{required:!1,type:["number"]},preserveArray:{required:!1,type:["boolean"]},properties:{required:!1,type:["string,object"]},type:{required:!1,type:["string"]}},e}(),h=function(){function e(e){this.options=e;var t=e.index,r=void 0===t?0:t,o=e.maxDepth,n=void 0===o?10:o;this.index=r,this.maxDepth=n}return e.prototype.flattenHelper=function(e,t,r){var o=this;void 0===r&&(r=0),Object.getOwnPropertyNames(t).forEach((function(n){"object"==typeof t[n]&&null!=t[n]&&!Array.isArray(t[n])&&r<o.maxDepth+1?o.flattenHelper(e,t[n],r+1):e[n]=t[n]}))},e.prototype.handleData=function(e){var t={},r=e[this.index];return this.flattenHelper(t,r),c(e,this.index,t)},e.prototype.validate=function(){new u(this.options).validate(e.specification)},e.specification={index:{required:!1,type:["number"]},maxDepth:{required:!1,type:["number"]}},e}();function l(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}var f,d={};!function(e){e.Pluck="pluck",e.Index="index",e.Pick="pick",e.Omit="omit",e.Prefix="prefix",e.Suffix="suffix",e.Filter="filter"}(f||(f={}));var v,y={pluck:function(e){return!1===e.includes("[")&&!1===e.includes("(")},index:function(e){return/.+\[-?\d+\]$/.test(e)},pick:function(e){return/.+\[\(.*\)\]$/.test(e)},omit:function(e){return/.+\[!\(.*\)\]$/.test(e)},prefix:function(e){return/.+\[\^\(.*\)\]$/.test(e)},suffix:function(e){return/.+\[\$\(.*\)\]$/.test(e)},filter:function(e){return/.+\[\?\(.*\)\]$/.test(e)}};!function(e){e.Pick="",e.Omit="!",e.Prefix="^",e.Suffix="$",e.Filter="?",e.Index="index"}(v||(v={}));var g=function(e){this.raw=e,this.raw=e.trim();for(var t=0,o=0,n=0;n<e.length;n+=1){var s=e.charCodeAt(n);if(33===s||s>=60&&s<=62||94===s)0===t&&(t=n);else if(t>0){o=n;break}}var a=e.substring(t,o);if(0!==a.length){var u=this.raw.split(a);if(u.length>2)throw new Error(i.format(r.SelectorIncorrectTokenCount,u.length.toString(),e));if(2!==u.length)throw new Error(i.format(r.SelectorIncorrectTokenCount,u.length.toString(),e));this.name=u[0],this.value=u[1],this.operator="="===a||"==="===a?"==":a}else this.name=this.raw,this.value=null,this.operator=null},w=function(){function e(e){switch(this.raw=e,this.index=0,this.props=[],this.raw=e.trim(),this.raw[0]){case"(":if(")"!==this.raw[this.raw.length-1])throw new Error(i.format(r.SelectorMissingToken,")",e));this.kind=v.Pick,this.parseProps(this.raw.substring(1,this.raw.length-1));break;case"!":if("("!==this.raw[1])throw new Error(i.format(r.SelectorMissingToken,"(",e));if(")"!==this.raw[this.raw.length-1])throw new Error(i.format(r.SelectorMissingToken,")",e));this.kind=v.Omit,this.parseProps(this.raw.substring(2,this.raw.length-1));break;case"^":if("("!==this.raw[1])throw new Error(i.format(r.SelectorMissingToken,"(",e));if(")"!==this.raw[this.raw.length-1])throw new Error(i.format(r.SelectorMissingToken,")",e));this.kind=v.Prefix,this.parseProps(this.raw.substring(2,this.raw.length-1));break;case"$":if("("!==this.raw[1])throw new Error(i.format(r.SelectorMissingToken,"(",e));if(")"!==this.raw[this.raw.length-1])throw new Error(i.format(r.SelectorMissingToken,")",e));this.kind=v.Suffix,this.parseProps(this.raw.substring(2,this.raw.length-1));break;case"?":if("("!==this.raw[1])throw new Error(i.format(r.SelectorMissingToken,"(",e));if(")"!==this.raw[this.raw.length-1])throw new Error(i.format(r.SelectorMissingToken,")",e));this.kind=v.Filter,this.parseProps(this.raw.substring(2,this.raw.length-1));break;default:if(this.index=Number.parseInt(this.raw,10),Number.isNaN(this.index))throw new Error(i.format(r.SelectorInvalidIndex,this.index.toString(),e));this.kind=v.Index}this.propNames=this.props.map((function(e){return e.name}))}return e.prototype.parseProps=function(e){var t=this,o=e.trim();if(0===o.length)throw new Error(r.SelectorNoProps);o.split(",").forEach((function(e){t.props.push(new g(e))}))},e}(),m=function(e){if(this.raw=e,this.raw=this.raw.trim(),!1===this.raw.includes("["))throw new Error(i.format(r.SelectorMissingToken,"[",e));if(!1===this.raw.endsWith("]"))throw new Error(i.format(r.SelectorMissingToken,"]",e));var t=this.raw.split("[");if(2!==t.length)throw new Error(i.format(r.SelectorIncorrectTokenCount,t.length.toString(),e));this.prop=t[0],this.op=new w(t[1].substring(0,t[1].length-1))},b=function(){function e(t){this.raw=t,this.parsedInfo={},this.kind=e.sniffKind(t),this.parse()}return e.prototype.select=function(e){switch(this.kind){case f.Pluck:return this.selectPluck(e);case f.Index:return this.selectIndex(e);case f.Pick:return this.selectPick(e);case f.Omit:return this.selectOmit(e);case f.Prefix:return this.selectPrefix(e);case f.Suffix:return this.selectSuffix(e);case f.Filter:return this.selectFilter(e);default:throw new Error(i.format(r.SelectorSyntaxUnsupported,this.kind))}},e.prototype.parse=function(){switch(this.kind){case f.Pluck:break;case f.Index:case f.Pick:case f.Omit:case f.Prefix:case f.Suffix:case f.Filter:this.brackets=new m(this.raw);break;default:throw new Error(i.format(r.SelectorSyntaxUnsupported,this.kind))}},e.prototype.selectPluck=function(e){return e[this.raw]},e.prototype.selectIndex=function(e){if(!this.brackets||this.brackets.op.kind!==v.Index)throw new Error(i.format(r.SelectorMissingToken,"[i]",this.raw));var t=e[this.brackets.prop];if(void 0!==t){var o=this.brackets.op.index;if(!(o>=t.length||(o<0&&(o=t.length+o),o<0)))try{return t[o]}catch(e){return}}},e.prototype.selectPick=function(e){if(!this.brackets||this.brackets.op.kind!==v.Pick)throw new Error(i.format(r.SelectorMissingToken,"[()]",this.raw));var t=e[this.brackets.prop];if(void 0!==t){var o={},n=!1;if(this.brackets.op.props.forEach((function(e){void 0!==t[e.name]&&(o[e.name]=t[e.name],n=!0)})),!1!==n)return o}},e.prototype.selectOmit=function(e){if(!this.brackets||this.brackets.op.kind!==v.Omit)throw new Error(i.format(r.SelectorMissingToken,"![()",this.raw));var t=e[this.brackets.prop];if(void 0!==t){for(var o={},n=!1,s=Object.getOwnPropertyNames(t),a=0;a<s.length;a+=1){var u=s[a];this.brackets.op.propNames.includes(u)||(o[u]=t[u],n=!0)}if(!1!==n)return o}},e.prototype.selectPrefix=function(e){if(!this.brackets||this.brackets.op.kind!==v.Prefix)throw new Error(i.format(r.SelectorMissingToken,"^[()]",this.raw));var t=e[this.brackets.prop];if(void 0!==t){for(var o={},n=!1,s=Object.getOwnPropertyNames(t),a=0;a<s.length;a+=1)for(var u=s[a],c=0;c<this.brackets.op.propNames.length;c+=1)if(u.startsWith(this.brackets.op.propNames[c])){o[u]=t[u],n=!0;break}if(!1!==n)return o}},e.prototype.selectSuffix=function(e){if(!this.brackets||this.brackets.op.kind!==v.Suffix)throw new Error(i.format(r.SelectorMissingToken,"$[()]",this.raw));var t=e[this.brackets.prop];if(void 0!==t){for(var o={},n=!1,s=Object.getOwnPropertyNames(t),a=0;a<s.length;a+=1)for(var u=s[a],c=0;c<this.brackets.op.propNames.length;c+=1)if(u.endsWith(this.brackets.op.propNames[c])){o[u]=t[u],n=!0;break}if(!1!==n)return o}},e.prototype.selectFilter=function(e){if(!this.brackets||this.brackets.op.kind!==v.Filter)throw new Error(i.format(r.SelectorMissingToken,"?[()]",this.raw));var t=e[this.brackets.prop];if(void 0!==t){for(var o=0;o<this.brackets.op.props.length;o+=1){var n=this.brackets.op.props[o];if(void 0===t[n.name]&&"undefined"!==n.value)return;if(null!==n.value)switch(typeof t[n.name]){case"boolean":if(t[n.name]!==("true"===n.value.toLowerCase()))return;break;case"string":if("=="===n.operator&&t[n.name]!=n.value)return;if("!="==n.operator&&t[n.name]==n.value)return;if("=^"===n.operator&&!t[n.name].startsWith(n.value))return;if("!^"===n.operator&&t[n.name].startsWith(n.value))return;break;case"number":if("=="===n.operator&&t[n.name]!=n.value)return;if("!="===n.operator&&t[n.name]==n.value)return;if(">="===n.operator&&t[n.name]<n.value)return;if("<="===n.operator&&t[n.name]>n.value)return;if(">"===n.operator&&t[n.name]<=n.value)return;if("<"===n.operator&&t[n.name]>=n.value)return;break;case"undefined":case"object":if("=="===n.operator&&null!=t[n.name])return;if("!="===n.operator&&null==t[n.name])return;break;default:throw new Error(i.format(r.SelectorSyntaxUnsupported,n.raw))}}return t}},e.sniffKind=function(e){if(0===e.length)throw new Error(i.format(r.SelectorMalformed,e));for(var t=Object.keys(y),o=0;o<t.length;o+=1){var n=t[o];if(y[n](e))return n}throw new Error(i.format(r.SelectorMalformed,e))},e}(),E=function(){function e(e){this.path=e,this.tokens=[],this.elements=[],this.path=e.trim();for(var t=!1,r="",o=0;o<this.path.length;o+=1)"."!==this.path[o]||t?(r+=this.path[o],"["===this.path[o]&&(t=!0),"]"===this.path[o]&&(t=!1)):(this.tokens.push(r),this.elements.push(new b(r)),r="");this.tokens.push(r),this.elements.push(new b(r))}return e.prototype.select=function(e){for(var t=e,r=0;r<this.elements.length;r+=1)if(void 0===(t=this.elements[r].select(t)))return;return t},e}();function O(e){if(void 0===d[e])try{d[e]=new E(e)}catch(t){d[e]=!1}return d[e]}function k(e,t){var r=O(e);if(!1!==r)return r.select(t||l())}var x,D=function(){function e(e){this.options=e}return e.prototype.handleData=function(e){var t=this.options,r=t.func,o=t.thisArg,n=l();if(o)switch(typeof o){case"object":n=o;break;case"string":n=k(o);break;default:throw new Error("Unsupported this context used")}if(!n)throw new Error("No this context set");var i=null;switch(typeof r){case"function":return null==(i=r.apply(n,e))?null:[i];case"string":return null==(i=k(r).apply(n,e))?null:[i];default:return null}},e.prototype.validate=function(){new u(this.options).validate(e.specification)},e.specification={func:{required:!0,type:["string","function"]},thisArg:{required:!1,type:["string","object"]}},e}(),j=function(){function e(e){this.options=e;var t=e.index,r=void 0===t?0:t,o=e.properties,n=void 0===o?[]:o;this.index=r,this.properties="string"==typeof n?n.split(",").map((function(e){return e.trim()})):n}return e.prototype.handleData=function(e){var t=e[this.index];if("object"!=typeof t&&!1===Array.isArray(t))throw new Error("Can only fan out arrays or properties on objects");var r=[];if(0===this.properties.length)return Array.isArray(t)?r.push.apply(r,t):Object.values(t).forEach((function(e){Array.isArray(e)?r.push.apply(r,e):"object"==typeof e&&r.push(e)})),r;for(var o=0;o<this.properties.length;o+=1){var n=t[this.properties[o]];Array.isArray(n)?r.push.apply(r,n):r.push(n)}return r},e.prototype.validate=function(){new u(this.options).validate(e.specification)},e.specification={index:{required:!1,type:["number"]},properties:{required:!1,type:["string"]}},e}(),S=function(){function e(e){this.options=e;var t=e.index,r=void 0===t?0:t,o=e.position,n=void 0===o?0:o;this.index=r,this.position=n}return e.prototype.handleData=function(e){var t=this.options,r=t.defaultValue,o=t.select,n=t.value;if(o&&void 0!==n)throw new Error("Both 'select' and 'value' options set");var i=n||k(o,e[this.index]);if(void 0===i&&void 0!==r&&(i=r),void 0===i)throw new Error("Failed to find a value to insert");var s=e.slice();return s.splice(this.position>=0?this.position:s.length-this.position,0,i),s},e.prototype.validate=function(){var t=new u(this.options);t.validate(e.specification);var r=this.options,o=r.select,n=r.value;o||void 0!==n||t.throwError("selection"," and 'value' are missing - at least one is required"),o&&void 0!==n&&t.throwError("selection"," and 'value' are both defined - use only one option")},e.specification={defaultValue:{required:!1,type:["boolean,string,number,object"]},index:{required:!1,type:["number"]},select:{required:!1,type:["string"]},value:{required:!1,type:["boolean,string,number,object"]},position:{required:!1,type:["number"]}},e}();!function(e){e.Bool="_bool",e.Bools="_bools",e.Date="_date",e.Dates="_dates",e.Int="_int",e.Ints="_ints",e.Obj="_obj",e.Objs="_objs",e.String="_str",e.Strings="_strs",e.Real="_real",e.Reals="_reals"}(x||(x={}));var I=function(){function e(e){this.options=e;var t=e.index,r=void 0===t?-1:t,o=e.maxDepth,n=void 0===o?10:o;this.index=r,this.maxDepth=n}return e.coerceNumSuffix=function(){return x.Real},e.coerceSuffix=function(t){if(Array.isArray(t))return t.every((function(e){return"string"==typeof e}))?x.Strings:t.every((function(e){return"boolean"==typeof e}))?x.Bools:t.every((function(e){return"number"==typeof e}))?x.Reals:t.every((function(e){return e instanceof Date}))?x.Dates:t.every((function(e){return"object"==typeof e}))?x.Objs:null;if(t instanceof Date)return x.Date;switch(typeof t){case"string":return x.String;case"boolean":return x.Bool;case"number":return e.coerceNumSuffix();case"object":return x.Obj;default:return null}},e.prototype.mapToSuffix=function(t,r){var o=this;void 0===r&&(r=0);var n={};return null==t||Object.getOwnPropertyNames(t).forEach((function(i){var s=t[i],a=0!==r||"pageName"!==i&&"displayName"!==i&&"email"!==i?e.coerceSuffix(s):"",u=""+i+a;if(null!==a)switch(a){case x.Obj:r<o.maxDepth&&(n[u]=o.mapToSuffix(s,r+1));break;case x.Objs:r<o.maxDepth&&(n[u]=s.map((function(e){return o.mapToSuffix(e,r+1)})));break;default:n[u]=s}})),n},e.prototype.handleData=function(e){var t=this.index>=0?this.index:e.length+this.index;return"string"==typeof e[t]&&(t-=1),c(e,t,this.mapToSuffix(e[t]))},e.prototype.validate=function(){new u(this.options).validate(e.specification)},e.specification={index:{required:!1,type:["number"]},maxDepth:{required:!1,type:["number"]}},e}(),P=function(){function e(e){this.options=e;var t=e.index,r=void 0===t?0:t,o=e.properties,n=void 0===o?{}:o;this.index=r,this.properties=n}return e.prototype.handleRename=function(e){for(var t=Object.getOwnPropertyNames(this.properties),r=0;r<t.length;r+=1){var o=t[r],n=this.properties[o],i=e[o];delete e[o],e[n]=i}},e.prototype.handleData=function(e){if("object"!=typeof e[this.index])throw new Error("Can only convert property names on objects");var t=a({},e[this.index]);return this.handleRename(t),c(e,this.index,t)},e.prototype.validate=function(){var t=new u(this.options);t.validate(e.specification);var r=this.options.properties;0===Object.getOwnPropertyNames(r).length&&t.throwError("properties","at least one property must be renamed");for(var o=Object.getOwnPropertyNames(r),n=0;n<o.length;n+=1)"string"!=typeof r[o[n]]&&t.throwError("properties","can only rename to string values")},e.specification={index:{required:!1,type:["number"]},properties:{required:!0,type:["object"]}},e}(),R=function(){function e(e){this.options=e;var t=e.index,r=void 0===t?0:t;this.index=r}return e.prototype.handleData=function(e){var t=k(this.options.select,{$:e[this.index]});return null==t?null:[t]},e.prototype.validate=function(){var t=new u(this.options);t.validate(e.specification),"$"!==this.options.select.charAt(0)&&t.throwError("select","must begin with $")},e.specification={index:{required:!1,type:["number"]},select:{required:!0,type:["string"]}},e}(),N=function(){function e(){}return e.create=function(t,o){if(!e.hasOperator(t))throw new Error(i.format(r.UnknownValue,t));return new this.operators[t](o)},e.hasOperator=function(e){return void 0!==this.operators[e]},e.operators={convert:p,flatten:h,function:D,insert:S,suffix:I,query:R,rename:P,"fan-out":j},e}(),T=function(e,t,r){this.path=e,this.property=t,this.args=r},M=function(e,t,r){this.path=e,this.property=t,this.value=r};function A(e){return"datalayerobserver/"+e}var _=function(){function e(t,r,o){void 0===r&&(r=!1),void 0===o&&(o=e.DefaultDebounceTime),this.target=t,this.debug=r,this.debounce=o,this.listener=null,this.operators=[],this.timeoutId=null,this.debugger=function(e,t,r){return console.debug(t?""+r+e+"\n"+r+JSON.stringify(t):""+r+e)},this.start()}return e.prototype.fireEvent=function(e){void 0===e&&(e=this.target.query()),e&&this.handleData([e])},e.prototype.handleEvent=function(e){var r=this,o=e.detail,n=o.args,s=o.value,a=e.type,u=this.target.path;if(void 0===s&&void 0===n)i.getInstance().debug(t.EventEmpty,{path:u});else if(a===A(u))if(void 0!==s){"number"==typeof this.timeoutId&&window.clearTimeout(this.timeoutId);var c=this.target.query();c&&(this.timeoutId=window.setTimeout((function(){r.timeoutId=null,r.handleData([c])}),this.debounce))}else this.handleData(n||[]);else i.getInstance().warn(t.EventUnexpected,{path:u})},e.prototype.handleData=function(r,o){void 0===o&&(o=0);var n=this.target.path;this.runDebugger(n+" handleData entry",r);for(var s=r,a=o;a<this.operators.length;a+=1){var u=this.operators[a].options.name;try{if(null===s)return this.runDebugger("["+a+"] "+u+" halted",s,"  "),null;if(null!==(s=this.operators[a].handleData(s))&&this.operators[a]instanceof j){for(var c=0;c<s.length;c+=1)this.handleData([s[c]],a+1);break}var p="";if(this.debug&&null!==s&&null!==s[0]&&"object"==typeof s[0]){var h=s[0];p="(numKeys="+e.numProperties(h)+" sizeOfValues="+e.sizeOfValues(h)+" sizeOfPayload="+e.sizeOfPayload(h)+")"}this.runDebugger("["+a+"] "+u+" output "+p,s,"  ")}catch(e){return i.getInstance().error(t.OperatorError,{operator:u,path:n,reason:e.message}),null}}return this.runDebugger(n+" handleData exit",s),s},e.sizeOfPayload=function(e,t){return void 0===t&&(t=2),JSON.stringify(e).length*t},e.sizeOfValues=function(e,t){var r=this;void 0===t&&(t=2);var o=0;return"object"==typeof e&&Object.getOwnPropertyNames(e).forEach((function(n){switch(typeof e[n]){case"object":null==e[n]||Array.isArray(e[n])||(o+=r.sizeOfValues(e[n]));break;case"string":o+=e[n].length*t;break;case"number":o+=8;break;case"boolean":o+=2}})),o},e.numProperties=function(e){var t=this,r=0;return"object"==typeof e&&Object.getOwnPropertyNames(e).forEach((function(o){"object"!=typeof e[o]||null==e[o]||Array.isArray(e[o])?r+=1:r+=t.numProperties(e[o])})),r},e.prototype.runDebugger=function(e,t,r){void 0===r&&(r=""),this.debug&&this.debugger(e,t,r)},e.prototype.push=function(){for(var e=this,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];t.forEach((function(t){return e.operators.push(t)}))},e.prototype.start=function(){var e=this;this.listener||(this.listener=function(t){return e.handleEvent(t)},window.addEventListener(A(this.target.path),this.listener))},e.prototype.stop=function(){window.removeEventListener(A(this.target.path),this.listener),this.listener=null},e.DefaultDebounceTime=250,e}(),q=function(){function e(e,t,o,n){if(void 0===n&&(n=""),this.subject=e,this.property=t,this.path=o,this.selector=n,"object"!=typeof e)throw new Error(r.TargetSubjectObject);if(!t)throw new Error(r.TargetPropertyMissing);if(!o)throw new Error(r.TargetPathMissing);var i=typeof(this.selector?k(this.path):this.subject[this.property]);switch(i){case"object":case"function":this.type=i;break;default:throw new Error(r.DataLayerMissing)}}return Object.defineProperty(e.prototype,"subjectPath",{get:function(){return this.path.substring(0,this.path.lastIndexOf("."))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"value",{get:function(){return k(this.path)||this.subject[this.property]},enumerable:!1,configurable:!0}),e.prototype.query=function(){return this.selector?k(this.selector):this.value},e.find=function(t){var o=O(t);if(!o)throw new Error(i.format(r.SelectorMalformed,t));for(var n="",s="",a="",u=o.elements,c=0;c<u.length;c+=1){var p=u[c],h=p.kind,d=p.raw,v=p.brackets;if(h!==f.Pluck&&h!==f.Index){if(v){s=t.substring(0,t.indexOf("["+v.op.raw+"]")),a=v.prop;break}throw new Error("Brackets expected in "+d+" but not found")}n+=n?"."+d:d,s+=s?"."+d:d,a=v?v.prop:d}return n===s&&(n=n.substring(0,n.lastIndexOf("."))),new e(n?k(n):l(),a,s,t)},e}(),C=function(e){function o(){var t=null!==e&&e.apply(this,arguments)||this;return t.configurable=!0,t.enumerable=!0,t.writable=!0,t}return function(e,t){function r(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(o,e),o.checkShimAllowed=function(e){if(Object.isFrozen(e))throw new Error(i.format(r.ShimFail,"frozen"));if(Object.isSealed(e))throw new Error(i.format(r.ShimFail,"sealed"))},o.prototype.addPropertyMonitor=function(){var e=this;o.checkShimAllowed(this.object);var t=Object.getOwnPropertyDescriptor(this.object,this.property);if(t){var r=t.configurable,n=t.enumerable,i=t.writable;this.configurable=r,this.enumerable=n,this.writable=i}Object.defineProperty(this.object,this.property,{configurable:this.configurable,enumerable:this.enumerable,get:function(){return e.state},set:function(t){var r=e.state!==t;e.state=t,r&&e.emit(t)}})},o.prototype.remove=function(){try{Object.defineProperty(this.object,this.property,{enumerable:this.enumerable,configurable:this.configurable,value:this.state,writable:this.writable})}catch(e){i.getInstance().error(t.MonitorRemoveError,{path:this.path,property:this.property,reason:e.message})}},o.prototype.addFunctionMonitor=function(){var e=this;o.checkShimAllowed(this.object),this.object[this.property]=function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];try{return e.emit(r),e.state.apply(e.object,r)}catch(r){return i.getInstance().error(t.MonitorCallError,{path:e.property,property:e.property,reason:r.message}),null}}},o}(function(){function e(e,o,n){if(this.object=e,this.property=o,this.path=n,!e)throw new Error(r.DataLayerMissing);if(n.endsWith(o)&&"function"!=typeof e[o]&&i.getInstance().warn(t.MonitorDuplicateProp,{path:n,property:o}),this.copy(),"object"!=typeof e&&"function"!=typeof e[o])throw new Error(i.format(r.UnsupportedType,typeof e));"function"==typeof e[o]?this.addFunctionMonitor():this.addPropertyMonitor()}return e.prototype.copy=function(){this.state=this.object[this.property]},e.prototype.emit=function(e){try{window.dispatchEvent(function(e,t,r,o){return new CustomEvent(A(o),{detail:"function"==typeof e[t]?new T(o,t,r):new M(o,t,r)})}(this.object,this.property,e,this.path))}catch(e){i.getInstance().error(t.MonitorEmitError,{path:this.path,property:this.property,reason:e.message})}},e}()),$=function(){function e(){this.monitors={}}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.create=function(e,t,r){var o="function"==typeof e[t]?r:r+"."+t;if(!this.monitors[o]){var n=Object.getOwnPropertyDescriptor(e,t)||null;(null===n||n.configurable)&&(this.monitors[o]=new C(e,t,r))}return this.monitors[o]},e.prototype.remove=function(e,t){var r=this;void 0===t&&(t=!1),(t?Object.getOwnPropertyNames(this.monitors).filter((function(t){return t.startsWith(e)})):[e]).forEach((function(e){var t=r.monitors[e];t&&(t.remove(),delete r.monitors[e])}))},e}(),L=function(){function e(e){var t=this;void 0===e&&(e={rules:[],previewMode:!1,previewDestination:"console.log",readOnLoad:!1,validateRules:!0}),this.config=e,this.customOperators={},this.handlers=[],this.listeners={};var r=Date.now(),o=e.appender,n=e.logLevel,s=e.rules;o&&("string"==typeof o?i.getInstance(o):i.getInstance().appender=o),n&&(i.getInstance().level=n),s&&(s.forEach((function(e){return t.registerRule(e)})),i.getInstance().record("DLO rule count",{numericValue:s.length})),i.getInstance().record("DLO constructor time",{numericValue:r-Date.now()})}return e.prototype.addHandler=function(e,t,r){void 0===t&&(t=!1),void 0===r&&(r=_.DefaultDebounceTime);var o=new _(e,t,r);return this.handlers.push(o),o},e.prototype.addMonitor=function(e){var t=e.subject,r=e.property,o=e.subjectPath,n=e.path,i=e.selector;if("function"===e.type)$.getInstance().create(t,r,n);else{i&&$.getInstance().create(t,r,o);var s=e.value;Object.getOwnPropertyNames(e.query()).forEach((function(e){$.getInstance().create(s,e,n)}))}},e.prototype.addOperators=function(e,r,o){var n=this,s=this.config,a=s.beforeDestination,u=s.previewDestination,c=void 0===u?"console.log":u,p=s.previewMode;try{if(r.forEach((function(t){e.push(n.getOperator(t))})),a)(Array.isArray(a)?a:[a]).forEach((function(t){return e.push(n.getOperator(t))}));var h=p?c:o;e.push(new D({name:"function",func:h}))}catch(o){throw this.removeHandler(e),i.getInstance().error(t.OperatorError,{operator:JSON.stringify(r)}),o}},e.prototype.getOperator=function(e){try{var r=e.name,o=this.customOperators[r]?this.customOperators[r]:N.create(r,e);return this.config.validateRules&&o.validate(),o}catch(r){throw i.getInstance().error(t.OperatorError,{operator:JSON.stringify(e)}),r}},e.prototype.isUrlValid=function(e){var t=this.config.urlValidator;return t?t(e):!e||RegExp(e).test(window.location.href)},e.prototype.registerTarget=function(e,r,o,n,s,a,u){void 0===n&&(n=!1),void 0===s&&(s=!0),void 0===a&&(a=!1),void 0===u&&(u=_.DefaultDebounceTime);var c=e,p=c.value;s&&Array.isArray(p)&&(p.push&&p.unshift?(this.registerTarget(q.find(e.path+".unshift"),r,o,!1,!0,a,u),c=q.find(e.path+".push")):i.getInstance().warn(t.MonitorCreateError,{path:c.path,property:c.property,selector:c.selector,reason:"Browser does not support push and unshift"}));var h=this.addHandler(c,!!a,u);if(this.addOperators(h,r,o),n)if(Array.isArray(p))for(var l=0;l<p.length;l+=1)try{h.fireEvent(p[l])}catch(e){i.getInstance().error(t.ObserverReadError,{path:c.path,property:c.property,selector:c.selector,reason:e.message})}else if("object"===c.type)try{h.fireEvent()}catch(e){i.getInstance().error(t.ObserverReadError,{path:c.path,property:c.property,selector:c.selector,reason:e.message})}if(s||"function"===c.type)try{this.addMonitor(c)}catch(e){i.getInstance().warn(t.MonitorCreateError,{path:c.path,property:c.property,selector:c.selector,reason:e.message})}return h},e.prototype.registerRule=function(e,r,o){var n=this;void 0===r&&(r=0),void 0===o&&(o=300);var s=this.config.readOnLoad,a=e.id,u=void 0===a?"":a,c=e.debounce,p=e.debug,h=e.source,l=e.operators,f=void 0===l?[]:l,d=e.destination,v=e.readOnLoad,y=e.url,g=e.monitor,w=void 0===g||g,m=void 0===v?s:v;if(h&&d){if(this.isUrlValid(y))try{var b=q.find(h);this.registerTarget(b,f,d,m,w,p,c)}catch(s){setTimeout((function(){try{var o=q.find(h);n.registerTarget(o,f,d,m,w,p,c)}catch(o){r>3?i.getInstance().error(t.RuleRegistrationError,{rule:u,source:h,reason:o.message}):n.registerRule(e,r+1)}}),r*o)}}else i.getInstance().error(t.RuleInvalid,{rule:u,source:h,reason:"Missing "+(h?"destination":"source")})},e.prototype.registerOperator=function(e,t){if(N.hasOperator(e)||this.customOperators[e])throw new Error(i.format(r.DuplicateValue,e));this.customOperators[e]=t},e.prototype.removeHandler=function(e){e.stop();var t=this.handlers.indexOf(e);t>-1&&this.handlers.splice(t,1)},e}();!function(){try{var e=Date.now(),r=window;if(i.getInstance(r._dlo_appender),r._dlo_observer)return void i.getInstance().warn(t.ObserverMultipleLoad);var o=function(){try{var e=Date.now(),r=[];return Object.getOwnPropertyNames(window).forEach((function(e){if(!1!==e.startsWith("_dlo_rules")){var o=window[e];!1!==Array.isArray(o)?o.forEach((function(e){r.push(e)})):i.getInstance().warn(t.RuleInvalid,{property:o,reason:"Rules list must be an array"})}})),i.getInstance().record("DLO rule processing time",{numericValue:e-Date.now()}),r}catch(e){return i.getInstance().error(t.RuleRegistrationError,{reason:"Error: "+e}),[]}}();0===o.length&&i.getInstance().warn(t.ObserverRulesNone),r._dlo_observer=new L({appender:r._dlo_appender||void 0,beforeDestination:r._dlo_beforeDestination||void 0,logLevel:r._dlo_logLevel||void 0,previewMode:!0===r._dlo_previewMode,previewDestination:r._dlo_previewDestination||void 0,readOnLoad:!0===r._dlo_readOnLoad,validateRules:!0===r._dlo_validateRules,urlValidator:r._dlo_urlValidator||void 0,rules:o}),i.getInstance().record("DLO initialization time",{numericValue:e-Date.now()})}catch(e){i.getInstance().error(t.ObserverInitializationError,{reason:"Error: "+e})}}()}();
