define(['module.base','web/modules/mylocations','localization/copy','util/weather_convertion','mustache'],function(Module,mylocations,copy,convert,Mustache){Module.Locationlist=function(){window._Module.prototype.template_manager.load('web/savedlocations/edit_or_no_saved_locations/add_edit_locations/each_location/each_location_dropdown/dropdown_locations_wrapper');var tmplts=['add_edit_locations','edit_or_no_saved_locations','each_location','each_location_dropdown','dropdown_locations_wrapper'];var self=this;self.tpl=window.templates;self.tpl_main='locationlist';var citypage=(typeof _config.url_weather!="undefined"?'/'+_config.url_weather+'/':'/weather/');self.init=function(elm,data){if(location.href.indexOf(copy.page_url.url_myaccount_edit_locations)>=0){mylocations.reLoadLocationsOnce();}
for(var i=tmplts.length-1;i>-1;i--){if(typeof window.templates[tmplts[i]]=='undefined'){setTimeout(function(){self.init();},50);return;}}
if(location.search.indexOf(copy.page_url.url_myaccount_edit_locations)>=0||location.search.indexOf(copy.page_url.url_my_alerts)>=0){if(mylocations.isUserLoggedin()){if(typeof window.reloaded_locations=='undefined'){setTimeout(function(){self.init(elm,data);},450);return;}}}
var elem,locations=mylocations.getLocations()||[],allPlaceCode=[];var length=locations.length;self.rederSavedLocationsComponent(length);var container=$('#savedlocations-container');container.html('');var dropdown_container=$('#savedlocations-dropdown ul[class="submenu"]');dropdown_container.html('');if($.isArray(locations)&&locations.length>0){$.each(locations,function(index,val){elem=self.createElem(val,index);if(index<4){$(elem).appendTo(container);}else{$("#savedlocations-dropdown ul[class='submenu']").append(elem);}
allPlaceCode.push(val.placeCode.toLowerCase());});}
if(window._config.placecode&&($('.edit-mylocation').length==0)){var isAlreadySaved=self.isLocationSaved(window._config.placecode,allPlaceCode);self.renderAddOrEditlocation(isAlreadySaved);}};self.rederSavedLocationsComponent=function(length){if(self.enableEditLocationIcon(length)){self.removeDropdown();self.renderEditOrNoLocations(true);}else if(self.enableDropdown(length)){self.removeEditLocationIcon();self.renderLocationDropdown();}else if(self.enableAddLocationIcon(length)){self.bindOverlay();self.renderEditOrNoLocations(false);}}
self.bindOverlay=function(){require(['modals','defaults'],function(modals,defaults){modals.bind(defaults.overlays.locationOverlay);});}
self.enableDropdown=function(length){if(length>=5&&$('#savedlocations-dropdown').length==0){return true;}
return false;};self.enableEditLocationIcon=function(length){if(length>=1&&length<=4&&$('#edit-savedlocations').length==0){return true;}
return false;};self.enableAddLocationIcon=function(length){if(length==0&&$('#edit-savedlocations').length==0){return true;}
return false;};self.removeDropdown=function(){if($('#savedlocations-dropdown').length>0){$('#savedlocations-dropdown').remove();return true;}
return false;};self.removeEditLocationIcon=function(){if($('#edit-savedlocations').length>0){$('#edit-savedlocations').remove();return true;}
return false;};self.createElem=function(data,index){var position=index+1;var alertStatus=self.currentLocationHasAlert(data);var domElement,locationData=self.getLocationUrl(data.locationType);var locationNameTruncated=self.truncateLocationName(data.city);var wxicon_image=alertStatus?'icon-lightening-small.png':'icons/wxicons_small/'+data.weather_icon+'.png';var city_url=locationData.url+(data.placeCode||'').toLowerCase();var tempUnit=mylocations.getStoredData('pelm_unit');var tempValue=self.getConvertedTemp(tempUnit,data.temperature_unit,data.temperature);var gapLocationName=data.city+' '+data.province+', '+data.countryName+' ['+position+']';gapLocationName=gapLocationName.replace("'","");var template_data={"isAlert":alertStatus,"cityURL":city_url,"placeCode":(data.placeCode||'').toLowerCase(),"locationNameFull":data.city+' '+data.province+', '+data.countryName,"locationNameTruncated":locationNameTruncated,"tempValue":tempValue,"tempUnit":tempUnit,"imgSrc":window._config['image_url']+wxicon_image,"gapLocationName":gapLocationName};if(index<4){domElement=Mustache.render(window.templates['each_location'],template_data,{});}else{domElement=Mustache.render(window.templates['each_location_dropdown'],template_data,{});}
return domElement;}
self.currentLocationHasAlert=function(data){if((window.placecode&&data&&data.placeCode)&&(window.placecode.toLowerCase()==data.placeCode.toLowerCase())&&window.alertexists.toLowerCase()==="true"){return 1;}
return parseInt(data.alertStatus);}
self.isLocationSaved=function(placecode,allPlaceCode){var isSaved=allPlaceCode.indexOf(placecode)!==-1?true:false;return isSaved;}
self.renderEditOrNoLocations=function(edit_locations){var domElement=Mustache.render(window.templates['edit_or_no_saved_locations'],{"isEditLocations":edit_locations,"lbl_view_edit_location":copy.location.lbl_view_edit_location,"url_myaccount_edit_locations":copy.page_url.url_myaccount_edit_locations},{});$(domElement).appendTo('#savedlocations-banner');}
self.renderLocationDropdown=function(){var domElement=Mustache.render(window.templates['dropdown_locations_wrapper'],{"lbl_view_edit_loc":copy.location.lbl_view_edit_location,"lbl_edit_locations":copy.location.lbl_edit_location,"edit_locations_url":copy.page_url.url_myaccount_edit_locations},{});$(domElement).appendTo('#savedlocations-banner');}
self.renderAddOrEditlocation=function(isAlreadySaved){$('#add-saved-location').html('');var domElement=Mustache.render(window.templates['add_edit_locations'],{"isAlreadySaved":isAlreadySaved,"url_myaccount_edit_locations":copy.page_url.url_myaccount_edit_locations,"lbl_saved_to_my_locations":copy.location.lbl_saved_to_my_locations,"lbl_add_to_my_locations":copy.location.lbl_add_to_my_locations},{});$('#add-saved-location').html(domElement);if(!isAlreadySaved){$('.addlocation-button').on('click',function(event){event.preventDefault();var add_loc=self.shouldAddLocation();if(add_loc){if(typeof window.placecode=='string'){require(['web/modules/location_search'],function(search){var loc=(typeof window.postalcode!=undefined&&window.postalcode!=null)?window.postalcode:window.placecode;search.addLocation(loc);});}
self.renderAddOrEditlocation(true);}});}};self.shouldAddLocation=function(){if(window.localStorage.pelm_mylocations&&typeof window.localStorage.pelm_mylocations!=='undefined'){var locations=null;try{locations=JSON.parse(window.localStorage.pelm_mylocations);}catch(e){}
if(locations&&locations.length>=10){return false;}}
return true;}
self.truncateLocationName=function(cityName){var truncatedName=cityName.length>8?cityName.substring(0,8)+'...':cityName;return truncatedName;}
self.getConvertedTemp=function(cookieTemp,storedUnit,storedTemp){var convertedValue=(cookieTemp==(storedUnit?storedUnit.toLowerCase():''))?storedTemp:convert.temperature(storedTemp,cookieTemp);return convertedValue;}
self.getLocationUrl=function(locType){var purl='',replace_purl='',replace_locale='';var data=window._config.domain_redirect_products;if(data&&data.indexOf('{')>=0&&data.indexOf('<')<0){data=JSON.parse(data);}
switch(locType){case'schools':if(typeof copy.page_url.school_url!='undefined'){purl=copy.page_url.school_url;replace_purl=(data.schools.countrycode)?'/'+data.schools.countrycode:'';replace_locale=(data.schools.locale)?data.schools.locale:'';}
break;case'cottages':if(typeof copy.page_url.cottage_url!='undefined'){purl=copy.page_url.cottage_url;replace_purl=(data.cottages.countrycode)?'/'+data.cottages.countrycode:'';replace_locale=(data.cottages.locale)?data.cottages.locale:'';}
break;case'attractions':if(typeof copy.page_url.attractions_url!='undefined'){purl=copy.page_url.attractions_url;replace_purl=(data.attractions.countrycode)?'/'+data.attractions.countrycode:'';replace_locale=(data.attractions.locale)?data.attractions.locale:'';}
break;case'golf':if(typeof copy.page_url.golf_url!='undefined'){purl=copy.page_url.golf_url;replace_purl=(data.golf.countrycode)?'/'+data.golf.countrycode:'';replace_locale=(data.golf.locale)?data.golf.locale:'';}
break;case'ski':if(pelm_util.isDefined(copy.page_url.ski_url)){purl=copy.page_url.ski_url;replace_purl=(data.ski.countrycode)?'/'+data.ski.countrycode:'';replace_locale=(data.ski.locale)?data.ski.locale:'';}
break;case'airports':if(pelm_util.isDefined(copy.page_url.airport_url)){purl=copy.page_url.airport_url;replace_purl=(data.airports.countrycode)?'/'+data.airports.countrycode:'';replace_locale=(data.airports.locale)?data.airports.locale:'';}
break;case'sailing':if(pelm_util.isDefined(copy.page_url.sailing_cruising_url)){purl=copy.page_url.sailing_cruising_url;}
break;default:purl=copy.page_url.weather_url;break;}
if(replace_locale&&replace_locale!==window._config.locale){purl=replace_purl+"/"+purl;}
return{'url':'/'+purl+'/','locale':replace_locale};}};return Module.factory('Locationlist');});;