/*!
 * AnySign, v1.0.1.26.
 * 
 * For more information on this product, please see
 * https://www.hsecure.co.kr/
 * 
 * Copyright (c) Hancom Secure Inc. All Rights Reserved.
 * 
 * Date: 2019-08-25
 */
Secure=(function(){var dm=sofo.cT||{};var ia=sofo.crypto||{};if(!Object.create){Object.create=function(o,Wz){if(typeof o!=='object'&&typeof o!=='function')throw new TypeError('Object prototype may only be an Object: '+o);else if(o===null)throw new Error("This browser's implementation of Object.create is a shim and doesn't support 'null' as the first argument.");if(typeof Wz!='undefined')throw new Error("This browser's implementation of Object.create is a shim and doesn't support a avD argument.");function F(){};F.prototype=o;return new F();};}var Qq={"close_notify":"40000","unexpected_message":"40010","bad_record_mac":"40020","decryption_failed_RESERVED":"40021","record_overflow":"40022","bad_verify_hash":"40023","bad_verify_mac":"40024","decompression_failure":"40030","no_certificate_RESERVED":"40041","bad_certificate":"40042","unsupported_certificate":"40043","certificate_revoked":"40044","certificate_expired":"40045","certificate_unknown":"40046","illegal_parameter":"40047","unknown_ca":"40048","access_denied":"40049","decode_error":"40050","decrypt_error":"40051","unknown_error":"41000","create_keyBlock_failure":"41001","generatorRandom_fail":"41002","unknown_sym_algorithm":"41003","unknown_hash_algorithm":"41004","invalid_keyBlock":"41005","invalid_pem_format":"41006","utf8_decode_fail":"41007","unsupported_protocol_type":"41010"};var xv="",Gy="1.0.0";var tZ,CL,Fs;var tI;var rz,Gf,yX,wT;var VG,SF,TQ;var la={};var gM;var dA;var iv;var fc;var encryptedData;var BI=function(){return{value:"",param:{vm:null,qR:null,nh:null},iv:{},fc:{},dA:{},server:{iv:{},fc:{},dA:{}}};};var bQ=new BI();var pf={};var DC=function(bA,hash){return{protocolType:"secure",message:bA,hash:hash};};var Hy=function(bA,hash){return{protocolType:"envelope",message:bA,hash:hash};};function gF(bA,mb){this.errorCode=Qq[bA];this.hq=bA;if(mb==null||mb==undefined)this.mb="";else this.mb=mb;};gF.prototype=Object.create(Error.prototype);gF.prototype.constructor=gF;function envelopeCreateKeyBlock(aQ){var nH=aQ.fc.length;var eN=aQ.dA.length;var cO=aQ.iv.length;var la,Jx;try{Jx=nH+eN+cO;aQ.fc.value=dm.uv(nH);aQ.dA.value=dm.uv(eN);aQ.iv.value=dm.uv(cO);la=dm.bV(Jx);var offset=0;dm.kb(aQ.fc.value,0,la,offset,nH);offset+=20;dm.kb(aQ.dA.value,0,la,offset,eN);offset+=16;dm.kb(aQ.iv.value,0,la,offset,cO);offset+=16;if(la===undefined||la==null){throw new gF("unknown_sym_algorithm");}return la;}catch(e){if(e.hq)throw new gF(e.hq,"[envelopeCreateKeyBlock]");else throw new gF(e.message,"[envelopeCreateKeyBlock]");}};function setCipher(aQ){try{switch(aQ.param.qR){case "jN":{aQ.iv.length=16;aQ.dA.length=16;}break;case "aesCBC":{aQ.iv.length=16;aQ.dA.length=16;}break;default:{throw new gF("unknown_sym_algorithm");}break;}switch(aQ.param.nh){case "macWithSHA":{aQ.fc.length=20;}break;default:{throw new gF("unknown_hash_algorithm");}break;}}catch(e){if(e.hq)throw new Error("[AnySign4PC][setCipher] ErrorMsg : "+e.hq+"("+e.errorCode+")");else throw e;}};function setAlgorithm(protocolType,aQ){if(aQ===undefined)aQ=new BI();try{switch(protocolType){case "secure":{aQ.param.vm="RSAES-PKCS1-V1_5";aQ.param.nh="macWithSHA";aQ.param.qR="jN";}break;case "envelope":{aQ.value="RSA_SEED_128_SHA";aQ.param.nh="macWithSHA";aQ.param.vm="RSAES-PKCS1-V1_5";aQ.param.qR="aesCBC";}break;default:{throw new gF("unsupported_protocol_type");}break;}}catch(e){throw new Error("[AnySign4PC][setAlgorithm] ErrorMsg : "+e.hq+"("+e.errorCode+")");}};var AE=function(protocolType,qa){var io;try{if(protocolType=="secure"){rz=dm.uv(32);if(rz===undefined||rz==null){throw new gF("generatorRandom_fail");}var bA={sid:xv,messageType:"client_hello",version:Gy,random:dm.hg(rz)};var zS=ia.Bd(JSON.stringify(bA));tZ=dm.hg(zS.bg());io=JSON.stringify(DC(bA,tZ));}else{var bA={sid:"",messageType:"client_hello",version:Gy};tZ="";io=JSON.stringify(Hy(bA,tZ));}qa(io);}catch(e){if(e.hq)throw new Error("[AnySign4PC][AE] ErrorMsg : "+e.hq+"("+e.errorCode+")");else throw new Error("[AnySign4PC][AE][Native] ErrorMsg : "+e.message);}};function keyBlockToCipherSuite(block,aQ){try{if(block===undefined||block.length<=0)throw new gF("invalid_keyBlock");var bx=sofo.cT.bytesToHex(block.data);var nH=aQ.fc.length,eN=aQ.dA.length,cO=aQ.iv.length;var pos=0;aQ.fc.value=sofo.cT.hexToBytes(bx.slice(pos,nH*2));pos+=nH*2;aQ.server.fc.value=sofo.cT.hexToBytes(bx.slice(pos,pos+nH*2));pos+=nH*2;aQ.dA.value=sofo.cT.hexToBytes(bx.slice(pos,pos+eN*2));pos+=eN*2;aQ.server.dA.value=sofo.cT.hexToBytes(bx.slice(pos,pos+eN*2));pos+=eN*2;aQ.iv.value=sofo.cT.hexToBytes(bx.slice(pos,pos+cO*2));pos+=cO*2;aQ.server.iv.value=sofo.cT.hexToBytes(bx.slice(pos,pos+16*2));}catch(e){if(e.hq)throw new gF(e.hq,"[keyBlockToCipherSuite]");else throw new gF(e.message,"[keyBlockToCipherSuite]");}};var pu=function(protocolType,parse,aQ){try{tI=parse.message.cert;if(!dm.Kk(tI))throw new gF("invalid_pem_format");if(protocolType=="secure"){Gf=dm.Bi(parse.message.random);xv=dm.Bi(parse.message.sid);var Sx=JSON.stringify(parse.message);var KW=ia.vk(Sx,tZ,"sha1");if(dm.hg(KW.bg())!==(Fs=parse.hash))throw new gF("bad_verify_hash");yX=dm.uv(48);wT=dm.LW(yX,rz,Gf,7);keyBlockToCipherSuite(wT,aQ);}else{setAlgorithm(gM,bQ);setCipher(bQ);la=envelopeCreateKeyBlock(bQ);dA=bQ.dA.value;iv=bQ.iv.value;fc=bQ.fc.value;cert=forge.pki.certificateFromPem(tI);encryptedKey=cert.publicKey.encrypt(la.data,bQ.param.vm);}return true;}catch(e){if(e.hq)throw new Error("[AnySign4PC][pu]"+e.mb+"ErrorMsg : "+e.hq+"("+e.errorCode+")");else throw new Error("[AnySign4PC][pu]"+e.mb+"[Native] ErrorMsg : "+e.message);}};var AC=function(qa,aQ,zL){try{var Xa;var cert=forge.pki.certificateFromPem(zL);if(!dm.Kk(zL))throw new gF("invalid_pem_format");var encryptedData=cert.publicKey.encrypt(yX,aQ.param.vm);var io={messageType:"key_exchange",sid:dm.hg(xv),envelopedData:dm.hg(encryptedData)};var zS=ia.vk(JSON.stringify(io),Fs,"sha1");CL=dm.hg(zS.bg());qa(JSON.stringify(DC(io,CL)));return true;}catch(e){if(e.hq)throw new Error("[AnySign4PC][pu][AC] ErrorMsg : "+e.hq+"("+e.errorCode+")");else throw new Error("[AnySign4PC][pu][AC][Native] ErrorMsg : "+e.message);}};var finish=function(parse){try{var Tf=ia.vk(dm.hg(wT.data),"finish","sha1");var Ru=ia.vk(dm.hg(Tf.data),CL,"sha1");if(dm.hg(Ru.data)!==parse.hash)throw new gF("bad_verify_hash");else return "finish";}catch(e){if(e.hq)throw new Error("[AnySign4PC][finish] ErrorMsg : "+e.hq+"("+e.errorCode+")");else throw new Error("[AnySign4PC][finish][Native] ErrorMsg : "+e.message);}};function sendApplication(protocolType,sid,input,aQ,zL){var YO;var dA=aQ.dA.value;var iv=aQ.iv.value;var fc=aQ.fc.value;var encryptedData;try{var Js=dm.bV(input,'dX');if(protocolType=="secure"){encryptedData=ia.encrypt(input,dA,iv,aQ.param.qR);var bA={messageType:"application",sid:dm.hg(xv),encryptedData:dm.hg(encryptedData)};var Cr=ia.zK(Js.data,fc);io=JSON.stringify(DC(bA,dm.hg(Cr.data)));}else{encryptedData=ia.encrypt(input,dA,iv,aQ.param.qR);var bA={messageType:"application",sid:sid,ciphersuite:aQ.value,encryptedKey:dm.hg(encryptedKey),encryptedData:dm.hg(encryptedData)};var Cr=ia.zK(Js.data,fc);io=JSON.stringify(Hy(bA,dm.hg(Cr.data)));}}catch(e){if(e.hq)throw new Error("[AnySign4PC][sendApplication]"+e.mb+" ErrorMsg : "+e.hq+"("+e.errorCode+")");else throw new Error("[AnySign4PC][sendApplication]"+e.mb+"[Native] ErrorMsg : "+e.message);}return io;};function receiveApplication(protocolType,parse,aQ){var dA,fc,iv;try{if(protocolType=="secure"){fc=aQ.server.fc.value;dA=aQ.server.dA.value;iv=aQ.server.iv.value;}else{fc=aQ.fc.value;dA=aQ.dA.value;iv=aQ.iv.value;}var encryptedData=parse.message.encryptedData;var Fb=ia.decrypt(dm.Bi(encryptedData),dA,iv,aQ.param.qR);var Uo=ia.zK(Fb,fc);if(dm.hg(Uo.bg())!==parse.hash)throw new gF("bad_verify_hash");else{var fs;fs=dm.XQ(Fb);if(fs===undefined||fs==null)throw new gF("utf8_decode_fail");return fs;}}catch(e){if(e.hq)throw new Error("[AnySign4PC][receiveApplication] ErrorMsg : "+e.hq+"("+e.errorCode+")");else throw new Error("[AnySign4PC][receiveApplication][Native] ErrorMsg : "+e.message);}};return{start:function(protocolType,qa){try{if(protocolType===undefined||protocolType==null)gM="secure";gM=protocolType;if(gM=="secure"){pf["secure"]=new BI();var bQ=pf["secure"];setAlgorithm(gM,bQ);setCipher(bQ);}AE(gM,qa);}catch(e){throw e;}},handShake:function(qa,parse){var mq=false;try{if(gM=="secure"){var bQ=pf["secure"];if(pu(gM,parse,bQ))mq=AC(qa,bQ,tI);}else{mq=pu(gM,parse);}}catch(e){throw e;}return mq;},finish:function(parse){return finish(parse);},end:function(){gM=null;var aQ=pf["secure"];if(gM==="secure"){aQ.fc.value=null;aQ.dA.value=null;aQ.iv.value=null;aQ.server.fc.value=null;aQ.server.dA.value=null;aQ.server.iv.value=null;delete pf["secure"];wT=null;}else if(gM=="envelope"){TQ=null;VG=null;SF=null;}},sendApplication:function(input){var sid="";var io;try{if(gM=="secure")bQ=pf["secure"];io=sendApplication(gM,sid,input,bQ,tI);return io;}catch(e){throw e;}},receiveApplication:function(input){var parse=input;var CT;try{if(gM=="secure")bQ=pf["secure"];CT=receiveApplication(gM,input,bQ);return CT;}catch(e){throw e;}}}})(); 