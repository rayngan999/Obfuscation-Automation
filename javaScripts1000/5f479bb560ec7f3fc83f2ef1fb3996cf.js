define(["modules/id.core"],function(e){"use strict";e.utils.log("loading id.elAcViewTr.js");var t=function(){this.conf={observeContainerSelector:".idjs-SiteMain",activeViewArea:.5,activeViewTime:1e3,activeViewTimeDebug:1e4,ELEMENT_IDENTIFIER_DATA_ATTR:"data-id-elavtr",DEBUG_PARAMETER:"activeviewdebug",DEBUG_CSS_CLASS:"id-AdminDebug-tracking",DEBUG_CSS_CLASS_TIMER:"id-AdminDebug-tracking--timer",DEBUG_CSS_CLASS_TRACKED:"id-AdminDebug-tracking--tracked",DEBUG_INFO_CSS_CLASS:"id-AdminDebug-tracking-info"};var t,i=this,n=[],s=[];this.getObservedElements=function(){return n},this.setObservedElements=function(e){n=e},this.getFinishedElements=function(){return s},this.setFinishedElements=function(e){s=e},this.ObservedElementData=function(n,s){var o=this;this.element=n,this.intersectionObserver=s,this.hasBeenTracked=!1,this.timer=null,this.debugStartTimer=0,this.debugInterval=null,this.debugInfoElement=null,this.startTimer=function(){this.hasBeenTracked||(this.timer=setTimeout(function(){i.trackElementActiveView(o.element,o.intersectionObserver),o.hasBeenTracked=!0,clearTimeout(o.timer),o.timer=null,t&&(o.debugStartTimer=0,clearInterval(o.debugInterval),o.renderDebugInfo())},i.conf.activeViewTime),e.utils.log("[id.elAcViewTr.js] starting activeView timer for:",this.element),t&&(this.debugStartTimer=Date.now(),this.debugInterval=setInterval(function(){o.renderDebugInfo()},1e3)))},this.resetTimer=function(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null,e.utils.log("[id.elAcViewTr.js] resetting activeView timer for:",this.element),t&&(this.debugStartTimer=0,clearInterval(this.debugInterval),this.renderDebugInfo()))},this.initDebugInfo=function(){this.debugInfoElement=e.dom.util.create('<div class="'+i.conf.DEBUG_INFO_CSS_CLASS+'"> </div>'),this.element.appendChild(this.debugInfoElement[0]),this.element.classList.add(i.conf.DEBUG_CSS_CLASS)},this.renderDebugInfo=function(){var e,t,n="";this.debugStartTimer>0&&(e=Math.floor((Date.now()-this.debugStartTimer)/1e3%60),t=Math.floor(i.conf.activeViewTime/1e3%60),n+=e+"/"+t+" | "),this.debugStartTimer>0?(n+="VIEW TIMER",this.element.classList.add(i.conf.DEBUG_CSS_CLASS_TIMER),this.element.classList.remove(i.conf.DEBUG_CSS_CLASS_TRACKED)):this.hasBeenTracked?(n+="VIEW TRACKED",this.element.classList.add(i.conf.DEBUG_CSS_CLASS_TRACKED),this.element.classList.remove(i.conf.DEBUG_CSS_CLASS_TIMER)):(n+="VIEW WAIT",this.element.classList.remove(i.conf.DEBUG_CSS_CLASS_TIMER),this.element.classList.remove(i.conf.DEBUG_CSS_CLASS_TRACKED)),this.debugInfoElement[0].firstChild.nodeValue=n},t&&(this.initDebugInfo(),this.renderDebugInfo())},this.init=function(){if(window.hasOwnProperty("IntersectionObserver")&&window.hasOwnProperty("MutationObserver")&&Array.prototype.hasOwnProperty("filter")){var i,n,s,o,a=e.dom.$(this.conf.observeContainerSelector);a.length?(e.configuration.isDebugMode&&(i=new window.URLSearchParams(window.location.search),i.get(this.conf.DEBUG_PARAMETER)&&(t=!0,this.conf.activeViewTime=this.conf.activeViewTimeDebug)),o=e.dom.$(this.conf.observeContainerSelector)[0],n=this.initIntersectionObserver(),s=this.initMutationObserver(o,n),this.startMutationObserving(s,o),this.updateObservedElements(o,n)):e.utils.log("[id.elAcViewTr.js] failed to find observeContainer. please check configuration!")}else e.utils.log("[id.elAcViewTr.js] this module needs a better browser!")},this.initIntersectionObserver=function(){return new window.IntersectionObserver(this.intersectionObserverCallback,{threshold:this.conf.activeViewArea})},this.intersectionObserverCallback=function(e){var t,i;for(t=0;e.length>t;t+=1)i=e[t],i.isIntersecting?i.target.observeData.startTimer():i.target.observeData.resetTimer()},this.initMutationObserver=function(t,n){return new window.MutationObserver(e.utils.debounce(function(){i.updateObservedElements(t,n)},900,!1))},this.startMutationObserving=function(e,t){e.observe(t,{childList:!0,subtree:!0})},this.updateObservedElements=function(t,o){var a,r=[],l=!1;if(e.dom.$("["+this.conf.ELEMENT_IDENTIFIER_DATA_ATTR+"]",t).each(function(t){i.arrayContains(s,t)||(r.push(t),i.arrayContains(n,t)?n=i.arrayRemoveElement(n,t):(t.observeData=new i.ObservedElementData(t,o),o.observe(t),e.utils.log("[id.elAcViewTr.js] starting to observe new element:",t),l=!0))}),n.length)for(a=0;n.length>a;a+=1)n[a].observeData.resetTimer(),o.unobserve(n[a]),e.utils.log("[id.elAcViewTr.js] stopping to observe removed element:",n[a]),l=!0;n=r,l&&e.utils.log("[id.elAcViewTr.js] updated list of observed elements:",n)},this.trackElementActiveView=function(t,o){var a;try{a=JSON.parse(t.getAttribute(this.conf.ELEMENT_IDENTIFIER_DATA_ATTR))}catch(r){e.utils.log("[id.elAcViewTr.js] ElementActiveViewTracking failed! Please make sure to have a valid json config in the dataAttribute")}a&&(a=this.transformTrackConfToValidPayload(a),Object.keys(a).length&&(e.utils.log("[id.elAcViewTr.js] TRACKING elementActiveView:",t,a),e.event.publish(e.event.constants.CUA.TRACK,[{event:"INTERACTION",index:"user-interaction",type:"element-active-view",payload:a}]))),o.unobserve(t),n=i.arrayRemoveElement(n,t),s.push(t),e.utils.log("[id.elAcViewTr.js] stopping to observe element:",t),e.utils.log("[id.elAcViewTr.js] updated list of observed elements:",n),e.utils.log("[id.elAcViewTr.js] updated list of finished elements:",s)},this.transformTrackConfToValidPayload=function(e){var t={};return e&&(e.experimentId&&(t.experimentId=e.experimentId),e.experimentVariantId&&(t.experimentVariantId=e.experimentVariantId),e.experimentRoundNr&&(t.experimentRoundNr=e.experimentRoundNr)),t},this.arrayContains=function(e,t){var i;for(i=0;e.length>i;i+=1)if(e[i]===t)return!0;return!1},this.arrayRemoveElement=function(e,t){return e.filter(function(e){return e!==t})}};return t});