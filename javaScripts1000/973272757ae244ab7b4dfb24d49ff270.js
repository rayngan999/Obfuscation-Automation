webshop.social=webshop.social||{};webshop.social.Facebook={currentStatus:null,currentAccessToken:null,attemptedLogin:false,openedWindows:[],openedLink:null,popup:null,elevatedLogin:false,initialised:false,fbInitTimedOut:false,fbTimeout:null,logRegAction:false,authAction:function(){jQ("#facebook_login_redirect_started").attr("value","true");window.location.reload();},init:function(){this.installFB();var FacebookEventSender=Marionette.Object.extend({initialize:function(){webshop.gtm.registerEventSource(this);}});this.facebookEventSender=new FacebookEventSender();},registerLikeUnlikeCallbacks:function(){var self=this;if(FB&&FB.Event&&FB.Event.subscribe){FB.Event.subscribe('edge.create',function(targetUrl){self.facebookEventSender.trigger("gtm:FacebookLiked",targetUrl);});FB.Event.subscribe('edge.remove',function(targetUrl){self.facebookEventSender.trigger("gtm:FacebookUnliked",targetUrl);});}},installFB:function(){window.fbAsyncInit=function(){var self=window.webshop.social.Facebook;FB.init({appId:getConfigProperty('FACEBOOK_APP_ID'),channelUrl:'http://'+document.domain+application.url+'/channel.html',cookie:document.domain,xfbml:false,version:'v2.12'});if(jQ('.fb-like').get(0)||jQ('.fb-like-box').get(0))FB.XFBML.parse();webshop.social.Facebook.registerLikeUnlikeCallbacks();FB.getLoginStatus(function(response){webshop.social.Facebook.initialised=true;webshop.social.Facebook.currentStatus=response.status;if(response.status==='connected'){webshop.social.Facebook.currentAccessToken=response.authResponse.accessToken;webshop.social.Facebook.updateExtendedAccessToken(response);}
FB.Event.subscribe('auth.authResponseChange',webshop.social.Facebook._authChange);jQ('body').on('click','.fb-login-button',function(evt){evt.preventDefault();if(webshop.config.Facebook.facebookEnabled==true){webshop.social.Facebook.authenticate();evt.preventDefault();self.facebookEventSender.trigger('gtm:uaEvent',{category:'Login',action:'fb-loginbutton-click'});}else{webshop.ajax.Util.postRedirect(webshop.social.Facebook.constructUrl('https://',':8443','/login.go?facebookFallBack=true'),{_csrf:jQ("meta[name='_csrf']").attr("content")});}});jQ('#facebook_login_button_ready').attr('value','true');if(webshop.social.Facebook.fbTimeout){clearTimeout(webshop.social.Facebook.fbTimeout);webshop.social.Facebook.fbTimeout=null;}
webshop.social.Facebook.toggleFacebookButton();jQ('a[href$="/webshop/logout.do"]').on('click',function(e){e.preventDefault();if(webshop.social.Facebook.currentStatus==='connected'){webshop.social.Facebook.isFacebookUserLoggedIn(response,function(loggedIn){if(loggedIn){FB.logout();}else{window.location.replace(window.location.origin+"/webshop/logout.do");}});}else{window.location.replace(window.location.origin+"/webshop/logout.do");}});jQ('#facebook_logout_button_ready').attr('value','true');},true);};var js,id='facebook-jssdk';var s='script';var fjs=document.getElementsByTagName(s)[0];js=document.createElement(s);js.id=id;js.src="//connect.facebook.net/en_GB/sdk.js";fjs.parentNode.insertBefore(js,fjs);realWindowOpen=window.open;window.open=function(url,name,params){if(params){var widthStrLength="width=".length;var widthIdx=params.indexOf("width=");var widthEndingIdx,realParamsWidthVal;if(widthIdx!=-1){widthEndingIdx=params.indexOf(",",widthIdx)!=-1?params.indexOf(",",widthIdx):params.length;realParamsWidthVal=params.substring(widthIdx+widthStrLength,widthEndingIdx);if(!parseInt(realParamsWidthVal)){realParamsWidthVal=300;}}else{realParamsWidthVal=300;}
var heightStrLength="height=".length;var heightIdx=params.indexOf("height=");var heightEndingIdx,realParamsHeightVal;if(heightIdx!=-1){heightEndingIdx=params.indexOf(",",heightIdx)!=-1?params.indexOf(",",heightIdx):params.length;realParamsHeightVal=params.substring(heightIdx+heightStrLength,heightEndingIdx);if(!parseInt(realParamsHeightVal)){realParamsHeightVal=500;}}else{realParamsHeightVal=500;}
var multiScreenLeft=window.screenLeft!=undefined?window.screenLeft:screen.left;var multiScreenTop=window.screenTop!=undefined?window.screenTop:screen.top;var width=window.innerWidth;if(!width){width=document.documentElement.clientWidth;if(!width){width=screen.width;}}
var height=window.innerHeight;if(!height){height=document.documentElement.clientHeight;if(!height){height=screen.height;}}
var left=((width/2)-(realParamsWidthVal/2))+multiScreenLeft;var top=((height/2)-(realParamsHeightVal/2))+multiScreenTop;params='scrollbars=yes, width='+realParamsWidthVal+', height='+realParamsHeightVal+', top='+top+', left='+left;}
var windowResult=realWindowOpen(url,name,params);if(window.focus){windowResult.focus();}
webshop.social.Facebook.openedWindows.push(windowResult);return windowResult;}},toggleFacebookButton:function(){webshop.social.Facebook.fbInitTimedOut=true;jQ('.fb-disableable-login-button').removeClass('disabled');jQ('.fb-login-button').removeClass('noVis');jQ('.fb-login-button-popup').removeClass('noVis');jQ('#fb-login-button-separator').removeClass('noVis');jQ('.fb-error-text').hide();},updateExtendedAccessToken:function(response){jQ.ajax({url:webshop.social.Facebook.constructUrl('https://',':8443','/updateFacebookAccessToken.go'),data:{'ajax':true,'accessToken':response.authResponse.accessToken,'fbuid':response.authResponse.userID},dataType:'jsonp'});},isFacebookUserLoggedIn:function(response,callback){jQ.ajax({url:webshop.social.Facebook.constructUrl('https://',':8443','/isFacebookUserLoggedIn.go'),data:{'ajax':true,'fbuid':response.authResponse.userID},dataType:'jsonp',success:function(data){if(data.isSameUser===true){callback(true);}else{callback(false);}}});},authenticate:function(){if(webshop.config.Facebook.facebookEnabled){if(webshop.social.Facebook.currentStatus==='connected'||webshop.social.Facebook.currentStatus==='not_authorized'){webshop.social.Facebook._reauthenticate();}else{FB.login(function(response){if(!response.authResponse){webshop.social.Facebook._closeFBPopup();}},{scope:webshop.config.fbPermissions});}}else{var facebookFallback=ocBackbone.popup.regAndLoginMultiton.get().facebookFallback;facebookFallback.fetch();facebookFallback.show();}},_closeFBPopup:function(){var openedWindow;while((openedWindow=webshop.social.Facebook.openedWindows.pop())!=null){openedWindow.close();}},_reauthenticate:function(){FB.login(function(response){if(response.authResponse===null||response.authResponse.accessToken===webshop.social.Facebook.currentAccessToken){webshop.social.Facebook._closeFBPopup();}else{if(webshop.config.loggedIn&&!webshop.config.fbLinkedAccount){webshop.social.Facebook._connectUser(response);}else{webshop.social.Facebook._identifyUser(response);}}},{scope:webshop.config.fbPermissions,auth_type:'reauthenticate'});},_authChange:function(response){webshop.social.Facebook._closeFBPopup();if(response.status!=webshop.social.Facebook.currentStatus||(response.status==='connected'&&webshop.social.Facebook.attemptedLogin)){webshop.social.Facebook.currentStatus=response.status;if(response.status==='connected'){webshop.social.Facebook.currentAccessToken=response.authResponse.accessToken;webshop.social.Facebook.attemptedLogin=true;if(webshop.config.loggedIn&&!webshop.config.fbLinkedAccount){webshop.social.Facebook._connectUser(response);}else{webshop.social.Facebook._identifyUser(response);}}else if(response.status==='not_authorized'&&webshop.config.loggedIn){webshop.social.Facebook.currentAccessToken=null;window.location='/webshop/logout.do';}else if(webshop.config.loggedIn){webshop.social.Facebook.currentAccessToken=null;window.location='/webshop/logout.do';}}},_identifyUser:function(response){var self=this;jQ('#warning').hide();jQ.ajax({url:webshop.social.Facebook.constructUrl('https://',':8443','/isFacebookUserRegistered.go'),data:{'ajax':true,'fbuid':response.authResponse.userID,'accessToken':response.authResponse.accessToken},dataType:'jsonp',success:function(data){var isRegistrationPage=jQ('#quickRegAcceptForm').length>0,loginUrl=webshop.social.Facebook.constructUrl('https://',':8443','/login.go'),isLinkingPayPal=!!window.payPalUserId;if(data.error){var redirectUrl=webshop.social.Facebook.constructUrl('http://',':8080','/error.do');webshop.ajax.Util.postRedirect(redirectUrl,{'errorMessage':data.message});}
else if(data.valid){jQ("#facebook_login_redirect_started").attr("value","true");if(isRegistrationPage){webshop.social.FacebookCallbacks.displayStartShoppingForm.call(this,loginUrl,response);}else{if(jQ('#loginConfirm').length){loginUrl=document.URL;}else if(isLinkingPayPal){loginUrl='/webshop/paypalLinkAccountAcceptForm.do?fromFacebook';}
webshop.ajax.Util.postRedirect(loginUrl,{'success_redirect':jQ('.js-facebook-login-success-redirect').val(),'fbuid':response.authResponse.userID,'accessToken':response.authResponse.accessToken,'signedRequest':response.authResponse.signedRequest,'token':jQ('#loginToken').val(),'loginToken':jQ('#loginToken').val(),'_csrf':jQ("meta[name='_csrf']").attr("content")});}
self.facebookEventSender.trigger('gtm:uaEvent',{category:'Login',action:'fb-loginsuccess-registered'});}else{jQ("#facebook_login_redirect_started").attr("value","true");if(isRegistrationPage&&!data.emailExists){webshop.social.Facebook.goToRegisterForm(response.authResponse.userID,response.authResponse.accessToken,response.authResponse.signedRequest);}else{webshop.social.Facebook.loadLinkAccountOverlay(data.emailExists,data.email,response.authResponse.userID,response.authResponse.accessToken,response.authResponse.signedRequest);}
self.facebookEventSender.trigger('gtm:uaEvent',{category:'Login',action:'fb-loginsuccess-nowregister'});}},error:function(jqXHR,textStatus,errorThrown){window.location=url;}});},_connectUser:function(response){jQ('#warning').hide();jQ.ajax({url:webshop.social.Facebook.constructUrl('https://',':8443','/linkFacebookAccountOverlay.go'),data:{'ajax':true,'fbuid':response.authResponse.userID,'signedRequest':response.authResponse.signedRequest,'accessToken':response.authResponse.accessToken,'token':jQ('#loginToken').val()},dataType:'jsonp',success:function(data){if(data.valid){jQ("#facebook_login_redirect_started").attr("value","true");webshop.social.Facebook.authAction();}else{webshop.social.FacebookCallbacks.displayAccountAlreadyLinkedWarning.call(this);}}});},loadLinkAccountOverlay:function(emailExists,email,fbuid,accessToken,signedRequest){var data={emailExists:emailExists,emailAddress:email,fbuid:fbuid,accessToken:accessToken,signedRequest:signedRequest};if(webshop.social.Facebook.logRegAction){var facebookLinkAccount=ocBackbone.popup.regAndLoginMultiton.get().facebookLinkAccount;facebookLinkAccount.show();facebookLinkAccount.post(data);}else{webshop.ajax.Util.postRedirect(webshop.social.Facebook.constructUrl('https://',':8443','/linkAccountDisplay.go'),data);}},goToRegisterForm:function(fbuid,accessToken,signedRequest){var data={fbuid:fbuid,accessToken:accessToken,signedRequest:signedRequest};if(webshop.social.Facebook.logRegAction){var facebookReg=ocBackbone.popup.regAndLoginMultiton.get().facebookReg;facebookReg.show();facebookReg.post(data);}else{webshop.ajax.Util.postRedirect(webshop.social.Facebook.constructUrl('https://',':8443','/facebookRegistration.do'),data);}},constructUrl:function(protocol,port,page){var url=protocol+document.domain;if(location.port=='8443'||location.port=='8444'){url+=':'+location.port;}
url+=application.url+page;return url;}};webshop.social=webshop.social||{};webshop.social.FacebookCallbacks={displayStartShoppingForm:function(loginUrl,response){var extraLink=jQ('#extraLink');jQ('#warning').show();jQ('#warningText').text(getMessage('register.quickReg.facebookAccountLinkedToWebshop'));var startShoppingLoginForm=Handlebars.templates['registration/facebook/startShoppingLoginFormDesktop']({loginUrl:loginUrl,authResponse:response.authResponse,loginToken:jQ('#loginToken').val(),_csrf:jQ("meta[name='_csrf']").attr("content")});if(extraLink.get(0)){extraLink.html('').append(startShoppingLoginForm);extraLink=undefined;}
jQ('span#separatorText').text(getMessage('register.quickReg.facebookSetUpSeparateAccount'));},displayAccountAlreadyLinkedWarning:function(){jQ('#warning').show();jQ('#warningText').text(getMessage('register.quickReg.facebookAccountLinkedToAnotherWebshop'));}}
webshop.social=webshop.social||{};webshop.social.FacebookLoginConfirm={init:function(){this.facebookLoginConfirmView=new this.FacebookLoginConfirmView();},FacebookLoginConfirmView:Backbone.View.extend({el:'.fb-confirm-login-button',events:{'click':'handleClick'},handleClick:function(evt){this._reauthenticate();evt.preventDefault();},_reauthenticate:function(){FB.login(function(response){if(response.authResponse!=null&&response.authResponse.accessToken!=webshop.social.Facebook.currentAccessToken){webshop.social.Facebook._identifyUser(response);}},{scope:webshop.config.fbPermissions,auth_type:'reauthenticate'});this.trigger('gtm:uaEvent',{category:'Login',action:'fb-login-reauth'});}})};webshop.social=webshop.social||{};webshop.social.InviteFriend={init:function(){jQ('#fbsendmessage').on("click",function(evt){webshop.social.InviteFriend.sendAInvite();evt.preventDefault();});},sendAInvite:function(){FB.ui({method:'send',link:jQ('#sendLink').val()},function(response){if(response){webshop.social.InviteFriend.logRecordOfInvite();window.location.reload();}
else{}});},logRecordOfInvite:function(){var token_rand=jQ('#token_rand').val();jQ.ajax({url:'/webshop/sendRefereeMail.do',data:{'ajax':true,'type':'facebook','token':token_rand}});}};webshop.social=webshop.social||{};webshop.social.PayPalCallbacks={returnPayPalLoginAction:function(paypalRedirectURL){var facebookLinkAccountPopupModel=ocBackbone.popup.regAndLoginMultiton.get().facebookLinkAccount,elevatedLoginPopup=ocBackbone.popup.elevatedAuthenticationSingleton.get();if(facebookLinkAccountPopupModel.isDisplayed()){facebookLinkAccountPopupModel.linkToPPReturnHandler(paypalRedirectURL);}else if(elevatedLoginPopup.isDisplayed()){elevatedLoginPopup.ppLoginReturnHandler(paypalRedirectURL);}else{var redirectUrl=webshop.ajax.Util.addNewParameters(paypalRedirectURL,["fromNonResponsivePage"],["true"]);var successRedirectUrl=jQ('.js-paypal-login-success-redirect').val();if(redirectUrl.indexOf('/webshop/login.go')!==-1&&redirectUrl.indexOf('success_redirect=')===-1&&successRedirectUrl){redirectUrl=webshop.ajax.Util.addNewParameters(redirectUrl,["success_redirect"],[successRedirectUrl]);}
window.location.href=redirectUrl;}}};