define(['jquery','module.base','session','web/modules/country_selection'],function($,Module,_session,country_selection){Module.Profiled=(function(){var self=this,navUrlsArry=[],_page_profile={placecode:null,postalcode:null,gridindex:null,climcode:null,seo_url:null,county_code:null,location_type:null};self.init=function(){var page_url=self.getPageUrl();self.loadPageProfile();self._saveLocation();if((pelm_util.browser.isIE8()==true||pelm_util.browser.isIE9()==true)&&(page_url.indexOf('attractions')!=-1||page_url.indexOf(window._config.url_golf)!=-1))
{window.setIE8Links=function(){if(typeof window.alt_placecode!="undefined"||typeof window.issetalt_placecode!="undefined"){self.bindProfileElements();}
else
{setTimeout(setIE8Links,500);}};var setIELinks=function(){setIE8Links();};setIELinks();}
else
{self.bindProfileElements();}};self.isProfiled=function(){self.loadPageProfile();if(typeof _page_profile.placecode!="undefined"&&_page_profile.placecode!=null){return true;}
return false;};self.loadPageProfile=function(){if(typeof window._uf!="undefined"){_page_profile.placecode=window._uf.p;_page_profile.seo_url=window._uf.u;if(typeof window._uf.c!='undefined'){_page_profile.country_code=window._uf.c;}}else if(typeof window.placecode!="undefined"&&window.placecode!=null){_page_profile.placecode=window.placecode;}
if(typeof window.postalcode!="undefined"&&window.postalcode!=null){_page_profile.postalcode=window.postalcode;}
if(typeof window.gridindex!="undefined"&&window.gridindex!=null){_page_profile.gridindex=window.gridindex;}
if(typeof window._config.clim_code!="undefined"&&window._config.clim_code!=null){_page_profile.climcode=window._config.clim_code;}
if(typeof window._config.location_type!="undefined"&&window._config.location_type!=null){_page_profile.location_type=window._config.location_type;}};self.getPageProfile=function(){return _page_profile;};self._getLocation=function(){if(typeof _session.fld('pelm_lastloc')=="undefined"){return null;}
var data=null;data=$.parseJSON(_session.fld('pelm_lastloc'));return data;};self._saveLocation=function(){var page_url=self.getPageUrl();if(_page_profile.placecode!=null){var last_location=self._getLocation();var pc=_page_profile.placecode;if(pc.length>=4&&pc.length<9){var run_update=true;if(last_location!=null&&last_location.placecode==_page_profile.placecode){if(last_location.postalcode!=null||last_location.gridindex!=null){if(typeof window.ajax_weather!='undefined'&&window.ajax_weather==true){run_update=true;}else{run_update=false;}}else{run_update=false;}}
if(typeof JSON!=='undefined'&&run_update==true&&page_url.indexOf('ski')==-1&&page_url.indexOf('airport-forecast')==-1&&page_url.indexOf('aeroports')==-1&&page_url.indexOf(window._config.url_golf)==-1&&page_url.indexOf(window._config.url_cottage)==-1&&page_url.indexOf(window._config.url_camping)==-1&&page_url.indexOf(window._config.url_beaches)==-1){_session.save_cookie('pelm_lastloc',JSON.stringify(_page_profile));}}}};self.lookup=function(){$.get(window.url_countrycode+'/api/locate/city',{'placecode':_page_profile.placecode}).done(function(data){});};self.isAlsoPagePointcast=function(page){var result=false;if(page){if(page.postalcode){last_location=self._getLocation();if(page._uf){if(page._uf.p==last_location.placecode){result=true;}}}}
return result;}
self.getPageUrl=function(){var page_url='';if(typeof window.url_page.url!="undefined"&&window.url_page.url!=null){page_url=window.url_page.url;}
return page_url;};self.getPath=function(){return location.pathname;};self.updateLink14Day=function(link){var $link;if($(link).length){$link=$(link)[0];}
if($link){if((self.getPath().replace(/\/$/g,'').indexOf('\/weather\/')!==-1||self.getPath().replace(/\/$/g,'').indexOf('\/meteo\/')!==-1)&&($link.href.replace(/\/$/g,'').indexOf('\/14-day-weather-trend\/')!==-1||$link.href.replace(/\/$/g,'').indexOf('\/tendance-meteo-14-jours\/')!==-1)){if($link.href.replace(/\/$/g,'').indexOf('from7day=1')===-1){var seperator=$link.href.replace(/\/$/g,'').indexOf('?')!==-1?"&":"?";$link.setAttribute('href',$link.href.replace(window.location.origin,'')+seperator+'from7day=1');}}}};self.updateLinkAlertredirect=function(link){var $link;if($(link).length){$link=$(link)[0];$link.href=$link.href.replace(window.location.origin,'');}
if($link){if((self.getPath().replace(/\/$/g,'').indexOf('\/alerts\/high-alert\/')!==-1||self.getPath().replace(/\/$/g,'').indexOf('\/alertes\/high-alerte\/')!==-1)){var date=new Date();$link.href=$link.href+($link.href.indexOf('?')==-1?'?':'&')+'no_alert_redirect='+date.getFullYear()+'-'+(date.getMonth()+1)+'-'+date.getDate();$link.setAttribute('href',$link.href.replace(window.location.origin,'')+($link.href.indexOf('?')==-1?'?':'&')+'no_alert_redirect='+date.getFullYear()+'-'+(date.getMonth()+1)+'-'+date.getDate());}}};self.updateLinkHighlight=function(link){var $link;if($(link).length){$link=$(link);}
if($link){if($link.attr('href')==self.getPath().replace(/\/$/g,'')){$link.parent().addClass('active');}}};self.bindProfileElements=function(){var last_location=self._getLocation();var page_url=self.getPageUrl();$(".profiled_country a").each(function(){var link_url=$(this).attr('href');if(last_location!=null&&typeof last_location.country_code!='undefined'){if(link_url.substr(-1)=='/'){link_url=link_url.substr(0,link_url.length-1);}
link_url=country_selection.stripCountryCodeUrl(link_url);link_url='/'+last_location.country_code+link_url;$(this).attr('href',link_url);}});$(".profiled_country_user a").each(function(){var link_url=$(this).attr('href');var saved_user_countrycode=country_selection.getSavedCountryCode();if(saved_user_countrycode&&saved_user_countrycode!='ca'){link_url=country_selection.addSavedCountryCodeUrl(link_url);$(this).attr('href',link_url);}});$(".profiled_location a"+(self.isAlsoPagePointcast(window)?',.profiled_locations a':'')).each(function(){var title=$(this).attr('title');var link_url=$(this).attr('href');var makeAttractionListUrl=false;var location_type=(typeof last_location!='undefined'&&last_location!=null&&typeof last_location.location_type!='undefined'?last_location.location_type:'');if(typeof window.alt_placecode!="undefined"&&window.alt_placecode!=''&&page_url.indexOf('attractions')!=-1)
{makeAttractionListUrl=false;}
else if((typeof window.alt_placecode=="undefined"||window.alt_placecode=='')&&page_url.indexOf('attractions')!=-1)
{makeAttractionListUrl=true;}
if((last_location!=null&&link_url.indexOf('/ski')==-1&&link_url.indexOf('golf')==-1&&link_url.indexOf('cottage')==-1&&link_url.indexOf('chalet')==-1&&link_url.indexOf('camping')==-1&&link_url.indexOf('beaches')==-1&&link_url.indexOf('plages')==-1)&&makeAttractionListUrl==false&&(title!='Severe Weather Outlook'||location_type=='city'))
{if((page_url.indexOf('attractions')!=-1||page_url.indexOf(window._config.url_golf)!=-1)&&typeof window.alt_placecode!="undefined")
{last_location.placecode=window.alt_placecode;}
else if(typeof last_location.seo_url!="undefined"&&last_location.seo_url!=null){if(typeof window._config.friendly_city_urls!="undefined"&&window._config.friendly_city_urls!=false){if($(this).parent().hasClass('statistics')==true){last_location.placecode=last_location.climcode+'/'+last_location.placecode;}else{last_location.placecode=last_location.seo_url;}}}
if(last_location!=null&&typeof last_location.country_code!='undefined'){if(link_url.substr(-1)=='/'){link_url=link_url.substr(0,link_url.length-1);}
link_url=country_selection.stripCountryCodeUrl(link_url);link_url='/'+last_location.country_code+link_url;}
if($(this).parent().hasClass('country_ca')&&last_location.placecode.indexOf('canada')==-1){return;}
var replace_match=link_url.match(/list$/g);if(replace_match!=null&&replace_match.length){link_url=link_url.replace("list",last_location.seo_url);}else{if(!$(this).hasClass('trends_tab_link')){if(link_url.substr(-1)=='/'){link_url=link_url.substr(0,link_url.length-1);}
if(link_url.indexOf(last_location.seo_url)==-1){link_url=link_url+'/'+last_location.seo_url;}}}
if($(this).parent().hasClass('pointcast_link')){if(typeof last_location.postalcode!="undefined"&&last_location.postalcode!=null){link_url=link_url+'/'+last_location.postalcode;}
if(typeof last_location.gridindex!="undefined"&&last_location.gridindex!=null){link_url=link_url+'/'+last_location.gridindex;}}}else{var ip_data=_session.fld('pelm_ip');if(ip_data!=null){try{ip_data=$.parseJSON(ip_data);}catch(ex){ip_data=null;}
if(ip_data!=null&&typeof ip_data.prov!="undefined"&&ip_data.prov&&typeof ip_data.country!="undefined"&&ip_data.country){var country_code=ip_data.country.toLowerCase();var prov_code=ip_data.prov.toLowerCase();if(country_code!=""&&prov_code!=""&&country_code.length==2&&prov_code.length==2){if($(this).parent().hasClass('country_ca')&&country_code!="ca"){return;}
if(country_code!="us"&&country_code!="ca"){country_code="intl";prov_code="";}
if(link_url.substr(-1)=='/'){link_url=link_url.substr(0,link_url.length-1);}
if(link_url=='/alerts'){link_url=link_url+'/'+country_code+'/'+prov_code;}else{link_url=link_url+'/'+country_code+prov_code+'/all';}}}}}
if(link_url.match(/alerts/g)!==null){if(window.url_countrycode!==undefined){link_url=window.url_countrycode+'/alerts';}}
if(link_url==='/uk/alerts'){link_url=window.url_countrycode+'/news';}
navUrlsArry.push(link_url);$(this).attr('href',link_url);});$(".profiled_locations a, .profiled_location a").each(function(){if($(this).hasClass('trends_tab_link')){self.updateLink14Day($(this));self.updateLinkAlertredirect($(this));self.updateLinkHighlight($(this));}});$('.explore').each(function(){if($(this).children('a').length!=0){var last_Location=self._getLocation();var link_URL=$(this).children('#exploreurl').attr('href');var nonprofiled_match=link_URL.match(/explore/g);if(last_Location!=null){if(typeof last_Location.seo_url!="undefined"&&last_Location.seo_url!=null){if(typeof window._config.friendly_city_urls!="undefined"&&window._config.friendly_city_urls!=false){if($(this).parent().hasClass('statistics')==true){last_Location.placecode=last_Location.climcode+'/'+last_Location.placecode;}else{last_Location.placecode=last_Location.seo_url;}}}
var replace_match=link_URL.match(/list/g);if(nonprofiled_match==null){if(replace_match!=null&&replace_match.length){link_URL=link_URL.replace("list",last_Location.placecode);}else{if(link_URL.substr(-1)=='/'){link_URL=link_URL.substr(0,link_URL.length-1);}
link_URL=link_URL+'/'+last_Location.placecode;}}else{link_URL=link_URL.replace("/explore",'');}}else{var ip_data=_session.fld('pelm_ip');if(ip_data!=null){ip_data=$.parseJSON(ip_data);if(ip_data!=null&&typeof ip_data.prov!="undefined"&&typeof ip_data.country!="undefined"){var country_code=ip_data.country.toLowerCase();var prov_code=ip_data.prov.toLowerCase();if(country_code!=""&&prov_code!=""&&country_code.length==2&&prov_code.length==2){if($(this).parent().hasClass('country_ca')&&country_code!="ca"){return;}
if(country_code!="us"&&country_code!="ca"){country_code="intl";prov_code="";}
if(link_URL.substr(-1)=='/'){link_URL=link_URL.substr(0,link_URL.length-1);}
if(nonprofiled_match!=null&&nonprofiled_match.length){link_URL=link_URL.replace("/explore",'');}else{link_URL=link_URL+'/'+country_code+prov_code+'/all';}}}}}
$(this).children('a').attr('href',link_URL);$(this).children('h3').children('a').attr('href',link_URL);}});};});return Module.factory('Profiled');});;