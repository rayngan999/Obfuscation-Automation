webshop.search=webshop.search||{};var searchWrapper=jQ('#searchWrapper'),multiSearchWrapper=jQ('.searchTerms'),searchInput=jQ('#findText'),entryForm=multiSearchWrapper.find('#multiSearchForm'),resultsBox=multiSearchWrapper.find('#searchNavResults'),cancelButton=multiSearchWrapper.find('.cancelButton');webshop.search.SearchBox={init:function(){this.virtualPageViewsSender=new ocBackbone.gtm.GTMVirtualPageviewEventSender();this.url=window.location.href;this.setMultisearchJs();this.setButtons();this.addFormSubmitAnalytics();this.addGAVirtualPageUrl();this.preventEmptyValueSubmit();if(this.url.match(/([Rr]ecipe)/g)!==null){searchInput.attr('placeholder','Find a recipe');}},setMultisearchJs:function(){multiSearchWrapper.find("input[name=multiSearchButton]").val("js");multiSearchWrapper.find("#backToCombined").show();},setButtons:function(){var entryTextarea=entryForm.find('textarea');multiSearchWrapper.on('click','#editSearchList',function(e){webshop.search.SearchBox.addPageEventAnalytics('MULTI_SEARCH_EDIT_LIST_CLICKED');var currentItems=resultsBox.find('#resultsWrapper a'),parsedItems="";e.preventDefault();for(var i=0;i<=(currentItems.length-1);i++){parsedItems+=jQ(currentItems[i]).text()+'\n';}
entryTextarea.removeClass("hasPlaceholder");entryTextarea.val(parsedItems);resultsBox.hide();entryForm.show();});multiSearchWrapper.on('click','#clearSearchList',function(e){webshop.search.SearchBox.addPageEventAnalytics('MULTI_SEARCH_CLEAR_LIST_CLICKED');e.preventDefault();entryTextarea.val('');resultsBox.hide();entryForm.show();});},preventEmptyValueSubmit:function(){searchWrapper.on('submit','.suggestionsForm',function(e){if(!searchWrapper.find('.navSearchTxt').val()){e.preventDefault();}});},addFormSubmitAnalytics:function(){multiSearchWrapper.on('submit','#multiSearchForm',function(e){webshop.search.SearchBox.addPageEventAnalytics('MULTI_SEARCH_FORM_SUBMIT');});},addPageEventAnalytics:function(pageEventType){jQ.get('/webshop/createPageEvent.do',{ajax:true,pageEventType:pageEventType,pageViewId:webshop.analytics.pageViewId});},addGAVirtualPageUrl:function(){if(webshop.search.SearchBox.url.indexOf("MultiSearch")>-1){var virtualPagePath="/multi-search?entry=",currentItems=resultsBox.find('#resultsWrapper a'),itemsArray=new Array();for(var i=0;i<=(currentItems.length-1);i++){itemsArray.push(jQ(currentItems[i]).text());}
virtualPagePath=virtualPagePath+itemsArray.join("+");webshop.search.SearchBox.virtualPageViewsSender.send(virtualPagePath);}}};webshop.search=webshop.search||{};webshop.search.autoCompleteFill={el:jQ('.suggestionsForm'),init:function(){jQ.extend(this,{responseContainer:this.el.find('.searchSuggestions'),searchBox:this.el.find('#findText'),resultsList:this.el.find('#suggestions'),closeBtn:this.el.find('.closeResults'),placeholder:jQ('.placeholder'),chosenSuggestionPosition:jQ('#chosenSuggestionPosition'),isAutocompleteDisabled:this.el.find('#isAutocompleteDisabled'),closeSuggestionsOnClickSelectors:'body',prominentSearchForm:jQ('#searchWrapper.prominentSearchWrapper'),});this.bindEventHandlers();},bindEventHandlers:function(){var self=this;if(webshop.userData.betaFeatures['NEXT_SEARCH_SUGGESTIONS']){this.searchBox.on('focus',this.nextSearchTerms)}
if(this.isAutocompleteDisabled.val()!=='true'){this.searchBox.on('keyup',this.autocomplete);}
if(webshop.userData.betaFeatures['ACQUISITION_24186_MORE_PROMINENT_SEARCH']){this.searchBox.on('focus',this.setFormActive);this.searchBox.on('blur',this.setFormInactive);}
jQ('#searchWrapper').on('keydown',this.formAutoSubmit);this.searchBox.on('click',function(e){e.stopPropagation();});this.resultsList.on('click','li',function(){if(self.searchBox.val()==""){jQ.get('/webshop/createPageEvent.do',{ajax:true,pageEventType:'RELATED_SEARCH_SUGGESTION_SELECTED',pageViewId:webshop.analytics.pageViewId,SEARCH_TERM:jQ(this).text(),CHOSEN_SUGGESTION_POSITION:jQ(this).val()});}
self.searchBox.val(jQ(this).text());self.chosenSuggestionPosition.val(jQ(this).val());self.el.submit();});this.resultsList.on('mouseenter','li',function(){self.resultsList.find('.selected').removeAttr('class');jQ(this).addClass('selected');});this.resultsList.on('mouseleave','li',function(){jQ(this).removeAttr('class');self.chosenSuggestionPosition.val('');});this.el.on('click','.closeResults',function(){self.responseContainer.hide();});},nextSearchTerms:function(){var self=webshop.search.autoCompleteFill,typedValue=self.searchBox.val();if(typedValue.length==0){webshop.search.render.parseJSON('',[self.placeholder,self.resultsList],self.animatePanel);}},autocomplete:function(evt){var self=webshop.search.autoCompleteFill,typedValue=self.searchBox.val();if(typedValue.length>1&&evt.keyCode!=27){if(evt.keyCode!=13&&evt.keyCode!=38&&evt.keyCode!=40&&evt.keyCode!=37&&evt.keyCode!=39){webshop.search.render.parseJSON(typedValue.toLowerCase(),[self.placeholder,self.resultsList],self.animatePanel);self.chosenSuggestionPosition.val('');self.stateSet=false;}}
else{self.responseContainer.hide();self.resultsList.html('');}},animatePanel:function(jsonResponse){var self=webshop.search.autoCompleteFill,sku=self.el.find('.placeholder .product'),brand=self.el.find('.placeholder .brand'),results=self.el.find('.results'),brandTitle=self.el.find('.brandTitle'),productTitle=self.el.find('.skuTitle');if((brand.length==1||sku.length==1)&&!self.stateSet){results.addClass('singlePremium').removeClass('doublePremium');self.closeBtn.hide();}else if(brand.length>1||sku.length>1){results.addClass('doublePremium').removeClass('singlePremium');self.closeBtn.show();self.stateSet=true;}
if(!brand.length&&!sku.length){self.closeBtn.hide();}
(brand.length>0)?brandTitle.css('display','block'):brandTitle.css('display','none');(sku.length>0)?productTitle.css('display','block'):productTitle.css('display','none');(jsonResponse.d.length===0)?self.hidePanel():self.showResponseContainer();},formAutoSubmit:function(evt){var self=webshop.search.autoCompleteFill,currentElement=self.resultsList.find('.selected');if(self.resultsList.find('li').length>0){self.showResponseContainer();self.resultsList.find('li').removeAttr('class');}
if(evt.keyCode===38){currentElement=(currentElement.length>0&&currentElement.index()!=0)?currentElement.prev():self.resultsList.find('li:last');currentElement.addClass('selected');self.searchBox.val(currentElement.text());self.chosenSuggestionPosition.val(currentElement.val());}else if(evt.keyCode===40){currentElement=(currentElement.length>0&&(currentElement.index()+1)!=self.resultsList.find('li').length)?currentElement.next():self.resultsList.find('li:first');currentElement.addClass('selected');self.searchBox.val(currentElement.text());self.chosenSuggestionPosition.val(currentElement.val());}},showResponseContainer:function(){if(this.resultsList.is(':hidden')){this.responseContainer.show();jQ(this.closeSuggestionsOnClickSelectors).one('click.autoSearch',this.hidePanelEvent);}},hidePanel:function(){var self=webshop.search.autoCompleteFill;if(self.resultsList.is(':visible')){self.responseContainer.hide();self.resultsList.html('');self.placeholder.html('');jQ(this.closeSuggestionsOnClickSelectors).off('click.autoSearch',self.hidePanelEvent);}},hidePanelEvent:function(){webshop.search.autoCompleteFill.hidePanel();},setFormActive:function(){webshop.search.autoCompleteFill.prominentSearchForm.addClass('active');},setFormInactive:function(){webshop.search.autoCompleteFill.prominentSearchForm.removeClass('active');}};webshop.search=webshop.search||{};webshop.search.render={config:{url:'/webshop/getSearchSuggestions.do?entry=',responseContainer:jQ('.searchSuggestions'),suggestion:jQ('#suggestions'),isAutocompleteDisabled:jQ('#isAutocompleteDisabled')},cache:{},parseJSON:function(query,elementArray,callback){var render=webshop.search.render;if(render.config.isAutocompleteDisabled.val()!=='true'){jQ.getJSON(this.config.url+encodeURIComponent(query)+'&ajax=true',function(data){render.cache.jsonResponse=data;handleObj(data,query,callback);});}
function handleObj(data,q,callback){var len=data.d.length,re=new RegExp(q,'g'),smart=jQ('#smartTrolley');render.cache.jsonResponse=data;if(elementArray){reload(elementArray);}
for(var i=0;i<len;i++){if(data.d[i].id.toLowerCase().search(re)!=-1){data.d[i].id=data.d[i].id.toLowerCase().replace(re,'<strong>'+q+'</strong>');}
render.config.suggestion.append('<li value="'+i+'">'+data.d[i].id+'</li>');}
if(!smart.length){render.splitObj(data,callback);}
len?render.config.responseContainer.show():render.config.responseContainer.hide();}
function reload(elementArray){var len=elementArray.length;for(var i=0;i<len;i++){elementArray[i].html('');}}},splitObj:function(json,callback){for(var str in json.d[0]){var obj=json.d[0][str];if(typeof obj==='object'){this.render(obj,str,callback);}else{jQ('.results').removeClass('doublePremium').removeClass('singlePremium');}}
if(!json.d[0]){callback.call(this,this.cache.jsonResponse);}},render:function(obj,str,callback){var template;var key;var re;var templateRe=new RegExp('{{[a-zA-Z\-\_]*}}','g');for(var i=0;i<obj.length;i++){try{var placeholder=jQ('#placeholder-'+str);if(obj[i].nit>0){template=document.getElementById('alt-template-'+str).innerHTML;}else{template=document.getElementById('template-'+str).innerHTML;}
for(key in obj[i]){re=new RegExp('{{'+key+'}}','g');template=template.replace(re,obj[i][key]);}
template=template.replace(templateRe,'');placeholder.append(template);callback.call(this,this.cache.jsonResponse);}catch(err){console.log(err);}}
if(obj.length===0){callback.call(this,this.cache.jsonResponse);}}};