define(['jquery','session','localization/copy','web/modules/country_selection','web/modules/signin'],function($,_session,copy,country_selection,signin){var User=(function(){var self=this,_cookies={'uup_auth':'pelm_a','uup_auth_temp':'pelm_a_temp','uup_auth_refresh':'pelm_a_ref','uup_last_refresh':'pelm_a_last_ref','lr_auth':'pelm_lr','fm_auth':'SABRE_ID','fm_info':'fmugcuserinfo','uup_locs':'pelm_mylocations_uup','social_user':'pelm_social_user','ip':'pelm_ip'},_form_msg_id='#form_message',_get_domain=function(){var wdomain=null,thost=window.location.host,xarr=thost.split(".");if(thost.indexOf('.dqs')>-1){wdomain=xarr[2];}else{wdomain=xarr[1];}
return'.'+wdomain+'.com';},dmStr=_get_domain(),fm_session_hours=(typeof window._config.fm_session_hours!='undefined')?parseInt(window._config.fm_session_hours):24,fm_cookie_days=(typeof window._config.fm_cookie_days!='undefined')?parseInt(window._config.fm_cookie_days):30,fm_cookie_days_persistent=(typeof window._config.fm_cookie_days_persistent!='undefined')?parseInt(window._config.fm_cookie_days_persistent):365,c_exp=fm_cookie_days,_refresh_required=function(){if(_session.fld(_cookies.uup_auth)&&_session.fld(_cookies.fm_auth)&&!_session.fld(_cookies.uup_auth_refresh)){return false;}
if(_session.fld(_cookies.uup_auth_refresh)&&_session.fld(_cookies.uup_last_refresh)&&_session.fld(_cookies.uup_auth)&&_session.fld(_cookies.fm_auth)){var last_refresh_time=_session.fld(_cookies.uup_last_refresh),diff_hours=0,cur_time=new Date().getTime();if(last_refresh_time){diff_hours=Math.floor(Math.abs(cur_time-parseInt(last_refresh_time))/(60*60*1000));}
if(diff_hours>1||!last_refresh_time){return true;}
return false;}
return true;};self.redirect_my_profile=function(){if(window._user_tracking.is_eu_user()&&!window._user_tracking.consent_accepted()){if(typeof window.gdpr_enabled_timestamp!='undefined'){window.location.href=copy.page_url.url_my_profile;}}}
self.is_logged_in=function(){if(_session.fld(_cookies.uup_auth)&&_session.fld(_cookies.fm_auth)){if(window.location.pathname.indexOf(copy.page_url.url_my_account)==-1&&window._user_tracking.can_be_tracked()===false){self.sign_out();return false;}
return true;}
return false;};self.redirect_page=function(){var redirect_url=[copy.page_url.url_myaccount_edit_locations,copy.page_url.url_my_alerts,copy.page_url.url_upload];for(var i=0;i<redirect_url.length;i++){if(window.location.pathname.indexOf(redirect_url[i])!==-1){if(self.is_logged_in()===true){self.redirect_my_profile();return;}}}}
self.redirect_page();self.is_social_user=function(){return _session.fld(_cookies.social_user)&&_session.fld(_cookies.social_user)?true:false;};self.sign_out=function(){$.each(_cookies,function(k,v){_session.delete_cookie(v,"/",dmStr);});_session.delete_cookie(".AspNet.ApplicationCookie","/",dmStr);_session.delete_cookie("pelm_last_product","/",dmStr);if(typeof signin.refreshLabel=='function'){signin.refreshLabel();}
if(window._config.viafoura_flag&&window.viafoura&&window.viafoura.session){window.viafoura.session.logout();}
var s=document.createElement("script"),lr_sso_url=window._config.lr_sso_url||'';;s.src=lr_sso_url+'/ssologin/logout';document.body.appendChild(s);};self.delete_temp=function(){_session.delete_cookie(_cookies.uup_auth_temp,"/",dmStr);};self.gap_track_sign_in=function(){var platformLbl=window._config.platform=='web'?'desktopWeb':'mobileWeb';dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':"clicks",'eventLabel':"signIn | "+platformLbl});};self.sign_in=function(d){d=d||{};if(_session.fld('remember_user')=='true'||(typeof d.remember_me!='undefined'&&d.remember_me==true)){c_exp=fm_cookie_days_persistent;}
self.update_token(d.token,null);self.update_token_refresh(d.refreshtoken||d.token);self.update_fm_id(d.sabre_id);self.update_fm_userinfo(JSON.stringify(d.sabre_id+'||'+d.fmid+'|'+d.firstname));self.update_locations(d.locations);self.update_lr_auth(true);require(['web/modules/mylocations'],function(mylocations){mylocations.reLoadLocationsOnce();setTimeout(function(){if(!mylocations.getLocations()){self.transfer_locations_to_uup();}},750);});self.gap_track_sign_in();var gap_g=d.gender?d.gender.toLowerCase():'';__.m_sensitive("pelm_ga_g",gap_g);var gap_b=d.birthyear?d.birthyear:'';__.m_sensitive("pelm_ga_yob",gap_b);_session.save_localstorage('pelm_reg','yes');var gap_ug=d.userguid?d.userguid:'';_session.save_cookie('pelm_ga_ug',gap_ug);self.set_last_refresh_time();var s=document.createElement("script"),lr_sso_url=window._config.lr_sso_url||'';;s.src=lr_sso_url+'/ssologin/setToken?token='+d.token+'&apikey='+(window._config.lr_api_key||'');document.body.appendChild(s);if(window.opener&&window.opener.location){try{window.opener.location.reload();}catch(err){}}
try{self.set_cnp_cookie();}catch(err){}};self.update_token=function(token){if(token){_session.save_cookie_dm(_cookies.uup_auth,token,c_exp,'/',null,dmStr);}};self.update_token_temp=function(token){if(token){_session.save_cookie_dm(_cookies.uup_auth_temp,token,c_exp,'/',null,dmStr);}};self.update_lr_auth=function(val){_session.save_cookie_dm(_cookies.lr_auth,val,c_exp,'/',null,dmStr);};self.set_social_user=function(opt){_session.save_cookie_dm(_cookies.social_user,opt,c_exp,'/',null,dmStr);};self.get_token=function(){return _session.fld(_cookies.uup_auth);};self.get_token_temp=function(){return _session.fld(_cookies.uup_auth_temp);};self.update_token_refresh=function(token_refresh){if(token_refresh){_session.save_cookie_dm(_cookies.uup_auth_refresh,token_refresh,c_exp,'/',null,dmStr);}};self.update_fm_id=function(sabre_id){if(sabre_id){_session.save_cookie_dm(_cookies.fm_auth,sabre_id,c_exp,'/',null,dmStr);}};self.update_fm_userinfo=function(userinfo){if(userinfo){_session.save_cookie_dm(_cookies.fm_info,encodeURIComponent(userinfo),c_exp,'/',null,dmStr);}};self.update_locations=function(locations){if(locations&&locations!='[]'&&locations!=[]){if(typeof locations=="object"){locations=JSON.stringify(locations);}
try{locations=encodeURIComponent(locations);}catch(e){}
window._stored_locations=[];_session.save_cookie_dm(_cookies.uup_locs,locations,c_exp,null,null,dmStr);}};self.save_consent=function(accepted){if(window._user_tracking&&!window._user_tracking.is_eu_user()){return;}
var api_url='/api/myaccountlr/save_consent?u='+window.twn.getGuid()+'&a='+(accepted=!accepted?0:1);if(self.is_logged_in()===true){api_url+='&t='+self.get_token();}
if(typeof window._config.platform!='undefined'){api_url+='&p='+window._config.platform;}
__.a(api_url,function(){__.m('pelm_consent_saved',new Date().getTime(),5000);});};self.set_last_refresh_time=function(){_session.save_cookie_dm(_cookies.uup_last_refresh,(new Date().getTime()),c_exp,'/',null,dmStr);};self.refresh_token=function(callback){return __.a('/api/myaccountlr/auth_refresh',function(data){try{if(typeof data=='string'){data=$.parseJSON(data);}}catch(err){}
if(!data||typeof data.error!='undefined'||typeof data.token=='undefined'||data.token==''){window.token_refreshed=false;callback(false);return false;}
self.update_token(data.token);self.update_token_refresh(data.refreshtoken);self.set_last_refresh_time();window.token_refreshed=true;if(callback){callback(true);}});};self.fm_session_auth=function(){if(typeof window._config.fm_session_auth_enabled!='undefined'&&window._config.fm_session_auth_enabled==false){return false;}
var fminfo=_session.fld('fmugcuserinfo'),user_id="",last_auth=_session.fld('fm_last_auth'),sabre_id=_session.fld('SABRE_ID'),cur_date="",last_auth_date="",diff_hours=0,remb_user=_session.fld('remember_user'),fm_session_hours=(typeof window._config.fm_session_hours!='undefined')?parseInt(window._config.fm_session_hours):24,fm_cookie_days=(typeof window._config.fm_cookie_days!='undefined')?parseInt(window._config.fm_cookie_days):30,fm_cookie_days_persistent=(typeof window._config.fm_cookie_days_persistent!='undefined')?parseInt(window._config.fm_cookie_days_persistent):365;if(!fminfo||!sabre_id){return false;}
fminfo=fminfo.split('|');if(fminfo.length==3&&typeof fminfo[1]!="undefined"){user_id=parseInt(fminfo[1]);}
else if(fminfo.length==4&&typeof fminfo[2]!="undefined"){user_id=parseInt(fminfo[2]);}
if(!user_id){return false;}
if(last_auth){cur_date=new Date().getTime();last_auth=parseInt(last_auth);last_auth_date=new Date(last_auth).getTime();diff_hours=Math.floor(Math.abs(cur_date-last_auth_date)/(60*60*1000));}
if(!last_auth||diff_hours>=fm_session_hours){__.a('/api/filemob/get_session_token?u='+user_id,function(data){if(!data){return;}
var wdomain=null;var thost=window.location.host;var xarr=thost.split(".");if(thost.indexOf('.dqs')>-1){wdomain=xarr[2];}else{wdomain=xarr[1];}
var dmStr='.'+wdomain+'.com'
var c_exp=fm_cookie_days;if(remb_user=='true'){c_exp=fm_cookie_days_persistent;}
_session.save_cookie_dm('SABRE_ID',data,c_exp,null,null,dmStr);_session.save_cookie_dm('fm_last_auth',(new Date().getTime()),c_exp,null,null,dmStr);if(fminfo&&typeof fminfo[0]!="undefined"){fminfo[0]=data;var c_val=fminfo.join("|");_session.save_cookie_dm('fmugcuserinfo',encodeURIComponent(c_val),c_exp,null,null,dmStr);}});}};self.transfer_locations_to_uup=function(){require(['web/modules/mylocations'],function(mylocations){var locations=mylocations.getStoredData('pelm_mylocations');if(locations&&locations.length>0){$.each(locations,function(k,v){mylocations.update(v,null,false);});}});};self.get_fm_user_id=function(){var curr_user=_session.fld('fmugcuserinfo');if(typeof curr_user!='undefined'&&curr_user!=null){curr_user=curr_user.split('|');if(curr_user.length==3&&typeof curr_user[1]!="undefined"){curr_user_id=parseInt(curr_user[1]);}
else if(curr_user.length==4&&typeof curr_user[2]!="undefined"){curr_user_id=parseInt(curr_user[2]);}}};self.set_message=function(msg,type){if(type==null){type='message';}
$(_form_msg_id).html('<span class="msg-'+type+'">'+msg+'</span>');};self.clear_message=function(){$(_form_msg_id).html('');}
self.set_error=function(msg){self.set_message(msg,'error');};self.start_loading=function(msg){msg='<div id="loading"><img src="/images/loading_web.gif" alt="Loading" />'+msg+'</div>';self.set_message(msg,'loading');};self.end_loading=function(){$('#loading').remove();};self.redirect=function(url){if(typeof window._config.lr_switchtest!='undefined'&&window._config.lr_switchtest){window.top.location.href=url.replace('my-account/','my-account-lr/').replace('mon-compte/','mon-compte-lr/');}else{window.top.location.href=url;}};self.redirect_signin=function(){self.redirect(country_selection.addSavedCountryCodeUrl(copy.signin.url_sign_in));};self.redirect_signup=function(){self.redirect(country_selection.addSavedCountryCodeUrl(copy.signin.url_sign_up));};self.redirect_signup_social=function(){self.redirect(country_selection.addSavedCountryCodeUrl(copy.signin.url_sign_up+'?social=1'));};self.redirect_secure=function(url){var protocol=('https:'==document.location.protocol?'https':'http'),url=(url!=null?url:window.location.href);if(protocol=='http'){self.redirect('https://'+url.replace(protocol,''));}};self.check_refresh=function(callback){if(callback){callback(false);}}
self.check_auth=function(callback){if(self.is_logged_in()==false){self.sign_out();self.redirect_signin();return false;}
if(callback){callback();}
return true;};self.check_auth_token=function(callback){if(self.is_logged_in()==true){__.a('/api/myaccountlr/user_read',function(data){if(data&&typeof data!='undefined'&&data!=null)
{if(typeof data=='string'){data=$.parseJSON(data);}
if(data&&callback){callback();}}});}}
self.shortLink=function(firebase_cnf,callback){var _cnfa=window._config.apps_dynamic_link;if(!_cnfa||!firebase_cnf.target_url){return false;}
var _cnf={"dynamicLinkInfo":{"dynamicLinkDomain":_cnfa.apps_dynamic_link_domain,"link":firebase_cnf.target_url,"iosInfo":{"iosBundleId":_cnfa.apps_ios_bundleid,"iosFallbackLink":firebase_cnf.target_url,"iosCustomScheme":_cnfa.apps_ios_custom_scheme},"androidInfo":{"androidPackageName":_cnfa.apps_android_packagename,"androidFallbackLink":firebase_cnf.target_url,}}};self.post_request_json(_cnfa.apps_firebase_url,_cnf,function(data){var response=data,err="";if(typeof response=='string'){response=$.parseJSON(data);}
if(!response||response.length<=0||!response.shortLink){user.set_error('Unable to open in App');$("#nav_additional_links").show();return;}
var link=response.shortLink;if(callback){callback(link);}});return true;}
self.set_cnp_cookie=function(){if(session.fld('pelm_uup_user_alerts')==''||session.fld('pelm_uup_user_alerts')==null){__.a('/api/myaccountlr/user_read_alert_locations_cnp',function(data){if(data&&typeof data!='undefined'&&data!=null&&typeof data=='string'){data=$.parseJSON(data);}
if(typeof data.notifications=='undefined'||data.notifications=={}){return;}
var user_alerts={};for(var rule in data.notifications){for(var i in data.notifications[rule]){pc=data.notifications[rule][i];if(typeof user_alerts[pc]=='undefined'){user_alerts[pc]=[];}
user_alerts[pc].push(rule);}}
session.save_cookie('pelm_uup_user_alerts',JSON.stringify(user_alerts));});}};self.post_request=function(url,parameters,success,fail){var xmlHttp=null;var XMLHTTPREQUEST_MS_PROGIDS=new Array('Microsoft.XMLHTTP','Msxml3.XMLHTTP','Msxml2.XMLHTTP','Msxml2.XMLHTTP.7.0','Msxml2.XMLHTTP.6.0','Msxml2.XMLHTTP.5.0','Msxml2.XMLHTTP.4.0','MSXML2.XMLHTTP.3.0');var _makePOSTRequest=function(url,parameters,callback){if(window.XMLHttpRequest!=null){xmlHttp=new window.XMLHttpRequest();}else if(window.ActiveXObject!=null){var success=false;for(var i=0;i<XMLHTTPREQUEST_MS_PROGIDS.length&&!success;i++){try{xmlHttp=new ActiveXObject(XMLHTTPREQUEST_MS_PROGIDS[i]);success=true;}catch(ex){}}}else{self.set_error("Your browser is not supported.");return xmlHttp;}
xmlHttp.onreadystatechange=callback;xmlHttp.open('POST',url,true);xmlHttp.setRequestHeader('Content-type','application/x-www-form-urlencoded; charset=UTF-8');xmlHttp.setRequestHeader('Accept','text/html,application/xhtml+xml')
if(typeof parameters!='string'){var query=[];for(var key in parameters){query.push(encodeURIComponent(key)+'='+encodeURIComponent(parameters[key]));};parameters=query.join('&');}
xmlHttp.send(parameters);}
self.start_loading(copy.myaccount.lbl_please_wait);var request=_makePOSTRequest(url,parameters,function(){if(xmlHttp.readyState==4){if(xmlHttp.status==200){var result=xmlHttp.responseText;success(result);}else{if(fail!=null){fail(xmlHttp);}else{var err=xmlHttp.responseText;self.set_error(err);}}
self.end_loading();}});return request;}
self.post_request_json=function(url,body,success,fail){var xmlHttp=null;var XMLHTTPREQUEST_MS_PROGIDS=new Array('Microsoft.XMLHTTP','Msxml3.XMLHTTP','Msxml2.XMLHTTP','Msxml2.XMLHTTP.7.0','Msxml2.XMLHTTP.6.0','Msxml2.XMLHTTP.5.0','Msxml2.XMLHTTP.4.0','MSXML2.XMLHTTP.3.0');var _makePOSTRequest=function(url,body,callback){if(window.XMLHttpRequest!=null){xmlHttp=new window.XMLHttpRequest();}else if(window.ActiveXObject!=null){var success=false;for(var i=0;i<XMLHTTPREQUEST_MS_PROGIDS.length&&!success;i++){try{xmlHttp=new ActiveXObject(XMLHTTPREQUEST_MS_PROGIDS[i]);success=true;}catch(ex){}}}else{self.set_error("Your browser is not supported.");return xmlHttp;}
xmlHttp.onreadystatechange=callback;xmlHttp.open('POST',url,true);xmlHttp.setRequestHeader('Content-type','application/json; charset=UTF-8');xmlHttp.setRequestHeader('Accept','text/html,application/xhtml+xml')
xmlHttp.send(JSON.stringify(body));}
var request=_makePOSTRequest(url,body,function(){if(xmlHttp.readyState==4){if(xmlHttp.status==200){var result=xmlHttp.responseText;success(result);}else{if(fail!=null){fail(xmlHttp);}else{var err=xmlHttp.responseText;self.set_error(err);}}}});return request;}
self.getParameterByName=function(name,url){if(!url){url=window.location.href;}
name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);if(!results)return null;if(!results[2])return'';return decodeURIComponent(results[2].replace(/\+/g," "));}
self.set_portal_cookie=function(returnUrl){var cportal=self.getParameterByName('cportal');if(cportal){_session.save_localstorage('cportal',JSON.stringify({'ts':Date.now(),'url':returnUrl}));}}
self.clear_portal_cookie=function(){if(typeof localStorage!='undefined'){localStorage.removeItem('cportal');}else{_session.save_localstorage('cportal','');}};self.get_return_url=function(){var returnUrl=self.getParameterByName('ReturnUrl');var cportal=self.getParameterByName('cportal');if(cportal&&returnUrl){if(typeof window.atob!='undefined'){try{returnUrl=atob(returnUrl);}catch(e){}}}
var savedPortal=null;if(typeof localStorage!='undefined'){savedPortal=localStorage.getItem('cportal');}else{savedPortal=_session.fld('cportal');}
if((!returnUrl&&!cportal)&&savedPortal){savedPortal=JSON.parse(savedPortal);if(savedPortal!=""){if(Date.now()<(savedPortal.ts+(3*60*60*1000))){try{if(savedPortal.url&&savedPortal.url!=""){returnUrl=atob(savedPortal.url);}}catch(e){}}}}
self.clear_portal_cookie();return returnUrl;};return self;});return User();});;