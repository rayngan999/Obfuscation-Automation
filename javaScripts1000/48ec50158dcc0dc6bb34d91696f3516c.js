define(['jquery','module.base','localization/copy'],function($,Module,copy){Module.search=function(){var self=this;var searchXhr,searchThrottle,list,countryCodes;self.init=function(){if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,'');};}
window.mainSearchMore=function(cls){$('#suggestionlist').attr('class','suggestion_list '+cls);$('#suggestionlist_news').attr('class','suggestion_list_news '+cls);}
window.mainSearchLess=function(cls){$('#suggestionlist').removeClass(cls);$('#suggestionlist_news').removeClass(cls);}
window.indexSearchMore=function(cls){$('#more-'+cls).addClass('hidden');$('#less-'+cls).removeClass('hidden');$('.more-search-list-'+cls).removeClass('hidden');}
window.indexSearchLess=function(cls){$('#more-'+cls).removeClass('hidden');$('#less-'+cls).addClass('hidden');$('.more-search-list-'+cls).addClass('hidden');}
$(function(){if($('html').hasClass('lt-ie10')){$("#search").val(copy.search.label_loc_keyword);}});self.addInputEventListeners();$('#searchform','#searchform_news').submit(function(){self.addFormSubmitListener();});$(document).on('click','#closeList',function(){$(".suggestion_list_div").hide();});$(document).on('keydown','#search, #search_news',function(e){self.arrowKeyEvent(e);return;});$(document).ready(function(){self.addLatLong});}
self.addLatLong=function()
{if(typeof ugc_default_search_text!="undefined"){$('#photoDetails, .photo-detail').find('#search-query').val(ugc_default_search_text);}
if((typeof window._user_config!="undefined")&&(typeof window._user_config=="object")&&(typeof window._user_config.lat!="undefined")&&(typeof window._user_config.lng!="undefined")){$('#searchlat').val(parseFloat(window._user_config.lat).toFixed(4));$('#searchlong').val(parseFloat(window._user_config.lng).toFixed(4));$('#searchlat_news').val(parseFloat(window._user_config.lat).toFixed(4));$('#searchlong_news').val(parseFloat(window._user_config.lng).toFixed(4));}else if((typeof window._config.lat!="undefined")&&(typeof window._config.lng!="undefined")){$('#searchlat').val(parseFloat(window._config.lat).toFixed(4));$('#searchlong').val(parseFloat(window._config.lng).toFixed(4));$('#searchlat_news').val(parseFloat(window._config.lat).toFixed(4));$('#searchlong_news').val(parseFloat(window._config.lng).toFixed(4));}}
self.arrowKeyEvent=function(e)
{var kCode=e.which||e.keyCode,c,selected;if((kCode!=40&&kCode!=38&&kCode!=13&&kCode!=39&&kCode!=37)||typeof list=='undefined'){return;}
selected=list.filter('.selected');if(!(kCode==39||kCode==37)){list.removeClass('selected');list.removeClass('headingselected');}
if(kCode==40){if(!selected.length||selected.is(':last-child')){c=list.eq(2);}else{c=selected.next();}}else if(kCode==38){if(!selected.length||selected.is(':nth-child(2)')){c=list.last();}else{c=selected.prev();}}else if(kCode==13){if(selected.length>0){e.preventDefault();if(selected.find('a:first').hasClass('see-more')||selected.find('a:first').hasClass('see-less')){return false;}
dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':'clicks','eventLabel':"searchEnter | "+$("#search").val()});var href=selected.find('a').attr('data-href');window.location.href=href;return false;}}else if(kCode==37){if(!selected.find('a:first').hasClass('see-more')){return false;}
if(selected.length>0){e.preventDefault();var classList=selected.find('a:first').attr('class').split(' ');for(i=0;i<classList.length;i++){if(classList[i].indexOf("more_")!==-1){window.mainSearchLess(classList[i]);}}
return false;}}else if(kCode==39){if(!selected.find('a:first').hasClass('see-more')){return false;}
if(selected.length>0){e.preventDefault();var classList=selected.find('a:first').attr('class').split(' ');for(i=0;i<classList.length;i++){if(classList[i].indexOf("more_")!==-1){window.mainSearchMore(classList[i]);}}
return false;}}
c.addClass('selected');if(c.hasClass("heading")){if(c.find('a:first').length){c.addClass('headingselected');}else{return self.arrowKeyEvent(e);}
return;}
if(c.hasClass('more')&&!c.is(":visible")){return self.arrowKeyEvent(e);}};self.addFormSubmitListener=function()
{var formid=$(this).attr('id');var query_length,num_suggestions,num_locations;query_length=$(this).length;if(formid=='search_news'){num_suggestions=$('ul#suggestionlist_news li.result').length;num_locations=$('ul#locationslist_news li.result').length;}else{num_suggestions=$('ul#suggestionlist li.result').length;num_locations=$('ul#locationslist li.result').length;}
if(window._config.locale=='en_gb'&&((query_length>0&&query_length<2)||(num_suggestions==0&&num_locations==0))){return false;}}
self.addInputEventListeners=function()
{$("#search, #search_news").on('focus',function(){if($('html').hasClass('lt-ie10')&&$(this).val()==copy.search.label_loc_keyword){$(this).val('');}}).on('blur',function(){if($('html').hasClass('lt-ie10')&&$(this).val()==''){$(this).val(copy.search.label_loc_keyword);}}).on('keyup',function(e){var kCode=e.which||e.keyCode;var formid=$(this).attr('id');var retrylimit;if(typeof window._config.newsearch!='undefined'&&typeof window._config.newsearch.retry_limit!='undefined'){retrylimit=window._config.newsearch.retry_limit;}else{retrylimit=1;}
if($(this).val().length>=3){countryCodes=window._config.search_country_code_null;if(formid=='search_news'){$(".suggestion_list_news_div").show();}else{$(".suggestion_list_div").show();}
var searchText=$(this).val().trim();if(searchThrottle){clearTimeout(searchThrottle);}
if(typeof searchXhr!="undefined"){searchXhr.abort();}
if(kCode==40||kCode==38||kCode==37||kCode==39){return;}
searchThrottle=setTimeout(function(){var d_lat,d_lng;if((typeof window._user_config!="undefined")&&(typeof window._user_config=="object")&&(typeof window._user_config.lat!="undefined")&&(typeof window._user_config.lng!="undefined")){d_lat=parseFloat(window._user_config.lat).toFixed(4);d_lng=parseFloat(window._user_config.lng).toFixed(4);}else if((typeof window._config.lat!="undefined")&&(typeof window._config.lng!="undefined")){d_lat=parseFloat(window._config.lat).toFixed(4);d_lng=parseFloat(window._config.lng).toFixed(4);}
searchXhr=$.ajax({url:(window.user_countrycode_url?window.user_countrycode_url:window.url_countrycode)+'/api/location/search',dataType:'json',data:{"searchText":searchText,"countryCodes":countryCodes,"lat":d_lat,"long":d_lng},timeout:5000,tryCount:0,retryLimit:retrylimit,success:function(data){$('.suggestion_list').html('');var typeKey={'city':['location','locations',0,''],'province':['location','locations',0,''],'country':['location','locations',0,''],'ski':['location','ski',0,''],'school':['school','schools',0,''],'schools':['school','schools',0,''],'golf':['golf','golf',0,''],'airport':['airport','airports',0,''],'airports':['airport','airports',0,''],'park':['park','parks',0,''],'parks':['park','parks',0,''],'cottage':['cottage','cottage',0,''],'campground':['campground','campground',0,''],'beach':['beach','beach',0,''],'marine':['marine','marine',0,''],'attraction':['attraction','attractions',0,''],'attractions':['attraction','attractions',0,''],'postcode':['location','locations',0,''],'school':['school','schools',0,''],'schools':['school','schools',0,''],'airport':['airport','airports',0,''],'park':['park','parks',0,''],'postcode':['location','locations',0,'']};var text='<li class="pointcast-message"><img src="'+window._config.image_url+'PointCast-Logo-White-'+window._config.lang.toLowerCase()+'.png" alt="POINTCAST"><p>'+copy.search.pointcastlbl+'</p></li>';if(data!=''&&data!=null){var foundCity=0,foundSki=0,foundSchools=0,foundGolf=0,foundAirports=0,foundParks=0,typeCtr=0,moreClass='more';$.each(data,function(k,v){var itemClass='result',val='',text_sub='',text_items='';if(typeKey[v.type]){if(typeKey[v.type][2]==0){typeKey[v.type][2]+=1;typeCtr=0;}}
typeCtr++;if(typeKey[v.type]){typeKey[v.type][2]+=1;if(typeCtr<20){if(typeCtr>5){itemClass+=' '+moreClass
if(typeKey[v.type]){itemClass+=' '+moreClass+'_'+typeKey[v.type][1];}}
val=v.name;if(v.type=="province"){val=v.name+", "+v.country;}else{if(v.countrycode==window._config.domain_countrycode&&(v.countrycode=='CA')||(v.countrycode=='US')){if(v.provcode){val=v.name+", "+v.provcode;}else if(v.province){val=v.name+", "+v.province;}}else{if(v.province){val=v.name+", "+v.country;}
if((window._config.locale.substring(3)).toUpperCase()=='CA'&&v.provcode){val=v.name+", "+v.provcode;}else if(v.province){val=v.name+", "+v.province;if(typeof v.displayCountry=='undefined'&&(v.countrycode!='CA')&&(v.countrycode!='US')){val=v.name+", "+v.country;}}
if(v.displayCountry){val=v.name;if(v.province){val=val+", "+v.province;}
val=val+", "+v.country;}}}
text_items+='<li class="'+itemClass+'"><a data-event-action="clicks" data-event-label="searchDropDown | '+searchText+'" data-omni_link_name="'+window._config.site_prefix+': search: dropdown click: '+v.code+'" data-href="'+v.url+'" data-omni_action="search: dropdown" onclick="setTimeout(function(){window.location.href = \''+v.url+'\';}, 800);" tabindex="'+k+'">'+val+'</a></li>';typeKey[v.type][3]+=text_items;}}});var more_less='';for(types in typeKey){more_less='';if(typeKey[types][2]==0){continue;}
if(typeKey[types][2]>6){more_less='<a data-omni_link_name="'+window._config.site_prefix+': search: results: show more" data-omni_action="search: results: show more/less" href="javascript:window.mainSearchMore(\'more_'+typeKey[types][1]+'\'); " class="see-more more_'+typeKey[types][1]+'">+</a><a data-omni_link_name="'+window._config.site_prefix+': search: results: show less" data-omni_action="search: results: show more/less" href="javascript:window.mainSearchLess(\'more_'+typeKey[types][1]+'\');" class="see-less more_'+typeKey[types][1]+'">-</a>';}
text+='<li class="heading '+types+'">'+more_less+copy.search[typeKey[types][1]]+'</li>'+typeKey[types][3];}}else{text+="<li class='no-result'>"+copy.search.error+"</li>";}
if(formid=='search_news'){$('.suggestion_list_news').html(text);list=$('.suggestion_list_news li');}else{$('.suggestion_list').html(text);list=$('.suggestion_list li');}},error:function(xhr,textStatus,errorThrown){if(textStatus=='timeout'){this.tryCount++;if(this.tryCount<=this.retryLimit){$.ajax(this);return;}
return;}}});},250);}else if(kCode!=40&&kCode!=38){if(formid=='search_news'){$(".suggestion_list_news_div").hide();$('.suggestion_list_news').html('');}else{$(".suggestion_list_div").hide();$('.suggestion_list').html('');}}}).on('blur',function(){$(document).on('click',function(event){if(!$(event.target).closest('.navsearchform').length&&!$(event.target).closest(".o-mainsearch-results").length){$(".suggestion_list_div").hide();$("#mylocations").hide();$('#search').val('');}});});}}
return Module.factory("search");});;