var AjaxController=function(delay){this.xhr=null;this.timeout=null;this.delay=!isNaN(delay)?delay:500;};AjaxController.prototype.send=function(options){var that=this;if(this.timeout){clearTimeout(this.timeout);}
this.timeout=setTimeout(function(){that.xhr=jQuery.ajax(options);},this.delay);};AjaxController.prototype.getXhr=function(){return this.xhr;};webshop.ajax=webshop.ajax||{};webshop.ajax.Util={init:function(){var _ajax=jQuery.ajax;jQuery.extend({ajax:function(settings){if(settings.dataType!='jsonp'){settings.url=webshop.ajax.Util.getUrlWithPageProtocol(settings.url);}
return _ajax.call(this,settings);}});jQ(document).ajaxSend(function(e,xhr,settings){application.activeRequestFlag=true;});jQ(document).ajaxStop(function(e,xhr,settings){application.activeRequestFlag=false;});jQ(document).ajaxComplete(function(e,xhr,ajaxOptions){if(typeof(xhr)!=='undefined'&&webshop.ajax.Util.isJsonResponse(xhr.getAllResponseHeaders())){try{var response=JSON.parse(xhr.responseText);}catch(e){}
webshop.ajax.Util.redirectIfNecessary(response,ajaxOptions);}});jQ.ajaxSetup({data:{pageViewId:webshop.common.jsTopBodyVariables.pageViewId,fromNonResponsivePage:true},cache:false});},isJsonResponse:function(allHeaders){return allHeaders.indexOf('json')!=-1;},getTextValue:function(xml,tagName){var tags=xml.getElementsByTagName(tagName);if(tags&&tags.length>0&&tags[0]&&tags[0].firstChild){return tags[0].firstChild.data;}
return null;},getTags:function(xml,tagName){var tags=xml.getElementsByTagName(tagName);if(tags&&tags.length>0){return tags;}
return null;},getCleanTextValue:function(xml,tagName){var textValue=this.getTextValue(xml,tagName);if(textValue){return unescape(decodeURI(textValue)).replace(/\+/g," ");}else{return null;}},cleanTextValue:function(textValue){if(textValue){return unescape(decodeURI(textValue)).replace(/\+/g," ");}else{return null;}},redirectIfNecessary:function(response,ajaxOptions){var redirectionUrl=_.get(response,'redirectionWarning');var shouldRedirect=!_.isUndefined(redirectionUrl)&&!response.silent&&!ajaxOptions.skipRedirectionHandler;if(shouldRedirect){redirectUser(redirectionUrl);}},getUrlWithPageProtocol:function(url){url=url.replace(/^http[s]?:/,window.location.protocol);if(window.location.port=='8080'||window.location.port=='8443'){url=url.replace(/:8[0-9][0-9][0-9]\//,':'+window.location.port+"/");}
return url;},postRedirect:function(url,params){var form=jQ('<form></form>');form.attr('method','POST');form.attr('action',url);for(var i in params){var input=jQ('<input />');input.attr('type','hidden');input.attr('name',i);input.attr('value',params[i]);input.appendTo(form);}
jQ('body').append(form);form.submit();},getFormDataAsJSON:function(form){return _.object(_.map(form.serializeArray(),_.values));},addNewParameters:function(url,parameterNames,parameterValues){if(parameterNames&&parameterValues){var namesSize=parameterNames.length,valuesSize=parameterValues.length;if(namesSize>0&&namesSize===valuesSize){var newUrl=url+(url.indexOf('?')>-1?'&':'?');for(i=0;i<namesSize;i++){var param=parameterNames[i]+'='+encodeURI(parameterValues[i]);newUrl=(i===0)?newUrl+param:newUrl+'&'+param;}
return newUrl;}}
return url;}};