(function(Backbone,betaFeatures){'use strict';Backbone.Webshop.mixins.isBetaFeatureEnabled=function(betaFeature){return Boolean(betaFeatures[betaFeature]);};Backbone.Webshop.mixins.areBetaFeaturesEnabled=function(betaFeatures){return betaFeatures.every(function(betaFeature){return Backbone.Webshop.mixins.isBetaFeatureEnabled(betaFeature);});};})(Backbone,webshop.userData.betaFeatures);(function(Backbone,features){'use strict';Backbone.Webshop.mixins.isFeatureEnabled=function(feature){return Boolean(features[feature]);}})(Backbone,webshop.userData.features);(function(Backbone,featureFlags){'use strict';Backbone.Webshop.mixins.isFeatureFlagOn=function(featureFlagName){return Boolean(featureFlags[featureFlagName]);}})(Backbone,webshop.userData.featureFlags);ocBackbone=ocBackbone||{};ocBackbone.validation=ocBackbone.validation||{};ocBackbone.validation.utils={revalidateGroupElements:function(groupElements,currentElementName,errorClass,validator){var groupElementsArray=groupElements.split(' ');groupElementsArray.forEach(function(name){var $el=jQ("[name='"+name+"']");if(name!==currentElementName&&$el.hasClass(errorClass)){validator.element($el);}});}}
ocBackbone=ocBackbone||{};ocBackbone.validation=ocBackbone.validation||{};ocBackbone.validation.LoginValidation=function(formSelector){var _inputFieldErrorClass='error',_serverSideErrorClass='server-side-error';this.highlight=function(element,errorClass,validClass){var $element=jQ(element);$element.addClass(_inputFieldErrorClass);$element.siblings('input#'+$element.attr('name')).addClass(_inputFieldErrorClass);};this.unhighlight=function(element,errorClass,validClass){var $parent=jQ(formSelector).parent(),$element=jQ(element);$element.removeClass(_inputFieldErrorClass);$element.siblings('input#'+$element.attr('name')).removeClass(_inputFieldErrorClass);$element.parent().next('.formFieldError').remove();};this.errorPlacement=function(error,$element){$element.closest('form').siblings('.formFieldError.server-side-error').remove();error.insertAfter($element.parent());};};_.extend(ocBackbone.validation.LoginValidation.prototype,{ignore:[],rules:{"login":{required:true,email:true},"password":{required:true}},messages:{"login":{"required":"Please enter a valid email address","email":"Please enter a valid email address"},"password":{"required":"Password is required"}},errorElement:'span',errorClass:'formFieldError'});ocBackbone=ocBackbone||{};ocBackbone.validation=ocBackbone.validation||{};ocBackbone.validation.quickRegValidation=(function(){var _inputFieldErrorClass='error',validationRules={rules:{"customer.title":{required:true},"customer.firstName":{required:true,"StrictOneLineTextRule":true},"customer.lastName":{required:true,"StrictOneLineTextRule":true},"customer.login":{required:true,email:true},"customer.password":{required:true,"customer.password-LengthRule":true},"customer.passwordConfirm":{required:true,equalTo:"#qr-password"},"postcode":{required:true,"PostcodeRule":true,"postcode-LengthRule":true}},messages:{"customer.title":{"required":"quickReg.title.required"},"customer.firstName":{"required":"Enter your first name.","StrictOneLineTextRule":"Your first name contains invalid characters"},"customer.lastName":{"required":"Enter your last name.","StrictOneLineTextRule":"Your last name contains invalid characters"},"customer.login":{"required":"Sorry, we need a valid email address.","email":"Sorry, we need a valid email address."},"customer.password":{"required":"Please enter a password.","customer.password-LengthRule":"Sorry, that password is too short."},"customer.passwordConfirm":{"required":"Please re-enter your password.","equalTo":"Sorry, your passwords do not match."},"postcode":{"required":"Double check your postcode and try again.","PostcodeRule":"Double check your postcode and try again.","postcode-LengthRule":"Double check your postcode and try again."}},errorElement:'span',errorClass:'formFieldError',highlight:function(element,errorClass,validClass){var $element=jQ(element);if($element.attr('name')==='customer.firstName'){$element.closest('.gridRow').next().addClass('post-error');}
if($element.attr('name')==='customer.login'){$element.parent().next('#qr-email-error').remove();$element.parent().next('.user-already-registered-msg').remove();}
$element.addClass(_inputFieldErrorClass);},unhighlight:function(element,errorClass,validClass){var $element=jQ(element);if($element.attr('name')==='customer.firstName'){$element.closest('.gridRow').next().removeClass('post-error');}
$element.removeClass(_inputFieldErrorClass);$element.parent().next('.formFieldError').remove();if($element.attr('name')==='customer.login'){$element.parent().next('.user-already-registered-msg').remove();}},invalidHandler:function(event,validator){window.ocBackbone.pubsub.trigger("validator:invalidreg",{errors:validator.invalid});},errorPlacement:function(error,$element){$element.closest('form').siblings('.formFieldError.server-side-error').remove();error.insertAfter($element.parent());}};return validationRules;})();ocBackbone=ocBackbone||{};ocBackbone.validation=ocBackbone.validation||{};ocBackbone.validation.Validation=function(formValidatorSettings){var _formValidators={};this.events=function(){var ret={};formValidatorSettings.forEach(function(formValidatorSetting){ret['textchange '+formValidatorSetting.DOMSelectors.formSelector]=getUpdateSubmitButtonHandler(formValidatorSetting.DOMSelectors);});return ret;}();this.render=function(){var that=this,ret=this._parentRender&&this._parentRender();formValidatorSettings.forEach(function(formValidatorSetting){var formSelector=formValidatorSetting.DOMSelectors.formSelector;_formValidators[formSelector]=that.$(formSelector).validate(formValidatorSetting.validationRules);});return ret;};function getUpdateSubmitButtonHandler(DOMSelectors){return function(){if(_formValidators[DOMSelectors.formSelector].silentCheckForm()){this.$(DOMSelectors.submitButtonSelector).removeClass(DOMSelectors.submitButtonInvalidClass).addClass(DOMSelectors.submitButtonValidClass);}else{this.$(DOMSelectors.submitButtonSelector).removeClass(DOMSelectors.submitButtonValidClass).addClass(DOMSelectors.submitButtonInvalidClass);}};};};ocBackbone=ocBackbone||{};ocBackbone.validation=ocBackbone.validation||{};ocBackbone.validation.changePasswordValidation=(function(){var _getMainParentDiv=function($element){var $parent=$element.parent(),$rowParent=$parent.parent();return $rowParent.hasClass("gridRow")?$rowParent:$parent;},_inputFieldErrorClass='error',validationRules={rules:{"password":{required:true,"customer.password-LengthRule":true},"passwordConfirm":{required:true,equalTo:"#qr-password"}},messages:{"password":{"required":"Please enter a password.","customer.password-LengthRule":"Sorry, that password is too short."},"passwordConfirm":{"required":"Please re-enter your password.","equalTo":"Sorry, your passwords do not match."}},errorElement:'span',errorClass:'formFieldError',highlight:function(element,errorClass,validClass){var $element=jQ(element),$mainDiv=_getMainParentDiv($element),$next=$mainDiv.next();$element.addClass(_inputFieldErrorClass);if($next.hasClass(errorClass)){$next.remove();}},unhighlight:function(element,errorClass,validClass){var $element=jQ(element),$mainDiv=_getMainParentDiv($element),$next=$mainDiv.next();$element.removeClass(_inputFieldErrorClass);if($next.hasClass(errorClass)){$next.remove();}},errorPlacement:function(error,$element){error.insertAfter(_getMainParentDiv($element));}};return validationRules;})();ocBackbone.validation.accountChangePasswordValidation=jQ.extend({},ocBackbone.validation.changePasswordValidation,{rules:{"password":{required:true,"customer.password-LengthRule":true},"passwordConfirm":{required:true,equalTo:"#newPassword"}}});ocBackbone=ocBackbone||{};ocBackbone.validation=ocBackbone.validation||{};ocBackbone.validation.resetPasswordValidation=(function(){var _getMainParentDiv=function($element){var $parent=$element.parent(),$rowParent=$parent.parent();return $rowParent.hasClass('gridRow')?$rowParent:$parent;},_inputFieldErrorClass='error',validationRules={rules:{username:{required:true,email:true},postcode:{required:true,PostcodeRule:true,'postcode-LengthRule':true}},messages:{username:{required:'Please enter a valid email address',email:'Please enter a valid email address'},postcode:{required:'Double check your postcode and try again.',PostcodeRule:'Double check your postcode and try again.','postcode-LengthRule':'Double check your postcode and try again.'}},errorElement:'span',errorClass:'formFieldError',highlight:function(element,errorClass,validClass){var $element=jQ(element),$mainDiv=_getMainParentDiv($element),$next=$mainDiv.next();$element.addClass(_inputFieldErrorClass);if($next.hasClass(errorClass)){$next.remove();}},unhighlight:function(element,errorClass,validClass){var $element=jQ(element),$mainDiv=_getMainParentDiv($element),$next=$mainDiv.next();$element.removeClass(_inputFieldErrorClass);if($next.hasClass(errorClass)){$next.remove();}},errorPlacement:function(error,$element){error.insertAfter(_getMainParentDiv($element));}};return validationRules;})();ocBackbone.app('validation');ocBackbone.apps.validation.views.VALIDATIONPARSE=Backbone.View.extend({initialize:function(){var errorDetails=this.$('#errorDetails');this.errorText=jQ('<span ></span>').addClass('error');if(errorDetails.get(0))this.updateErrorStates(errorDetails.html());},caching:{obj:{},eventIds:[],currentModel:{},mandatoryEls:{premiseId:true},errorInfo:{premiseId:{elId:"premiseId"}}},events:{'change select':'_mandatoryCheck','blur select':'_mandatoryCheck','keyup input#prefecture':'_mandatoryCheck','blur input:not(.js-prevent-legacy-validation)':'_mandatoryCheck','click .validate':'_mandatoryCheck','submit .validate':'_mandatoryCheck'},updateErrorStates:function(errorJSON){var errors=(typeof errorJSON==='string')?JSON.parse(errorJSON):errorJSON;if(errors)this.addErrorElements(errors);},addErrorElements:function(errorElements){var self=this;_.forEach(errorElements,function(element){self.caching.mandatoryEls[element.elId]=element.isMandatory;self.caching.errorInfo[element.elId]=element;});},_isInputValid:function(element){var elemVal=element.get(0).value;var id=element.attr('id');return this._isValueValid(id,elemVal);},_isValueValid:function(id,value){var validationFail=false;var details=this.caching.errorInfo[id];if(details&&details.matchString){var pattern=new RegExp(details.matchString,'i');if(!pattern.match(value)){validationFail=true;}}else if(details&&!value){validationFail=true;}else if(details&&value.length===0){validationFail=true;}
return!validationFail;},_displayError:function(errorElement,details){var elParent=errorElement.parent(),errorText=(elParent.find('.error').get(0))?elParent.find('.error'):this.errorText.clone().append();if(!details){return;}
if(elParent.hasClass('formRow')){elParent.removeClass('formRow').addClass('formRowError inError-'+details.elId);}
if(details.text){errorElement.after(errorText.html((typeof details.text==='object')?details.text.current:details.text));}},_hideError:function(errorElement,details){var parentEl=errorElement.parent();if(!details){return;}
if(parentEl.hasClass('inError-'+details.elId)){parentEl.removeClass('formRowError inError-'+details.elId).addClass('formRow');parentEl.find('.error').remove();}},_mandatoryCheck:function(evt){var elem={};var valid=true;var self=this;_.forEach(this.caching.mandatoryEls,function(value,key){elem=self.$('#'+key);var elementDetails=self.caching.errorInfo[key];var elementFound=elem.get(0);if(value&&elementFound&&!self._isInputValid(elem)){if(evt){evt.preventDefault();evt.stopPropagation();}
valid=false;self._displayError(elem,elementDetails);}else if(elementFound){self._hideError(elem,elementDetails);}});_.forEach(this.caching.mandatoryEls,function(value,key){elem=self.$('#'+key);var elementFound=elem.get(0);if(!elementFound){return;}
var button=elem.parents('.details').find('.action .button').eq(1);if(!valid){button.addClass('disabled');}else{button.removeClass('disabled');}});return valid;},_handleAjaxError:function(el,details){(details.redirectURL)?window.location.href=details.redirectURL:this._displayError(el,{elId:'ajax',text:details.text});}});ocBackbone.views.validation=new ocBackbone.apps.validation.views.VALIDATIONPARSE({el:jQ('#wrapper')});ocBackbone.app('popup');ocBackbone.apps.popup.views.GLOBALPOPUP=Backbone.View.extend({initialize:function(){_.bindAll(this,'_closePopup');},el:jQ('body'),help:{usage:"USAGE:\n\nThis mechanism is used to create and control the popup based on a set of pre-determined options. There's no need to try and control anything about the popup apart from the "+"information to be shown.\n\nTo invoke the popup you'll need to call the following function:\n\nocBackbone.utils.popup.create({});\n\nThis function expects an object with the settings "+"required for the content of the popup.\n\n\nOBJECT SETTINGS:",className:"\n\nSpecify an overriding class name for the popup - (Doesn't require the '.' indentifier)\n\n  {\n    className : 'OVERIDE CLASS NAME'\n  }\n",insertAjax:"\n\nUse this option when the information isn't being created in the JS or the information isn't currently on the page. This option can be used two different ways (Either a "+"string or an object. ALL AJAX TEMPLATES MUST BE .EJS FILES)\n\n\n- Ajax request where the information coming back doesn't need to be parsed through a template\n\n  {\n    insertAjax : 'URL "+"TO AJAX DATA'\n  }\n\n\n- Ajax request where a template is also required\n\n  {\n    insertAjax : {\n      url : 'URL TO AJAX DATA',\n      template : 'URL TO TEMPLATE'\n    }\n  }\n\n\n"+"- Ajax request where the data is required but the template is being supplied\n\n  {\n    insertAjax : {\n      url : 'URL TO AJAX DATA',\n      template : 'TEMPLATE CODE'\n    }\n  }\n",insertStatic:"\n\nUse this option if you want to include a static piece of HTML that doesn't require and XHR request.\n\nThis option accepts a string, a jQuery created element stack "+"( jQ('<div></div>').addClass('classname') ) or a vanilla javascript createElement option ( document.createElement('div') ).\n\n  {\n    insertStatic : 'STATIC DETAILS'\n  }\n",onOpenCallback:"\n\nThis is an optional callback which is fired when the code has finished rendering\n\n  {\n    onOpenCallback : function(){}\n  }\n",onCloseCallback:"\n\nThis is an optional callback which is fired when the popup has been closed\n\n  {\n    onCloseCallback : function(){}\n  }\n"},create:function(options){this.options=options||{};this.popupOverlay=jQ('<div></div>').addClass('modalPopupOverlay');this.popupContainer=jQ('<div></div>').addClass('modalPopup spinner');this.popupCloseButton=jQ('<i></i>').addClass('close');this.popupContainer.append(this.popupCloseButton);this.popupOverlay.on('click',this._closePopup);this.popupCloseButton.on('click',this._closePopup);this.$el.append(this.popupOverlay,this.popupContainer);this.popupOverlay.stop().fadeIn('fast');this._centerPopup();this.popupContainer.stop().fadeIn('fast');if(!(_.isEmpty(this.options)))this._additionalOptions();return this.popupContainer;},_closePopup:function(evt){var self=this;if(evt)evt.preventDefault();this.popupOverlay.off('click',this._closePopup);this.popupCloseButton.off('click',this._closePopup);this.popupOverlay.stop().fadeOut('fast');this.popupContainer.stop().fadeOut('fast',function(){self.popupContainer.html('');self.popupContainer=undefined;self.$('.modalPopupOverlay').remove();self.$('.modalPopup').remove();});if(typeof this.options.onCloseCallback==='function')this.options.onCloseCallback.call(this);this.popupOverlay=undefined;this.popupCloseButton=undefined;this.template=undefined;},_additionalOptions:function(){if(this.options.className){if(typeof this.options.className==='string'&&this.options.className.indexOf('.')===-1){this.$('.modalPopup').addClass(this.options.className);this._centerPopup();}
else{console.warn(this.help.usage+this.help.className);}}
if(this.options.insertAjax)this._getDetails();if(this.options.insertStatic){try{this._appendData(this.options.insertStatic);}
catch(err){console.warn("!! I can't add the information given into the popup !!\n\n"+this.help.usage+this.help.insertStatic);}}
if(this.options.insertPageEl)this._appendData(this.options.insertPageEl.clone().wrap('<div></div>').parent().html());},_getDetails:function(){var typeOf=Object.prototype.toString.call(this.options.insertAjax);if(typeOf==='[object String]'){if(ocBackbone.templates[this.options.cacheTemplate]){this._appendData(ocBackbone.templates[this.options.cacheTemplate]);}
else{this._doAjax({scope:this,url:this.options.insertAjax,type:'text'},this._appendData);}}
else if(typeOf==='[object Object]'){if(this.options.insertAjax.template){this._getTemplate(function(){if(this.options.insertAjax.url){this._doAjax({scope:this,url:this.options.insertAjax.url,type:'json'},this._appendData);}
else{(this.options.insertAjax.data)?this._appendData(this.options.insertAjax.data):console.warn('!! No data to add to template !!\n\n'+this.help.usage+this.help.insertAjax);}});}
else{console.warn('!! No template specified !!\n\n'+this.help.usage+this.help.insertAjax);}}
else{console.warn('!! Invalid variable type !!\n\n'+this.help.usage+this.help.insertAjax);}},_doAjax:function(details,successCallback){var self=this;jQ.ajax({url:details.url,dataType:details.type,success:function(data){if(self.options.cacheTemplate)ocBackbone.templates[self.options.cacheTemplate]=data;successCallback.call(details.scope,data);},error:function(err){console.warn('!! '+err.status+' '+err.statusText+' - '+details.url+' !!\n\n'+self.help.usage+self.help.insertAjax);}});},_getTemplate:function(completedCallback){if(this.options.insertAjax.template.indexOf('.ejs')>-1){if(ocBackbone.templates[this.options.cacheTemplate]){this.template=_.template(ocBackbone.templates[this.options.cacheTemplate],null,{variable:'jsonData'});}
else{this._doAjax({scope:this,url:this.options.insertAjax.template,type:'text'},function(data){this.template=_.template(data,null,{variable:'jsonData'});completedCallback.call(this);});}}
else{this.template=_.template(this.options.insertAjax.template,null,{variable:'jsonData'});completedCallback.call(this);}},_appendData:function(data){this.popupContainer.removeClass('spinner');this.popupContainer.append((Object.prototype.toString.call(data)==='[object Object]'&&!(data instanceof jQuery))?this.template(data):data);this._centerPopup();if(typeof this.options.onOpenCallback==='function')this.options.onOpenCallback.call(this);},_centerPopup:function(){this.popupContainer.css({'margin-top':((this.popupContainer.outerHeight()/2)* -1),'margin-left':((this.popupContainer.outerWidth()/2)* -1)});},displayHelp:function(){var combinedString='';for(var helper in this.help){if(this.help.hasOwnProperty(helper))combinedString+=this.help[helper];}
console.warn(combinedString);}});ocBackbone.app('prettySelects');var ENTER_KEY_CODE=13;var DOWN_ARROW_KEY_CODE=40;var UP_ARROW_KEY_CODE=38;var TAB_KEY_CODE=9;var ESCAPE_KEY_CODE=27;ocBackbone.apps.prettySelects.views.PrettySelect=Backbone.View.extend({tagName:'span',className:'prettySelect',events:{'click .button':'showOptions','mouseleave ul':'handleMouseLeave','mouseover ul':'handleMouseOver','click ul':'handleOnClick','keydown ul':'handleKeyPressOnList','keypress #select_button':'handleKeyPressOnButton'},initialize:function(options){this.selectElement=options['selectElement'];this.disabled=options['disableSelect'];this.mouseBackIn=false;this.lastIdx=0;$(document).on('click',function(evt){var isClickInside=this.$('ul').has(evt.target).length||this.$('#select_button').is(evt.target);if(!isClickInside){this.hideOptions();}}.bind(this));},render:function(){this.$el.html('');this.renderOptions();this.renderButton();return this;},handleMouseLeave:function(evt){if(this.$('ul').has(evt.target).length){return}
var self=this;this.mouseBackIn=false;setTimeout(function(){if(!self.mouseBackIn){self.hideOptions();}},500);},handleMouseOver:function(){this.mouseBackIn=true;},handleOnClick:function(evt){if(evt.target.tagName==='LI'&&!this.disabled){this.chooseOption(evt);}},handleKeyPressOnButton:function(evt){var key=evt.key||evt.keyCode;var handled=false;if(key==='Escape'||key==='Esc'||key===ESCAPE_KEY_CODE){this.hideOptions();handled=true;}else if(key==='Enter'||key===ENTER_KEY_CODE){this.showOptions();handled=true;}
if(handled){evt.preventDefault();}},handleKeyPressOnList:function(evt){if(evt.defaultPrevented){return;}
var isListOpened=this.$('ul').attr('aria-expanded')&&!this.$('ul').hasClass('hidden');if(!isListOpened){return evt;}
var currSelectedIdx=parseInt(this.$('li:focus').attr('id'));var elemIdx,handled=false;var key=evt.key||evt.keyCode;if(key==='Escape'||key==='Esc'||key===ESCAPE_KEY_CODE){this.hideOptions();handled=true;}else if(key==='Enter'||key===ENTER_KEY_CODE){this.chooseOption(evt);handled=true;}else if(key==='ArrowUp'||key==='Up'||key===UP_ARROW_KEY_CODE){elemIdx=currSelectedIdx===0?this.lastIdx:currSelectedIdx-1;this.$('li[id="'+elemIdx+'"]').focus();handled=true;}else if(key==='ArrowDown'||key==='Down'||key===DOWN_ARROW_KEY_CODE||key==='Tab'||key===TAB_KEY_CODE){elemIdx=currSelectedIdx===this.lastIdx?0:currSelectedIdx+1;this.$('li[id="'+elemIdx+'"]').focus();handled=true;}
if(handled){evt.preventDefault();evt.stopPropagation();}},showOptions:function(){if(this.disabled){return;}
this.$('ul').removeClass('hidden').attr('aria-expanded',true);this.$('li')[0].focus();},hideOptions:function(){this.$('ul').addClass('hidden').attr('aria-expanded',false);},renderOptions:function(){var currentList=jQ('<ul class="hidden" aria-expanded="false" role="listbox"></ul>');var selectOptions=jQ('option',this.selectElement);var selectedOption=jQ('option:selected',this.selectElement);this.lastIdx=selectOptions.length-1;selectOptions.each(function(index){var option=jQ('<li class="storedCard" tabindex="0" role="option"></li>').attr('id',index).attr('data-value',this.value).append('<span class="icon"></span>').append(this.innerHTML);if(jQ(this).attr('hidden')){option.css("display","none");}
if(selectedOption[0].value===selectOptions[index].value){option.addClass("selected");}
option.appendTo(currentList).find('.icon').attr('data-icon',jQ(this).attr('data-icon'));});this.$('ul').remove();this.$el.append(currentList);},renderButton:function(){var selectedOption=jQ('option:selected',this.selectElement);this.$('.button').remove();var selectButton=jQ('<span class="button secondary storedCard" role="button" id="select_button" tabindex="0"></span>');selectButton.append('<span id="selectedPaymentMethodName" class="icon"></span>').append(selectedOption.html()).appendTo(this.$el).find('.icon').attr('data-icon',selectedOption.attr('data-icon')).attr('data-payment-name',selectedOption.attr('data-payment-name'));if(this.disabled){selectButton.addClass('disabled');}},chooseOption:function(evt){var value=jQ(evt.target).attr('data-value');var selectedOption=jQ('option[value="'+value+'"]',this.selectElement);selectedOption.get(0).selected=true;selectedOption.change();var elements=evt.target.parentElement;jQ(elements).find('li').each(function(index,elem){var li=jQ(elem);if(li.attr('data-value')===value){li.addClass('selected');li.attr('aria-selected',true);}else{li.removeClass('selected');li.attr('aria-selected',false);}});this.renderButton();this.hideOptions();window.ocBackbone.pubsub.trigger("prettySelect:optionChanged",evt);}},{enhanceSelect:function(selectElement,disableSelect){var view=new this({selectElement:selectElement,disableSelect:disableSelect});view.render().$el.insertAfter(selectElement);jQ(selectElement).addClass('hidden');}});jQ(function(){jQ('select#storedCardId').each(function(i){ocBackbone.apps.prettySelects.views.PrettySelect.enhanceSelect(this);});});webshop.favImport=webshop.favImport||{};webshop.favImport.qr={init:function(){jQ('.qr-content #favouritesImportStores a').on('click',webshop.common.Util.mySupermarketControl);}};ocBackbone.app('favImport');ocBackbone.apps.favImport.views.POPUPCONTROL=Backbone.View.extend({events:{'click':'handleFavImport'},subViews:{popup:{}},handleFavImport:function(evt){var popup={},self=this;evt.preventDefault();this.subViews.popup=new ocBackbone.apps.popup.views.GLOBALPOPUP();this.subViews.popup.create({className:'favImportPopup',insertAjax:'selectStoreForImport.go',onOpenCallback:function(){self.subViews.popup.popupContainer.on('click','a',webshop.common.Util.mySupermarketControl);},onCloseCallback:function(){self.subViews.popup.popupContainer.off('click','a',webshop.common.Util.mySupermarketControl);self.subViews.popup=null;}});}});new ocBackbone.apps.favImport.views.POPUPCONTROL({el:jQ('.favPopup')});webshop.smartbanner={init:function(){if(this.shouldShowBanner()){var el=jQ('.smartbanner');new webshop.smartbanner.SmartBannerView({el:el});}},shouldShowBanner:function(){var privateLocalStorage=(window.privateLocalStorage||window.localStorage);if(privateLocalStorage.getItem('smartbanner-hide')){return false;}
if(jQ('.smartbanner').length==0){return false;}
return true;}};webshop.smartbanner.SmartBannerView=Backbone.View.extend({className:'smartbanner',events:{'click .smartbanner-close':'close'},initialize:function(){this.$el.addClass('visible');},close:function(event){event.preventDefault();this.$el.removeClass('visible');this.dontShowAgain();},dontShowAgain:function(){var privateLocalStorage=(window.privateLocalStorage||window.localStorage);privateLocalStorage.setItem('smartbanner-hide','true');}});webshop.persbanner={init:function(){var el=jQ('.pers');new webshop.persbanner.PersBannerView({el:el});}};webshop.persbanner.PersBannerView=Backbone.View.extend({ACTION_CLICK:'click',ACTION_CLOSE:'close',url:'/webshop/personalisation/banner/',events:{'click .close':'close','click a:not(.close)':'click'},initialize:function(){},close:function(e){e.preventDefault();this.$el.hide();jQ.ajax({url:this.url+this.ACTION_CLOSE,type:'POST'});},click:function(e){e.preventDefault();jQ.ajax({url:this.url+this.ACTION_CLICK,type:'POST'}).always(function(){window.location.href=e.target.getAttribute('href');});}});(function(Backbone,URI){'use strict';Backbone.Webshop.mixins.getSuccessRedirectFromUrlParam=function(){if(URI(window.location.search).hasQuery("success_redirect")){return URI.parseQuery(window.location.search)['success_redirect'];}else{return null;}};})(Backbone,URI);webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.utils={tryParseJSON:function(jsonString){if(Object.prototype.toString.call(jsonString)==='[object Object]'){return jsonString;}
try{var o=JSON.parse(jsonString);if(o&&typeof o==="object"&&o!==null){return o;}}catch(e){}
return false;},redirectTo:function(path){window.location.href=path;},getRedirectPath:function(ajaxResponse){redirectUrl=ajaxResponse.redirectURL||ajaxResponse.redirectionWarning;if(redirectUrl){return(redirectUrl.match(/^https?:\/\//i))?redirectUrl:'/webshop'+redirectUrl;}
return null;},redirectTo:function(path){window.location.href=path;},giveSubmitFeedback:function(e){var submitBtn=jQ(e.target);submitBtn.width(submitBtn.width());submitBtn.addClass('submitting').text('Submitting...');},disconnectFacebookAccount:function(paramsObj){FB.logout(function(response){if(paramsObj&&paramsObj.isFBRegPopup){ocBackbone.header.RegLogHeaderView.prototype.register();}else{ocBackbone.header.RegLogHeaderView.prototype.login();}});return false;},disconnectPayPalAccount:function(paramsObj){if(paramsObj&&paramsObj.isPPRegPopup){window.location.href='/webshop/logout.do?destination=register';}else{window.location.href='/webshop/logout.do?destination=login';}
return false;},linkRequiresLoginPopup:function(element){return jQ(element).attr('data-requireslogin')==="true";},linkRequiresElevatedLoginPopup:function(element){return jQ(element).attr('data-requiresElevatedLogin')==="true";},isIphoneNavigator:function(){return Boolean(navigator.userAgent.match(/iPhone/i));},addNewParametersFromJsonObject:function(url,parameters){if(parameters){var newUrl=url+(url.indexOf('?')>-1?'&':'?');var i=0;var param;for(var parameterName in parameters){param=encodeURIComponent(parameterName)+'='+encodeURIComponent(parameters[parameterName]);newUrl=(i===0)?newUrl+param:newUrl+'&'+param;i++;}
return newUrl;}
else{return url;}}};ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.PopupsEventBus=_.extend({},Backbone.Events);ocBackbone=window.ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.PopupModel=Backbone.Model.extend({defaults:{display:false,content:'<p>Default content.</p><p><strong>Please change me.</strong></p>',classNames:[],isContentFetched:true},hide:function(){this.set('display',false);this.stopListening(ocBackbone.popup.PopupsEventBus,'popup:show');},show:function(){this.set('display',true);ocBackbone.popup.PopupsEventBus.trigger('popup:show');this.listenTo(ocBackbone.popup.PopupsEventBus,'popup:show',this.hide);},isDisplayed:function(){return this.get('display');},clearContent:function(){this.set('content',null);},setContent:function(content){var previousContent=this.get('content');this.set('content',content);if(previousContent===content){this.trigger('contentNotChanged');}},addClass:function(className){var newNames=className.split(' ');var oldNames=this.get('classNames');this.set('classNames',_.union(oldNames,newNames));},removeClass:function(className){var newNames=className.split(' ');var oldNames=this.get('classNames');this.set('classNames',_.difference(oldNames,newNames));}},{extend:function(child){var model=Backbone.Model.extend.apply(this,arguments);model.prototype.defaults=_.extend({},this.prototype.defaults,child.defaults);return model;}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.AjaxPopupModel=ocBackbone.popup.PopupModel.extend({defaults:{display:false,content:'Loading...',classNames:[],isContentFetched:false},url:function(){return this.get('url');},parse:function(response,options){if(response.redirectionWarning){this.redirectionHandler(response)}
this.set('isContentFetched',true);return{content:response};},redirectionHandler:function(location){return window.location.href=location;},defaultDataType:'html',fetch:function(options){options=jQ.extend(options,{dataType:this.defaultDataType});return ocBackbone.popup.PopupModel.prototype.fetch.call(this,options);}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.AjaxPopupModelRedir=ocBackbone.popup.AjaxPopupModel.extend({parse:function(response,options){this.set('isContentFetched',true);var json=webshop.popup.utils.tryParseJSON(response),redirectUrl,content;if(json){redirectUrl=webshop.popup.utils.getRedirectPath(json);if(!redirectUrl){window.location.href='/webshop/error.do';}else{window.location.href=redirectUrl;content='Redirecting...';}}else{content=response;}
return{content:content};}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.TabsPopupModel=ocBackbone.popup.PopupModel.extend({setSilentDefaultSubviewId:function(id){this.set({defaultSubviewId:id},{silent:true});},setSubviewFetchOptions:function(options){this.set({subviewFetchOptions:options});},tabModels:{},addTabModel:function(id,tabModel){this.tabModels[id]=tabModel;}});ocBackbone=window.ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.PopupView=(function(){function renderPopup(){this.$el.html(this.template(this.model.toJSON()));jQ('body').append(this.$el);this.$('.popup').position('center');this.$('input, textarea').placeholder();}
function removePopup(){this.$el.html('');}
return Backbone.View.extend({className:'popup-wrapper',events:{'click .overlay,.close':'closePopup','click .js-submit-button.btn-register':'formSubmit'},getOption:Backbone.Marionette.proxyGetOption,template:_.template('<div class="overlay" ></div>'+'<div class="popup <%= classNames.join(\' \') %>">'+'<a class="close" ></a>'+'<div class="errors"><% if (arguments[0].error) { %><%= error %><% } %></div>'+'<div id="js-popup-content"><%= content %></div>'+'</div>'),initialize:function(attrs){this.options=attrs;this.listenTo(this.model,'change contentNotChanged',this.render);},closePopup:function(e){this.onClose(e);this.model.hide();},formSubmit:_.debounce(webshop.popup.utils.giveSubmitFeedback,5000,true),render:function(){if(this.model.isDisplayed()){renderPopup.call(this);if(!webshop.common.Util.isIPad()){var firstInput=this.$('.popup input:visible').first();if(firstInput){firstInput.focus();}}
if(typeof this.onShow==='function'){this.onShow();}}else{removePopup.call(this);}
return this;},onClose:function(){}},{extend:function(child){var view=Backbone.View.extend.apply(this,arguments);view.prototype.events=_.extend({},this.prototype.events,child.events);view.prototype._parentRender=this.prototype.render;return view;}});})();ocBackbone=window.ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.TargetedPopupView=(function(){function renderPopup(){this.$el.html(this.template(this.model.toJSON()));jQ('body').append(this.$el);var width=this.model.get('width')||0;if(width){this.$('.targeted-popup').width(width);}}
function removePopup(){this.$el.html('').hide();}
return Backbone.View.extend({className:'targeted-popup-wrapper',events:{'click .overlay':'closePopup'},getOption:Backbone.Marionette.proxyGetOption,template:Handlebars.templates['popup/targeted'],initialize:function(attrs){this.options=attrs;this.listenTo(this.model,'change contentNotChanged',this.render);this.listenTo(this.model,'target:set',this.anchorToTarget||function(){});},anchorToTarget:function(target){var $target=jQ(target),tOffset=$target.offset(),tWidth=$target.width(),tHeight=$target.height(),$targetedPopup=this.$('.targeted-popup'),tpWidth=$targetedPopup.width();$targetedPopup.css({top:(tOffset.top+tHeight+13)+'px',left:(tOffset.left+(tWidth/2)-(tpWidth/2))+'px'});this.$el.show();},closePopup:function(){if(typeof this.onClose==='function'){this.onClose();}
this.model.hide();},onClose:function(){},render:function(){if(this.model.isDisplayed()){renderPopup.call(this);}else{removePopup.call(this);}
return this;}},{extend:function(child){var view=Backbone.View.extend.apply(this,arguments);view.prototype.events=_.extend({},this.prototype.events,child.events);view.prototype._parentRender=this.prototype.render;return view;}});})();webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.SendAjaxModalFormSvc=function(options){options=_.extend({formAction:'',successRedirectUrl:'',incorrectDataFormSelector:''},options);this.formAction=options.formAction;this.successRedirectUrl=options.successRedirectUrl;this.incorrectDataFormSelector=options.incorrectDataFormSelector;};webshop.popup.svc.SendAjaxModalFormSvc.prototype.post=function(data,model){var _this=this;return jQ.ajax({url:this.formAction,type:'POST',data:data}).done(function(data){var json=webshop.popup.utils.tryParseJSON(data),redirectUrl;if(json){redirectUrl=webshop.popup.utils.getRedirectPath(json);window.location.href=redirectUrl||_this.successRedirectUrl;return;}
if(_this.isIncorrectDataForm(data)){model.setContent(data);}else if(_this.isElevatedLoginForm(data)){var elevatedAuthenticationPopup=ocBackbone.popup.elevatedAuthenticationSingleton.get();var successRedirectUrl=_this.successRedirectUrl;if(_this.formAction.indexOf('/ajaxUnlinkFacebookForm.go')!==-1){successRedirectUrl='/webshop/setWebshopPassword.go';}
elevatedAuthenticationPopup.set('successRedirectUrl',successRedirectUrl);elevatedAuthenticationPopup.show();elevatedAuthenticationPopup.fetch();}else{if(typeof _this.successRedirectUrl==='function'){_this.successRedirectUrl();}else{window.location.href=_this.successRedirectUrl;}}});};webshop.popup.svc.SendAjaxModalFormSvc.prototype.isElevatedLoginForm=function(html){return jQ(html).find('#elevatedLoginPopup').addBack('#elevatedLoginPopup').length>0;};webshop.popup.svc.SendAjaxModalFormSvc.prototype.isIncorrectDataForm=function(html){return jQ(html).find(this.incorrectDataFormSelector).addBack(this.incorrectDataFormSelector).length>0;};webshop.popup.svc.SendAjaxModalFormSvc.prototype.setSuccessRedirectUrl=function(successRedirectUrl){this.successRedirectUrl=successRedirectUrl;};(function(ocBackbone){'use strict';ocBackbone.popup.OneUsePopupModel=ocBackbone.popup.PopupModel.extend({show:function(){var self=this;Backbone.ajax({url:"/webshop/webservices/account/preferences?preference="+self.get('preferenceName'),contentType:"application/json",success:function(response){if(!(response[self.get('preferenceName')]=='true')){ocBackbone.popup.PopupModel.prototype.show.call(self);}}})},hide:function(){ocBackbone.popup.PopupModel.prototype.hide.call(this);var data={};data[this.get('preferenceName')]='true';Backbone.ajax({url:"/webshop/webservices/account/preferences",type:'PUT',contentType:"application/json",data:JSON.stringify(data)});}});})(ocBackbone);ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.TabSubView=Backbone.View.extend({template:_.template('<%= content %>'),tabId:'someTabId',tabName:'tabNameToDisplay',events:{'click .js-submit-button.btn-register':'formSubmit'},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$('input, textarea').placeholder();if(typeof this.afterRender==='function'){this.afterRender();}
return this;},getTabName:function(){return this.tabName;},getTabId:function(){return this.tabId;},formSubmit:_.debounce(webshop.popup.utils.giveSubmitFeedback,5000,true)},{extend:function(child){var view=Backbone.View.extend.apply(this,arguments);view.prototype.events=_.extend({},this.prototype.events,child.events);view.prototype._parentRender=this.prototype.render;return view;}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.TabsPopupView=(function(){var iframeHandlerAttached=false;function renderPopup(defaultSubviewId){var isSsoEnabled=Backbone.Webshop.mixins.isBetaFeatureEnabled('SSO_INTEGRATION');var classNames=[];if(isSsoEnabled){classNames.push('sso');}
this.$el.html(this.template(_.extend(this.model.toJSON(),{subviews:this._subviews,defaultSubviewId:defaultSubviewId,classNames:classNames,})));jQ('body').append(this.$el);this.$('.popup').position('center');if(!iframeHandlerAttached){this.attachIframeHandler();iframeHandlerAttached=true;}}
function removePopup(){this.$el.html('');}
function loadTemplate(templateUrl){var templateString;if(!this.template){jQ.ajax({url:templateUrl,method:'GET',async:false,success:function(data){templateString=data;},error:function(error){console.error("Error while getting "+templateUrl+": "+error.statusText);}});}
return templateString;}
var TEMPLATE_URL='/webshop/static/ajaxTemplates/popups/tabsPopupTemplate.html';return Backbone.View.extend({_subviews:[],tabs:null,className:'popup-wrapper',events:{'click .overlay,.close':'closePopup','click .popupTab':'goToTab'},tabsBindingAttributes:[],template:_.template(loadTemplate(TEMPLATE_URL)),initialize:function(){var subview;var popupModel=this.model;var view=this;this.tabs.forEach(function(tab){var tabModel=new tab.model();subview=new tab.subview({model:tabModel});view._subviews.push(subview);if(subview.afterInit&&typeof subview.afterInit==='function'){subview.afterInit();}
popupModel.addTabModel(subview.tabId,tabModel);view.tabsBindingAttributes.forEach(function(attr){tabModel.listenTo(view.model,'change:'+attr,function(){tabModel.set(attr,view.model.get(attr));});});});this.listenTo(this.model,'change:display',this.render);},switchSubview:function(subviewId){var newSubview=this.getSubview(subviewId);var fetchOpts=this.model.get('subiewFetchOptions')||{};var from=window.registrationSource;if(newSubview){if(this.currentSubview){this.stopListening(this.currentSubview.model,'change contentNotChanged',this.renderAndAddSubview);}
this.currentSubview=newSubview;this.listenTo(this.currentSubview.model,'change contentNotChanged',this.renderAndAddSubview);if(from&&from==='register_button'&&this.currentSubview.model.get('isRegistration')){jQ.extend(true,fetchOpts,{data:{from:from,trackAjax:true}});window.registrationSource=null;}else if(from&&this.currentSubview.model.get('isLogin')){jQ.extend(true,fetchOpts,{data:{from:from,trackAjax:true}});window.registrationSource=null;}else if(this.currentSubview.model.get('isRegistration')){jQ.extend(true,fetchOpts,{data:{from:'login',trackAjax:true}});window.registrationSource=null;}
this.currentSubview.model.fetch(fetchOpts).always(this.renderAndAddSubview.bind(this));this.model.set('subviewFetchOptions',null);}},getSubview:function(subviewId){return _.find(this._subviews,function(subview){return subview.getTabId()===subviewId;});},goToTab:function(event){var newSubviewId=jQ(event.target).attr('for');if(this.currentSubview.getTabId()!==newSubviewId){this.switchSubview(newSubviewId);}},render:function(){if(!this.model.isDisplayed()){removePopup.call(this);}else{var defaultSubviewId=this.model.get('defaultSubviewId')||this._subviews[0].getTabId();renderPopup.call(this,defaultSubviewId);if(this.customRenderAction){this.customRenderAction();}
this.switchSubview(defaultSubviewId);}
return this;},renderAndAddSubview:_.debounce(function(){this.$('.popupSubview').empty().append(this.currentSubview.render().$el);if(this.currentSubview.afterRender&&typeof this.currentSubview.afterRender==='function'){this.currentSubview.afterRender();}
this.currentSubview.delegateEvents();if(this.customSubviewRenderAction){this.customSubviewRenderAction();}},100),attachIframeHandler:function(){var that=this;jQ(window).on('message',function(e){if(!that.isValidTargetOrigin(e.originalEvent.origin)||(isNaN(e.originalEvent.data.height))){return;}
that.currentSubview.resizeSsoIframe(e.originalEvent.data);});},isValidTargetOrigin:function(origin){var ssoTargetOrigin=webshop.common.jsVariables.get('ssoTargetOrigin');var windowOrigin=window.location.origin;if(!windowOrigin){windowOrigin=window.location.protocol+"//"+window.location.hostname+(window.location.port?':'+window.location.port:'');}
return origin===ssoTargetOrigin||origin===windowOrigin;},closePopup:function(){this.onClose();this.model.hide();},onClose:function(){}},{extend:function(child){var view=Backbone.View.extend.apply(this,arguments);view.prototype.events=_.extend({},this.prototype.events,child.events);return view;}});})();webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.generalHandler={init:function(){jQ(document).on('click','[data-requiresLogin]',function(event){var $target=jQ(event.target);var requiresLoginAttr=$target.attr('data-requiresLogin');if(requiresLoginAttr!=='true'&&requiresLoginAttr!=='newCustomer'){return;}
var evSource=$target.text()||$target.attr('id')||$target.className()||'';var evSourceString;try{evSourceString=encodeURI(evSource.toLowerCase().trim().replace(/ /g,'_'));}catch(err){console.log('Error while creating evSourceString');}
if(evSourceString){window.registrationSource=evSourceString;}
event.preventDefault();var successRedirectUrl=this.href.replace(window.location.origin,'');if(Backbone.Webshop.mixins.isBetaFeatureEnabled('SSO_INTEGRATION')&&Backbone.Webshop.mixins.isBetaFeatureEnabled('SSO_FULL_REDIRECT')){var targetPath=requiresLoginAttr==='newCustomer'?'/webshop/quickReg.do':'/webshop/login.go';window.location.href=targetPath+'?success_redirect='+encodeURIComponent(successRedirectUrl);}else{var loginPopup=ocBackbone.popup.regAndLoginMultiton.get().regLogin;loginPopup.set('successRedirectUrl',successRedirectUrl);var subviewId=requiresLoginAttr==='newCustomer'?'newCustomer':'returningCustomer';loginPopup.setSilentDefaultSubviewId(subviewId);loginPopup.show();}
return false;});if(!_.isEmpty(location.search.match(/linkPayPalAccount=true/))){var paypalLinkAccount=ocBackbone.popup.regAndLoginMultiton.get().paypalLinkAccount;paypalLinkAccount.fetch();paypalLinkAccount.show();}
if(jQ('#js-showPersonalisedCouponsPopup').length){var personalisedCouponsPopup=new Backbone.Webshop.IntroducingCouponPopupView();personalisedCouponsPopup.model.show();}
if(jQ('#js-showAddressOutOfZonePopup').length){var addressOutOfZonePopup=new Backbone.Webshop.AddressOutOfZonePopupView();addressOutOfZonePopup.model.show();}}};(function(Backbone){"use strict";Backbone.Webshop.AddressOutOfZonePopupView=ocBackbone.popup.PopupView.extend({id:'addressOutOfZonePopup',events:{'click .js-close':'closePopup'},model:new ocBackbone.popup.PopupModel({content:Handlebars.templates['homepage/addressOutOfZonePopup'](),})});})(Backbone);ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};(function(ocBackbone,jQ){jQ(document).ready(function(){ocBackbone.popup.LoginSubView=ocBackbone.popup.TabSubView.extend({id:'loginSubview',tabName:getMessage('login.login.returningCustomer'),tabId:'returningCustomer',events:{'submit #simpleLoginForm':'login','submitted .paypalLogin':'paypalLogin','click #fbLoginButton':'facebookLogin','click #js-paypalFallbackButton':'showPaypalFallback'},resizeSsoIframe:function(data){jQ('.sso-iframe-login').css('height',data.height+'px');window.ocBackbone.pubsub.trigger('popupHeight',{height:data.height,captcha:data.captcha});},login:_.debounce(function(e){this.model.login(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true),paypalLogin:_.debounce(function(e){this.model.paypalLogin();return false;},1000,true),facebookLogin:_.debounce(function(e){this.model.facebookLogin();return false;},1000,true),showPaypalFallback:function(e){e.preventDefault();var paypalFallback=ocBackbone.popup.regAndLoginMultiton.get().paypalFallback;paypalFallback.fetch();paypalFallback.show();}}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#simpleLoginForm',submitButtonSelector:'#js-popupLoginButton',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-primary'},validationRules:new ocBackbone.validation.LoginValidation('#simpleLoginForm')}]));})}(ocBackbone,jQuery));ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};function getLoginAjaxPopupUrl(){var url=URI('/webshop/ajaxLogin.go?ajax=true&popup=true&trackAjax=true');var success_redirect=Backbone.Webshop.mixins.getSuccessRedirectFromUrlParam();if(success_redirect!=null){url.setQuery('success_redirect',URI.parseQuery(window.location.search)['success_redirect']);}
return url.build().toString();}
ocBackbone.popup.LoginAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{url:getLoginAjaxPopupUrl(),successRedirectUrl:''},initialize:function(){this.set('isLogin',true);this.loginSvc=new webshop.popup.svc.PopupLoginSvc();this._updateUrl();webshop.gtm.registerEventSource(this);this.on('change:successRedirectUrl',function(model,value,options){this.loginSvc.setSuccessRedirectUrl(value);this._updateUrl();}.bind(this));},login:function(data){this.loginSvc.post(data,this);},paypalLogin:function(){this.hide();},facebookLogin:function(){webshop.social.Facebook.logRegAction=true;webshop.social.Facebook.authenticate();this.trigger('gtm:uaEvent',{category:'Login',action:'fb-loginbutton-popup-click'});this.hide();},_updateUrl:function(){var uri=URI(this.defaults.url);if(this.get('successRedirectUrl')){uri.setQuery('success_redirect',this.get('successRedirectUrl'));}
this.set('url',uri.build().toString());}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.QuickRegSubView=ocBackbone.popup.TabSubView.extend({id:'quickRegistrationSubview',tabName:'New customer',tabId:'newCustomer',events:{'submit #quickRegAcceptForm':'register','submitted .paypalLogin':'paypalRegister','click #fbLoginButton':'facebookRegister','click #js-paypalFallbackButton':'showPaypalFallback'},resizeSsoIframe:function(data){jQ('.sso-iframe-registration').css('height',data.height+'px');window.ocBackbone.pubsub.trigger('popupHeight',{height:data.height,captcha:data.captcha});},register:_.debounce(function(e){this.model.register(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true),paypalRegister:_.debounce(function(e){this.model.paypalRegister();return false;},1000,true),facebookRegister:_.debounce(function(e){this.model.facebookRegister();return false;},1000,true),showPaypalFallback:function(e){e.preventDefault();var paypalFallback=ocBackbone.popup.regAndLoginMultiton.get().paypalFallback;paypalFallback.fetch();paypalFallback.show();}}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#quickRegAcceptForm',submitButtonSelector:'#acceptForm',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-secondary'},validationRules:ocBackbone.validation.quickRegValidation}]));ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};function getQuickRegAjaxPopupUrl(){var url=URI('/webshop/ajaxQuickReg.do?ajax=true');var success_redirect=Backbone.Webshop.mixins.getSuccessRedirectFromUrlParam();if(success_redirect!=null){url.setQuery('success_redirect',URI.parseQuery(window.location.search)['success_redirect']);}
return url.build().toString();}
ocBackbone.popup.QuickRegAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{url:getQuickRegAjaxPopupUrl(),},initialize:function(){this.set('isRegistration',true);this.registrationSvc=new webshop.popup.svc.PopupRegistrationSvc();this._updateUrl();webshop.gtm.registerEventSource(this);_.bindAll(this,'onValidationError');window.ocBackbone.pubsub.on("validator:invalidreg",this.onValidationError);this.on('change:successRedirectUrl',function(model,value,options){this.registrationSvc.setSuccessRedirectUrl(value);this._updateUrl();}.bind(this));},register:function(data){return this.registrationSvc.post(data,this);},paypalRegister:function(){this.hide();},facebookRegister:function(){webshop.social.Facebook.logRegAction=true;webshop.social.Facebook.authenticate();this.trigger('gtm:uaEvent',{category:'Register',action:'fb-quick-reg-popup'});this.hide();},initPostCode:function(data){this.initialFormData=data;},fetch:function(options){if(this.initialFormData){return ocBackbone.popup.AjaxPopupModel.prototype.fetch.call(this,{type:'POST',data:this.initialFormData});}else{return ocBackbone.popup.AjaxPopupModel.prototype.fetch.call(this,options);}},getFormUrl:function(){return location.origin+this.get('url');},onValidationError:function(data){Backbone.Webshop.analytics.WebshopAnalytics.generateNewPageView("REGISTRATION_FORM_ERRORS",this.getFormUrl()).done(function(){Backbone.Webshop.analytics.WebshopAnalytics.reportFormValidationErrors(data.errors,"REGISTRATION_FORM_ERRORS");});},_updateUrl:function(){var uri=URI(this.defaults.url);if(this.get('successRedirectUrl')){uri.setQuery('success_redirect',this.get('successRedirectUrl'));}
this.set('url',uri.build().toString());}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};jQuery(document).ready(function(){ocBackbone.popup.LoginRegTabsPopupView=ocBackbone.popup.TabsPopupView.extend({id:'loginRegPopup',tabs:[{subview:ocBackbone.popup.LoginSubView,model:ocBackbone.popup.LoginAjaxPopupModel},{subview:ocBackbone.popup.QuickRegSubView,model:ocBackbone.popup.QuickRegAjaxPopupModel}],tabsBindingAttributes:['successRedirectUrl'],render:function(){this.watchSsoIframeHeight();ocBackbone.popup.TabsPopupView.prototype.render.call(this);return this;},events:{'change #jsFakeTermsCheckbox':'setRegistrationFormHiddenCheckbox'},watchSsoIframeHeight:function(){if(typeof(window.ocBackbone.pubsub._events.popupHeight)!=='undefined'){return;}
window.ocBackbone.pubsub.on('popupHeight',function(data){var popup=this.$('.popup');var extraSpace=120;popup.height(data.height+extraSpace);popup.one('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend',function(e){popup.position({at:'center',my:'center',of:jQ(window.document.body),using:function(css,calc){jQ(this).animate(css,200,'linear');}});});},this);},customRenderAction:function(){this._firstSubviewRendered=false;},customSubviewRenderAction:function(){this.changePopupHeight({type:'default'});if(!this._firstSubviewRendered){this.$('.popup').position('center');this._firstSubviewRendered=true;}
if(this.$('#recaptcha-ajax-wrapper').length>0){this.changePopupHeight({type:'captcha'});}
if(!webshop.common.Util.isIPad()){var firstInput=this.$('.popup input:visible').first();if(firstInput){firstInput.focus();}}},changePopupHeight:function(obj){this.$('.popup').css('height','');if(obj&&obj.type==='captcha'){this.$('.popup').removeClass('popupQuickRegContainer popupLoginContainer');this.$('.popup').addClass('popupLoginWithCaptchaContainer');}else if(this.currentSubview.getTabId()==='returningCustomer'){this.$('.popup').removeClass('popupQuickRegContainer popupLoginWithCaptchaContainer');this.$('.popup').addClass('popupLoginContainer');}else{this.$('.popup').removeClass('popupLoginContainer popupLoginWithCaptchaContainer');this.$('.popup').addClass('popupQuickRegContainer');}},setRegistrationFormHiddenCheckbox:function(event){this.$('#offersOptIn').attr('checked',!!jQ(event.target).attr('checked'));}});});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.FacebookLinkAccountAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{url:'/webshop/ajaxLinkAccountDisplay.go?ajax=true'},initialize:function(){this.fbLinkAccountSvc=new webshop.popup.svc.PopupLinkFbAccountSvc();this.addClass('link-unlink-popup');},switchToFacebookRegistration:function(data){this.get('facebookRegPopupModel').post(data);this.hide();this.get('facebookRegPopupModel').show();},post:function(data){var options={type:'POST',data:data};return this.fetch(options);},linkFacebookAccount:function(data){this.fbLinkAccountSvc.post(data,this);},linkToPPReturnHandler:function(url){var that=this;if(url.indexOf("/webshop/ajaxLinkFacebookAccount.go")===-1){window.location.href=url;return;}
jQ.ajax({url:url,data:{ajax:true,popup:true},dataType:'html'}).done(function(response){var json=webshop.popup.utils.tryParseJSON(response),content;if(json){window.location.href=webshop.popup.utils.getRedirectPath(json);content="Redirecting..."}else{content=response;}
that.set({content:content});});}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.FacebookLinkAccountPopupView=ocBackbone.popup.PopupView.extend({id:'facebookLinkAccountPopup',events:{'click #changeFacebookAccount':'disconnectFacebookAccount','submit #registerForm':'switchToFacebookRegistration','submit #linkAccountForm':'linkFacebookAccount'},switchToFacebookRegistration:_.debounce(function(e){this.model.switchToFacebookRegistration(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true),linkFacebookAccount:_.debounce(function(e){this.model.linkFacebookAccount(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true),disconnectFacebookAccount:function(event){return webshop.popup.utils.disconnectFacebookAccount();},render:function(){ocBackbone.popup.PopupView.prototype.render.call(this);if(this.$('#recaptcha-ajax-wrapper').length>0){this.$('.popup').addClass('popupWithCaptcha');}
return this;}}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#linkAccountForm',submitButtonSelector:'#linkAccountsButton',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-primary'},validationRules:new ocBackbone.validation.LoginValidation('#linkAccountForm')}]));ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.FacebookRegistrationAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{url:'/webshop/ajaxFacebookRegistration.do?ajax=true'},initialize:function(){this.registrationSvc=new webshop.popup.svc.PopupRegistrationSvc();},register:function(data){return this.registrationSvc.post(data,this);},post:function(data){return this.fetch({type:'POST',data:data});}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.FacebookRegistrationPopupView=ocBackbone.popup.PopupView.extend({id:'facebookRegistrationPopup',events:{'click #changeFacebookAccount':'disconnectFacebookAccount','submit #quickRegAcceptForm':'register'},register:_.debounce(function(e){this.model.register(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true),disconnectFacebookAccount:function(event){return webshop.popup.utils.disconnectFacebookAccount({isFBRegPopup:true});}}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#quickRegAcceptForm',submitButtonSelector:'#acceptForm',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-secondary'},validationRules:ocBackbone.validation.quickRegValidation}]));ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.PaypalLinkAccountAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{url:'/webshop/ajaxPaypalLinkAccount.do?ajax=true'},initialize:function(){this.paypalLinkAccountSvc=new webshop.popup.svc.PopupLinkPaypalAccountSvc();this.addClass('link-unlink-popup');},switchToPaypalRegistration:function(){this.hide();this.trigger('switch:register');},linkPaypalAccount:function(data){return this.paypalLinkAccountSvc.post(data,this);}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.PaypalLinkAccountPopupView=ocBackbone.popup.PopupView.extend({id:'paypalLinkAccountPopup',events:{'click #changePayPalAccount':'disconnectPayPalAccount','submit #registerForm':'switchToPaypalRegistration','submit #linkAccountForm':'linkPaypalAccount','click .linkFacebook':'linkToFacebookAccount'},switchToPaypalRegistration:_.debounce(function(e){this.model.switchToPaypalRegistration();return false;},1000,true),linkPaypalAccount:_.debounce(function(e){this.model.linkPaypalAccount(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true),linkToFacebookAccount:_.debounce(function(e){webshop.social.Facebook.authenticate();return false;},1000,true),disconnectPayPalAccount:function(event){return webshop.popup.utils.disconnectPayPalAccount();},render:function(){ocBackbone.popup.PopupView.prototype.render.call(this);if(this.$('#recaptcha-ajax-wrapper').length>0){this.$('.popup').addClass('popupWithCaptcha');}
return this;}}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#linkAccountForm',submitButtonSelector:'#linkAccountsButton',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-primary'},validationRules:new ocBackbone.validation.LoginValidation('#linkAccountForm')}]));ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.PaypalRegistrationAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{url:'/webshop/ajaxPaypalRegister.do?ajax=true'},initialize:function(options){this.listenTo(options.paypalLinkAccount,'switch:register',this.display);this.registrationSvc=new webshop.popup.svc.PaypalPopupRegistrationSvc();},display:function(){this.show();this.fetch({type:'POST'});},register:function(data){return this.registrationSvc.post(data,this);}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.PaypalRegistrationPopupView=ocBackbone.popup.PopupView.extend({id:'paypalRegistrationPopup',events:{'click #changePayPalAccount':'disconnectPayPalAccount','submit #quickRegAcceptForm':'register'},register:_.debounce(function(e){this.model.register(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true),disconnectPayPalAccount:function(event){return webshop.popup.utils.disconnectPayPalAccount({isPPRegPopup:true});}}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#quickRegAcceptForm',submitButtonSelector:'#acceptForm',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-secondary'},validationRules:ocBackbone.validation.quickRegValidation}]));ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.QuickRegPopupView=ocBackbone.popup.PopupView.extend({id:'quickRegistrationPopup',events:{'submit #quickRegAcceptForm':'register','submitted .paypalLogin':'paypalRegister','click #fbLoginButton':'facebookRegister'},register:function(e){this.model.register(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},paypalRegister:function(e){this.model.paypalRegister();return false;},facebookRegister:function(e){this.model.facebookRegister();return false;}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.SocialFallbackAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{successRedirectUrl:''},initialize:function(options){if(options.type==='facebook'){this.set({url:'/webshop/login.go?facebookFallBack=true&ajax=true&popup=true'});this.loginSvc=new webshop.popup.svc.PopupLoginSvc('/webshop/ajaxLogin.go?facebookFallBack=true&ajax=true&popup=true');this.resetPasswordSvc=new webshop.popup.svc.PopupResetPasswordSvc('/webshop/resetPasswordFromFacebookFallback.do?ajax=true&popup=true');}else if(options.type==='paypal'){this.set({url:'/webshop/login.go?paypalFallBack=true&ajax=true&popup=true'});this.loginSvc=new webshop.popup.svc.PopupLoginSvc('/webshop/ajaxLogin.go?paypalFallBack=true&ajax=true&popup=true');this.resetPasswordSvc=new webshop.popup.svc.PopupResetPasswordSvc('/webshop/resetPasswordFromPayPalFallback.do?ajax=true&popup=true');}
webshop.gtm.registerEventSource(this);this.on('change:successRedirectUrl',function(model,value,options){this.loginSvc.setSuccessRedirectUrl(value);}.bind(this));},login:function(data){this.loginSvc.post(data,this);},resetPassword:function(data){this.resetPasswordSvc.post(data,this);}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.SocialFallbackPopupView=ocBackbone.popup.PopupView.extend({id:'socialFallbackPopup',events:{'submit #simpleLoginForm':'login','submit #resetpassword':'resetPassword'},login:_.debounce(function(e){this.model.login(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true),resetPassword:_.debounce(function(e){this.model.resetPassword(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true)}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#simpleLoginForm',submitButtonSelector:'#js-popupLoginButton',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-primary'},validationRules:new ocBackbone.validation.LoginValidation('#simpleLoginForm')},{DOMSelectors:{formSelector:'#resetpassword',submitButtonSelector:'#resetPwdSubmitBtn',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-primary'},validationRules:ocBackbone.validation.resetPasswordValidation}]));webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.PaypalPopupRegistrationSvc=function(){webshop.popup.svc.SendAjaxModalFormSvc.call(this,{formAction:'/webshop/ajaxQuickRegAcceptFormPayPal.do',successRedirectUrl:location.href.replace(/(&)linkAccount=true/,''),incorrectDataFormSelector:'#quickRegAcceptForm'});};webshop.popup.svc.PaypalPopupRegistrationSvc.prototype=Object.create(webshop.popup.svc.SendAjaxModalFormSvc.prototype);webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.PopupLinkFbAccountSvc=function(){webshop.popup.svc.SendAjaxModalFormSvc.call(this,{formAction:'/webshop/ajaxLinkFacebookAccount.go?ajax=true',successRedirectUrl:'/webshop/startWebshop.do?redirect=1',incorrectDataFormSelector:'#linkAccountForm'});};webshop.popup.svc.PopupLinkFbAccountSvc.prototype=Object.create(webshop.popup.svc.SendAjaxModalFormSvc.prototype);webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.PopupLinkPaypalAccountSvc=function(){webshop.popup.svc.SendAjaxModalFormSvc.call(this,{formAction:'/webshop/ajaxPaypalLinkAccountAcceptForm.do?ajax=true',successRedirectUrl:location.href.replace(/(&)linkPayPalAccount=true/,''),incorrectDataFormSelector:'#linkAccountForm'});};webshop.popup.svc.PopupLinkPaypalAccountSvc.prototype=Object.create(webshop.popup.svc.SendAjaxModalFormSvc.prototype);webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.PopupLoginSvc=function(url){webshop.popup.svc.SendAjaxModalFormSvc.call(this,{formAction:url||'/webshop/ajaxLogin.go?ajax=true&popup=true',successRedirectUrl:location.pathname+location.search,incorrectDataFormSelector:'#simpleLoginForm'});};webshop.popup.svc.PopupLoginSvc.prototype=Object.create(webshop.popup.svc.SendAjaxModalFormSvc.prototype);webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.PopupRegistrationSvc=function(){webshop.popup.svc.SendAjaxModalFormSvc.call(this,{formAction:'/webshop/ajaxQuickRegAcceptForm.do',successRedirectUrl:'/webshop/quickRegComplete.do?dnr=true',incorrectDataFormSelector:'#quickRegAcceptForm'});};webshop.popup.svc.PopupRegistrationSvc.prototype=Object.create(webshop.popup.svc.SendAjaxModalFormSvc.prototype);webshop=window.webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.PopupResetPasswordSvc=function(url){webshop.popup.svc.SendAjaxModalFormSvc.call(this,{formAction:url||'/webshop/resetPassword.do?ajax=true&popup=true',successRedirectUrl:location.pathname+location.search,incorrectDataFormSelector:'#resetpassword'});};webshop.popup.svc.PopupResetPasswordSvc.prototype=Object.create(webshop.popup.svc.SendAjaxModalFormSvc.prototype);ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.regAndLoginMultiton=(function(){function newRegLoginPopup(){var regLoginModel=new ocBackbone.popup.TabsPopupModel();new ocBackbone.popup.LoginRegTabsPopupView({model:regLoginModel});return regLoginModel;}
function newPaypalLinkAccountPopup(){var paypalLinkAccount=new ocBackbone.popup.PaypalLinkAccountAjaxPopupModel();new ocBackbone.popup.PaypalLinkAccountPopupView({model:paypalLinkAccount});return paypalLinkAccount;}
function newFacebookLinkAccountPopup(facebookReg){var facebookLinkAccount=new ocBackbone.popup.FacebookLinkAccountAjaxPopupModel({facebookRegPopupModel:facebookReg});new ocBackbone.popup.FacebookLinkAccountPopupView({model:facebookLinkAccount});return facebookLinkAccount;}
function newFacebookRegPopup(){var facebookRegistration=new ocBackbone.popup.FacebookRegistrationAjaxPopupModel();new ocBackbone.popup.FacebookRegistrationPopupView({model:facebookRegistration});return facebookRegistration;}
function newFacebookFallbackPopup(){var facebookFallback=new ocBackbone.popup.SocialFallbackAjaxPopupModel({type:'facebook'});new ocBackbone.popup.SocialFallbackPopupView({model:facebookFallback});return facebookFallback;}
function newPaypalFallbackPopup(){var paypalFallback=new ocBackbone.popup.SocialFallbackAjaxPopupModel({type:'paypal'});new ocBackbone.popup.SocialFallbackPopupView({model:paypalFallback});return paypalFallback;}
function newPaypalRegPopup(paypalLinkAccount){var paypalRegistration=new ocBackbone.popup.PaypalRegistrationAjaxPopupModel({paypalLinkAccount:paypalLinkAccount});new ocBackbone.popup.PaypalRegistrationPopupView({model:paypalRegistration});return paypalRegistration;}
return{instances:{},get:function(){if(!_.isEmpty(ocBackbone.popup.regAndLoginMultiton.instances)){return ocBackbone.popup.regAndLoginMultiton.instances;}
var regLogin=newRegLoginPopup();var facebookReg=newFacebookRegPopup();var facebookFallback=newFacebookFallbackPopup();var paypalFallback=newPaypalFallbackPopup();var facebookLinkAccount=newFacebookLinkAccountPopup(facebookReg);var paypalLinkAccount=newPaypalLinkAccountPopup();var paypalRegPopup=newPaypalRegPopup(paypalLinkAccount);ocBackbone.popup.regAndLoginMultiton.instances={regLogin:regLogin,facebookLinkAccount:facebookLinkAccount,facebookReg:facebookReg,paypalFallback:paypalFallback,facebookFallback:facebookFallback,paypalLinkAccount:paypalLinkAccount,paypalRegPopup:paypalRegPopup};return ocBackbone.popup.regAndLoginMultiton.instances;}};})();(function(Backbone){"use strict";Backbone.Webshop.IntroducingCouponPopupView=ocBackbone.popup.PopupView.extend({id:'introducingCouponsPopup',events:{'click .js-close':'closePopup'},onShow:function(){this.logAnalyticsEvent();},logAnalyticsEvent:function(){Backbone.$.ajax({type:'POST',url:'/webshop/coupons/notification/',data:{event:'introPopup'}});},model:new ocBackbone.popup.PopupModel({content:Handlebars.templates['coupons/introducingCouponsPopup'](),})});})(Backbone);ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.UnlinkFacebookAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{url:'/webshop/ajaxFacebookUnlinkAccount.go?ajax=true'},initialize:function(){this.unlinkSvc=new webshop.popup.svc.PopupUnlinkFacebookSvc();this.addClass('link-unlink-popup');},unlink:function(data){return this.unlinkSvc.post(data,this);}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.UnlinkFacebookPopupView=ocBackbone.popup.PopupView.extend({id:'unlinkFacebookPopup',events:{'submit #fbUnlinkForm':'unlink'},unlink:_.debounce(function(e){this.model.unlink(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true)}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#fbUnlinkForm',submitButtonSelector:'#fb-unlink-unlink',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-secondary'},validationRules:ocBackbone.validation.changePasswordValidation}]));webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.PopupUnlinkFacebookSvc=function(){webshop.popup.svc.SendAjaxModalFormSvc.call(this,{formAction:'/webshop/ajaxUnlinkFacebookForm.go',successRedirectUrl:'/webshop/facebookActions.go',incorrectDataFormSelector:'#fbUnlinkForm'});};webshop.popup.svc.PopupUnlinkFacebookSvc.prototype=Object.create(webshop.popup.svc.SendAjaxModalFormSvc.prototype);webshop.popup.svc.PopupUnlinkFacebookSvc.prototype.constructor=webshop.popup.svc.SendAjaxModalFormSvc;ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.unlinkFacebookSingleton={get:function get(){var unlinkFacebookPopup=new ocBackbone.popup.UnlinkFacebookAjaxPopupModel();new ocBackbone.popup.UnlinkFacebookPopupView({model:unlinkFacebookPopup});this.get=function(){return unlinkFacebookPopup;}
return unlinkFacebookPopup;}};ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.UnlinkPaypalAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{url:'/webshop/ajaxPaypalUnlinkAccount.go?ajax=true'},initialize:function(){this.unlinkSvc=new webshop.popup.svc.PopupUnlinkPaypalSvc();this.addClass('link-unlink-popup');},unlink:function(data){return this.unlinkSvc.post(data,this);}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.UnlinkPaypalPopupView=ocBackbone.popup.PopupView.extend({id:'unlinkPaypalPopup',events:{'submit #ppUnlinkForm':'unlink'},unlink:_.debounce(function(e){this.model.unlink(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true)}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#ppUnlinkForm',submitButtonSelector:'#fb-unlink-unlink',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-secondary'},validationRules:ocBackbone.validation.changePasswordValidation}]));webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.PopupUnlinkPaypalSvc=function(){webshop.popup.svc.SendAjaxModalFormSvc.call(this,{formAction:'/webshop/ajaxPaypalUnlinkForm.go',successRedirectUrl:'/webshop/paypalActions.do',incorrectDataFormSelector:'#ppUnlinkForm'});};webshop.popup.svc.PopupUnlinkPaypalSvc.prototype=Object.create(webshop.popup.svc.SendAjaxModalFormSvc.prototype);webshop.popup.svc.PopupUnlinkPaypalSvc.prototype.constructor=webshop.popup.svc.SendAjaxModalFormSvc;ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.unlinkPaypalSingleton={get:function(){var unlinkPaypalPopup=new ocBackbone.popup.UnlinkPaypalAjaxPopupModel();new ocBackbone.popup.UnlinkPaypalPopupView({model:unlinkPaypalPopup});this.get=function(){return unlinkPaypalPopup;}
return unlinkPaypalPopup;}};ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.ElevatedAuthenticationAjaxPopupModel=ocBackbone.popup.AjaxPopupModelRedir.extend({defaults:{url:'/webshop/ajaxLoginElevated.go?ajax=true&popup=true',formAction:'/webshop/ajaxLoginElevated.go?ajax=true&popup=true',successRedirectUrl:'/webshop/displaySettingsMenu.go',incorrectDataFormSelector:'#elevatedLoginPopup'},initialize:function(){this.authenticateSvc=new webshop.popup.svc.PopupAuthenticateUserSvc(this.defaults);this._updateUrl();this.on('change:successRedirectUrl',function(model,value,options){this.authenticateSvc.setSuccessRedirectUrl(value);this._updateUrl();}.bind(this));},login:function(data){return this.authenticateSvc.post(data,this);},ppLoginReturnHandler:function(url){var that=this;if(url.indexOf('/webshop/login.go')!==-1&&url.indexOf('success_redirect=')===-1){var redirectUrl=jQ('.js-paypal-login-success-redirect').val()||this.get('successRedirectUrl');if(redirectUrl){url=webshop.ajax.Util.addNewParameters(url,["success_redirect"],[redirectUrl]);}}
if(url.indexOf("/webshop/paypalAlreadyLinked.do")===-1&&url.indexOf("/webshop/paypalsignup.do")===-1){window.location.href=url;return;}
jQ.ajax({url:url,data:{ajax:true,popup:true},dataType:'html'}).done(function(response){var json=webshop.popup.utils.tryParseJSON(response),content;if(json){window.location.href=webshop.popup.utils.getRedirectPath(json);content="Redirecting...";}else{content=response;}
that.set({content:content});});},_updateUrl:function(){var uri=URI(this.defaults.url);if(this.get('successRedirectUrl')){uri.setQuery('success_redirect',this.get('successRedirectUrl'));}
this.set('url',uri.build().toString());}});ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.ElevatedAuthenticationPopupView=ocBackbone.popup.PopupView.extend({id:'elevatedAuthenticationPopup',events:{'submit #simpleLoginForm':'login','click #fbLoginButton':'fbLogin','click #js-paypalFallbackButton':'showPaypalFallback'},login:_.debounce(function(e){this.model.login(webshop.ajax.Util.getFormDataAsJSON(jQ(e.target)));return false;},1000,true),fbLogin:_.debounce(function(e){webshop.social.FacebookLoginConfirm.facebookLoginConfirmView.handleClick(e);return false;},1000,true),showPaypalFallback:function(e){e.preventDefault();var paypalFallback=ocBackbone.popup.regAndLoginMultiton.get().paypalFallback;paypalFallback.fetch();paypalFallback.show();},render:function(){ocBackbone.popup.PopupView.prototype.render.call(this);if(this.$('#recaptcha-ajax-wrapper').length>0){this.$('.popup').addClass('popupWithCaptcha');}
if(this.$('span.separator').length<=0){this.$('.popup').addClass('one-choice').position('center');}
return this;}}).extend(new ocBackbone.validation.Validation([{DOMSelectors:{formSelector:'#simpleLoginForm',submitButtonSelector:'#js-popupLoginButton',submitButtonValidClass:'btn-register',submitButtonInvalidClass:'btn-primary'},validationRules:new ocBackbone.validation.LoginValidation('#simpleLoginForm')}]));webshop=webshop||{};webshop.popup=webshop.popup||{};webshop.popup.svc=webshop.popup.svc||{};webshop.popup.svc.PopupAuthenticateUserSvc=function(options){webshop.popup.svc.SendAjaxModalFormSvc.call(this,options);};webshop.popup.svc.PopupAuthenticateUserSvc.prototype=Object.create(webshop.popup.svc.SendAjaxModalFormSvc.prototype);webshop.popup.svc.PopupAuthenticateUserSvc.prototype.constructor=webshop.popup.svc.SendAjaxModalFormSvc;ocBackbone=ocBackbone||{};ocBackbone.popup=ocBackbone.popup||{};ocBackbone.popup.elevatedAuthenticationSingleton={get:function(){var elevatedAuthenticationPopup=new ocBackbone.popup.ElevatedAuthenticationAjaxPopupModel();new ocBackbone.popup.ElevatedAuthenticationPopupView({model:elevatedAuthenticationPopup});this.get=function(){return elevatedAuthenticationPopup;};return elevatedAuthenticationPopup;}};(function(Backbone){'use strict';Backbone.Webshop.mixins.parseFormattedPrice=function(priceObject){function extractPriceFromPoundSymbol(priceWithCurrencySymbol){var priceWithPoundMatch=priceWithCurrencySymbol.match(/&pound;(.*)/);return priceWithPoundMatch!=null&&priceWithPoundMatch.length>1?priceWithPoundMatch[1]:null;}
function extractPriceFromPenceSymbol(priceWithCurrencySymbol){var priceWithPenceMatch=priceWithCurrencySymbol.match(/([0-9]+)p$/);if(priceWithPenceMatch!=null&&priceWithPenceMatch.length>1){if(priceWithPenceMatch[1].length==1){return'0.0'+priceWithPenceMatch[1];}else{return'0.'+priceWithPenceMatch[1];}}else{return null;}}
var priceWithCurrencySymbol=priceObject.currentPrice;if(!priceWithCurrencySymbol){return undefined;}
var priceWithoutPoundSymbol=extractPriceFromPoundSymbol(priceWithCurrencySymbol);if(priceWithoutPoundSymbol!=null){return stringToNumber(priceWithoutPoundSymbol);}else{var priceWithoutPenceSymbol=extractPriceFromPenceSymbol(priceWithCurrencySymbol);if(priceWithoutPenceSymbol!=null){return stringToNumber(priceWithoutPenceSymbol);}else{return stringToNumber(priceWithCurrencySymbol);}}};function stringToNumber(str){if(str==null||str.length==0||isNaN(str)){return null;}else{return Number(str);}}})(Backbone);(function(Backbone,_){'use strict';Backbone.Webshop.trolley.TrolleyItemModel=Backbone.Model.extend({idAttribute:'sku',defaults:{sku:''},basketItemEvents:{change:function(basketItem){this.set(basketItem.toJSON());},remove:function(){this.set({itemQuantity:0,error:'',itemPrice:''});}},bindEntityEvents:Backbone.Marionette.proxyBindEntityEvents,initialize:function(){this.basket=Backbone.Webshop.Basket.getInstance();this.bindBasketEvents();},bindBasketEvents:function(){this.bindEntityEvents(this.basket.findItem(this.get('sku')),this.basketItemEvents);},addToBasket:function(quantity){var trolleyData=this._buildTrolleyItemData();return this.basket.addFromTrolley(trolleyData,getAddStatus.call(this),quantity);},removeFromBasket:function(quantity){var trolleyData=this._buildTrolleyItemData();return this.basket.removeFromTrolley(trolleyData,quantity);},isEmpty:function(){return this.get('itemQuantity')===0;},_buildTrolleyItemData:function(){return _.extend(this.toJSON(),{listName:'Trolley sidebar',sectionTitle:'Trolley sidebar',pageType:'Trolley sidebar',price:this.parseFormattedPrice({currentPrice:this.get('itemCataloguePrice')}),pageComponentIdForBQU:Backbone.Webshop.trolley.analytics.mixin.PageComponentId(this.get('sku')),pageViewId:webshop.common.jsTopBodyVariables.pageViewId,analyticsPageType:'Trolley sidebar'});},parseFormattedPrice:Backbone.Webshop.mixins.parseFormattedPrice});function getAddStatus(){if(this.isEmpty()){return'EMPTY_BUT_ADDED';}
return'ADDED';}})(Backbone,_);(function(Backbone,ocBackbone,webshop){'use strict';ocBackbone=ocBackbone||{};ocBackbone.header=ocBackbone.header||{};ocBackbone.header.RegLogHeaderView=Backbone.View.extend({el:'#header',template:false,events:{'click #loginButton':'login','click #quickReg':'register'},login:function(e){e&&e.preventDefault();var successRedirectUrl=this.getSuccessRedirectForCurrentLocation();if(this.isSsoFullRedirectEnabled()){window.location.href='/webshop/login.go?success_redirect='+encodeURIComponent(successRedirectUrl);}else{var loginPopup=ocBackbone.popup.regAndLoginMultiton.get().regLogin;window.registrationSource='login_button';loginPopup.set('successRedirectUrl',successRedirectUrl);loginPopup.setSilentDefaultSubviewId('returningCustomer');loginPopup.show();}},register:function(e){e&&e.preventDefault();var successRedirectUrl=this.getSuccessRedirectForCurrentLocation();if(this.isSsoFullRedirectEnabled()){window.location.href=this.isContextKeepingEnabled()?'/webshop/quickReg.do':'/webshop/quickReg.do?success_redirect='+encodeURIComponent(successRedirectUrl);}else{var quickReg=ocBackbone.popup.regAndLoginMultiton.get().regLogin;window.registrationSource='register_button';quickReg.setSilentDefaultSubviewId('newCustomer');quickReg.show();var loginPopup=ocBackbone.popup.regAndLoginMultiton.get().regLogin;loginPopup.set('successRedirectUrl',successRedirectUrl);}},isSsoFullRedirectEnabled:function(){return Backbone.Webshop.mixins.isBetaFeatureEnabled('SSO_INTEGRATION')&&Backbone.Webshop.mixins.isBetaFeatureEnabled('SSO_FULL_REDIRECT');},isContextKeepingEnabled:function(){return Backbone.Webshop.mixins.isBetaFeatureEnabled('ACQUISITION_23586_CONTEXT_KEEPING');},getSuccessRedirectForCurrentLocation:function(){return webshop.common.jsTopBodyVariables.doNotRedirectAfterLogin?'':location.pathname+location.search;}});webshop=webshop||{};webshop.header=webshop.header||{};webshop.header.RegLogHeader={init:function(){new ocBackbone.header.RegLogHeaderView();}};})(Backbone,ocBackbone,webshop);webshop=window.webshop||{};webshop.common=webshop.common||{};webshop.common.Tooltip={showTooltip:function(){var eventSelector=jQ(this),tooltipSelector=eventSelector.data("tooltip");jQ(tooltipSelector).addClass('show').attr("aria-hidden","false");if(eventSelector.hasClass('js-fake-button')){webshop.common.Tooltip.placeTooltip(this,tooltipSelector);}},hideTooltip:function(){var eventSelector=jQ(this),tooltipSelector=eventSelector.data("tooltip");jQ(tooltipSelector).removeClass('show').attr("aria-hidden","true");},initTooltip:function(hoverParent){var hoverTrigger=jQ(hoverParent).find(".js-tt-trigger");hoverTrigger.hoverIntent({over:this.showTooltip,out:this.hideTooltip,timeout:200});hoverTrigger.on('focus',this.showTooltip);hoverTrigger.on('blur',this.hideTooltip);},placeTooltip:function(eventObject,tooltipSelector){var buttonID=eventObject.id;if(buttonID==="placeOrder-top-trigger"){jQ(tooltipSelector).addClass('placeOrderWarning').removeClass('footer');}else if(buttonID==="placeOrder-btm-trigger"){jQ(tooltipSelector).addClass('footer').removeClass('placeOrderWarning');}}};webshop=webshop||{};webshop.accountSettings=webshop.accountSettings||{};webshop.accountSettings.editLoginDetails={init:function(){new ocBackbone.accountSettings.editLoginDetailsView({el:'#js-editLoginDetailsPage'});}};webshop=webshop||{};webshop.accountSettings=webshop.accountSettings||{};webshop.accountSettings.facebookSettings={init:function(){new ocBackbone.accountSettings.facebookSettingsView({el:'#facebookSettingsPage'});}};webshop.accountSettings=webshop.accountSettings||{};webshop.accountSettings.memberBenefits={init:function(){jQ(webshop.common.Tooltip.initTooltip(".js-ext-partner-discount-limit"));jQ(webshop.common.Tooltip.initTooltip(".js-ext-partner-discount-percentage"));jQ(webshop.common.Tooltip.initTooltip(".js-ext-partner-discount-free-delivery"));}};webshop=webshop||{};webshop.accountSettings=webshop.accountSettings||{};webshop.accountSettings.paypalSettings={init:function(){new ocBackbone.accountSettings.paypalSettingsView({el:'#paypalSettings'});}};ocBackbone=ocBackbone||{};ocBackbone.accountSettings=ocBackbone.accountSettings||{};ocBackbone.accountSettings.editLoginDetailsView=Backbone.View.extend({initialize:function(){Backbone.$('#changePasswordForm').validate(ocBackbone.validation.accountChangePasswordValidation);Backbone.$('#changeUsernameForm input').one("focus",function(){Backbone.$(".js-validation-error").remove()});}});ocBackbone=ocBackbone||{};ocBackbone.accountSettings=ocBackbone.accountSettings||{};ocBackbone.accountSettings.facebookSettingsView=Backbone.View.extend({events:{'click #facebookUnlink':'facebookUnlink'},facebookUnlink:function(e){var $form=jQ('#facebookUnlinkForm'),$anchor=jQ(e.target),needsPassword=$anchor.attr('data-nopassword')==="true",unlinkFacebookPopup;if(needsPassword){unlinkFacebookPopup=ocBackbone.popup.unlinkFacebookSingleton.get();unlinkFacebookPopup.show();unlinkFacebookPopup.fetch();}else{$form.submit();}
return false;}});ocBackbone=ocBackbone||{};ocBackbone.accountSettings=ocBackbone.accountSettings||{};ocBackbone.accountSettings.paypalSettingsView=Backbone.View.extend({events:{'click #unlinkPaypalAccount':'unlinkPaypalAccount'},unlinkPaypalAccount:function(e){var $form=jQ('#paypalUnlinkForm');var $anchor=jQ(e.target);var needsPassword=$anchor.attr('data-nopassword')==="true";if(needsPassword){var unlinkPaypalPopup=ocBackbone.popup.unlinkPaypalSingleton.get();unlinkPaypalPopup.show();unlinkPaypalPopup.fetch();}else{$form.submit();}
return false;}});(function(Backbone){'use strict';var FavouritesEventTracker=Backbone.Marionette.Object.extend({initialize:function(){webshop.gtm.registerEventSource(this);},triggerGtmEvent:function(action,label,value){this.trigger('gtm:uaEvent',{category:'Favourites',action:action,label:label,value:value});},triggerPageEvent:function(description,fields){Backbone.Webshop.analytics.WebshopAnalytics.reportPageEvent(description,fields);},triggerEvent:function(eventName){this.triggerGtmEvent(eventName);this.triggerPageEvent('Favourites '+eventName);},triggerEventWithSourceAndSku:function(eventName,src,sku){this.triggerGtmEvent(eventName,'From '+src);this.triggerPageEvent(eventName,{SOURCE:src,SKU:sku});},triggerAddedtoFavouritesBop:function(sku){this.triggerEventWithSourceAndSku('Added to favourites','Back of Pack',sku)},triggerRemovedFromFavouritesBop:function(sku){this.triggerEventWithSourceAndSku('Removed from favourites','Back of Pack',sku)},triggerAddedtoFavouritesFop:function(sku){this.triggerEventWithSourceAndSku('Added to favourites','Front of Pack',sku)},triggerRemovedFromFavouritesFop:function(sku){this.triggerEventWithSourceAndSku('Removed from favourites','Front of Pack',sku)}});Backbone.Webshop.FavouritesEventTracker={getInstance:_.once(function(){return new FavouritesEventTracker})};})(Backbone);