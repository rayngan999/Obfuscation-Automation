define(['module.base','session','jquery','mustache'],function(Module,session,$,Mustache){Module.getcurrentlocationip=function(){var self=this,_getPlacecode=function(errorHandler){return _renderModule(JSON.parse(decodeURIComponent(_getCookie('pelm_ip'))));},_getCookie=function getCookie(cname){var name=cname+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1);if(c.indexOf(name)==0)return c.substring(name.length,c.length);}
return"";},_handleError=function(err){$('#current-location-ip').addClass('error');$('#current-location-ip').show();},_convert_fahrenheit=function(c_temp){c_temp=Number(c_temp);var f_temp=(c_temp*(9/5))+32;return Math.round(f_temp);},_toggle_temp=function(temp){if(temp===null){temp=window._config.tempunit;}
if(temp==='c'){$('#current-location .current-location-current-temp-c').show();$('#current-location .current-location-current-temp-f').hide();$('#current-location-ip .current-location-current-temp-c').show();$('#current-location-ip .current-location-current-temp-f').hide();}else if(temp==='f'){$('#current-location .current-location-current-temp-f').show();$('#current-location .current-location-current-temp-c').hide();$('#current-location-ip .current-location-current-temp-f').show();$('#current-location-ip .current-location-current-temp-c').hide();}},_renderModule=function(loc_data){try{JSON.parse(JSON.stringify(loc_data));}catch(e){$('#current-location-ip').addClass('error');$('#current-location-ip').show();return false;}
var cc=typeof loc_data.country!='undefined'&&loc_data.country?loc_data.country.toLowerCase():'';if(cc!="ca"&&cc!="us"&&cc!="de"&&cc!="uk"&&cc!="gb"){loc_data.prov="";}
if(!loc_data.code){return false;}
var locale=_config.locale.split('_');locale[1]=locale[1].toUpperCase();locale=locale.join('-');loc_data.locale=locale;var current_data_url,successCallback;if(_config.current_location&&_config.current_location.data_source&&_config.current_location.data_source=='diad'){current_data_url=window._config.url_base_diad_obs
+loc_data.code+'?textform=short&locale='+locale+'&unit=metric';successCallback=self._successCallbackDiad;}else{current_data_url=window.url_countrycode+'/api/obsdata/'+loc_data.code;successCallback=self._successCallbackObsData;}
$.ajax({url:current_data_url,timeout:100000,headers:{'x-request-id':window.twn.getRequestId(),'x-session-id':window.twn.getSessionId()},success:function(wdata){successCallback(wdata,loc_data);},tryCount:0,retryLimit:2,error:function(xhr,textStatus){if(textStatus=='timeout'||[500,503,504].includes(xhr.status)){this.tryCount++;if(this.tryCount<=this.retryLimit){var ajaxOpts=this;setTimeout(function(){$.ajax(ajaxOpts);},1500);return;}}
self._done({wx_data:false});}});};self._successCallbackDiad=function(wdata,loc_data){var translatedData=loc_data||{};if(wdata){var obs=wdata.observation||{};translatedData.wx_data=true;translatedData.icon=(obs.weatherCode&&obs.weatherCode.icon?obs.weatherCode.icon:'');translatedData.temp_c=typeof obs.temperature!=='undefined'?obs.temperature:'';translatedData.temp_f=typeof obs.temperature!=='undefined'?_convert_fahrenheit(obs.temperature):'';translatedData.image_url=window._config.image_url;translatedData.wxcondition=(obs.weatherCode&&obs.weatherCode.text?obs.weatherCode.text:'');translatedData.condition=(obs.weatherCode&&obs.weatherCode.text?obs.weatherCode.text:'');translatedData.lbl_current_weather=window._config.lbl_current_weather;translatedData.lbl_view_forecast=window._config.lbl_view_forecast;translatedData.lbl_updatetime=window._config.lbl_updatetime;var options={weekday:'short',month:'short',day:'numeric',hour:'numeric',minute:'numeric'};if(wdata.observation&&wdata.observation.time&&wdata.observation.time.utc&&loc_data.locale){var localTime=wdata.observation.time.utc.split(/[^0-9]/);var updatetime_local=new Date(Date.UTC(localTime[0],localTime[1]-1,localTime[2],localTime[3],localTime[4]));translatedData.updatetime=updatetime_local.toLocaleDateString(loc_data.locale,options);}else{translatedData.updatetime='';}}else{translatedData.wx_data=false;}
self._done(translatedData);};self._successCallbackObsData=function(wdata,loc_data){var translatedData=loc_data||{};if(wdata){translatedData.wx_data=true;wdata=$.parseJSON(wdata);translatedData.icon=wdata.icon||'';translatedData.temp_c=typeof wdata.temperature!=='undefined'?wdata.temperature:'';translatedData.temp_f=typeof wdata.temperature!=='undefined'?_convert_fahrenheit(wdata.temperature):'';translatedData.image_url=window._config.image_url;translatedData.wxcondition=wdata.wxcondition||'';translatedData.condition=wdata.wxcondition||'';translatedData.lbl_current_weather=window._config.lbl_current_weather;translatedData.lbl_view_forecast=window._config.lbl_view_forecast;translatedData.lbl_updatetime=window._config.lbl_updatetime;translatedData.updatetime=wdata.updatetime||'';}else{translatedData.wx_data=false;}
self._done(translatedData);};self._done=function(data){var template;if(typeof window.templates.current_location=='object')
template=window.templates.current_location[0];else
template=window.templates.current_location;var output=Mustache.render(template,data,{});$('#current-location-ip').html(output);$('#current-location-ip .user-current-location').append('<div class="current-location-updatedon">'+data.lbl_updatetime+' '+data.updatetime+'</div>');if(data.wx_data){if(session.fld('pelm_unit')!==undefined&&session.fld('pelm_unit')!==null){_toggle_temp(session.fld('pelm_unit'));}else{_toggle_temp(window._config.tempunit);}}else{return;}
$('#current-location-ip').show();};self.tpl_main='current_location';self.init=function(elm){_getPlacecode(_handleError);};};return Module.factory('getcurrentlocationip');});;