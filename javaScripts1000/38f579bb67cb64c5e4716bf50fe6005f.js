(function($){(function(){var storageAvailable=true;try{if(typeof window.localStorage!=='undefined'){window.localStorage.setItem('testLocalStorage','success');window.localStorage.removeItem('testLocalStorage');}}catch(err){storageAvailable=false;}
if(!storageAvailable||typeof window.localStorage==='undefined'||typeof window.sessionStorage==='undefined')(function(){window.jsStorage={};var Storage=function(type){function create(name,value,days,cookieAvailable){function createCookie(name,value,days){var date,expires;if(days){date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString();}else{expires="";}
document.cookie=name+"="+value+expires+"; path=/";}
function createMap(name,value){jsStorage[name]=value;}
if(cookieAvailable){createCookie(name,value,days);}else{createMap(name,value);}}
function readCookie(name){var nameEQ=name+"=",ca=document.cookie.split(';'),i,c;for(i=0;i<ca.length;i++){c=ca[i];while(c.charAt(0)==' '){c=c.substring(1,c.length);}
if(c.indexOf(nameEQ)==0){return c.substring(nameEQ.length,c.length);}}
return null;}
function readMap(name){return jsStorage[name];}
function read(name){var cookie,map;cookie=readCookie(name);map=readMap(name);if(_.isEmpty(cookie)){if(_.isEmpty(map)){return null;}else{return map;}}else{if(_.isEmpty(map)){return cookie;}else{return JSON.stringify(_.assign(JSON.parse(cookie),JSON.parse(map)));}}}
function setData(data,cookieAvailable){if(type==='session'){data=JSON.stringify(data);window.name=data;}else{var name='localStorage';if(cookieAvailable){var mapValue=JSON.parse(readMap(name));data=_(data).omit(_(mapValue).keys().value()).value();}else{var cookieValue=JSON.parse(readCookie(name));data=_(data).omit(_(cookieValue).keys().value()).value();}
data=JSON.stringify(data);create(name,data,365,cookieAvailable);}}
function clearData(){if(type==='session'){window.name='';}else{create('localStorage','',365,true);create('localStorage','',undefined,false);}}
function getData(){var data=type==='session'?window.name:read('localStorage');try{data=JSON.parse(data)||{};}catch(e){data={};}
return data;}
var data=getData();return{length:0,clear:function(){data={};this.length=0;clearData();},getItem:function(key){return data[key]===undefined?null:data[key];},key:function(i){var ctr=0;for(var k in data){if(ctr===i)return k;else ctr++;}
return null;},removeItem:function(key,cookieAvailable){delete data[key];this.length--;setData(data);},setItem:function(key,value,cookieAvailable){data[key]=value+'';this.length++;setData(data,cookieAvailable);}};};if(storageAvailable){if(typeof window.localStorage==='undefined')window.localStorage=new Storage('local');if(typeof window.sessionStorage==='undefined')window.sessionStorage=new Storage('session');}else{window.privateLocalStorage=new Storage('local');window.privateSessionStorage=new Storage('session');}})();})();(function(){var _=this._;var Backbone=this.Backbone;function S4(){return(((1+Math.random())*0x10000)|0).toString(16).substring(1);};function guid(){return(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());};Backbone.LocalStorage=window.Store=function(name,cookieAvailable){this.name=name;this.cookieAvailable=_.isUndefined(cookieAvailable)?true:cookieAvailable;var store=this.localStorage().getItem(this.name)||"";this.records=(store&&store.split(","))||[];};_.extend(Backbone.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","),this.cookieAvailable);},safeGet:function(name){var obj=this.localStorage().getItem(name);if(!obj){return'{}';}
return obj;},create:function(model){if(!model.id){model.id=guid();model.set(model.idAttribute,model.id);}
this.localStorage().setItem(this.name+"-"+model.id,JSON.stringify(model),this.cookieAvailable);this.records.push(model.id.toString());this.save();return model.toJSON();},update:function(model){this.localStorage().setItem(this.name+"-"+model.id,JSON.stringify(model),this.cookieAvailable);if(!_.include(this.records,model.id.toString()))this.records.push(model.id.toString());this.save();return model.toJSON();},find:function(model){return JSON.parse(this.safeGet(this.name+"-"+model.id));},findAll:function(){return _(this.records).chain().map(function(id){var obj=JSON.parse(this.safeGet(this.name+"-"+id));return _.isEmpty(obj)?false:obj;},this).compact().value();},destroy:function(model){this.localStorage().removeItem(this.name+"-"+model.id,this.cookieAvailable);this.records=_.reject(this.records,function(record_id){return record_id==model.id.toString();});this.save();return model;},localStorage:function(){var storage;if(window.privateLocalStorage){storage=window.privateLocalStorage;}else{storage=localStorage;}
return storage;}});Backbone.LocalStorage.sync=window.Store.sync=Backbone.localSync=function(method,model,options,error){var store=model.localStorage||model.collection.localStorage,resp,error="Record not found",syncDfd=$.Deferred&&$.Deferred();if(typeof options=='function'){options={success:options,error:error};}
try{switch(method){case"read":resp=model.id!=undefined?store.find(model):store.findAll();break;case"create":resp=store.create(model);break;case"update":resp=store.update(model);break;case"delete":resp=store.destroy(model);break;}}catch(e){error=e;}
if(resp){options.success(resp);if(syncDfd){syncDfd.resolve();}}else{options.error("Record not found");if(syncDfd){syncDfd.reject();}}
return syncDfd&&syncDfd.promise();};Backbone.SessionStorage=window.SessionStore=function(name){this.name=name;var store=this.sessionStorage().getItem(this.name)||"";this.records=(store&&store.split(","))||[];};_.extend(Backbone.SessionStorage.prototype,{save:function(){this.sessionStorage().setItem(this.name,this.records.join(","));},safeGet:function(name){var obj=this.sessionStorage().getItem(name);if(!obj){return'{}';}
return obj;},create:function(model){if(!model.id){model.id=guid();model.set(model.idAttribute,model.id);}
this.sessionStorage().setItem(this.name+"-"+model.id,JSON.stringify(model));this.records.push(model.id.toString());this.save();return model.toJSON();},update:function(model){this.sessionStorage().setItem(this.name+"-"+model.id,JSON.stringify(model));if(!_.include(this.records,model.id.toString()))this.records.push(model.id.toString());this.save();return model.toJSON();},find:function(model){return JSON.parse(this.safeGet(this.name+"-"+model.id));},findAll:function(){return _(this.records).chain().map(function(id){var obj=JSON.parse(this.safeGet(this.name+"-"+id));return _.isEmpty(obj)?false:obj;},this).compact().value();},destroy:function(model){this.sessionStorage().removeItem(this.name+"-"+model.id);this.records=_.reject(this.records,function(record_id){return record_id==model.id.toString();});this.save();return model;},sessionStorage:function(){var storage;if(window.privateLocalStorage){storage=window.privateSessionStorage;}else{storage=sessionStorage;}
return storage;}});Backbone.SessionStorage.sync=Backbone.sessionSync=function(method,model,options,error){var store=model.sessionStorage||model.collection.sessionStorage,resp,error="Record not found",syncDfd=$.Deferred&&$.Deferred();if(typeof options=='function'){options={success:options,error:error};}
try{switch(method){case"read":resp=model.id!=undefined?store.find(model):store.findAll();break;case"create":resp=store.create(model);break;case"update":resp=store.update(model);break;case"delete":resp=store.destroy(model);break;}}catch(e){error=e;}
if(resp){options.success(resp);if(syncDfd)syncDfd.resolve();}else{options.error(error);if(syncDfd)syncDfd.reject();}
return syncDfd&&syncDfd.promise();};Backbone.ajaxSync=Backbone.sync;Backbone.getSyncMethod=function(model){if(model.localStorage||(model.collection&&model.collection.localStorage)){return Backbone.LocalStorage.sync;}
if(model.sessionStorage||(model.collection&&model.collection.sessionStorage)){return Backbone.SessionStorage.sync;}
return Backbone.ajaxSync;};Backbone.sync=function(method,model,options,error){return Backbone.getSyncMethod(model).apply(this,[method,model,options,error]);};})();})(jQuery);(function(Backbone,_,$){'use strict';Backbone.Webshop.LocalStorageModel=Backbone.Model.extend({cookieAvailable:true,getOption:Backbone.Marionette.proxyGetOption,initialize:function(){if(_.isEmpty(this.id)){throw'Property "this.id" must be set.';}
this.localStorage=new Backbone.LocalStorage(this.id,this.getOption('cookieAvailable'));var cachedModel=this.localStorage.find(this);if(!_.isObject(cachedModel)){this.localStorage.create(this);}else{this.set(this.parse(cachedModel));}},set:function(key,val,options){return set.call(this,this.localStorage,key,val,options);},fetch:function(options){return fetch.call(this,options);},shouldFetchData:function(){return shouldFetchData.call(this);}});Backbone.Webshop.SessionStorageModel=Backbone.Model.extend({initialize:function(){if(_.isEmpty(this.id)){throw'Property "this.id" must be set.';}
this.sessionStorage=new Backbone.SessionStorage(this.id);var cachedModel=this.sessionStorage.find(this);if(!_.isObject(cachedModel)){this.sessionStorage.create(this);}else{this.set(this.parse(cachedModel));}},set:function(key,val,options){return set.call(this,this.sessionStorage,key,val,options);},fetch:function(options){return fetch.call(this,options);},shouldFetchData:function(){return shouldFetchData.call(this);}});function set(storage,key,val,options){var setResult=Backbone.Model.prototype.set.call(this,key,val,options);if(storage){storage.update(this);}
return setResult;}
function fetch(options){options=options?_.clone(options):{};var deferred=new $.Deferred();if(!this.shouldFetchData()){return deferred.resolve(this.toJSON()).promise();}
var success=options.success;if(options.parse===void 0)options.parse=true;var model=this;options.success=function(resp){if(!model.set(model.parse(resp,options),options))return false;if(success)success(model,resp,options);model.trigger('sync',model,resp,options);}.bind(this);Backbone.ajaxSync('read',this,options).done(function(){deferred.resolve(this.toJSON())}.bind(this));return deferred.promise();}
function shouldFetchData(){var defaults=this.defaults||{};var model=this.toJSON()||{};if(_.keys(defaults).length!==_.keys(model).length){return false;}
for(var key in model){if(model[key]!=defaults[key]){return false;}}
return true;}})(Backbone,_,jQuery);(function(Backbone,_,$){'use strict';Backbone.Webshop.LocalStorageCollection=Backbone.Collection.extend({cookieAvailable:true,getOption:Backbone.Marionette.proxyGetOption,initialize:function(){if(_.isEmpty(this.id)){throw'Property "this.id" must be set.';}
this.localStorage=new Backbone.LocalStorage(this.id,this.getOption('cookieAvailable'));var cachedCollection=this.localStorage.find(this);if(_.isEmpty(cachedCollection)){this.localStorage.create(this);}else{this.reset(cachedCollection);}},set:function(models,options){return set.call(this,this.localStorage,models,options);},fetch:function(options){return fetch.call(this,options);}});Backbone.Webshop.SessionStorageCollection=Backbone.Collection.extend({initialize:function(){if(_.isEmpty(this.id)){throw'Property "this.id" must be set.';}
this.sessionStorage=new Backbone.SessionStorage(this.id);var cachedCollection=this.sessionStorage.find(this);if(_.isEmpty(cachedCollection)){this.sessionStorage.create(this);}else{this.reset(cachedCollection);}},set:function(models,options){return set.call(this,this.sessionStorage,models,options);},fetch:function(options){return fetch.call(this,options);}});function set(storage,models,options){var result=Backbone.Collection.prototype.set.call(this,models,options);if(storage){storage.update(this);}
return result;}
function fetch(options){options=options?_.clone(options):{};var deferred=new $.Deferred();if(!this.isEmpty()){return deferred.resolve(this.toJSON()).promise();}
var success=options.success;options.success=function(model,resp){model=this.parse(model);this.reset(model);if(success)success(model,resp,options);this.trigger('sync',this,model,options);}.bind(this);Backbone.ajaxSync('read',this,options).done(function(){deferred.resolve(this.toJSON())}.bind(this));return deferred.promise();}})(Backbone,_,jQuery);