define(["modules/id.core","modules/id.cookie"],function(e,t){"use strict";e.utils.log("loading id.tracking-manager.js");var i=new t,n=function(){this.conf={trackingModules:e.configuration.trackingFeatures,uuidName:"cua_uuid",newUser:"new_user",maxTrackingQueueSize:20,trackingQueueTimer:1e4};var t=this,n=[],s=!1,o=document.createElement("div"),a=document.createElement("a");this.getReferrer=function(){return o.innerText=this.getUnsafeDocumentReferrer(),o.innerHTML},this.getUnsafeDocumentReferrer=function(){return document.referrer&&""!==document.referrer?document.referrer:""},this.getReferrerDomain=function(){var e=this.getReferrer(),t="";return e&&""!==e?(a.href=e,t=a.hostname):t},this.getUUidFromPersistence=function(){return i.get(this.conf.uuidName)},this.getNewUserFromPersistence=function(){return i.get(this.conf.newUser)},this.trackingQueue=function(e){return e&&(n=e),n},this.trackingQueueCurrentlyProcessing=function(e){return(e===!0||e===!1)&&(s=e),s},this.getWinHref=function(){return window.location.href&&""!==window.location.href?window.location.href:""},this.getTimestamp=function(){return Date.now()},this.trackEvent=function(t){var i=this.extendTrackingCallData(t);this.validateTrackingData(i)?e.configuration.features&&e.configuration.features.idt_tracking&&this.addToTrackingQueue(this.transformCuaTrackingObjectToIdTTrackingObject(i)):e.utils.log("CUA tracking FAILED! Invalid data structure for call: ",t,i)},this.extendTrackingCallData=function(e){var t,i=this.getCommonPayload()||{},n=e&&e.length||0;for(t=0;n>t;t+=1)e[t].payload=this.mergePayloads(e[t].payload,i);return e},this.validateTrackingData=function(t){var i,n,s,o,a=t&&t.length||0,r=["PAGEVIEW","INTERACTION"],d=["page-view","event","user-interaction","session","navigation-timing","user-insights"],l=["collector","ActionBox","Formular","Comment","container-click","element-click","element-active-view"],c=["group","pageType","onlineId","channel","category","url","documentLabel","clientId","uid","userAgent","newUser","userType","eventGeneratedTimestamp","pageViewId"],h=c.length;if(0===a||!e.utils.isArray(t))return e.utils.log("WARNING: CUA tracking data should always be an array with at least one object inside."),!1;for(i=0;a>i;i+=1){if(o=t[i],s=o.payload,!s)return e.utils.log("WARNING: CUA call should have at least a payload set"),!1;for(n=0;h>n;n+=1)if(!s.hasOwnProperty(c[n]))return e.utils.log("WARNING: CUA tracking data common payload is missing mandatory value for key '"+c[n]+"'"),!1;if(!e.utils.inArray(o.event,r))return e.utils.log("WARNING: CUA tracking data has an invalid event '"+o.event+"'."),!1;if(!e.utils.inArray(o.index,d))return e.utils.log("WARNING: CUA tracking data has an invalid index '"+o.index+"'."),!1;if(void 0!==o.type&&!e.utils.inArray(o.type,l))return e.utils.log("WARNING: CUA tracking data has an invalid type '"+o.type+"'."),!1}return!0},this.getCommonPayload=function(){var t=this.getUUidFromPersistence()||"not-available-"+Date.now(),i=this.getNewUserFromPersistence();return{group:e.configuration.page.group,pageType:e.configuration.page.pageType,onlineId:e.configuration.page.onlineId||0,channel:e.configuration.page.deviceType,category:e.configuration.page.category,categoryId:e.configuration.page.categoryId,url:this.getWinHref(),documentLabel:e.configuration.page.documentLabel,clientId:e.configuration.page.clientId,uid:t,userAgent:navigator&&navigator.userAgent||"",newUser:i,userType:e.configuration.page.userType,referrer:this.getReferrer(),referrerDomain:this.getReferrerDomain(),eventGeneratedTimestamp:this.getTimestamp(),pageViewId:e.configuration.page.pageViewId}},this.mergePayloads=function(t,i){var n,s={};e.utils.extend(s,i);for(n in t)t.hasOwnProperty(n)&&(s[n]=t[n],i&&i.hasOwnProperty(n)&&e.utils.log("WARNING: CUA call overwrites the common payload property '"+n+"'. Make sure this is intentional."));return s},this.transformCuaTrackingObjectToIdTTrackingObject=function(e){var t,i=[],n=e&&e.length;for(t=0;n>t;t+=1)i[t]={type:this.getNormalizedTypeForIdT(e[t]),payload:e[t].payload};return i},this.getNormalizedTypeForIdT=function(t){return e.utils.stringToCamelCase(void 0!==t.payload.hasAdblock?"user-adblock":t.type||t.index)},this.addToTrackingQueue=function(e){n=n.concat(e),n.length>=t.conf.maxTrackingQueueSize&&t.submitTrackingQueue(),s===!1&&t.startTrackingQueueProcessing()},this.startTrackingQueueProcessing=function(){t.handleEventListenersForQueue("addEventListener"),s=setInterval(function(){t.submitTrackingQueue()},t.conf.trackingQueueTimer)},this.stopTrackingQueueProcessing=function(){t.handleEventListenersForQueue("removeEventListener"),clearInterval(s),s=!1},this.handleEventListenersForQueue=function(e){var i="addEventListener"===e?"addEventListener":"removeEventListener";window[i]&&(document[i]("visibilitychange",t.submitTrackingQueue,!1),window[i]("pagehide",t.submitTrackingQueue,!1),window[i]("beforeunload",t.submitTrackingQueue,!1))},this.submitTrackingQueue=function(){var e=n.splice(0,t.conf.maxTrackingQueueSize);e.length>0&&t.sendTrackingDataIdT(e),0===n.length&&t.stopTrackingQueueProcessing()},this.sendTrackingDataIdT=function(t){var i,n,s,o="https://idat.production.ippen.space/idat",a=JSON.stringify(t);try{if(i=new window.Blob([a],{type:"text/plain;charset=UTF-8"}),navigator.sendBeacon(o,i),e.configuration.isDebugMode&&!window.jasmine)for(s=0;t.length>s;s+=1)e.utils.log("beacon idt-tracking type["+s+"]="+t[s].type)}catch(r){try{n=new XMLHttpRequest,n.open("POST",o,!1),n.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),n.send(a)}catch(d){e.utils.log("idt-tracking failed, neither beacon, nor synchronous xhr did work :(")}}},this.hashCode=function(e){var t,i,n=0,s=e.length;if(0===s)return n;for(t=0;s>t;t+=1)i=e.charCodeAt(t),n=(n<<5)-n+i,n&=n;return n},this.init=function(){var t,i=this.conf.trackingModules,n=[];for(t in i)i.hasOwnProperty(t)&&n.push(e.module.moduleDefinition(t,"modules/t/id."+t));e.initComponents("tracking",n)},e.event.subscribe(e.event.constants.CUA.TRACK,function(e){t.trackEvent(e)})};return n});