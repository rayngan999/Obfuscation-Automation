zdLogger=function(h,f,F,y,l){this.fp=l;var x=this;this.clientId=f.clientId;this.currSocket=null;this.ehLogsToSend=[];this.SU_LoggerServiceHttp="";this.SU_BaseUrlServiceHttp="";this.cookiesEnabled=A();this.timestamp=f.timestamp;this.serverTime=f.serverTime;this.initDate=f.startDate;var b=function(I){for(var J in I){if(I.hasOwnProperty(J)&&(I[J]===undefined||I[J]===""||I[J]===null)){delete I[J]}else{if(typeof(I[J])!="string"){I[J]=JSON.stringify(I[J])}}}};d(f.initialToken);this.checkCompatabilityFunctions=function(){if(!Date.prototype.toISOString){(function(){function I(K){var J=String(K);if(J.length===1){J="0"+J}return J}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+I(this.getUTCMonth()+1)+"-"+I(this.getUTCDate())+"T"+I(this.getUTCHours())+":"+I(this.getUTCMinutes())+":"+I(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1000).toFixed(3)).slice(2,5)+"Z"}}())}};function A(){var I=navigator.cookieEnabled;if(!I){document.cookie="testcookie";I=document.cookie.indexOf("testcookie")!=-1}return I}function v(J,L,I){var K="expires="+I.toUTCString();document.cookie=J+"="+L+";"+K+";path=/"}function a(J){var L=J+"=";var I=document.cookie.split(";");for(var K=0;K<I.length;K++){var M=I[K];while(M.charAt(0)==" "){M=M.substring(1,M.length)}if(M.indexOf(L)==0){return M.substring(L.length,M.length)}}return null}function D(I){var J=new Date();J.setTime(J.getTime()+30*60*60*1000);v("zdSessionId_"+x.clientId,I,J)}function E(){var I=a("zdSessionId_"+f.clientId);if(!I){I=F.generateUuid();D(I)}return I}function m(L){if(L&&x.SU_BaseUrlServiceHttp.indexOf(L.origin)>-1&&typeof(L.data)=="string"){var K=L.data.split("{:}");if(K[0]){var I=K[0].split(":");if(I[0]=="ZoomdWidgetLogger"){var J={};switch(I[1]){case"StartSession":try{J=JSON.parse(K[3])}catch(L){}x.startSession(K[1],K[2],J);break;case"StopSession":x.stopSession(K[1]);break;case"LogEvent":try{J=JSON.parse(K[2])}catch(L){}x.logEvent(K[1],J,K[3]);break;case"SetTime":x.setTime(K[1]);break}}}}}this.init=function(J){var I=function(){return{clientId:f.clientId,clientSiteUrl:(document.URL),clientPageTitle:h("head > title",document).text(),zoom:F.getZoom(),sessionId:f.sessionId,resolution:screen.availWidth+"X"+screen.availHeight,language:f.Language,referrer:document.referrer,userId:f.userId,abGroup:f.abGroup,userAgent:navigator.userAgent||navigator.vendor||window.opera||"",environment:f.environment,widgetMinorVersion:f.widgetVersion,platform:f.Platform?f.Platform:"",ver:f.Version,injectorVersion:f.injectorVersion,abTesting:f.Platform==="codefuel"?"perion":"zoomd",clientIpAddress:f.clientIpAddress,isMobile:window.matchMedia("only screen and (max-width: 760px)").matches,cookiesEnabled:x.cookiesEnabled}};if(window.addEventListener){window.addEventListener("message",m,false)}else{window.attachEvent("onmessage",m)}this.startSession("PageSession","sessionId",I());if(f.JsInject){F.loadScript(f.JsInject+"?userId="+f.userId,"customJS")}x.checkCompatabilityFunctions();e();if(J){J()}return x};function C(M){y.emit(M.action,M);if(f.EventsTargetsMappings==null||f.EventsTargetsMappings.length==0||f.EventsTargetsMappings.some(function(O){return O.match.action==="*"})==false){g(M);return}var L=f.EventsTargetsMappings.filter(function(O){return Object.keys(O.match).every(function(P){return O.match[P]==="*"||new RegExp(O.match[P]).test(M[P]||"")})});for(var K=0;K<L.length;++K){var I=L[K].targets;if(I.length==0){g(M);return}for(var J=0;J<I.length;++J){var N=I[J];switch(N.type){case"EventHubs":g(M);break;case"Adobe":H(M,N);break;case"Google":z(M,N);break;case"GoogleTagManager":k(M,N);break}}}}function H(K,J){if(h.isFunction(window.s_gi)&&window.s&&typeof(window.s)=="object"&&h.isFunction(window.s.track)){var I=t(J,K);if(!h.isEmptyObject(I)){Object.keys(I).forEach(function(L){window.s[L]=I[L]});window.s.track()}}}function z(K,J){if(h.isFunction(window.ga)){var I=t(J,K);if(!h.isEmptyObject(I)){if(I.hasOwnProperty("eventAction")&&I.eventAction){I.eventAction=I.eventAction.toLowerCase()}if(I.hasOwnProperty("eventLabel")&&I.eventLabel){I.eventLabel=I.eventLabel.toLowerCase()}ga(function(L){if(L){L.send(I.hitType,I)}else{var M=u();if(M){M.send(I.hitType,I)}else{ga("send",I)}}})}}}function u(){var J=window.ga.getAll();if(J){var I=J[0];if(I){return I}}return undefined}function k(K,J){var L=J.dataLayerName||"dataLayer";if(Array.isArray(window[L])){var I=t(J,K);if(!h.isEmptyObject(I)){if(I.hasOwnProperty("GA_event_action")&&I.GA_event_action){I.GA_event_action=I.GA_event_action.toLowerCase()}if(I.hasOwnProperty("GA_event_label")&&I.GA_event_label){I.GA_event_label=I.GA_event_label.toLowerCase()}window[L].push(I)}}}function t(Q,M){var P={};var N=Object.keys(Q.action);if(N.length>0){for(var I=0;I<N.length;++I){var S=N[I];var R=Q.action[S];if(/event\.((?:\w+\.?)+)/g.test(R)){var O=R;var L=new RegExp(/event\.((?:\w+\.?)+)/g);var J,X,V,K;while((X=L.exec(O))!==null){J=X[1];K="";var W=J.indexOf(".")+1;if(W>0){K=J.substring(W);J=J.substring(0,W-1)}V=M[J]||"";if(W>0&&K.length>0){try{var U=JSON.parse(V);V=U[K]}catch(T){}}R=R.replace(X[0],V)}}P[S]=R}}return P}function g(K){try{K=j(K);var I=w();if(!I){x.ehLogsToSend.push(K);q();return}var J=f.eventHubsEndpoint+"/messages";h.ajax({url:J,method:"POST",contentType:"application/atom+xml;type=entry;charset=utf-8",crossDomain:true,headers:{Authorization:I,sourcesenderId:"3",clientId:'"'+x.clientId+'"',action:K.action},data:JSON.stringify(K),error:function(M,O,N){if(F.LogError&&M.status>0){F.LogError("zdLogger: general error sending to events hub.",{jqXHRstatusText:M.statusText,jqXHRstatusCode:M.status,errorThrown:N,statusText:O,clientId:x.clientId,action:K.action,requestUrl:J,token:I})}}})}catch(L){if(F.LogError){F.LogError("zdLogger: error sending to events hub.",{exception:L.message,clientId:x.clientId,action:K.action,requestUrl:J,token:I})}}}function j(J){if(f.EventsParametersFilter==null||!Array.isArray(f.EventsParametersFilter)||f.EventsParametersFilter.length==0){return J}var I=Object.keys(J);var K={};I.forEach(function(L){if(f.EventsParametersFilter.indexOf(L)<0){K[L]=J[L]}});return K}function w(){return x.cookiesEnabled?a(x.clientId+"-ehtoken"):x.token}function d(I){if(I&&I.expires){var J=new Date(I.expires.match(/\d+/)[0]*1);if(x.cookiesEnabled){v(x.clientId+"-ehtoken",I.token,J)}else{x.token=I.token;setTimeout(function(){x.token=null},J.getTime()-new Date().getTime())}}}function i(){if(x.ehLogsToSend){h.each(x.ehLogsToSend,function(I,J){g(J)})}x.ehLogsToSend=[]}function q(){var I="";if(window.Zoomd&&Zoomd.Widget&&Zoomd.Widget.SU_BaseUrlServiceHttp){I=Zoomd.Widget.SU_BaseUrlServiceHttp}if(I===""){return}h.ajax({url:I+"zoomd/SearchUi/GetToken",data:{clientId:x.clientId},crossDomain:true,method:"POST",success:function(J){if(J){if(J!="error"){d(J);i()}}},error:function(J){if(F.LogError){F.LogError("zdLogger: error refreshing token.",{error:J,clientId:x.clientId,url:I,events:x.ehLogsToSend})}}})}var p=[];this.setTime=function(I){p[I]=(new Date()).getTime()};var G=function(I){if(p[I]){return((new Date()).getTime()-p[I])*0.001}return null};var c={order:[]};var s=function(){var I=c.PageSession;if(I){if(I.zoom){I.zoom=F.getZoom()}if(I.isMobile){I.isMobile=window.matchMedia("only screen and (max-width: 760px)").matches}}};var e=function(){h(window).resize(function(){s()})};this.startSession=function(J,I,K){if(c[J]){this.stopSession(J)}c[J]={};this.setTime(J);c[J].parameters=K||{};c[J].parameters[I]=c[J].__id=F.generateUuid();c.order.push(J);return c[J].parameters[I]};this.updateSession=function(J,L,K){if(!c[J]||c[J].__id!==L){return false}var I=c[J].parameters;c[J].parameters=h.extend({},I,K);return c[J].__id};this.stopSession=function(I){if(c[I]){c[I]=undefined;c.order=c.order.filter(function(J){if(J===I){return false}return true});return true}return false};var n=function(){var J={};if(c.order.length>0){var K="";for(var I=0;I<c.order.length;I++){K=c.order[I];if(c[K]&&c[K].parameters){J=h.extend({},J,c[K].parameters)}}}return J};this.logEvent=function(L,J,K){J=J||{};if(typeof(J)!="object"){return false}if(K){var N=G(K);if(N){J.timeSeconds=N}}J.startTime=r().toISOString();J.rk=o();var I=n();J=h.extend({},I,J);J.skipperToken=f.skipperToken;J.siteSessionId=E();J.action=L;if(!!this.fp){J.persistentUserId=this.fp.get()}b(J);if(f.EventsTargetsMappings&&f.EventsTargetsMappings.length>0){try{C(J)}catch(M){if(F.LogError){F.LogError("zdLogger: processEventsTargets failed.",{exception:M.message,clientId:x.clientId})}}}else{C(J)}return true};this.getSessionParameters=function(I){var J=n();return h.extend({},J,I||{})};function r(){var I=new Date().getTime()-x.initDate.getTime();return new Date(x.serverTime.getTime()+I)}function B(){var I=new Date().getTime()-x.initDate.getTime();return x.timestamp+(I*1000)}function o(){return B()+F.generateUuid().substring(0,8)}return x};