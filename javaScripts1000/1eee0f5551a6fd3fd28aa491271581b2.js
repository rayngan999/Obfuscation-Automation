"use strict";!function(){var e=window.location.host.replace(/^.*?([\w\d\-]+\.[\w\d\:]+)\r?$/,"$1"),o=["wsj.com","marketwatch.com","barrons.com"],t=e.indexOf(":");t>-1&&(e=e.substr(0,t));var a=e,n={ssoSecondaryIframes:{},generateSsoIframes:function(e,t,a){for(var n=0;n<o.length;n++){var s=o[n].trim(),r="iframe-rp-"+s+"-"+(new Date).getTime(),i=this.createIframe(r,s,t,a);this.ssoSecondaryIframes[r]=this.onIframeCompleted.bind(this),e.appendChild(i)}},generateRestoreIframe:function(o,t){var a=e,n="iframe-rp-"+a+"-"+(new Date).getTime(),s=this.createIframe(n,a,"monitor",t);this.ssoSecondaryIframes[n]=this.onIframeCompleted.bind(this),o.appendChild(s)},createIframe:function(o,t,a,n){var s=t.split(".")[0];"marketwatch"===s&&(s="mw");var r=document.createElement("iframe");r.setAttribute("id",o);var i=window.location.protocol+"//accounts."+t,d=i+"/assets/secondary-rp-sync.html?iframe_id="+encodeURIComponent(o),m="",c="https://accounts.dowjones.com".replace("dowjones.com",t);if("logout"==a){var l=i+"/auth/slo-done?iframe_id="+encodeURIComponent(o);m=e===t?l:c+"/auth/sso/logout?url="+encodeURIComponent(d)}else if("login"==a){var g=i+"/auth/sso-done?iframe_id="+encodeURIComponent(o);m=e===t?g:c+"/auth/silent-login?target="+encodeURIComponent(d)}else m=i+"/auth/sso-restore?djcs_session="+n+"&iframe_id="+encodeURIComponent(o);return r.setAttribute("src",m),r.setAttribute("style","width:0;height:0;border:none"),r},onIframeCompleted:function(e){delete this.ssoSecondaryIframes[e],document.getElementsByTagName("body")[0].removeChild(document.getElementById(e))},clearIframes:function(){for(var e in this.ssoSecondaryIframes)this.ssoSecondaryIframes[e](e)}},s={getCookie:function(e,o){var t=(o||document.cookie).match(RegExp("(?:^|;\\s*)"+e.replace(/([.*+?\^${}()|\[\]\/\\])/g,"\\$1")+"=([^;]*)"));return t?t[1]:null},deleteCookie:function(e,o){o.cookie=e+"=; Domain=."+a+"; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"}},r=(document.getElementsByTagName("body")[0],s.getCookie("run-sso")),i=s.getCookie("run-slo"),d=s.getCookie("djcs_route");if(r&&d)s.deleteCookie("run-sso",document),n.generateSsoIframes(document.getElementsByTagName("body")[0],"login",d);else if(i&&d)s.deleteCookie("run-slo",document),n.generateSsoIframes(document.getElementsByTagName("body")[0],"logout",d);else if(void 0!==window.localStorage){var m=window.localStorage.getItem("session"),c=window.localStorage.getItem("routeid"),l=window.localStorage.getItem("ts");if(m&&c&&l)if(parseInt(l)+1728e5<Date.now())window.localStorage.removeItem("session"),window.localStorage.removeItem("routeid"),window.localStorage.removeItem("ts"),s.deleteCookie("restored-sso",document);else{var g=m+"&routeid="+c+"&ts="+l+"&routeid-mismatch="+(d&&d===c?"false":"true");null==s.getCookie("restored-sso")&&n.generateRestoreIframe(document.getElementsByTagName("body")[0],g)}}function w(o){if(!(o.origin.indexOf(e)<0&&o.origin.indexOf("dowjones.com")<0)&&"string"==typeof o.data&&"DJSSO"===o.data.substr(0,5))try{var t=o.data.split("|")[2],r=JSON.parse(t);switch(r.name){case"iframe-done":void 0!==window.localStorage&&("sso-done"===r.data.action?r.data.session&&0==r.data.session.indexOf("M")&&(window.localStorage.setItem("session",r.data.session),window.localStorage.setItem("routeid",s.getCookie("djcs_route")),window.localStorage.setItem("ts",Date.now())):"slo-done"===r.data.action&&(window.localStorage.removeItem("session"),window.localStorage.removeItem("routeid"),window.localStorage.removeItem("ts"),s.deleteCookie("restored-sso",document))),n.onIframeCompleted.call(n,r.data.frameId);var i=s.getCookie("restored-sso");i&&"true"===i&&(document.cookie="restored-sso=done; Domain=."+a+"; Path=/",window.location.reload())}}catch(e){console.error("event data not JSON",o)}}window.postMessage&&(window.addEventListener?window.addEventListener("message",w,!1):window.attachEvent&&window.attachEvent("onmessage",w))}();