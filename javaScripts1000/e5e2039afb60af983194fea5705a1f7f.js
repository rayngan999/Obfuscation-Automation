define(['session','jquery','web/modules/my_account_lr/user'],function(_session,$,user){function objToString(obj){var str='';for(var p in obj){if(obj.hasOwnProperty(p)){str+=p+'::'+obj[p]+'\n';}}
return str;}
var mylocations=(function(){var userloc_update_interval=10*60*1000;if(typeof window._config.userloc_update_interval!='undefined'&&window._config.userloc_update_interval!==""&&window._config.userloc_update_interval!=null){userloc_update_interval=window._config.userloc_update_interval;}
var self={},_locations=[],guid='',guidUpdate='',alertUpdate='',udata=[],pdata={},toIndex,fromIndex,delPos,editPos,isnew=false,_pwdata,uup_enabled=true,_config={'userCache':24*60*60*1000,'alertsCache':2*60*1000,'weatherCache':10*60*1000,'blacklistDays':30*24*60*60*1000,'weatherUrl':(typeof(window.url_countrycode!='undefined'&&window.url_countrycode)?window.url_countrycode:'')+'/api/savedlocation/index/','alertUrl':(typeof(window.url_countrycode!='undefined'&&window.url_countrycode)?window.url_countrycode:'')+'/api/savedlocation/alerts/','locationCache':userloc_update_interval,},_get_domain=function(){var wdomain=null,thost=window.location.host,xarr=thost.split(".");if(thost.indexOf('.dqs')>-1){wdomain=xarr[2];}else{wdomain=xarr[1];}
return'.'+wdomain+'.com';},dmStr=_get_domain(),_save=function(key,value,type){var val=value;type=type||'storage';if(typeof value=="object"){val=JSON.stringify(value);}
if(type=='cookie'){_session.save_cookie(key,val);}else{_session.save_localstorage(key,val);}},_saveStorage=function(key,value){_save(key,value,'storage');},_saveCookie=function(key,value){_save(key,value,'cookie');},_saveCookieDm=function(key,value){var val=value;if(typeof val=="object"){if(typeof val.placeCode!='undefined'){val=_shorten_location_keys(val);}else{$.each(val,function(i,item){val[i]=_shorten_location_keys(item);});}
val=JSON.stringify(val);}
try{val=encodeURIComponent(val);}catch(e){}
var wdomain=null;var thost=window.location.host;var xarr=thost.split(".");if(thost.indexOf('.dqs')>-1){wdomain=xarr[2];}else{wdomain=xarr[1];}
var dmStr='.'+wdomain+'.com'
window._stored_locations=[];_session.save_cookie_dm(key,val,30,null,null,dmStr);},_getData=function(url,param){return $.get(url,param);},_isUserLoggedin=function(){var fm_session_token=_session.fld('SABRE_ID');if(document.cookie.indexOf('SABRE_ID')!=-1&&fm_session_token!=""&&(typeof window._config.uup_signin_popup_enabled!='undefined'&&window._config.uup_signin_popup_enabled==true)){return true;}else{return false;}},_location_keys={'postCode':{'alias':'p'},'placeCode':{'alias':'c'},'city':{'alias':'i','encode':true},'province':{'alias':'v','encode':true},'country':{'alias':'n'},'countryName':{'alias':'a','encode':true},'countyName':{'alias':'y','encode':true},'prizmCode':{'alias':'z'},'gridIndex':{'alias':'g'},'locationType':{'alias':'l'},'friendlyName':{'alias':'f','encode':true},'alertStatus':{'alias':'s','uup':false},'weather_icon':{'alias':'w','uup':false},'temperature':{'alias':'t','uup':false},'temperature_unit':{'alias':'u','uup':false}},_shorten_location_keys=function(d,encode_enabled,uup){var uup_value={};if(typeof(encode_enabled)=='undefined'){encode_enabled=false;}
if(typeof(uup)=='undefined'){uup=false;}
$.each(_location_keys,function(key,props){if(uup&&(typeof props.uup!='undefined'&&props.uup==false)){return;}
var v='';if(typeof d[key]!="undefined"){v=d[key];}
else if(typeof d[props.alias]!='undefined'){v=d[props.alias];}
if(typeof props.encode!='undefined'&&props.encode==true){try{v=decodeURIComponent(v);}catch(e){}
if(encode_enabled){try{v=encodeURIComponent(v);}catch(e){}}}
uup_value[props.alias]=v;});return uup_value;},_unshorten_location_keys=function(d){var uup_value={};$.each(_location_keys,function(key,props){var v='';if(typeof d[key]!="undefined"){v=d[key];}
else if(typeof d[props.alias]!='undefined'){v=d[props.alias];}
if(typeof props.encode!='undefined'&&props.encode==true){try{v=decodeURIComponent(v);}catch(e){}}
uup_value[key]=v;});return uup_value;},_update=function(type){var updatedLocs=[],profileData=[],isUpdated=false,newloc=true,profileChange=false;self.checkNewUser();var locs=self.getLocations()||[];var curLocs=locs;var homecity=self.getStoredData('pelm_homecity')||{};var data=udata||{};var postalcode=data.postCode||'';var pc=data.placeCode||'';var addloc,delHome=false,pgPc='';var deletedLocation=null;var uup_locations=[];if($.isArray(locs)==false){locs=[];}
if(locs.length>0){$.each(locs,function(key,value){addloc=true;if((pelm_util.isDefined(data.postCode)&&(value.placeCode||'').toLowerCase()==(pc||'').toLowerCase()&&value.postCode==postalcode)||key==delPos||key==fromIndex||key==editPos){var addloc;if(type=='delete'&&key==delPos){dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':'clicks','eventLabel':"deleteLocation"});addloc=false;profileChange=true;if(pelm_util.isDefined(homecity.postcode)&&homecity.postcode==value.postCode){delHome=true;homecity={};}
deletedLocation=value.placeCode;}
if((typeof udata.placeCode!='undefined'&&(udata.placeCode||'').toLowerCase()==(value.placeCode||'').toLowerCase())||editPos==key){value=udata;}
newloc=false;}
if(addloc==true&&pelm_util.isDefined(value.placeCode)){updatedLocs.push(value);uup_locations.push(_shorten_location_keys(value,true,true));}});if(type=='move'){dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':'clicks','eventLabel':"moveLocation"});updatedLocs=moveArrayElement(locs,fromIndex,toIndex);uup_locations=moveArrayElement(uup_locations,fromIndex,toIndex);newloc=false;}}
if(newloc==true&&locs.length<10&&pelm_util.isDefined(udata.placeCode)){updatedLocs.push(udata);uup_locations.push(_shorten_location_keys(udata,true,true));profileChange=true;pgPc=(udata.gridIndex!='')?udata.gridIndex:udata.placeCode;dataLayer.push({'event':'saveLocationEvent','eventCategory':"saveLocation",'eventAction':udata.city,'eventLabel':udata.province+", "+udata.country,'eventValue':udata.placeCode});}
if(updatedLocs.length>0||type=='delete'){if(pgPc==''&&pelm_util.isDefined(udata.placeCode)&&type!='delete'){profileChange=true;pgPc=udata.placeCode;}
if(_isUserLoggedin()===true){_saveCookieDm('pelm_mylocations_uup',updatedLocs);}else{_saveStorage('pelm_mylocations',updatedLocs);}
if(delHome==true){self.deleteHomecity();}
self.checkHomecity();updatePageWeatherData(pgPc);if(profileChange==true){_updateUserProfile(updatedLocs,delHome,type);}
if(_isUserLoggedin()===true){var inputLocations=[];if(type=='delete'){if(deletedLocation){inputLocations=[deletedLocation];}}
_update_uup(uup_locations,type,inputLocations);}
isUpdated=true;}
return isUpdated;},_update_uup=function(uup_locations,type,inputLocations){if(typeof type=='undefined'){type='update';}
if(typeof inputLocations=='undefined'){inputLocations=[];}
var http_params={"loc":uup_locations,"u":_session.fld('pelm_a'),"t":type,"in":inputLocations};var get_params=JSON.stringify(http_params);var api_locs='/api/uup/index?d='+get_params;if(_session.fld('pelm_lr')){api_locs='/api/myaccountlr/update_user_locations?d='+get_params;}
__.a(api_locs,function(data){try{if(typeof data=='string'){data=$.parseJSON(data);}}catch(err){}
if(data&&typeof data.error!='undefined'&&typeof data.status!='undefined'&&data.status==401){user.sign_out();window.reloaded_locations=true;}});},_reload_uup_locations=function(){var ut=_session.fld('pelm_a');if(typeof ut!='undefined'&&ut!=null&&ut!=''&&typeof user!='undefined'){user.check_refresh(function(refreshed){if(refreshed){ut=_session.fld('pelm_a');if(!ut){window.reloaded_locations=true;return false;}}
var reload_api_uri="/api/myaccount/reload_user_locations?t="+ut;if(_session.fld('pelm_lr')){reload_api_uri="/api/myaccountlr/reload_user_locations?t="+ut;}
__.a(reload_api_uri,function(data){try{if(typeof data=='string'){data=$.parseJSON(data);}}catch(err){}
var locations=data.locations;var status=data.status;if(typeof status!='undefined'&&status==401){window.reloaded_locations=true;return false;}
if(locations&&typeof status!='undefined'&&status==200){if(typeof locations=="object"){locations=JSON.stringify(locations);}
try{locations=encodeURIComponent(locations);}catch(e){}
window._stored_locations=[];_session.save_cookie_dm("pelm_mylocations_uup",locations,30,null,null,dmStr);var newtime=currentTimestamp();_saveStorage('pelm_userloc_lastupdate',newtime);window.reloaded_locations=true;updateAllSavedLocationsAjax();}});});}},_refreshSavedLocations=function(){var favoriteLocationFileDir=window._config.isNitroHeader?'_nitro':'';require(['web/modules/favorite_locations'+favoriteLocationFileDir],function(favorites){favorites.refreshBar();});},_updateUserProfile=function(newdata,delHome,updateType){var pdata,ddata;guid=guid||self.getGuid();if(typeof window._config.uup_enabled!='undefined'&&window._config.uup_enabled==true&&uup_enabled==true){if(typeof window._config.uup_check_enabled!='undefined'&&window._config.uup_check_enabled==true){$.when(_session.get_user(guid,'profile')).done(function(x){if(!x||(x&&x.indexOf('profile')<0)){pdata=buildProfileData(updateType,newdata,delHome,true);_session.create_user(guid,pdata);}else{pdata=buildProfileData(updateType,newdata,delHome,false);_session.update_user(guid,pdata);}}).fail(function(){pdata=buildProfileData(updateType,newdata,delHome,true);_session.create_user(guid,pdata);});}else{pdata=buildProfileData(updateType,newdata,delHome,true);_session.update_user(guid,pdata);}
self.updateGuidLastTimestamp(guidUpdate);}
return false;},buildProfileData=function(updateType,locdata,delHome,nprofile){var homecity=self.getHomecity();var hpostcode,hprizmcode,n=0,pdata={};hpostcode=homecity.postcode||'';hprizmcode=homecity.prizmcode||'';pdata['key']=guid;if(nprofile){pdata['guid']=guid;}
pdata['Language']=window._config.lang||'';pdata['UserLang']=window._config.lang||'';pdata['Platform']='Web';pdata['Random']=currentTimestamp();var fmugcuserinfo=_session.fld('fmugcuserinfo');pdata['omniture_id']=_session.fld('s_vi');if(typeof fmugcuserinfo=='string'){pdata['fmugcuserinfo']=fmugcuserinfo.split("|").splice(1).join('|');}
pdata['fmugcuser']=_session.fld('fmugcuser');var _i=__.k('pelm_ip');if(_i){_i=Function('return '+decodeURIComponent(__.k('pelm_ip'))+'')();if(_i.lat&&_i.lng){pdata['DetectedLatLong']=_i.lat+','+_i.lng;}
if(_i.ip){pdata['IPAddress']=_i.ip;}}
if(pelm_util.isDefined(window.gridindex)){pdata['LastPointCastAccess']=new Date().getTime();;}
if(pelm_util.notEmpty(window.postalcode)&&pelm_util.isDefined(s_pelm)&&pelm_util.isDefined(s_pelm.eVar46)&&s_pelm.eVar46=='Yes'){pdata['PointCastPageDate']=new Date().toString();}
pdata['UserAgent']=window.navigator.userAgent;_i=__.k('pelm_unit');if(!_i){_i='c';}
pdata['unit']=_i;if(delHome==true){pdata['PrimaryPostalCode']='';pdata['PrimaryCode']='';pdata['PrimaryCity']='';pdata['PrimaryGridIndex']='';pdata['PrimaryPrizm']='';}
$.each(locdata,function(index,data){if(hpostcode!=''&&hpostcode==data.postCode){pdata['PrimaryPostalCode']=data.postCode;pdata['PrimaryCode']=data.placeCode;pdata['PrimaryCity']=data.city+' '+data.province;pdata['PrimaryGridIndex']=data.gridIndex;pdata['PrimaryPrizm']=data.prizmCode;}
n=index+1;pdata['Location'+'PostalCode'+n]=data.postCode;pdata['Location'+'Code'+n]=data.placeCode;pdata['Location'+n]=data.city+' '+data.province;pdata['Location'+'GridIndex'+n]=data.gridIndex;pdata['Location'+'Prizm'+n]=data.prizmCode;});if(updateType=='delete'){n=n+1;pdata['Location'+'PostalCode'+n]='';pdata['Location'+'Code'+n]='';pdata['Location'+n]='';pdata['Location'+'GridIndex'+n]='';pdata['Location'+'Prizm'+n]='';}
return pdata;},updateSavedLocationWeatherDataFromJson=function(data){var find="{{";var regex=new RegExp(find,"g");data=data.replace(regex,"{");find="}}";regex=new RegExp(find,"g");data=data.replace(regex,"}");var myloc=[],newloc=false;myloc=self.getLocations()||[];if(data&&data.indexOf('{')>=0&&data.indexOf('<')<0&&myloc.length>0){wdata=JSON.parse(data);var wcode=window.placecode||'',windex=window.gridindex||'';var temp,icon,unit;if(pelm_util.isObject(_pwdata)&&pelm_util.isDefined(_pwdata.temperature)){temp=_pwdata.temperature;icon=_pwdata.icon;unit=_pwdata.temperature_unit;}else{_d=window._d||{},wd=_d.d||'',wd=(typeof wd=='string'&&wd.indexOf('{')>-1)?JSON.parse(wd):wd;if(pelm_util.isDefined(wd.obs)){icon=wd.obs.icon;temp=wd.obs.temperature;unit=wd.obs.temperature_unit;}}
$.each(wdata,function(index,val){if(pelm_util.notEmpty(val.temperature)){$.each(myloc,function(i,v){if(pelm_util.notEmpty(v.gridIndex)&&(v.gridIndex||'').toLowerCase()==(val.placecode||'').toLowerCase()){if(pelm_util.isDefined(temp)&&windex.toLowerCase()==(v.gridIndex||'').toLowerCase()){val.icon=icon;val.temperature=temp;val.temperature_unit=unit;}
myloc[i].weather_icon=val.icon;myloc[i].temperature=val.temperature;myloc[i].temperature_unit=val.temperature_unit;return;}else if(pelm_util.isEmpty(v.gridIndex)&&(v.placeCode||'').toLowerCase()==(val.placecode||'').toLowerCase()){if(pelm_util.isDefined(temp)&&(wcode.toLowerCase()==(v.placeCode||'').toLowerCase()&&windex.toLowerCase()==(v.gridIndex||'').toLowerCase())){val.icon=icon;val.temperature=temp;val.temperature_unit=unit;}
myloc[i].weather_icon=val.icon;myloc[i].temperature=val.temperature;myloc[i].temperature_unit=val.temperature_unit;return;}});}});if(_isUserLoggedin()===true){_saveCookieDm('pelm_mylocations_uup',myloc);}else{_saveStorage('pelm_mylocations',myloc);}
_refreshSavedLocations();self.setWeatherLastUpdateToCurrentTimeStamp();}},updateAllSavedLocationsAjax=function(){var mylocs=[];if(_isUserLoggedin()===true){mylocs=self.getLocations('pelm_mylocations_uup')||[];}else{mylocs=self.getLocations('pelm_mylocations')||[];}
var params=[];if($.isArray(mylocs)&&mylocs.length>0){$.each(mylocs,function(index,val){if(val.gridIndex&&val.gridIndex!=''){params[index]=(val.gridIndex||'').toUpperCase();}else{params[index]=(val.placeCode||'').toUpperCase();}});_config.weatherUrl=_config.weatherUrl.replace('undefined','');__.a(_config.weatherUrl+'?placecodes='+encodeURI(params),function(data,status){updateSavedLocationWeatherDataFromJson(data);},function(){});}},updatePageWeatherData=function(pc){var wdata=_pwdata||{},myloc=[],wcode=window.placecode||'',windex=window.gridindex||'',pc=(typeof pc=='string')?pc.toLowerCase():'',isSaved=false,index,sdata='';if(_isUserLoggedin()===true){myloc=self.getLocations('pelm_mylocations_uup')||[];}else{myloc=self.getLocations('pelm_mylocations')||[];}
$.each(myloc,function(i,val){var scode=val.placeCode||'',sindex=val.gridIndex||'';if(windex.length>0){if(windex.toLowerCase()==sindex.toLowerCase()){isSaved=true;index=i;sdata=val.temperature||'';return false;}}else if(scode.toLowerCase()==wcode.toLowerCase()){isSaved=true;index=i;sdata=val.temperature||'';return false;}});if(wdata&&pelm_util.isDefined(wdata.temperature)){if(isSaved){myloc[index].weather_icon=wdata.icon;myloc[index].temperature=wdata.temperature;myloc[index].temperature_unit=wdata.temperature_unit;}
if(_isUserLoggedin()===true){_saveCookieDm('pelm_mylocations_uup',myloc);}else{_saveStorage('pelm_mylocations',myloc);}
_refreshSavedLocations();}else if((wcode.length>0&&isSaved)||pc.length>0){wcode=(windex.length>0)?windex.toUpperCase():wcode;var c=(wcode.length>0)?wcode:pc;$.when(_getData(_config.weatherUrl,{'placecodes':{'0':c}})).done(function(data,status){updateSavedLocationWeatherDataFromJson(data);});}else{setTimeout(function(){_refreshSavedLocations();},500);}},moveArrayElement=function(arr,fromPos,toPos){arr.splice(toPos,0,arr.splice(fromPos,1)[0]);return arr;},currentTimestamp=function(){var time=new Date().getTime();return time;};self.getStoredData=function(key){var val=_session.fld(key);if(!val||val==null){return false;}
if(val.indexOf('{')>=0||val.indexOf('[')>=0){val=JSON.parse(val);}
return val;};self.getStoredLocations=function(key){var val=_session.fld_raw(key);if(val){try{val=decodeURIComponent(val);}catch(e){val=unescape(val);}}
if(!val||val==null){return false;}
if(val.indexOf('{')>=0||val.indexOf('[')>=0){val=JSON.parse(val);}
if($.isArray(val)){$.each(val,function(i,item){val[i]=_unshorten_location_keys(item);});}
return val;};self.updateAlertsStatus=function(alertLocs){var mylocs=[];if(_isUserLoggedin()===true){mylocs=self.getLocations('pelm_mylocations_uup');}else{mylocs=self.getLocations('pelm_mylocations');}
mylocs=($.isArray(mylocs))?mylocs:[];$.each(alertLocs,function(key,alert){$.each(mylocs,function(k,loc){if((loc.placeCode||'').toLowerCase()==(alert.placeCode||'').toLowerCase()){mylocs[k].alertStatus=alert.status;}});});if(_isUserLoggedin()===true){_saveCookieDm('pelm_mylocations_uup',mylocs);}else{_saveStorage('pelm_mylocations',mylocs);}};self.updateSavedLocationDataFromCurrentWeather=function(wdata){_pwdata=wdata;updatePageWeatherData('');};self.userExists=function(){guid=self.getStoredData('guid');return(guid)?true:false;};self.checkNewUser=function(){if(self.userExists()==false){window.twn.setGuid();}};self.isUserActive=function(){var bdy=$('body'),u_active=true;if(bdy.hasClass('focused')){u_active=true;}else if(bdy.hasClass('blurred')){u_active=false;}
return u_active;};self.getLocations=function(){if(_isUserLoggedin()===true){if(typeof window._stored_locations=='undefined'||!window._stored_locations||window._stored_locations.length==0){window._stored_locations=self.getStoredLocations('pelm_mylocations_uup');}
return window._stored_locations;}
return self.getStoredData('pelm_mylocations');};self.reLoadLocations=function(){var storedTime=self.getStoredData('pelm_userloc_lastupdate')||0;var timediff=currentTimestamp()-storedTime;if(timediff>_config.locationCache){_reload_uup_locations();}
setInterval(function(){var _isUserActive=self.isUserActive();if(_isUserActive){_reload_uup_locations();}},_config.locationCache);};self.reLoadLocationsOnce=function(){_reload_uup_locations();};self.getGuid=function(){return self.getStoredData('guid');};self.checkHomecity=function(){var homecity=self.getHomecity();var mylocs=self.getLocations();var loggedInUsr=_isUserLoggedin();if(typeof homecity!='object'&&typeof homecity.postcode=='undefined'&&mylocs.length>0){$.each(mylocs,function(i,locs){if(locs.postCode!=''&&locs.prizmCode!=''){_saveCookie('pelm_homecity',{'postcode':locs.postCode,'prizmcode':locs.prizmCode});if(typeof self.getStoredData('pelm_first_home')!='string'){var newLocs=moveArrayElement(mylocs,i,0);if(loggedInUsr===true){_saveCookieDm('pelm_mylocations_uup',newLocs);}else{_saveStorage('pelm_mylocations',newLocs);}
_saveCookie('pelm_first_home','true');}
return false;}});}};self.setHomecity=function(data){if(typeof data.postCode==undefined){return false;}
_saveCookie('pelm_homecity',{'postcode':data.postCode,'prizmcode':data.prizmCode});return true;};self.getHomecity=function(){return self.getStoredData('pelm_homecity');};self.deleteHomecity=function(){var date=new Date();var days=-1;date.setTime(date.getTime()+(days*24*60*60*1000));document.cookie='pelm_homecity'+"='';  SameSite=Strict; Secure; expires="+date.toGMTString()+"; path="+escape("/");};self.getCount=function(){var myloc=self.getLocations()||[];var i=0;if($.isArray(myloc)){i=myloc.length;}
return i;};self.checkLocationSaved=function(placecode){var myloc=self.getLocations()||[];var isSaved=false;var winplacecode=placecode||'',locplacecode='';var winpostcode=window.postalcode||'';if($.isArray(myloc)&&myloc.length>0){$.each(myloc,function(index,loc){locplacecode=loc.placeCode||'';if(locplacecode.toLowerCase()==winplacecode.toLowerCase()&&(loc.postCode||'').toLowerCase()==winpostcode.toLowerCase()){isSaved=true;return false;}});}
return isSaved;};self.checkBlockedLocations=function(placecode){var blacklist=self.getStoredData('pelm_blocklocations')||{};var timediff,newlist={},inList=false,isupdate=false;$.each(blacklist,function(pc,val){timediff=currentTimestamp()-val;isupdate=true;if((pc||'').toLowerCase()==(placecode||'').toLowerCase()){inList=true;}
if(timediff>_config.blacklistDays){inList=false;}else{newlist[pc]=val;}});if(isupdate){_saveCookie('pelm_blocklocations',newlist);}
return inList;};self.updateBlockedLocations=function(placecode){var blacklist=self.getStoredData('pelm_blocklocations')||{};blacklist[placecode]=currentTimestamp();_saveCookie('pelm_blocklocations',blacklist);};self.move=function(oldPos,newPos){toIndex=newPos;fromIndex=oldPos;delPos=editPos=null;return _update('move');};self.update=function(data,pos,uup_enbl){udata=data;editPos=pelm_util.notDefined(pos)?null:pos;delPos=toIndex=fromIndex=null;uup_enabled=(typeof uup_enbl=='undefined'||uup_enbl==true)?true:false;return _update('update');};self.remove=function(pos){delPos=parseInt(pos)-1;return _update('delete');};self.updateGuidLastTimestamp=function(utimestamp){var utimestamp=utimestamp||currentTimestamp();_saveStorage('pelm_guidlastupdate',utimestamp);setTimeout(function(){var mylocs=self.getLocations()||[];if(mylocs.length>0){_updateUserProfile(mylocs,false,'update');}else{utimestamp=currentTimestamp();var guid=self.getGuid();var pdata={'key':guid,'Random':utimestamp};_session.update_user(guid,pdata);self.updateGuidLastTimestamp();}},_config.userCache);};self.setAlertsLastUpdateToCurrentTimeStamp=function(){var newtime=currentTimestamp();_saveStorage('pelm_alertslastupdate',newtime);};self.setWeatherLastUpdateToCurrentTimeStamp=function(){var newtime=currentTimestamp();_saveStorage('pelm_weatherlastupdate',newtime);setTimeout(function(){updateAllSavedLocationsAjax();},_config.weatherCache);};self.setSavedLocationsUpdateTimer=function(force){var storedTime=self.getStoredData('pelm_weatherlastupdate')||0;var timediff=currentTimestamp()-storedTime;var mylocs=self.getLocations()||[];var force_update=force||false;if(pelm_util.isDefined(mylocs)&&typeof mylocs=='string'){_saveStorage('pelm_mylocations',[]);}
if(mylocs.length>0&&(timediff>_config.weatherCache||force_update)){updateAllSavedLocationsAjax();}else if(mylocs.length>0&&timediff<_config.weatherCache){setTimeout(function(){updateAllSavedLocationsAjax();},(_config.weatherCache-timediff));}
storedTime=self.getStoredData('pelm_guidlastupdate')||0;timediff=currentTimestamp()-storedTime;if(mylocs.length>0&&(timediff>_config.userCache||force_update)){_updateUserProfile(mylocs,false,'update');}};self.deleteCrossLocationCookie=function(){var splitUrl=window.location.hostname.split('.').reverse();var domain='.'+splitUrl[1]+'.'+splitUrl[0];if(self.getStoredData('pelm_crosslocations')!=false){document.cookie='pelm_crosslocations'+"={};  SameSite=Strict; Secure; expires="+new Date('1983','01','01').toGMTString()+"; path="+escape("/")+"; domain="+escape(domain);}
if(self.getStoredData('pelm_location_update')!=false){document.cookie='pelm_location_update'+"='';  SameSite=Strict; Secure; expires="+new Date('1983','01','01').toGMTString()+"; path="+escape("/")+"; domain="+escape(domain);}
return true;};self.setCrossLocations=function(locations){self.deleteCrossLocationCookie();return true;};self.mergeCrossLocations=function(){self.deleteCrossLocationCookie();return true;};self.isUserLoggedin=function(){return _isUserLoggedin();}
return self;});return mylocations();});;